/*
Copyright 2022 Comcast Cable Communications Management, LLC

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at
    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
"use strict";(self.webpackChunka_porrtal_io_app=self.webpackChunka_porrtal_io_app||[]).push([[3251],{76279:(we,ge,T)=>{T.d(ge,{r:()=>K});var B=T(14259);function K(_,m){if(!(this instanceof K))return new K(_,m);this._maxEntries=Math.max(4,_||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),m&&("function"==typeof m?this.toBBox=m:this._initFormat(m)),this.clear()}function k(_,m,S){if(!S)return m.indexOf(_);for(var F=0;F<m.length;F++)if(S(_,m[F]))return F;return-1}function M(_,m){L(_,0,_.children.length,m,_)}function L(_,m,S,F,w){w||(w=E(null)),w.minX=1/0,w.minY=1/0,w.maxX=-1/0,w.maxY=-1/0;for(var O,b=m;b<S;b++)O=_.children[b],Y(w,_.leaf?F(O):O);return w}function Y(_,m){return _.minX=Math.min(_.minX,m.minX),_.minY=Math.min(_.minY,m.minY),_.maxX=Math.max(_.maxX,m.maxX),_.maxY=Math.max(_.maxY,m.maxY),_}function re(_,m){return _.minX-m.minX}function Z(_,m){return _.minY-m.minY}function X(_){return(_.maxX-_.minX)*(_.maxY-_.minY)}function $(_){return _.maxX-_.minX+(_.maxY-_.minY)}function W(_,m){return(Math.max(m.maxX,_.maxX)-Math.min(m.minX,_.minX))*(Math.max(m.maxY,_.maxY)-Math.min(m.minY,_.minY))}function V(_,m){var S=Math.max(_.minX,m.minX),F=Math.max(_.minY,m.minY),w=Math.min(_.maxX,m.maxX),O=Math.min(_.maxY,m.maxY);return Math.max(0,w-S)*Math.max(0,O-F)}function C(_,m){return _.minX<=m.minX&&_.minY<=m.minY&&m.maxX<=_.maxX&&m.maxY<=_.maxY}function N(_,m){return m.minX<=_.maxX&&m.minY<=_.maxY&&m.maxX>=_.minX&&m.maxY>=_.minY}function E(_){return{children:_,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function U(_,m,S,F,w){for(var O,b=[m,S];b.length;)(S=b.pop())-(m=b.pop())<=F||(O=m+Math.ceil((S-m)/F/2)*F,(0,B.q)(_,O,m,S,w),b.push(m,O,O,S))}K.prototype={all:function(){return this._all(this.data,[])},search:function(_){var m=this.data,S=[],F=this.toBBox;if(!N(_,m))return S;for(var w,O,b,D,z=[];m;){for(w=0,O=m.children.length;w<O;w++)b=m.children[w],N(_,D=m.leaf?F(b):b)&&(m.leaf?S.push(b):C(_,D)?this._all(b,S):z.push(b));m=z.pop()}return S},collides:function(_){var m=this.data,S=this.toBBox;if(!N(_,m))return!1;for(var F,w,O,b,D=[];m;){for(F=0,w=m.children.length;F<w;F++)if(O=m.children[F],N(_,b=m.leaf?S(O):O)){if(m.leaf||C(_,b))return!0;D.push(O)}m=D.pop()}return!1},load:function(_){if(!_||!_.length)return this;if(_.length<this._minEntries){for(var m=0,S=_.length;m<S;m++)this.insert(_[m]);return this}var F=this._build(_.slice(),0,_.length-1,0);if(this.data.children.length)if(this.data.height===F.height)this._splitRoot(this.data,F);else{if(this.data.height<F.height){var w=this.data;this.data=F,F=w}this._insert(F,this.data.height-F.height-1,!0)}else this.data=F;return this},insert:function(_){return _&&this._insert(_,this.data.height-1),this},clear:function(){return this.data=E([]),this},remove:function(_,m){if(!_)return this;for(var S,F,w,O,b=this.data,D=this.toBBox(_),z=[],q=[];b||z.length;){if(b||(b=z.pop(),F=z[z.length-1],S=q.pop(),O=!0),b.leaf&&-1!==(w=k(_,b.children,m)))return b.children.splice(w,1),z.push(b),this._condense(z),this;O||b.leaf||!C(b,D)?F?(S++,b=F.children[S],O=!1):b=null:(z.push(b),q.push(S),S=0,F=b,b=b.children[0])}return this},toBBox:function(_){return _},compareMinX:re,compareMinY:Z,toJSON:function(){return this.data},fromJSON:function(_){return this.data=_,this},_all:function(_,m){for(var S=[];_;)_.leaf?m.push.apply(m,_.children):S.push.apply(S,_.children),_=S.pop();return m},_build:function(_,m,S,F){var w,O=S-m+1,b=this._maxEntries;if(O<=b)return M(w=E(_.slice(m,S+1)),this.toBBox),w;F||(F=Math.ceil(Math.log(O)/Math.log(b)),b=Math.ceil(O/Math.pow(b,F-1))),(w=E([])).leaf=!1,w.height=F;var D,z,q,H,ae=Math.ceil(O/b),Ie=ae*Math.ceil(Math.sqrt(b));for(U(_,m,S,Ie,this.compareMinX),D=m;D<=S;D+=Ie)for(U(_,D,q=Math.min(D+Ie-1,S),ae,this.compareMinY),z=D;z<=q;z+=ae)H=Math.min(z+ae-1,q),w.children.push(this._build(_,z,H,F-1));return M(w,this.toBBox),w},_chooseSubtree:function(_,m,S,F){for(var w,O,b,D,z,q,H,ae;F.push(m),!m.leaf&&F.length-1!==S;){for(H=ae=1/0,w=0,O=m.children.length;w<O;w++)z=X(b=m.children[w]),(q=W(_,b)-z)<ae?(ae=q,H=z<H?z:H,D=b):q===ae&&z<H&&(H=z,D=b);m=D||m.children[0]}return m},_insert:function(_,m,S){var w=S?_:(0,this.toBBox)(_),O=[],b=this._chooseSubtree(w,this.data,m,O);for(b.children.push(_),Y(b,w);m>=0&&O[m].children.length>this._maxEntries;)this._split(O,m),m--;this._adjustParentBBoxes(w,O,m)},_split:function(_,m){var S=_[m],F=S.children.length,w=this._minEntries;this._chooseSplitAxis(S,w,F);var O=this._chooseSplitIndex(S,w,F),b=E(S.children.splice(O,S.children.length-O));b.height=S.height,b.leaf=S.leaf,M(S,this.toBBox),M(b,this.toBBox),m?_[m-1].children.push(b):this._splitRoot(S,b)},_splitRoot:function(_,m){this.data=E([_,m]),this.data.height=_.height+1,this.data.leaf=!1,M(this.data,this.toBBox)},_chooseSplitIndex:function(_,m,S){var F,w,O,b,D,z,q,H;for(z=q=1/0,F=m;F<=S-m;F++)b=V(w=L(_,0,F,this.toBBox),O=L(_,F,S,this.toBBox)),D=X(w)+X(O),b<z?(z=b,H=F,q=D<q?D:q):b===z&&D<q&&(q=D,H=F);return H},_chooseSplitAxis:function(_,m,S){var F=_.leaf?this.compareMinX:re,w=_.leaf?this.compareMinY:Z;this._allDistMargin(_,m,S,F)<this._allDistMargin(_,m,S,w)&&_.children.sort(F)},_allDistMargin:function(_,m,S,F){_.children.sort(F);var w,O,b=this.toBBox,D=L(_,0,m,b),z=L(_,S-m,S,b),q=$(D)+$(z);for(w=m;w<S-m;w++)O=_.children[w],Y(D,_.leaf?b(O):O),q+=$(D);for(w=S-m-1;w>=m;w--)O=_.children[w],Y(z,_.leaf?b(O):O),q+=$(z);return q},_adjustParentBBoxes:function(_,m,S){for(var F=S;F>=0;F--)Y(m[F],_)},_condense:function(_){for(var m,S=_.length-1;S>=0;S--)0===_[S].children.length?S>0?(m=_[S-1].children).splice(m.indexOf(_[S]),1):this.clear():M(_[S],this.toBBox)},_initFormat:function(_){var m=["return a"," - b",";"];this.compareMinX=new Function("a","b",m.join(_[0])),this.compareMinY=new Function("a","b",m.join(_[1])),this.toBBox=new Function("a","return {minX: a"+_[0]+", minY: a"+_[1]+", maxX: a"+_[2]+", maxY: a"+_[3]+"};")}}},7547:(we,ge,T)=>{var B,K,k,M,L,Y,re,Z,X,$,W,V,C,N,E,U,_,m,S,F,w,O,b,D,z,q,H,ae,Ie,ue,fe,ie,me,Ke,vt,at,Je,ut,xt,$e,Ge,et,ht,Pe,ke,je,lt,dt,St,ct,tt,Ze,Ne,gt,bt,st,rt,We,ft,Ct,pt,g;T.d(ge,{$y:()=>O,AH:()=>K,CS:()=>lt,DD:()=>Z,Dd:()=>Ie,Em:()=>w,JS:()=>ke,Ky:()=>X,Lh:()=>dt,Qb:()=>rt,RL:()=>B,RS:()=>ft,TF:()=>F,Tx:()=>L,UR:()=>_,UX:()=>st,bj:()=>je,eZ:()=>re,id:()=>z,kP:()=>at,r4:()=>$e,sj:()=>Je,v2:()=>k,zQ:()=>ae,zV:()=>U}),(g=B||(B={}))[g.BUTT=0]="BUTT",g[g.ROUND=1]="ROUND",g[g.SQUARE=2]="SQUARE",g[g.UNKNOWN=4]="UNKNOWN",function(g){g[g.BEVEL=0]="BEVEL",g[g.ROUND=1]="ROUND",g[g.MITER=2]="MITER",g[g.UNKNOWN=4]="UNKNOWN"}(K||(K={})),function(g){g[g.SCREEN=0]="SCREEN",g[g.MAP=1]="MAP"}(k||(k={})),function(g){g[g.Tint=0]="Tint",g[g.Ignore=1]="Ignore",g[g.Multiply=99]="Multiply"}(M||(M={})),function(g){g.Both="Both",g.JustBegin="JustBegin",g.JustEnd="JustEnd",g.None="None"}(L||(L={})),function(g){g[g.Mosaic=0]="Mosaic",g[g.Centered=1]="Centered"}(Y||(Y={})),function(g){g[g.Normal=0]="Normal",g[g.Superscript=1]="Superscript",g[g.Subscript=2]="Subscript"}(re||(re={})),function(g){g[g.MSSymbol=0]="MSSymbol",g[g.Unicode=1]="Unicode"}(Z||(Z={})),function(g){g[g.Unspecified=0]="Unspecified",g[g.TrueType=1]="TrueType",g[g.PSOpenType=2]="PSOpenType",g[g.TTOpenType=3]="TTOpenType",g[g.Type1=4]="Type1"}(X||(X={})),function(g){g[g.Display=0]="Display",g[g.Map=1]="Map"}($||($={})),function(g){g.None="None",g.Loop="Loop",g.Oscillate="Oscillate"}(W||(W={})),function(g){g[g.Z=0]="Z",g[g.X=1]="X",g[g.Y=2]="Y"}(V||(V={})),function(g){g[g.XYZ=0]="XYZ",g[g.ZXY=1]="ZXY",g[g.YXZ=2]="YXZ"}(C||(C={})),function(g){g[g.Rectangle=0]="Rectangle",g[g.RoundedRectangle=1]="RoundedRectangle",g[g.Oval=2]="Oval"}(N||(N={})),function(g){g[g.None=0]="None",g[g.Alpha=1]="Alpha",g[g.Screen=2]="Screen",g[g.Multiply=3]="Multiply",g[g.Add=4]="Add"}(E||(E={})),function(g){g[g.TTB=0]="TTB",g[g.RTL=1]="RTL",g[g.BTT=2]="BTT"}(U||(U={})),function(g){g[g.None=0]="None",g[g.SignPost=1]="SignPost",g[g.FaceNearPlane=2]="FaceNearPlane"}(_||(_={})),function(g){g[g.Float=0]="Float",g[g.String=1]="String",g[g.Boolean=2]="Boolean"}(m||(m={})),function(g){g[g.Intersect=0]="Intersect",g[g.Subtract=1]="Subtract"}(S||(S={})),function(g){g.OpenEnded="OpenEnded",g.Block="Block",g.Crossed="Crossed"}(F||(F={})),function(g){g.FullGeometry="FullGeometry",g.PerpendicularFromFirstSegment="PerpendicularFromFirstSegment",g.ReversedFirstSegment="ReversedFirstSegment",g.PerpendicularToSecondSegment="PerpendicularToSecondSegment",g.SecondSegmentWithTicks="SecondSegmentWithTicks",g.DoublePerpendicular="DoublePerpendicular",g.OppositeToFirstSegment="OppositeToFirstSegment",g.TriplePerpendicular="TriplePerpendicular",g.HalfCircleFirstSegment="HalfCircleFirstSegment",g.HalfCircleSecondSegment="HalfCircleSecondSegment",g.HalfCircleExtended="HalfCircleExtended",g.OpenCircle="OpenCircle",g.CoverageEdgesWithTicks="CoverageEdgesWithTicks",g.GapExtentWithDoubleTicks="GapExtentWithDoubleTicks",g.GapExtentMidline="GapExtentMidline",g.Chevron="Chevron",g.PerpendicularWithArc="PerpendicularWithArc",g.ClosedHalfCircle="ClosedHalfCircle",g.TripleParallelExtended="TripleParallelExtended",g.ParallelWithTicks="ParallelWithTicks",g.Parallel="Parallel",g.PerpendicularToFirstSegment="PerpendicularToFirstSegment",g.ParallelOffset="ParallelOffset",g.OffsetOpposite="OffsetOpposite",g.OffsetSame="OffsetSame",g.CircleWithArc="CircleWithArc",g.DoubleJog="DoubleJog",g.PerpendicularOffset="PerpendicularOffset",g.LineExcludingLastSegment="LineExcludingLastSegment",g.MultivertexArrow="MultivertexArrow",g.CrossedArrow="CrossedArrow",g.ChevronArrow="ChevronArrow",g.ChevronArrowOffset="ChevronArrowOffset",g.PartialFirstSegment="PartialFirstSegment",g.Arch="Arch",g.CurvedParallelTicks="CurvedParallelTicks",g.Arc90Degrees="Arc90Degrees"}(w||(w={})),function(g){g.Mitered="Mitered",g.Bevelled="Bevelled",g.Rounded="Rounded",g.Square="Square",g.TrueBuffer="TrueBuffer"}(O||(O={})),function(g){g.ClosePath="ClosePath",g.ConvexHull="ConvexHull",g.RectangularBox="RectangularBox"}(b||(b={})),function(g){g.BeginningOfLine="BeginningOfLine",g.EndOfLine="EndOfLine"}(D||(D={})),function(g){g.Mitered="Mitered",g.Bevelled="Bevelled",g.Rounded="Rounded",g.Square="Square"}(z||(z={})),function(g){g.Fast="Fast",g.Accurate="Accurate"}(q||(q={})),function(g){g.BeginningOfLine="BeginningOfLine",g.EndOfLine="EndOfLine"}(H||(H={})),function(g){g.Sinus="Sinus",g.Square="Square",g.Triangle="Triangle",g.Random="Random"}(ae||(ae={})),function(g){g[g.None=0]="None",g[g.Default=1]="Default",g[g.Force=2]="Force"}(Ie||(Ie={})),function(g){g[g.Buffered=0]="Buffered",g[g.Left=1]="Left",g[g.Right=2]="Right",g[g.AlongLine=3]="AlongLine"}(ue||(ue={})),function(g){g[g.Linear=0]="Linear",g[g.Rectangular=1]="Rectangular",g[g.Circular=2]="Circular",g[g.Buffered=3]="Buffered"}(fe||(fe={})),function(g){g[g.Discrete=0]="Discrete",g[g.Continuous=1]="Continuous"}(ie||(ie={})),function(g){g[g.AcrossLine=0]="AcrossLine",g[g.AloneLine=1]="AloneLine"}(me||(me={})),function(g){g[g.Left=0]="Left",g[g.Right=1]="Right",g[g.Center=2]="Center",g[g.Justify=3]="Justify"}(Ke||(Ke={})),function(g){g[g.Base=0]="Base",g[g.MidPoint=1]="MidPoint",g[g.ThreePoint=2]="ThreePoint",g[g.FourPoint=3]="FourPoint",g[g.Underline=4]="Underline",g[g.CircularCW=5]="CircularCW",g[g.CircularCCW=6]="CircularCCW"}(vt||(vt={})),function(g){g.Butt="Butt",g.Round="Round",g.Square="Square"}(at||(at={})),function(g){g.NoConstraint="NoConstraint",g.HalfPattern="HalfPattern",g.HalfGap="HalfGap",g.FullPattern="FullPattern",g.FullGap="FullGap",g.Custom="Custom"}(Je||(Je={})),function(g){g[g.None=-1]="None",g[g.Custom=0]="Custom",g[g.Circle=1]="Circle",g[g.OpenArrow=2]="OpenArrow",g[g.ClosedArrow=3]="ClosedArrow",g[g.Diamond=4]="Diamond"}(ut||(ut={})),function(g){g[g.ExtraLeading=0]="ExtraLeading",g[g.Multiple=1]="Multiple",g[g.Exact=2]="Exact"}(xt||(xt={})),function(g){g.Bevel="Bevel",g.Round="Round",g.Miter="Miter"}($e||($e={})),function(g){g[g.Default=0]="Default",g[g.String=1]="String",g[g.Numeric=2]="Numeric"}(Ge||(Ge={})),function(g){g[g.InsidePolygon=0]="InsidePolygon",g[g.PolygonCenter=1]="PolygonCenter",g[g.RandomlyInsidePolygon=2]="RandomlyInsidePolygon"}(et||(et={})),function(g){g[g.Tint=0]="Tint",g[g.Replace=1]="Replace",g[g.Multiply=2]="Multiply"}(ht||(ht={})),function(g){g[g.ClipAtBoundary=0]="ClipAtBoundary",g[g.RemoveIfCenterOutsideBoundary=1]="RemoveIfCenterOutsideBoundary",g[g.DoNotTouchBoundary=2]="DoNotTouchBoundary",g[g.DoNotClip=3]="DoNotClip"}(Pe||(Pe={})),function(g){g.NoConstraint="NoConstraint",g.WithMarkers="WithMarkers",g.WithFullGap="WithFullGap",g.WithHalfGap="WithHalfGap",g.Custom="Custom"}(ke||(ke={})),function(g){g.Fixed="Fixed",g.Random="Random",g.RandomFixedQuantity="RandomFixedQuantity"}(je||(je={})),function(g){g.LineMiddle="LineMiddle",g.LineBeginning="LineBeginning",g.LineEnd="LineEnd",g.SegmentMidpoint="SegmentMidpoint"}(lt||(lt={})),function(g){g.OnPolygon="OnPolygon",g.CenterOfMass="CenterOfMass",g.BoundingBoxCenter="BoundingBoxCenter"}(dt||(dt={})),function(g){g[g.Low=0]="Low",g[g.Medium=1]="Medium",g[g.High=2]="High"}(St||(St={})),function(g){g[g.MarkerCenter=0]="MarkerCenter",g[g.MarkerBounds=1]="MarkerBounds"}(ct||(ct={})),function(g){g[g.None=0]="None",g[g.PropUniform=1]="PropUniform",g[g.PropNonuniform=2]="PropNonuniform",g[g.DifUniform=3]="DifUniform",g[g.DifNonuniform=4]="DifNonuniform"}(tt||(tt={})),function(g){g.Tube="Tube",g.Strip="Strip",g.Wall="Wall"}(Ze||(Ze={})),function(g){g[g.Random=0]="Random",g[g.Increasing=1]="Increasing",g[g.Decreasing=2]="Decreasing",g[g.IncreasingThenDecreasing=3]="IncreasingThenDecreasing"}(Ne||(Ne={})),function(g){g[g.Relative=0]="Relative",g[g.Absolute=1]="Absolute"}(gt||(gt={})),function(g){g[g.Normal=0]="Normal",g[g.LowerCase=1]="LowerCase",g[g.Allcaps=2]="Allcaps"}(bt||(bt={})),function(g){g[g.LTR=0]="LTR",g[g.RTL=1]="RTL"}(st||(st={})),function(g){g.Draft="Draft",g.Picture="Picture",g.Text="Text"}(rt||(rt={})),function(g){g[g.Top=0]="Top",g[g.Center=1]="Center",g[g.Baseline=2]="Baseline",g[g.Bottom=3]="Bottom"}(We||(We={})),function(g){g[g.Right=0]="Right",g[g.Upright=1]="Upright"}(ft||(ft={})),function(g){g[g.Small=0]="Small",g[g.Medium=1]="Medium",g[g.Large=2]="Large"}(Ct||(Ct={})),function(g){g[g.Calm=0]="Calm",g[g.Rippled=1]="Rippled",g[g.Slight=2]="Slight",g[g.Moderate=3]="Moderate"}(pt||(pt={}))},99666:(we,ge,T)=>{T.d(ge,{KS:()=>X,PX:()=>L,QS:()=>W,_I:()=>B,jL:()=>Z,nE:()=>$,vs:()=>re,xp:()=>Y});const B=8388607,K=8388608,L=0,Y=1,re=V=>(V&K)>>>23,Z=V=>V&B,X=V=>re(V)===Y?254:255;function $(V){return re(V)===Y}function W(V,C){return((C?K:0)|V)>>>0}},39351:(we,ge,T)=>{T.d(ge,{$0:()=>W,AI:()=>k,By:()=>ie,C1:()=>g,CQ:()=>Ft,CU:()=>Ne,Ex:()=>w,I_:()=>Y,Ic:()=>H,Ij:()=>ue,Ip:()=>We,Iv:()=>Se,Iw:()=>O,MI:()=>pt,SD:()=>Lt,Tz:()=>De,Uh:()=>Ut,V4:()=>Ze,XJ:()=>rt,_6:()=>Ot,a:()=>gt,aK:()=>et,e0:()=>Tt,eV:()=>V,f2:()=>fe,fL:()=>st,iJ:()=>ae,jk:()=>At,kF:()=>Je,m4:()=>ke,mx:()=>me,nM:()=>Ie,oK:()=>Pt,pU:()=>Ge,ru:()=>L,tQ:()=>ct,uG:()=>je,xl:()=>$e,xm:()=>C,yP:()=>ut});const k=1e-30,L=4294967295,Y=512,W=8,V=10,C=29,w=24,O=8,H=0,ae=1,Ie=2,ue=3,fe=4,ie=5,me=6,Je=5,ut=6,$e=1,Ge=2,et=3,ke=2,je=1,ct=1.05,Ze=5,Ne=6,gt=1.15,st=2,rt=8,We=500,pt=10,g=1024,Ut=2,Ft=0,De=1,Pt=4,Tt=8,Se=16,Ot=4,Lt=1,At=4},5254:(we,ge,T)=>{T.d(ge,{Au:()=>V,Jz:()=>E,UJ:()=>N});const B=new Float32Array(1);function V(m){return[255&m,(65280&m)>>>8,(16711680&m)>>>16,(4278190080&m)>>>24]}function N(m,S){return 65535&m|S<<16}function E(m,S,F,w){return 255&m|(255&S)<<8|(255&F)<<16|w<<24}new Uint32Array(B.buffer)},55746:(we,ge,T)=>{T.d(ge,{k:()=>V,p:()=>C});var B=T(65389),K=T(61885),M=(T(8314),T(62208)),L=T(76279),Y=T(5548),re=T(16669),Z=T(52397);function X(N,E){return N<<16|E}function $(N){return(4294901760&N)>>>16}function W(N){return 65535&N}const V={getObjectId:N=>N.getObjectId(),getAttributes:N=>N.readAttributes(),getAttribute:(N,E)=>N.readAttribute(E),cloneWithGeometry:(N,E)=>N,getGeometry:N=>N.readHydratedGeometry(),getCentroid:(N,E)=>N.readCentroid()};class C extends re.J{constructor(E,U,_){super(E,U),this.featureAdapter=V,this.events=new K.Z,this._featureSetsByInstance=new Map,this._objectIdToDisplayId=new Map,this._spatialIndexInvalid=!0,this._indexSearchCache=new B.Z(50),this._index=(0,L.r)(9,m=>({minX:this._storage.getXMin(m),minY:this._storage.getYMin(m),maxX:this._storage.getXMax(m),maxY:this._storage.getYMax(m)})),this.mode=_}get storeStatistics(){let E=0,U=0,_=0;return this.forEach(m=>{const S=m.readGeometry();S&&(U+=S.isPoint?1:S.lengths.reduce((F,w)=>F+w,0),_+=S.isPoint?1:S.lengths.length,E+=1)}),{featureCount:E,vertexCount:U,ringCount:_}}hasInstance(E){return this._featureSetsByInstance.has(E)}onTileData(E,U){if((0,M.Wi)(U.addOrUpdate))return U;if(U.addOrUpdate.attachStorage(this._storage),"snapshot"===this.mode){const m=U.addOrUpdate.getCursor();for(;m.next();){const S=m.getDisplayId();this.setComputedAttributes(this._storage,m,S,E.scale)}return U}this._featureSetsByInstance.set(U.addOrUpdate.instance,U.addOrUpdate);const _=U.addOrUpdate.getCursor();for(;_.next();)this._insertFeature(_,E.scale);return this._spatialIndexInvalid=!0,this.events.emit("changed"),U}search(E){this._rebuildIndex();const U=E.id,_=this._indexSearchCache.find(w=>w.tileId===U);if((0,M.pC)(_))return _.readers;const m=new Map,S=this._searchIndex(E.bounds),F=[];for(const w of S){const O=this._storage.getInstanceId(w),b=$(O),D=W(O);m.has(b)||m.set(b,[]),m.get(b).push(D)}return m.forEach((w,O)=>{const b=this._featureSetsByInstance.get(O);F.push(Z.t.from(b,w))}),this._indexSearchCache.enqueue({tileId:U,readers:F}),F}insert(E){const U=E.getCursor(),_=this._storage;for(;U.next();){const m=X(U.instance,U.getIndex()),S=U.getObjectId(),F=this._objectIdToDisplayId.get(S)??this._storage.createDisplayId();U.setDisplayId(F),_.setInstanceId(F,m),this._objectIdToDisplayId.set(S,F)}this._featureSetsByInstance.set(E.instance,E),this._spatialIndexInvalid=!0}remove(E){const U=this._objectIdToDisplayId.get(E);if(!U)return;const _=this._storage.getInstanceId(U),m=W(_),S=$(_),F=this._featureSetsByInstance.get(S);this._objectIdToDisplayId.delete(E),this._storage.releaseDisplayId(U),F.removeAtIndex(m),F.isEmpty&&this._featureSetsByInstance.delete(S),this._spatialIndexInvalid=!0}toArray(){const E=new Array;return this.forEach(U=>E.push(U)),E}forEach(E){this._objectIdToDisplayId.forEach(U=>{const _=this._storage.getInstanceId(U),m=this._lookupFeature(_);E(m)})}forEachUnsafe(E){this._objectIdToDisplayId.forEach(U=>{const _=this._storage.getInstanceId(U),m=$(_),S=W(_),F=this._getFeatureSet(m);F.setIndex(S),E(F)})}forEachInBounds(E,U){const _=this._searchIndex(E);for(const m of _){const S=this.lookupFeatureByDisplayId(m,this._storage);U((0,M.Wg)(S))}}forEachBounds(E,U,_){this._rebuildIndex();const m=[0,0,0,0];for(const S of E){if(!S.readGeometry())continue;const F=S.getDisplayId();m[0]=this._storage.getXMin(F),m[1]=this._storage.getYMin(F),m[2]=this._storage.getXMax(F),m[3]=this._storage.getYMax(F),U((0,Y.JR)(_,m))}}sweepFeatures(E,U,_){this._spatialIndexInvalid=!0,this._objectIdToDisplayId.forEach((m,S)=>{E.has(m)||(U.releaseDisplayId(m),_&&_.unsetAttributeData(m),this._objectIdToDisplayId.delete(S))}),this.events.emit("changed")}sweepFeatureSets(E){this._spatialIndexInvalid=!0,this._featureSetsByInstance.forEach((U,_)=>{E.has(_)||this._featureSetsByInstance.delete(_)})}lookupObjectId(E,U){const _=this.lookupFeatureByDisplayId(E,U);return(0,M.Wi)(_)?null:_.getObjectId()}lookupDisplayId(E){return this._objectIdToDisplayId.get(E)}lookupFeatureByDisplayId(E,U){const _=U.getInstanceId(E);return this._lookupFeature(_)}lookupByDisplayIdUnsafe(E){const U=this._storage.getInstanceId(E),_=$(U),m=W(U),S=this._getFeatureSet(_);return S?(S.setIndex(m),S):null}_insertFeature(E,U){const _=this._storage,m=E.getObjectId(),S=X(E.instance,E.getIndex());_.getInstanceId(E.getDisplayId());let F=this._objectIdToDisplayId.get(m);F||(F=_.createDisplayId(),this._objectIdToDisplayId.set(m,F),this._spatialIndexInvalid=!0),E.setDisplayId(F),_.setInstanceId(F,S),this.setComputedAttributes(_,E,F,U)}_searchIndex(E){return this._rebuildIndex(),this._index.search({minX:E[0],minY:E[1],maxX:E[2],maxY:E[3]})}_rebuildIndex(){if(!this._spatialIndexInvalid)return;const E=[];"snapshot"===this.mode?this._featureSetsByInstance.forEach(U=>{const _=U.getCursor();for(;_.next();){const m=_.getDisplayId();this._storage.setBounds(m,_)&&E.push(m)}}):this._objectIdToDisplayId.forEach(U=>{const _=this._storage.getInstanceId(U);this._storage.setBounds(U,this._lookupFeature(_))&&E.push(U)}),this._index.clear(),this._index.load(E),this._indexSearchCache.clear(),this._spatialIndexInvalid=!1}_lookupFeature(E){const U=$(E),_=this._getFeatureSet(U);if(!_)return null;const m=_.getCursor(),S=W(E);return m.setIndex(S),m}_getFeatureSet(E){return this._featureSetsByInstance.get(E)}}},11288:(we,ge,T)=>{T.r(ge),T.d(ge,{default:()=>Tr});var B=T(15861),K=T(17626),k=T(80542),M=T(8314),L=T(32917),Y=T(77712),X=(T(85931),T(90912),T(76898)),$=T(37053),W=T(2584),C=T(62208),N=T(10699),E=T(82054),U=T(58175),_=T(60466),m=T(55746),S=T(38305),F=T(84792),w=T(26584),O=T(63290),b=T(93662),D=T(7848),z=T(89628),q=T(20477),H=T(66385),ae=T(25208);class ue extends ae.s{constructor(a,u,h){super(a,h),this._featureIndex=-1,this._dateFields=new Set,this._geometryType=h?.geometryType,this._features=u}static fromFeatures(a,u){const{objectIdField:h,geometryType:d}=u,f=(0,E.Yn)([],a,d,!1,!1,h);for(let p=0;p<f.length;p++)f[p].displayId=a[p].displayId;return ue.fromOptimizedFeatures(f,u)}static fromFeatureSet(a,u){const h=(0,E.h_)(a,u.objectIdField);return ue.fromOptimizedFeatureSet(h,u)}static fromOptimizedFeatureSet(a,u){const{features:h}=a,d=ue.fromOptimizedFeatures(h,u);d._exceededTransferLimit=a.exceededTransferLimit,d._transform=a.transform;for(const f of a.fields)"esriFieldTypeDate"===f.type&&d._dateFields.add(f.name);return d}static fromOptimizedFeatures(a,u,h){const d=ae.s.createInstance(),f=new ue(d,a,u);return f._transform=h,f}get _current(){return this._features[this._featureIndex]}get geometryType(){return this._geometryType}get hasFeatures(){return!!this._features.length}get hasNext(){return this._featureIndex+1<this._features.length}get exceededTransferLimit(){return this._exceededTransferLimit}get hasZ(){return!1}get hasM(){return!1}removeIds(a){const u=new Set(a);this._features=this._features.filter(h=>!u.has(h.objectId))}append(a){for(const u of a)this._features.push(u)}getSize(){return this._features.length}getCursor(){return this.copy()}getQuantizationTransform(){return this._transform}getAttributeHash(){let a="";for(const u in this._current.attributes)a+=this._current.attributes[u];return a}getIndex(){return this._featureIndex}setIndex(a){this._featureIndex=a}getObjectId(){return this._current.objectId}getDisplayId(){return this._current.displayId}setDisplayId(a){this._current.displayId=a}getGroupId(){return this._current.groupId}setGroupId(a){this._current.groupId=a}copy(){const a=new ue(this.instance,this._features,this.fullSchema());return this.copyInto(a),a}next(){for(;++this._featureIndex<this._features.length&&!this._getExists(););return this._featureIndex<this._features.length}readLegacyFeature(){return(0,E.EI)(this._current,this.geometryType,this.hasZ,this.hasM)}readOptimizedFeature(){return this._current}readLegacyPointGeometry(){return this.readGeometry()?{x:this.getX(),y:this.getY()}:null}readLegacyGeometry(){const a=this.readGeometry();return(0,E.di)(a,this.geometryType,this.hasZ,this.hasM)}readLegacyCentroid(){const a=this.readCentroid();return(0,C.Wi)(a)?null:{x:a.coords[0]*this._sx+this._tx,y:a.coords[1]*this._sy+this._ty}}readGeometryArea(){return(0,H.S6)(this._current)?(0,E.lz)(this._current.geometry,2):0}readUnquantizedGeometry(){const a=this.readGeometry();if("esriGeometryPoint"===this.geometryType||!a)return a;const u=a.clone();return function Ie({coords:c,lengths:a}){let u=0;for(const h of a){for(let d=1;d<h;d++)c[2*(u+d)]+=c[2*(u+d)-2],c[2*(u+d)+1]+=c[2*(u+d)-1];u+=h}}(u),u}readHydratedGeometry(){const a=this._current.geometry;if((0,C.Wi)(a))return null;const u=a.clone();return(0,C.pC)(this._transform)&&(0,E.$g)(u,u,this.hasZ,this.hasM,this._transform),u}getXHydrated(){if(!(0,H.S6)(this._current))return 0;const a=this._current.geometry.coords[0],u=this.getQuantizationTransform();return(0,C.Wi)(u)?a:a*u.scale[0]+u.translate[0]}getYHydrated(){if(!(0,H.S6)(this._current))return 0;const a=this._current.geometry.coords[1],u=this.getQuantizationTransform();return(0,C.Wi)(u)?a:u.translate[1]-a*u.scale[1]}getX(){return(0,H.S6)(this._current)?this._current.geometry.coords[0]*this._sx+this._tx:0}getY(){return(0,H.S6)(this._current)?this._current.geometry.coords[1]*this._sy+this._ty:0}readGeometry(){if(!(0,H.S6)(this._current))return null;const a=this._current.geometry.clone();if(a.isPoint)return a.coords[0]=a.coords[0]*this._sx+this._tx,a.coords[1]=a.coords[1]*this._sy+this._ty,a;let u=0;for(const h of a.lengths)a.coords[2*u]=a.coords[2*u]*this._sx+this._tx,a.coords[2*u+1]=a.coords[2*u+1]*this._sy+this._ty,u+=h;return a}readCentroid(){if(!(0,H.S6)(this._current))return null;if((0,C.Wi)(this._current.centroid)){const u=this._computeCentroid();if((0,C.Wi)(u))return null;u.coords[0]=(u.coords[0]-this._tx)/this._sx,u.coords[1]=(u.coords[1]-this._ty)/this._sy,this._current.centroid=u}const a=this._current.centroid.clone();return a.coords[0]=a.coords[0]*this._sx+this._tx,a.coords[1]=a.coords[1]*this._sx+this._ty,a}hasField(a){return a in this._current.attributes||this.getFieldNames().map(u=>u.toLowerCase()).includes(a.toLowerCase())}getFieldNames(){return Object.keys(this._current.attributes)}_readAttribute(a,u){const h=this._current.attributes[a];if(void 0!==h)return null!=h&&u&&this._dateFields.has(a)?new Date(h):h;const d=this.readAttributes(),f=a.toLocaleLowerCase().trim();for(const p in d)if(p.toLocaleLowerCase().trim()===f){const y=this._current.attributes[p];return null!=y&&u&&this._dateFields.has(p)?new Date(y):y}}copyInto(a){super.copyInto(a),a._featureIndex=this._featureIndex,a._transform=this._transform,a._dateFields=this._dateFields}_readAttributes(){return this._current.attributes}}var fe=T(24192),ie=T(88071),me=T(71260);const Ke=268435455;class vt{constructor(){this.fieldMap=new Map,this.fields=[],this.hasFeatures=!1,this.fieldCount=0,this.featureCount=0,this.objectIdFieldIndex=0,this.vertexCount=0,this.offsets={attributes:new Array,geometry:new Array},this.centroid=new Array}hasField(a){return this.fieldMap.has(a)}isDateField(a){return this.fieldMap.get(a)?.isDate}getFieldIndex(a){return this.fieldMap.get(a)?.index}}function at(c){const h=c.getLength(),d=c.pos()+h,f={name:"",isDate:!1};for(;c.pos()<d&&c.next();)switch(c.tag()){case 1:f.name=c.getString();break;case 2:"esriFieldTypeDate"===(0,me.O7)(c.getEnum())&&(f.isDate=!0);break;default:c.skip()}return f}function Je(c){return c.toLowerCase().trim()}const xt=O.Z.getLogger("esri.view.2d.layers.features.support.FeatureSetReaderPBF"),Ge=268435455,Pe={small:{delta:new Int32Array(128),decoded:new Int32Array(128)},large:{delta:new Int32Array(128e3),decoded:new Int32Array(128e3)}};function ke(c){return c<=Pe.small.delta.length?Pe.small:(c<=Pe.large.delta.length||(Pe.large.delta=new Int32Array(Math.round(1.25*c)),Pe.large.decoded=new Int32Array(Math.round(1.25*c))),Pe.large)}function je(c){return c.toLowerCase().trim()}function dt(c){for(;c.next();){if(1===c.tag())return c.getMessage();c.skip()}return null}function ct(c,a,u,h,d,f){return.5*Math.abs(c*h+u*f+d*a-c*f-u*a-d*h)}function tt(c,a,u,h){return c*h-u*a==0&&c*u+a*h>0}class Ze extends ae.s{constructor(a,u,h,d){super(a,d),this._hasNext=!1,this._isPoints=!1,this._featureIndex=-1,this._featureOffset=0,this._cache={area:0,unquantGeometry:void 0,geometry:void 0,centroid:void 0,legacyFeature:void 0,optFeature:void 0},this._geometryType=d.geometryType,this._reader=u,this._header=h,this._hasNext=h.hasFeatures,this._isPoints="esriGeometryPoint"===d.geometryType}static fromBuffer(a,u,h=!1){const d=u.geometryType,f=function lt(c){try{const u=new fe.Z(new Uint8Array(c),new DataView(c));for(;u.next();){if(2===u.tag())return dt(u.getMessage());u.skip()}}catch(a){const u=new w.Z("query:parsing-pbf","Error while parsing FeatureSet PBF payload",{error:a});xt.error(u)}return null}(a),p=function ut(c,a,u=!1){const I=c.pos(),x=new vt;let A=0,P=0,Q=null,se=null,ee=null,ne=!1;for(;c.next();)switch(c.tag()){case 1:Q=c.getString();break;case 3:se=c.getString();break;case 12:ee=c.processMessage(me.G$);break;case 9:if(x.exceededTransferLimit=c.getBool(),x.exceededTransferLimit){x.offsets.geometry=u?new Float64Array(8e3):new Int32Array(8e3),x.centroid=u?new Float64Array(16e3):new Int32Array(16e3);for(let J=0;J<x.centroid.length;J++)x.centroid[J]=Ke}break;case 13:{const J=at(c),de=J.name,ye=Je(J.name),he={fieldName:de,index:A++,isDate:J.isDate};x.fields.push(he),x.fieldMap.set(J.name,he),x.fieldMap.set(ye,he);break}case 15:{const J=c.getLength(),de=c.pos()+J;if(!x.exceededTransferLimit){const pe=x.centroid;x.offsets.geometry.push(0),pe.push(Ke),pe.push(Ke)}!ne&&x.exceededTransferLimit&&(ne=!0,x.offsets.attributes=u?new Float64Array(8e3*A):new Uint32Array(8e3*A));let ye=P*A;for(;c.pos()<de&&c.next();)switch(c.tag()){case 1:{ne?x.offsets.attributes[ye++]=c.pos():x.offsets.attributes.push(c.pos());const he=c.getLength();c.skipLen(he);break}case 2:if(a){const he=c.getLength(),pe=c.pos()+he;for(;c.pos()<pe&&c.next();)switch(c.tag()){case 3:{c.getUInt32();const ce=c.getSInt64(),Ae=c.getSInt64();x.centroid[2*P]=ce,x.centroid[2*P+1]=Ae;break}default:c.skip()}}else{x.offsets.geometry[P]=c.pos();const he=c.getLength();x.vertexCount+=he,c.skipLen(he)}break;case 4:{const he=c.getLength(),pe=c.pos()+he;for(;c.pos()<pe&&c.next();)switch(c.tag()){case 3:{c.getUInt32();const ce=c.getSInt64(),Ae=c.getSInt64();x.centroid[2*P]=ce,x.centroid[2*P+1]=Ae;break}default:c.skip()}break}default:c.skip()}P++,x.hasFeatures=!0;break}default:c.skip()}const oe=Q||se;if(!oe)throw new w.Z("FeatureSet has no objectId or globalId field name");return x.featureCount=P,x.fieldCount=A,x.objectIdFieldIndex=x.getFieldIndex(oe),x.transform=ee,x.displayIds=new Uint32Array(x.featureCount),x.groupIds=new Uint16Array(x.featureCount),c.move(I),x}(f,"esriGeometryPoint"===d,h),y=ae.s.createInstance();return new Ze(y,f,p,u)}get geometryType(){return this._geometryType}get size(){return this._header.featureCount}get hasZ(){return!1}get hasM(){return!1}get stride(){return 2+(this.hasZ?1:0)+(this.hasM?1:0)}get hasFeatures(){return this._header.hasFeatures}get hasNext(){return this._hasNext}get exceededTransferLimit(){return this._header.exceededTransferLimit}hasField(a){return this._header.hasField(a)||this._header.hasField(je(a))}getFieldNames(){return this._header.fields.map(a=>a.fieldName)}getSize(){return this.size}getQuantizationTransform(){return this._header.transform}getCursor(){return this.copy()}getIndex(){return this._featureIndex}setIndex(a){this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0,this._featureIndex=a}getAttributeHash(){let a="";return this._header.fields.forEach(({index:u})=>{a+=this._readAttributeAtIndex(u)+"."}),a}getObjectId(){return this._readAttributeAtIndex(this._header.objectIdFieldIndex)}getDisplayId(){return this._header.displayIds[this._featureIndex]}setDisplayId(a){this._header.displayIds[this._featureIndex]=a}getGroupId(){return this._header.groupIds[this._featureIndex]}setGroupId(a){this._header.groupIds[this._featureIndex]=a}readLegacyFeature(){if(void 0===this._cache.legacyFeature){const a=this.readCentroid(),u={attributes:this.readAttributes(),geometry:this._isPoints?this.readLegacyPointGeometry():this.readLegacyGeometry(),centroid:(a&&{x:a.coords[0],y:a.coords[1]})??null};return this._cache.legacyFeature=u,u}return this._cache.legacyFeature}readOptimizedFeature(){if(void 0===this._cache.optFeature){const a=new H.u_(this.readGeometry(),this.readAttributes(),this.readCentroid());return a.objectId=this.getObjectId(),a.displayId=this.getDisplayId(),this._cache.optFeature=a,a}return this._cache.optFeature}getXHydrated(){const a=this._header.centroid[2*this._featureIndex],u=this.getQuantizationTransform();return(0,C.Wi)(u)?a:a*u.scale[0]+u.translate[0]}getYHydrated(){const a=this._header.centroid[2*this._featureIndex+1],u=this.getQuantizationTransform();return(0,C.Wi)(u)?a:u.translate[1]-a*u.scale[1]}getX(){return this._header.centroid[2*this._featureIndex]*this._sx+this._tx}getY(){return this._header.centroid[2*this._featureIndex+1]*this._sy+this._ty}readLegacyPointGeometry(){return{x:this.getX(),y:this.getY()}}readLegacyGeometry(a){const u=this.readGeometry(a);return(0,E.di)(u,this.geometryType,!1,!1)}readLegacyCentroid(){const a=this.readCentroid();if(!a)return null;const[u,h]=a.coords;return{x:u,y:h}}readGeometryArea(){return this._cache.area||this.readGeometry(!0),this._cache.area}readUnquantizedGeometry(a=!1){if(void 0===this._cache.unquantGeometry){const u=this.readGeometry(a);if(!u)return this._cache.unquantGeometry=null,null;const h=ke(u.coords.length).decoded,d=u.clone(h),f=d.coords;let p=0;for(const y of d.lengths){for(let v=1;v<y;v++){const I=2*(p+v),x=2*(p+v-1);f[I]+=f[x],f[I+1]+=f[x+1]}p+=y}return this._cache.unquantGeometry=d,d}return this._cache.unquantGeometry}readHydratedGeometry(){if(this._isPoints){if(this._header.centroid[2*this._featureIndex]===Ge)return null;const d=this.getXHydrated(),f=this.getYHydrated();return new ie.Z([],[d,f])}const a=this.readGeometry();if(!a)return null;const u=a.clone(),h=this.getQuantizationTransform();return(0,C.pC)(h)&&(0,E.$g)(u,u,this.hasZ,this.hasM,h),u}readGeometry(a=!1){if(void 0===this._cache.geometry){let u=null;if(this._isPoints){if(this._header.centroid[2*this._featureIndex]===Ge)return null;const h=this.getX(),d=this.getY();u=new ie.Z([],[h,d])}else{const h=this._header.offsets.geometry[this._featureIndex],d=this._reader;if(0===h)return null;d.move(h);try{u=a?this._parseGeometryForDisplay(d):this._parseGeometry(d)}catch(f){return console.error("Failed to parse geometry!",f),null}}return this._cache.geometry=u,u}return this._cache.geometry}readCentroid(){if(void 0===this._cache.centroid){let a=null;const u=this._header.centroid[2*this._featureIndex]+this._tx,h=this._header.centroid[2*this._featureIndex+1]+this._ty;return u===Ge?(a=this._computeCentroid(),a&&(this._header.centroid[2*this._featureIndex]=a.coords[0]-this._tx,this._header.centroid[2*this._featureIndex+1]=a.coords[1]-this._ty)):a=new ie.Z([],[u,h]),this._cache.centroid=a,a}return this._cache.centroid}copy(){const a=this._reader.clone(),u=new Ze(this.instance,a,this._header,this.fullSchema());return this.copyInto(u),u}next(){for(this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0;++this._featureIndex<this.size&&!this._getExists(););return this._featureIndex<this.size}_readAttribute(a,u){const h=this._header.hasField(a)?a:je(a),d=this._header.getFieldIndex(h);if(null==d)return;const f=this._readAttributeAtIndex(d);return u&&null!=f&&this._header.isDateField(h)?new Date(f):f}_readAttributes(){const a={};return this._header.fields.forEach(({fieldName:u,index:h})=>{a[u]=this._readAttributeAtIndex(h)}),a}copyInto(a){super.copyInto(a),a._featureIndex=this._featureIndex,a._featureOffset=this._featureOffset,a._hasNext=this._hasNext}_readAttributeAtIndex(a){const h=this._reader;return h.move(this._header.offsets.attributes[this._featureIndex*this._header.fieldCount+a]),function St(c){const x=c.getLength(),A=c.pos()+x;for(;c.pos()<A&&c.next();)switch(c.tag()){case 1:return c.getString();case 2:return c.getFloat();case 3:return c.getDouble();case 4:return c.getSInt32();case 5:return c.getUInt32();case 6:return c.getInt64();case 7:return c.getUInt64();case 8:return c.getSInt64();case 9:return c.getBool();default:return c.skip(),null}return null}(h)}_parseGeometry(a){const d=a.getLength(),f=a.pos()+d,p=[],y=[];for(;a.pos()<f&&a.next();)switch(a.tag()){case 2:{const v=a.getUInt32(),I=a.pos()+v;for(;a.pos()<I;)y.push(a.getUInt32());break}case 3:{const v=a.getUInt32(),I=a.pos()+v;for(p.push(a.getSInt32()+this._tx),p.push(a.getSInt32()+this._ty),this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32();a.pos()<I;)p.push(a.getSInt32()),p.push(a.getSInt32()),this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32();break}default:a.skip()}return new ie.Z(y,p)}_parseGeometryForDisplay(a){const d=a.getLength(),f=a.pos()+d,p=[],y=[];let v=0,I=0,x=null,A=0;const P="esriGeometryPolygon"===this.geometryType;for(;a.pos()<f&&a.next();)switch(a.tag()){case 2:{const R=a.getUInt32(),G=a.pos()+R;for(;a.pos()<G;){const j=a.getUInt32();p.push(j),v+=j}x=ke(2*v).delta;break}case 3:{a.getUInt32();const R=2+(this.hasZ?1:0)+(this.hasM?1:0);for(const G of p)if(I+R*G>x.length)for(let j=0;j<G;j++)a.getSInt32(),a.getSInt32(),this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32();else if(P){const j=this.getAreaSimplificationThreshold(G,this._header.vertexCount);let te=2,Q=1;const se=!1;let ee=a.getSInt32(),ne=a.getSInt32();x[I++]=ee,x[I++]=ne,this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32();let oe=a.getSInt32(),J=a.getSInt32();for(this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32();te<G;){let de=a.getSInt32(),ye=a.getSInt32();this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32();const he=ee+oe,pe=ne+J;ct(ee,ne,he,pe,he+de,pe+ye)>=j?(A+=-.5*(he-ee)*(pe+ne),Q>1&&tt(x[I-2],x[I-1],oe,J)?(x[I-2]+=oe,x[I-1]+=J):(x[I++]=oe,x[I++]=J,Q++),ee=he,ne=pe):(de+=oe,ye+=J),oe=de,J=ye,te++}Q<3||se?I-=2*Q:(A+=-.5*(ee+oe-ee)*(ne+J+ne),tt(x[I-2],x[I-1],oe,J)?(x[I-2]+=oe,x[I-1]+=J,y.push(Q)):(x[I++]=oe,x[I++]=J,y.push(++Q)))}else{let j=0,te=a.getSInt32(),Q=a.getSInt32();this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32(),x[I++]=te,x[I++]=Q,j+=1;for(let se=1;se<G;se++){const ee=a.getSInt32(),ne=a.getSInt32(),oe=te+ee,J=Q+ne;A+=-.5*(oe-te)*(J+Q),this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32(),se>2&&tt(x[I-2],x[I-1],ee,ne)?(x[I-2]+=ee,x[I-1]+=ne):(x[I++]=ee,x[I++]=ne,j+=1),te=oe,Q=J}y.push(j)}break}default:a.skip()}if(this._cache.area=A,!y.length)return null;if(this._tx||this._ty){let R=0;for(const G of y)x[2*R]+=this._tx,x[2*R+1]+=this._ty,R+=G}return new ie.Z(y,x)}}class Ne{constructor(a){this.service=a}destroy(){}}function We(){return(We=(0,B.Z)(function*(c){const a=new b.Z;return yield a.open(c,{}),a})).apply(this,arguments)}class ft extends Ne{constructor(a){super(a),this._portsOpen=function rt(c){return We.apply(this,arguments)}(a.source).then(u=>this.client=u)}destroy(){this.client.close(),this.client=null}executeQuery(a,u){var h=this;return(0,B.Z)(function*(){yield h._portsOpen;const d=yield h.client.invoke("queryFeatures",a.toJSON(),u);return ue.fromFeatureSet(d,h.service)})()}}class Ct extends Ne{executeQuery(a,u){var h=this;return(0,B.Z)(function*(){const{data:d}=yield(0,q.executeQueryPBFBuffer)(h.service.source,a,u);return Ze.fromBuffer(d,h.service,!a.quantizationParameters)})()}}class pt extends Ne{executeQuery(a,u){var h=this;return(0,B.Z)(function*(){const{source:d,capabilities:f,spatialReference:p,objectIdField:y,geometryType:v}=h.service;if((0,C.pC)(a.quantizationParameters)&&!f.query.supportsQuantization){const x=a.clone(),A=(0,D.vY)((0,C.Wg)(x.quantizationParameters));x.quantizationParameters=null;const{data:P}=yield(0,q.executeQuery)(d,x,p,u),R=(0,E.h_)(P,y);return(0,E.RZ)(A,R),ue.fromOptimizedFeatureSet(R,h.service)}const{data:I}=yield(0,q.executeQuery)(d,a,h.service.spatialReference,u);return"esriGeometryPoint"===v&&(I.features=I.features?.filter(x=>{if((0,C.pC)(x.geometry)){const A=x.geometry;return Number.isFinite(A.x)&&Number.isFinite(A.y)}return!0})),ue.fromFeatureSet(I,h.service)})()}}class g extends Ne{executeQuery(a,u){var h=this;return(0,B.Z)(function*(){const{capabilities:d}=h.service;if(a.quantizationParameters&&!d.query.supportsQuantization){const p=a.clone(),y=(0,D.vY)((0,C.Wg)(p.quantizationParameters));p.quantizationParameters=null;const v=yield(0,z.WW)(h.service.source,a,u);return(0,E.RZ)(y,v),ue.fromOptimizedFeatureSet(v,h.service)}const f=yield(0,z.WW)(h.service.source,a,u);return ue.fromOptimizedFeatureSet(f,h.service)})()}}var Ut=T(97478),Ft=T(61885),De=T(84682),Pt=T(84952),Tt=T(65389);class Se{constructor(){this.version=0,this.source=!1,this.targets={feature:!1,aggregate:!1},this.storage={filters:!1,data:!1},this.mesh=!1,this.queryFilter=!1,this.why={mesh:[],source:[]}}static create(a){const u=new Se;for(const h in a){const d=a[h];if("object"==typeof d)for(const f in d)u[h][f]=d[f];u[h]=d}return u}static empty(){return Se.create({})}static all(){return Se.create({source:!0,targets:{feature:!0,aggregate:!0},storage:{filters:!0,data:!0},mesh:!0})}unset(a){this.version=a.version,a.source&&(this.source=!1),a.targets.feature&&(this.targets.feature=!1),a.targets.aggregate&&(this.targets.aggregate=!1),a.storage.filters&&(this.storage.filters=!1),a.storage.data&&(this.storage.data=!1),a.mesh&&(this.mesh=!1),a.queryFilter&&(this.queryFilter=!1)}any(){return this.source||this.mesh||this.storage.filters||this.storage.data||this.targets.feature||this.targets.aggregate||this.queryFilter}describe(){let a=0,u="";if(this.mesh){a+=20,u+="-> (20) Mesh needs update\n";for(const d of this.why.mesh)u+=`    + ${d}\n`}if(this.source){a+=10,u+="-> (10) The source needs update\n";for(const d of this.why.source)u+=`    + ${d}\n`}this.targets.feature&&(a+=5,u+="-> (5) Feature target parameters changed\n"),this.storage.filters&&(a+=5,u+="-> (5) Feature filter parameters changed\n"),this.targets.aggregate&&(a+=4,u+="-> (4) Aggregate target parameters changed\n"),this.storage.data&&(a+=1,u+="-> (1) Texture storage parameters changed"),console.debug(`Applying ${a<5?"Fastest":a<10?"Fast":a<15?"Moderate":a<20?"Slow":"Very Slow"} update of cost ${a}/45 `),console.debug(u)}toJSON(){return{queryFilter:this.queryFilter,source:this.source,targets:this.targets,storage:this.storage,mesh:this.mesh}}}class Ot{constructor(a,u){this.requests={done:new Array,stream:new Tt.Z(10)},this._edits=null,this._abortController=new AbortController,this._version=0,this._done=!1,this.didSend=!1,this.tile=a,this._version=u}get signal(){return this._abortController.signal}get options(){return{signal:this._abortController.signal}}get empty(){return!this.requests.done.length}get edits(){return this._edits}get done(){return this._done}end(){this._done=!0}clear(){this.requests.done=[]}applyUpdate(a){this.requests.done.forEach(u=>u.message.status.unset(a)),this._version=a.version,(0,C.pC)(this._edits)&&this._edits.status.unset(a)}add(a){a.message.status=a.message.status??Se.empty(),a.message.status.version=this._version,(0,M.Z)("esri-2d-update-debug")&&console.debug(this.tile.id,"DataTileSubscription:add",this._version),a.message.end&&this.requests.done.forEach(u=>{(0,C.pC)(u.message)&&u.message.end&&(u.message.end=!1)}),this.requests.done.push(a)}edit(a,u){const h=a.getQuantizationTransform(),d=a.fullSchema(),f=Array.from(a.features()),p=[...u,...f.map(y=>y.objectId)];this.removeIds(p),this._invalidate(),(0,C.Wi)(this._edits)?this._edits={type:"append",addOrUpdate:ue.fromOptimizedFeatures(f,d,(0,C.Wg)(h)),id:this.tile.id,status:Se.empty(),end:!0}:(this.requests.done.forEach(y=>y.message.end=!1),(0,C.Wg)(this._edits.addOrUpdate).append(a.features()))}*readers(){for(const{message:a}of this.requests.done)(0,C.pC)(a.addOrUpdate)&&(yield a.addOrUpdate);(0,C.pC)(this._edits)&&(0,C.pC)(this._edits.addOrUpdate)&&(yield this._edits.addOrUpdate)}_invalidate(){for(const a of this.requests.done)a.message.status=Se.empty();(0,C.pC)(this._edits)&&(this._edits.status=Se.empty())}removeIds(a){this._invalidate();for(const{message:u}of this.requests.done){const h=u.addOrUpdate;(0,C.pC)(h)&&(h.removeIds(a),h.isEmpty&&(u.addOrUpdate=null))}(0,C.pC)(this._edits)&&(0,C.pC)(this._edits.addOrUpdate)&&this._edits.addOrUpdate.removeIds(a),this.requests.done=this.requests.done.filter(u=>u.message.addOrUpdate||u.message.end)}abort(){this._abortController.abort()}}class At{constructor(a){this.events=new Ft.Z,this._resolver=(0,N.hh)(),this._didEdit=!1,this._subscriptions=new Map,this._outSR=a.outSR,this._serviceInfo=a.serviceInfo,this._onTileUpdateMessage=a.onMessage}destroy(){}_onMessage(a){var u=this;return(0,B.Z)(function*(){const h=u._subscriptions.get(a.id);if(!h)return;const d={...a,remove:a.remove??[],status:a.status??Se.empty()};return(0,N.R8)(u._onTileUpdateMessage(d,h.options))})()}update(a,u){const h=u.fields.length;u.outFields=function Lt(c,a){const u=new Set;return c&&c.forEach(h=>u.add(h)),a&&a.forEach(h=>u.add(h)),u.has("*")?["*"]:Array.from(u)}(this._schema?.outFields,u.outFields),u.outFields=u.outFields.length>=.75*h?["*"]:u.outFields,u.outFields.sort();const d=(0,De.Hg)(this._schema,u);if(!d)return;(0,M.Z)("esri-2d-update-debug")&&console.debug("Applying Update - Source:",d);const f="orderByFields"in this._serviceInfo&&this._serviceInfo.orderByFields?this._serviceInfo.orderByFields:this._serviceInfo.objectIdField+" ASC",p={returnCentroid:(0,M.Z)("esri-2d-query-centroid-enabled")&&"esriGeometryPolygon"===this._serviceInfo.geometryType,returnGeometry:!0,timeReferenceUnknownClient:"stream"!==this._serviceInfo.type&&this._serviceInfo.timeReferenceUnknownClient,outFields:u.outFields,outSpatialReference:this._outSR,orderByFields:[f],where:u.definitionExpression||"1=1",gdbVersion:u.gdbVersion,historicMoment:u.historicMoment,timeExtent:Ut.Z.fromJSON(u.timeExtent)},y=this._schema&&(0,De.uD)(d,"outFields");this._schema&&(0,De.V7)(d,["timeExtent","definitionExpression","gdbVersion","historicMoment","customParameters"])&&(a.why.mesh.push("Layer filter and/or custom parameters changed"),a.why.source.push("Layer filter and/or custom parameters changed"),a.mesh=!0,a.source=!0,a.queryFilter=!0),y&&(a.why.source.push("Layer required fields changed"),a.source=!0),(0,De.Hg)(p,this._queryInfo)&&(this._queryInfo=p),this._schema=u,this._resolver.resolve()}whenInitialized(){return this._resolver.promise}applyUpdate(a){var u=this;return(0,B.Z)(function*(){if(a.queryFilter||a.source&&u._didEdit)return u.refresh(a.version),void(u._didEdit=!1);u._subscriptions.forEach(h=>h.applyUpdate(a)),yield u.resend()})()}refresh(a){for(const u of this._tiles())this.unsubscribe(u),this.subscribe(u,a)}subscribe(a,u){const h=new Ot(a,u);this._subscriptions.set(a.id,h)}unsubscribe(a){const u=this.get(a.id);(0,C.pC)(u)&&u.abort(),this._subscriptions.delete(a.id)}createQuery(a={}){const u=this._queryInfo.historicMoment?new Date(this._queryInfo.historicMoment):null;return new Pt.Z({...this._queryInfo,historicMoment:u,...a})}get(a){return this._subscriptions.has(a)?this._subscriptions.get(a):null}queryLastEditDate(){return(0,B.Z)(function*(){throw new Error("Service does not support query type")})()}query(a){return(0,B.Z)(function*(){throw new Error("Service does not support query")})()}*_tiles(){const a=Array.from(this._subscriptions.values());for(const u of a)yield u.tile}edit(a,u){var h=this;return(0,B.Z)(function*(){const d=Array.from(h._subscriptions.values()),f=d.map(({tile:p})=>p);for(const p of d)p.removeIds(u);if(a.length){const p=f.map(v=>{const I=h.createTileQuery(v);return I.objectIds=a,{tile:v,query:I}}).map(function(){var v=(0,B.Z)(function*({tile:I,query:x}){return{tile:I,result:yield h.query(x),query:x}});return function(I){return v.apply(this,arguments)}}()),y=(yield(0,N.WW)(p)).map(function(){var v=(0,B.Z)(function*({tile:I,result:x}){if(!x.hasFeatures&&!u.length&&!a.length)return;const A=h._subscriptions.get(I.key.id);A&&A.edit(x,a)});return function(I){return v.apply(this,arguments)}}());yield(0,N.as)(y)}h._didEdit=!0})()}}var zt=T(71251);const Ss=O.Z.getLogger("esri.views.2d.layers.features.sources.BaseFeatureSource");class Zt extends At{constructor(a){var u,h;super(a),u=this,this.type="feature",this.mode="on-demand",this._adapter=function st(c){const{capabilities:a}=c;return function bt(c){return c&&c.capabilities&&c.collection&&c.layerDefinition}(c.source)?new g(c):function gt(c){return Array.isArray(c.source)}(c)?new ft(c):a.query.supportsFormatPBF&&(0,M.Z)("featurelayer-pbf")?new Ct(c):new pt(c)}(a.serviceInfo),this._queue=new zt.e({concurrency:8,process:(h=(0,B.Z)(function*(d){if((0,N.k_)(d),(0,C.pC)(d.tile)){const f=d.tile.key.id,{signal:p}=d,y=(0,M.Z)("esri-tiles-debug")?{tile:f.replace(/\//g,"."),depth:d.depth}:void 0,v=yield u._adapter.executeQuery(d.query,{signal:p,query:{...y,...u._schema.customParameters}});return v.level=d.tile.key.level,v}return u._adapter.executeQuery(d.query,{...d,query:u._schema.customParameters})}),function(f){return h.apply(this,arguments)})}),this._patchQueue=new zt.e({concurrency:8,process:function(){var h=(0,B.Z)(function*(d){if((0,N.k_)(d),(0,C.pC)(d.tile)){const f=d.tile.key.id,{signal:p}=d,y=(0,M.Z)("esri-tiles-debug")?{tile:f.replace(/\//g,"."),depth:d.depth}:void 0,v=yield u._adapter.executeQuery(d.query,{signal:p,query:{...y,...u._schema.customParameters}});return v.level=d.tile.key.level,v}return u._adapter.executeQuery(d.query,{...d,query:u._schema.customParameters})});return function(f){return h.apply(this,arguments)}}()})}destroy(){super.destroy(),this._adapter.destroy(),this._queue.destroy(),this._patchQueue.destroy()}get updating(){return!!this._queue.length||Array.from(this._subscriptions.values()).some(a=>!a.done)}get maxRecordCountFactor(){const{query:a}=this._serviceInfo.capabilities;return a.supportsMaxRecordCountFactor?4:null}get maxPageSize(){const{query:a}=this._serviceInfo.capabilities;return(a.maxRecordCount??8e3)*(0,C.Pt)(this.maxRecordCountFactor,1)}get pageSize(){return Math.min(8e3,this.maxPageSize)}enableEvent(a,u){}subscribe(a,u){super.subscribe(a,u);const h=this._subscriptions.get(a.id);this._fetchDataTile(a).catch(d=>{(0,N.D_)(d)||Ss.error(new w.Z("mapview-query-error","Encountered error when fetching tile",{tile:a,error:d}))}).then(()=>h.end())}unsubscribe(a){super.unsubscribe(a)}readers(a){return this._subscriptions.get(a).readers()}query(a){var u=this;return(0,B.Z)(function*(){return u._adapter.executeQuery(a,{query:u._schema.customParameters})})()}queryLastEditDate(){var a=this;return(0,B.Z)(function*(){const u=a._serviceInfo.source,h={...u.query,f:"json"};return(yield(0,F.default)(u.path,{query:h,responseType:"json"})).data.editingInfo.lastEditDate})()}createTileQuery(a,u={}){const h=this._serviceInfo.geometryType,d=this.createQuery(u);d.quantizationParameters=u.quantizationParameters??a.getQuantizationParameters(),d.resultType="tile",d.geometry=a.extent,this._serviceInfo.capabilities.query.supportsQuantization?"esriGeometryPolyline"===h&&(d.maxAllowableOffset=a.resolution*(0,M.Z)("feature-polyline-generalization-factor")):"esriGeometryPolyline"!==h&&"esriGeometryPolygon"!==h||(d.maxAllowableOffset=a.resolution,"esriGeometryPolyline"===h&&(d.maxAllowableOffset*=(0,M.Z)("feature-polyline-generalization-factor")));const f=this._serviceInfo.capabilities.query;return d.defaultSpatialReferenceEnabled=f.supportsDefaultSpatialReference,d.compactGeometryEnabled=f.supportsCompactGeometry,d}_executePatchQuery(a,u,h,d){var f=this;return(0,B.Z)(function*(){const p=u.clone();p.outFields=[f._serviceInfo.objectIdField,...h],p.returnCentroid=!1,p.returnGeometry=!1;const y=(0,C.pC)(p.start)?p.start/8e3:0;return f._patchQueue.push({tile:a,query:p,signal:d.signal,depth:y})})()}_resend(a,u){var h=this;return(0,B.Z)(function*(){const{query:d,message:f}=a,p=(0,C.pC)(d.outFields)?d.outFields:[],y=h._queryInfo.outFields,v=y.filter(I=>!p.includes(I));if((0,C.Wi)(f.addOrUpdate))h._onMessage({...f,type:"append"});else if(v.length)try{const I=h._subscriptions.get(f.id).tile,x=yield h._executePatchQuery(I,d,v,u);(0,N.k_)(u),d.outFields=y,f.addOrUpdate.joinAttributes(x),h._onMessage({...f,end:f.end,type:"append"})}catch{}else h._onMessage({...f,type:"append"})})()}_resendSubscription(a){var u=this;return(0,B.Z)(function*(){if((0,M.Z)("esri-2d-update-debug")&&console.debug(a.tile.id,"Resend Subscription"),a.empty)return u._onMessage({id:a.tile.id,addOrUpdate:null,end:!1,type:"append"});const h=a.signal;for(const d of a.requests.done)yield u._resend(d,{signal:h});return(0,C.pC)(a.edits)?u._onMessage(a.edits):void 0})()}resend(){var a=this;return(0,B.Z)(function*(){const u=Array.from(a._subscriptions.values());yield Promise.all(u.map(h=>a._resendSubscription(h)))})()}}const Ht=(0,M.Z)("esri-mobile"),Kt={maxDrillLevel:Ht?1:4,maxRecordCountFactor:Ht?1:3};class Cs extends Zt{constructor(a){super(a)}_fetchDataTile(a){var u=this;return(0,B.Z)(function*(){const h=u._serviceInfo.capabilities.query.supportsMaxRecordCountFactor,d=u._subscriptions.get(a.key.id),f=d.signal,p=a.getQuantizationParameters();let y=0;const v=function(){var I=(0,B.Z)(function*(x,A){const P=u._queryInfo,R=u.createTileQuery(x,{maxRecordCountFactor:h?Kt.maxRecordCountFactor:void 0,returnExceededLimitFeatures:!1,quantizationParameters:p});y++;try{const G=yield u._queue.push({tile:a,query:R,signal:f,depth:A});if(y--,(0,N.k_)(f),!G)return;if(P!==u._queryInfo)return void v(x,A);if(G.exceededTransferLimit&&A<Kt.maxDrillLevel){for(const te of x.createChildTiles())v(te,A+1);return}const j={id:a.id,addOrUpdate:G,end:0===y,type:"append"};d.add({query:R,message:j}),u._onMessage(j)}catch(G){(0,N.D_)(G)||u._onMessage({id:a.id,addOrUpdate:null,end:!0,type:"append"})}});return function(A,P){return I.apply(this,arguments)}}();v(a,0)})()}}var Jt=T(76279),Fs=T(5075),Ms=T(16147);function As(c,a){const u=c.weakClone();if((0,C.pC)(c.geometry)){const h=(0,E.Jd)(a,c.geometry.coords[0]),d=(0,E.IN)(a,c.geometry.coords[1]);u.geometry=new ie.Z([],[h,d])}return u}class Bs{constructor(a,u){this.onUpdate=a,this._geometryType=u,this._objectIdToFeature=new Map}get _features(){const a=[];return this._objectIdToFeature.forEach(u=>a.push(u)),a}add(a){this._objectIdToFeature.set(a.objectId,a),this._index=null}get(a){return this._objectIdToFeature.has(a)?this._objectIdToFeature.get(a):null}forEach(a){this._objectIdToFeature.forEach(a)}search(a){return this._index||(this._index=function Rs(c,a){const u=(0,Jt.r)(9,function ws(c){return"esriGeometryPoint"===c?a=>(0,C.pC)(a.geometry)?{minX:a.geometry.coords[0],minY:a.geometry.coords[1],maxX:a.geometry.coords[0],maxY:a.geometry.coords[1]}:{minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}:a=>{let u=1/0,h=1/0,d=-1/0,f=-1/0;return(0,C.pC)(a.geometry)&&a.geometry.forEachVertex((p,y)=>{u=Math.min(u,p),h=Math.min(h,y),d=Math.max(d,p),f=Math.max(f,y)}),{minX:u,minY:h,maxX:d,maxY:f}}}(a));return u.load(c),u}(this._features,this._geometryType)),function Ds(c,a){return c.search({minX:a.bounds[0],minY:a.bounds[1],maxX:a.bounds[2],maxY:a.bounds[3]})}(this._index,a)}removeById(a){const u=this._objectIdToFeature.get(a);return u?(this._objectIdToFeature.delete(a),this._index=null,u):null}update(a,u){this.onUpdate(a,u)}get size(){return this._objectIdToFeature.size}}class Us extends At{constructor(a){super(a),this.type="geoevent",this._dataReceiveEventEnabled=!1,this._level=0,this._updateInfo={websocket:0,client:0};const{outSR:u}=a,{geometryType:h,objectIdField:d,timeInfo:f,purgeOptions:p,source:y,spatialReference:v,serviceFilter:I,maxReconnectionAttempts:x,maxReconnectionInterval:A,updateInterval:P,enableDataReceived:R,customParameters:G}=a.serviceInfo,j=new Bs(this._onUpdate.bind(this),h),te=new Fs.Qo(j,d,f,p),Q=(0,Ms.I)(y,v,u,h,I,x,A,G);this._store=j,this._manager=te,this._connection=Q,this._quantize=function Es(c){return"esriGeometryPoint"===c?As:(a,u)=>{const h=a.weakClone(),d=new ie.Z,y=(0,E.Nh)(d,a.geometry,!1,!1,c,u,!1,!1);return h.geometry=y,h}}(h),this._dataReceiveEventEnabled=R,this._handles=[this._connection.on("feature",se=>this._onFeature(se)),(0,L.YP)(()=>Q.connectionStatus,se=>this.events.emit("connectionStatus",se)),(0,L.YP)(()=>Q.errorString,se=>this.events.emit("errorString",se))],this._initUpdateInterval=()=>{let se=performance.now();this._updateIntervalId=setInterval(()=>{const ee=performance.now(),ne=ee-se;if(ne>2500){se=ee;const oe=Math.round(this._updateInfo.client/(ne/1e3)),J=Math.round(this._updateInfo.websocket/(ne/1e3));this._updateInfo.client=0,this._updateInfo.websocket=0,this.events.emit("updateRate",{client:oe,websocket:J})}a.canAcceptRequest()&&this._manager.checkForUpdates()},P)},this._initUpdateInterval()}destroy(){super.destroy(),this._clearUpdateInterval(),this._handles.forEach(a=>a.remove()),this._connection.destroy()}_fetchDataTile(){}pauseStream(){this._clearUpdateInterval()}resumeStream(){this._initUpdateInterval()}enableEvent(a,u){"data-received"===a&&(this._dataReceiveEventEnabled=u)}get updating(){return!1}subscribe(a,u){super.subscribe(a,u);const h=this._subscriptions.get(a.id);this._level=a.level;const d=this._getTileFeatures(a);this._onMessage({type:"append",id:a.key.id,addOrUpdate:d,end:!0}),h.didSend=!0}unsubscribe(a){super.unsubscribe(a)}*readers(a){const u=this._subscriptions.get(a),{tile:h}=u;yield this._getTileFeatures(h);for(const d of u.requests.stream.entries)(0,C.pC)(d)&&(0,C.pC)(d.addOrUpdate)&&(yield d.addOrUpdate)}createTileQuery(a){throw new Error("Service does not support tile  queries")}resend(){var a=this;return(0,B.Z)(function*(){a._subscriptions.forEach(u=>{const{tile:h}=u,d={type:"append",id:h.id,addOrUpdate:a._getTileFeatures(h),end:!0};a._onMessage(d)})})()}_getTileFeatures(a){const u=this._store.search(a).map(h=>this._quantize(h,a.transform));return ue.fromOptimizedFeatures(u,this._serviceInfo,a.transform)}_onFeature(a){this._updateInfo.websocket++;try{this._dataReceiveEventEnabled&&this.events.emit("feature",a);const u=(0,E.XA)(a,this._serviceInfo.geometryType,!1,!1,this._serviceInfo.objectIdField);this._manager.add(u)}catch{}}_clearUpdateInterval(){clearInterval(this._updateIntervalId),this._updateIntervalId=0}_onUpdate(a,u){(0,C.pC)(a)&&(this._updateInfo.client+=a.length),this._subscriptions.forEach((h,d)=>{h.didSend&&h.tile.level===this._level&&this._onMessage({type:"append",id:d,addOrUpdate:null,clear:!0,end:!1})}),this._subscriptions.forEach((h,d)=>{if(!h.didSend||h.tile.level!==this._level)return;const p={type:"append",id:d,addOrUpdate:this._getTileFeatures(h.tile),remove:[],end:!0,status:Se.empty()};h.requests.stream.enqueue(p),this._onMessage(p)})}}const Ps=O.Z.getLogger("esri.views.2d.layers.features.sources.FeatureSource");class Os extends Zt{constructor(a){super(a)}_fetchDataTile(a){var u=this;return(0,B.Z)(function*(){const f=u._subscriptions.get(a.key.id);let p=!1,y=0,v=0;const I=(P,R)=>{v--,(0,N.k_)(f);const G=a.id,j=P.reader,te=P.query;if(!j.exceededTransferLimit){if(p=!0,0!==R&&!j.hasFeatures){const ee={id:G,addOrUpdate:j,end:0===v,type:"append"};return f.add({message:ee,query:te}),void u._onMessage(ee)}const se={id:G,addOrUpdate:j,end:0===v,type:"append"};return f.add({message:se,query:te}),void u._onMessage(se)}const Q={id:G,addOrUpdate:j,end:p&&0===v,type:"append"};f.add({message:Q,query:te}),u._onMessage(Q)};let x=0,A=0;for(;!p&&A++<20;){let P;for(let R=0;R<x+1;R++){const G=y++;v++,P=u._fetchDataTilePage(a,G,f).then(j=>j&&I(j,G)).catch(j=>{p=!0,(0,N.D_)(j)||(Ps.error(new w.Z("mapview-query-error","Encountered error when fetching tile",{tile:a,error:j})),u._onMessage({id:a.id,addOrUpdate:null,end:p,type:"append"}))})}yield P,(0,N.k_)(f),x=Math.min(x+2,6)}})()}_fetchDataTilePage(a,u,h){var d=this;return(0,B.Z)(function*(){(0,N.k_)(h);const f=d._queryInfo,p={start:d.pageSize*u,num:d.pageSize,returnExceededLimitFeatures:!0,quantizationParameters:a.getQuantizationParameters()};(0,C.pC)(d.maxRecordCountFactor)&&(p.maxRecordCountFactor=d.maxRecordCountFactor);const y=d.createTileQuery(a,p);try{const v=h.signal,I=yield d._queue.push({tile:a,query:y,signal:v,depth:u});return(0,N.k_)(h),I?f!==d._queryInfo?d._fetchDataTilePage(a,u,h):{reader:I,query:y}:null}catch(v){return(0,N.H9)(v),null}})()}}var Ls=T(4619),zs=T(52397);const Zs=O.Z.getLogger("esri.views.2d.layers.features.sources.SnapshotFeatureSource");function Ns(c,a,u){const h=c.getXHydrated(),d=c.getYHydrated(),f=a.getColumnForX(h),p=Math.floor(a.normalizeCol(f));return`${u}/${Math.floor(a.getRowForY(d))}/${p}`}function Nt(c,a){if((0,C.Wi)(c))return null;const u=a.transform,h=c.getQuantizationTransform();if((0,C.Wi)(h)){const[te,Q]=u.scale,[se,ee]=u.translate;return c.transform(-se/te,ee/Q,1/te,1/-Q)}const[d,f]=h.scale,[p,y]=h.translate,[v,I]=u.scale,[x,A]=u.translate;return c.transform((p-x)/v,(-y+A)/I,d/v,f/I)}class Gs extends Zt{constructor(a){super(a),this.mode="snapshot",this._loading=!0,this._controller=new AbortController,this._downloadPromise=null,this._didSendEnd=!1,this._queries=new Array,this._invalidated=!1,this._hasAggregates=!1,this._random=new Ls.Z(1e3),this._store=a.store,this._markedIdsBufId=this._store.storage.createBitset()}destroy(){super.destroy(),this._controller.abort()}get loading(){return this._loading}get _signal(){return this._controller.signal}update(a,u){super.update(a,u),this._hasAggregates=a.targets.aggregate}resend(a=!1){var u=this;return(0,B.Z)(function*(){if(yield u._downloadPromise,u._invalidated||a){const d=(0,C.s3)(u._schema.featureCount,"Expected featureCount to be defined");return u._invalidated=!1,u._subscriptions.forEach(f=>f.clear()),u._downloadPromise=u._download(d),void(yield u._downloadPromise)}const h=u._queries.map(({query:d,reader:f})=>u._sendPatchQuery(d,f));yield Promise.all(h),u._subscriptions.forEach(d=>{d.requests.done.forEach(f=>u._onMessage(f.message))})})()}refresh(){var a=this;return(0,B.Z)(function*(){yield a.resend(!0)})()}_sendPatchQuery(a,u){var h=this;return(0,B.Z)(function*(){const d=(0,C.pC)(a.outFields)?a.outFields:[],f=h._queryInfo.outFields,p=f.filter(x=>!d.includes(x));if(!p.length)return;const y=a.clone(),v=h._signal;y.returnGeometry=!1,y.returnCentroid=!1,y.outFields=p,a.outFields=f;const I=yield h._queue.push({query:y,depth:0,signal:v});(0,N.k_)({signal:v}),u.joinAttributes(I)})()}_fetchDataTile(a){var u=this;return(0,B.Z)(function*(){if(!u._downloadPromise){const I=(0,C.s3)(u._schema.featureCount,"Expected featureCount to be defined");u._downloadPromise=u._download(I)}const h=u._store.search(a),d=u._subscriptions.get(a.key.id),f=h.length-1;for(let I=0;I<f;I++){const x=Nt(h[I],a),A={type:"append",id:a.id,addOrUpdate:x,end:!1,status:Se.empty()};d.add({query:null,message:A}),u._hasAggregates||(yield(0,N.e4)(1)),u._onMessage(A)}const p=Nt(f>=0?h[f]:null,a),v={type:"append",id:a.id,addOrUpdate:p,end:u._didSendEnd,status:Se.empty()};d.add({query:null,message:v}),u._onMessage(v)})()}_download(a){var u=this;return(0,B.Z)(function*(){try{yield u.whenInitialized();const h=u._store.storage.getBitset(u._markedIdsBufId),d=new Set;h.clear();const f=Math.ceil(a/u.pageSize),p=Array.from({length:f},(y,v)=>v).sort((y,v)=>u._random.getInt()-u._random.getInt()).map(y=>u._downloadPage(y,h,d));yield Promise.all(p),u._store.sweepFeatures(h,u._store.storage),u._store.sweepFeatureSets(d)}catch(h){Zs.error("mapview-snapshot-source","Encountered and error when downloading feature snapshot",h)}u._sendEnd(),u._loading=!1})()}_downloadPage(a,u,h){var d=this;return(0,B.Z)(function*(){const f=d.pageSize,p={start:a*f,num:f,cacheHint:!0};(0,C.pC)(d.maxRecordCountFactor)&&(p.maxRecordCountFactor=d.maxRecordCountFactor);const y=d.createQuery(p),v=d._signal,I=yield d._queue.push({query:y,depth:a,signal:v});(0,N.k_)({signal:v}),d._queries.push({query:y,reader:I}),d._store.insert(I),h.add(I.instance);const x=I.getCursor();for(;x.next();)u.set(x.getDisplayId());d._send(I)})()}_send(a){if(!this._subscriptions.size)return;let u=null;const h=new Map,d=new Set,f=new Map;this._subscriptions.forEach(p=>{const y=p.tile;h.set(y.key.id,null),u=y.tileInfoView,d.add(y.level);const{row:v,col:I}=y.key,x=`${y.level}/${v}/${I}`,A=f.get(x)??[];A.push(p),f.set(x,A)});for(const p of d){const y=u.getLODInfoAt(p),v=a.getCursor();for(;v.next();){const I=Ns(v,y,p),x=v.getIndex();if(f.has(I))for(const A of f.get(I)){const P=A.tile.id;let R=h.get(P);(0,C.Wi)(R)&&(R=[],h.set(P,R)),R.push(x)}}}h.forEach((p,y)=>{if((0,C.pC)(p)){const v=this._subscriptions.get(y),I={type:"append",id:y,addOrUpdate:Nt(zs.t.from(a,p),v.tile),end:!1,status:Se.empty()};v.add({query:null,message:I}),this._onMessage(I)}})}_sendEnd(){this._subscriptions.forEach(a=>{const u={type:"append",id:a.tile.id,addOrUpdate:null,end:!0,status:Se.empty()};a.add({query:null,message:u}),this._onMessage(u)}),this._didSendEnd=!0}}var Ws=T(21286),Me=T(39351),le=T(99666),Ys=T(64288);T(81295),T(39406),O.Z.getLogger("esri.views.2d.engine.webgl");var it=T(67969);const _t=O.Z.getLogger("esri.views.layers.2d.features.support.AttributeStore"),Et=(_t,()=>null),Mt={sharedArrayBuffer:(0,M.Z)("esri-shared-array-buffer"),atomics:(0,M.Z)("esri-atomics")};function ss(c,a){return u=>a(c(u))}class $s{constructor(a,u,h,d){this.size=0,this.texelSize=4;const{pixelType:f,layout:p,textureOnly:y}=d;this.textureOnly=y||!1,this.pixelType=f,this._ctype=u,this.layout=p,this._resetRange(),this._shared=a,this.size=h,y||(this.data=this._initData(f,h,a,u))}get buffer(){return(0,C.yw)(this.data,a=>a.buffer)}unsetComponentAllTexels(a,u){const h=(0,C.Wg)(this.data);for(let d=0;d<this.size*this.size;d++)h[d*this.texelSize+a]&=~u;this.dirtyStart=0,this.dirtyEnd=this.size*this.size-1}setComponentAllTexels(a,u){const h=(0,C.Wg)(this.data);for(let d=0;d<this.size*this.size;d++)h[d*this.texelSize+a]|=255&u;this.dirtyStart=0,this.dirtyEnd=this.size*this.size-1}setComponent(a,u,h){const d=(0,C.Wg)(this.data);for(const f of h)d[f*this.texelSize+a]|=u,this.dirtyStart=Math.min(this.dirtyStart,f),this.dirtyEnd=Math.max(this.dirtyEnd,f)}setComponentTexel(a,u,h){(0,C.Wg)(this.data)[h*this.texelSize+a]|=u,this.dirtyStart=Math.min(this.dirtyStart,h),this.dirtyEnd=Math.max(this.dirtyEnd,h)}unsetComponentTexel(a,u,h){(0,C.Wg)(this.data)[h*this.texelSize+a]&=~u,this.dirtyStart=Math.min(this.dirtyStart,h),this.dirtyEnd=Math.max(this.dirtyEnd,h)}getData(a,u){const h=(0,le.jL)(a);return(0,C.Wg)(this.data)[h*this.texelSize+u]}setData(a,u,h){const d=(0,le.jL)(a);0!=(this.layout&1<<u)?(this.data[d*this.texelSize+u]=h,this.dirtyStart=Math.min(this.dirtyStart,d),this.dirtyEnd=Math.max(this.dirtyEnd,d)):_t.error("mapview-attributes-store","Tried to set a value for a texel's readonly component")}lock(){this.pixelType===it.Br.UNSIGNED_BYTE&&this._shared&&Mt.atomics&&"local"!==this._ctype&&Atomics.store(this.data,0,1)}unlock(){this.pixelType===it.Br.UNSIGNED_BYTE&&this._shared&&Mt.atomics&&"local"!==this._ctype&&Atomics.store(this.data,0,0)}expand(a){if(this.size=a,!this.textureOnly){const u=this._initData(this.pixelType,a,this._shared,this._ctype),h=(0,C.Wg)(this.data);u.set(h),this.data=u}}toMessage(){const a=this.dirtyStart,u=this.dirtyEnd,h=this.texelSize;if(a>u)return null;this._resetRange();const d=!(this._shared||"local"===this._ctype),f=this.pixelType,p=this.layout,y=(0,C.Wg)(this.data);return{start:a,end:u,data:d&&y.slice(a*h,(u+1)*h)||null,pixelType:f,layout:p}}_initData(a,u,h,d){const f=h&&"local"!==d?SharedArrayBuffer:ArrayBuffer,p=(0,Ys.UK)(a),y=new p(new f(u*u*4*p.BYTES_PER_ELEMENT));for(let v=0;v<y.length;v+=4)y[v+1]=255;return y}_resetRange(){this.dirtyStart=2147483647,this.dirtyEnd=0}}class er{constructor(a,u,h=(()=>{})){this._client=a,this.config=u,this._notifyChange=h,this._attributeComputeMap=new Map,this._blocks=new Array,this._filters=new Array(Me.m4),this._targetType=0,this._abortController=new AbortController,this._hasScaleExpr=!1,this._size=32,this._idsToHighlight=new Set;const d=u.supportsTextureFloat?it.Br.FLOAT:it.Br.UNSIGNED_BYTE;Et(`Creating AttributeStore ${Mt.sharedArrayBuffer?"with":"without"} shared memory`),this._blockDescriptors=[{pixelType:it.Br.UNSIGNED_BYTE,layout:1},{pixelType:it.Br.UNSIGNED_BYTE,layout:15,textureOnly:!0},{pixelType:it.Br.UNSIGNED_BYTE,layout:15,textureOnly:!0},{pixelType:d,layout:15},{pixelType:d,layout:15},{pixelType:d,layout:15},{pixelType:d,layout:15}],this._blocks=this._blockDescriptors.map(()=>null)}destroy(){this._abortController.abort()}get hasScaleExpr(){return this._hasScaleExpr}get _signal(){return this._abortController.signal}get hasHighlight(){return this._idsToHighlight.size>0}isUpdating(){return!!this._currUpdate||!!this._nextUpdate}update(a,u){this.config=u;const h=u.schema.processors[0].storage,d=(0,De.Hg)(this._schema,h);if((a.targets.feature||a.targets.aggregate)&&(a.storage.data=!0),d&&((0,M.Z)("esri-2d-update-debug")&&console.debug("Applying Update - AttributeStore:",d),a.storage.data=!0,this._schema=h,this._attributeComputeMap.clear(),!(0,C.Wi)(h))){switch(h.target){case"feature":this._targetType=le.PX;break;case"aggregate":this._targetType=le.xp}if("subtype"===h.type)for(const f in h.mapping){const p=h.mapping[f];if((0,C.pC)(p)&&(0,C.pC)(p.vvMapping))for(const y of p.vvMapping)this._bindAttribute(y)}else{if((0,C.pC)(h.vvMapping))for(const f of h.vvMapping)this._bindAttribute(f);if((0,C.pC)(h.attributeMapping))for(const f of h.attributeMapping)this._bindAttribute(f)}}}onTileData(a,u){if((0,C.Wi)(u.addOrUpdate))return;const h=u.addOrUpdate.getCursor();for(;h.next();){const d=h.getDisplayId();this.setAttributeData(d,h)}}invalidateResources(){this._createResourcesPromise=null,this._abortController.abort(),this._abortController=new AbortController}setHighlight(a,u){var h=this;return(0,B.Z)(function*(){const f=h._getBlock(0),p=u.map(y=>(0,le.jL)(y));f.lock(),f.unsetComponentAllTexels(0,1),f.setComponent(0,1,p),f.unlock(),h._idsToHighlight.clear();for(const y of a)h._idsToHighlight.add(y);yield h.sendUpdates()})()}updateFilters(a,u,h){var d=this;return(0,B.Z)(function*(){const{service:f,spatialReference:p}=h,{filters:y}=u,v=y.map((I,x)=>d._updateFilter(I,x,f,p));(yield Promise.all(v)).some(I=>I)&&(a.storage.filters=!0,(0,M.Z)("esri-2d-update-debug")&&console.debug("Applying Update - AttributeStore:","Filters changed"))})()}setData(a,u,h,d){const f=(0,le.jL)(a);this._ensureSizeForTexel(f),this._getBlock(u).setData(a,h,d)}getData(a,u,h){return this._getBlock(u).getData(a,h)}getHighlightFlag(a){return this._idsToHighlight.has(a)?Me.uG:0}unsetAttributeData(a){const u=(0,le.jL)(a);this._getBlock(0).setData(u,0,0)}setAttributeData(a,u){const h=(0,le.jL)(a);if(this._ensureSizeForTexel(h),this._getBlock(0).setData(h,0,this.getFilterFlags(u)),this._targetType!==(0,le.vs)(a))return;const d=this._attributeComputeMap,f=this.config.supportsTextureFloat?1:2;d.size&&d.forEach((y,v)=>{const I=v*f%4,x=Math.floor(v*f/4),A=this._getBlock(x+Me.aK),P=y(u);if(this.config.supportsTextureFloat)A.setData(h,I,P);else if(P===Me.AI)A.setData(h,I,255),A.setData(h,I+1,255);else{const R=(0,Ws.uZ)(Math.round(P),-32767,32766)+32768,j=(65280&R)>>8;A.setData(h,I,255&R),A.setData(h,I+1,j)}})}sendUpdates(){if((0,M.Z)("esri-2d-update-debug")&&console.debug("AttributeStore::sendUpdate"),this._notifyChange(),this._nextUpdate)return this._nextUpdate.promise;if(this._currUpdate)return this._nextUpdate=(0,N.hh)(),this._nextUpdate.promise;const a={blocks:this._blocks.map(u=>(0,C.pC)(u)?u.toMessage():null)};return this._currUpdate=this._createResources().then(()=>{const u=()=>{if(this._currUpdate=null,this._nextUpdate){const d=this._nextUpdate;this._nextUpdate=null,this.sendUpdates().then(()=>d.resolve())}else(0,M.Z)("esri-2d-update-debug")&&console.debug("AttributeStore::sendUpdate::No additional updates queued");this._notifyChange()};(0,M.Z)("esri-2d-update-debug")&&console.debug("AttributeStore::sendUpdate::client.update");const h=this._client.update(a,this._signal).then(u).catch(u);return this._client.render(this._signal),h}).catch(u=>{if((0,N.D_)(u))return this._createResourcesPromise=null,this._createResources();this._notifyChange(),_t.error(new w.Z("mapview-attribute-store","Encountered an error during client update",u))}),this._currUpdate}_ensureSizeForTexel(a){for(;a>=this._size*this._size;)if(this._expand())return}_bindAttribute(a){let d;if(null!=a.fieldIndex)d=function h(){return a.normalizationField&&_t.warn("mapview-arcade","Ignoring normalizationField specified with an arcade expression which is not supported."),p=>p.getComputedNumericAtIndex(a.fieldIndex)}();else{if(!a.field)return;d=function u(){return a.normalizationField?p=>{const y=p.readAttribute(a.normalizationField);return y?p.readAttribute(a.field)/y:null}:p=>p.readAttribute(a.field)}()}a.valueRepresentation&&(d=ss(d,p=>function Qs(c,a){if(!c||!a)return c;switch(a){case"radius":case"distance":return 2*c;case"diameter":case"width":return c;case"area":return Math.sqrt(c)}return c}(p,a.valueRepresentation))),this._attributeComputeMap.set(a.binding,ss(d,p=>null===p||isNaN(p)||p===1/0?Me.AI:p))}_createResources(){if((0,C.pC)(this._createResourcesPromise))return this._createResourcesPromise;this._getBlock(Me.xl),this._getBlock(Me.pU),Et("Initializing AttributeStore");const a={shared:Mt.sharedArrayBuffer&&"local"!==this._client.type,size:this._size,blocks:(0,C.Fd)(this._blocks,h=>({textureOnly:h.textureOnly,buffer:h.buffer,pixelType:h.pixelType}))},u=this._client.initialize(a,this._signal).catch(h=>{(0,N.D_)(h)?this._createResourcesPromise=null:_t.error(new w.Z("mapview-attribute-store","Encountered an error during client initialization",h))});return this._createResourcesPromise=u,u.then(()=>(0,C.Wi)(this._createResourcesPromise)?this._createResources():void 0),u}_getBlock(a){const u=this._blocks[a];if((0,C.pC)(u))return u;Et(`Initializing AttributeBlock at index ${a}`);const f=new $s(Mt.sharedArrayBuffer,this._client.type,this._size,this._blockDescriptors[a]);return this._blocks[a]=f,this._createResourcesPromise=null,f}_expand(){if(this._size<this.config.maxTextureSize){const a=this._size<<=1;return Et("Expanding block size to",a,this._blocks),(0,C.JR)(this._blocks,u=>u.expand(a)),this._createResourcesPromise=null,this._size=a,0}return _t.error(new w.Z("mapview-limitations","Maximum number of onscreen features exceeded.")),-1}_updateFilter(a,u,h,d){var f=this;return(0,B.Z)(function*(){const p=f._filters[u],y=(0,C.pC)(p)&&p.hash;if(!p&&!a||y===JSON.stringify(a))return!1;if((0,C.Wi)(a)){if(!p)return!1;const I=1<<u+1,x=f._getBlock(0);return f._filters[u]=null,x.setComponentAllTexels(0,I),f.sendUpdates(),!0}return yield(yield f._getFilter(u,h)).update(a,d),!0})()}_getFilter(a,u){var h=this;return(0,B.Z)(function*(){const d=h._filters[a];if((0,C.pC)(d))return d;const{default:f}=yield T.e(8967).then(T.bind(T,8967)),p=new f({geometryType:u.geometryType,hasM:!1,hasZ:!1,timeInfo:u.timeInfo,fieldsIndex:new _.Z(u.fields)});return h._filters[a]=p,p})()}isVisible(a){return!!(2&this._getBlock(0).getData(a,0))}getFilterFlags(a){let u=0;const h=(0,le.KS)(a.getDisplayId());for(let f=0;f<this._filters.length;f++){const y=this._filters[f];u|=(h&1<<f&&!(0,C.Wi)(y)&&!y.check(a)?0:1)<<f}let d=0;if(this._idsToHighlight.size){const f=a.getObjectId();d=this.getHighlightFlag(f)}return u<<1|d}}function jt(c,a,u,h){h%2&&(h+=1);let d=0,f=0,p=-90,y=90,v=-180,I=180;for(let x=0;x<h/2;x++){for(let A=0;A<5;A++){const P=(v+I)/2,R=u>P?1:0;d|=R<<29-(A+5*x),v=(1-R)*v+R*P,I=(1-R)*P+R*I}for(let A=0;A<5;A++){const P=(p+y)/2,R=a>P?1:0;f|=R<<29-(A+5*x),p=(1-R)*p+R*P,y=(1-R)*P+R*y}}c.geohashX=d,c.geohashY=f}function Dt(c,a,u,h,d){d%2&&(d+=1);let f=0,p=0,y=-90,v=90,I=-180,x=180;for(let A=0;A<d/2;A++){for(let P=0;P<5;P++){const R=(I+x)/2,G=h>R?1:0;f|=G<<29-(P+5*A),I=(1-G)*I+G*R,x=(1-G)*R+G*x}for(let P=0;P<5;P++){const R=(y+v)/2,G=u>R?1:0;p|=G<<29-(P+5*A),y=(1-G)*y+G*R,v=(1-G)*R+G*v}}c[2*a]=f,c[2*a+1]=p}T(29132),new Float64Array(2),new Float64Array(2);var Xe=T(65234),Ve=T(82959);class gs{constructor(a=[],u,h=8096){this.onRelease=d=>{},this._nodes=0,this._root=new Yt(this,0,0,0),this._statisticFields=a,this._pool=h?new Tt.Z(8096):null,this._serviceInfo=u}destroy(){this.clear()}_acquire(a,u,h){this._nodes++;let d=null;return(0,C.pC)(this._pool)&&(d=this._pool.dequeue()),(0,C.pC)(d)?d.realloc(a,u,h):d=new Yt(this,a,u,h),d}_release(a){this.onRelease(a),this._nodes--,(0,C.pC)(this._pool)&&this._pool.enqueue(a)}get count(){return this._root.count}get size(){return this._nodes}get poolSize(){return(0,C.R2)(this._pool,0,a=>a.size)}get depth(){let a=0;return this.forEach(u=>a=Math.max(a,u.depth)),a}dropLevels(a){this.forEach(u=>{if(u.depth>=a)for(let h=0;h<u.children.length;h++){const d=u.children[h];d&&this._release(d)}}),this.forEach(u=>{if(u.depth>=a)for(let h=0;h<u.children.length;h++)u.children[h]=null})}clear(){this.forEach(a=>this._release(a)),this._root=new Yt(this,0,0,0)}insert(a,u,h=0){const d=ue.fromOptimizedFeatures([a],this._serviceInfo).getCursor();d.next();const f=d.readGeometry();if(!f)return;const[p,y]=f.coords;this.insertCursor(d,a.displayId,p,y,a.geohashX,a.geohashY,u,h)}insertCursor(a,u,h,d,f,p,y,v=0){let I=this._root,x=0,A=0,P=0;for(;null!==I;){if(I.depth>=v&&(I.count+=1,I.xTotal+=h,I.yTotal+=d,I.xGeohashTotal+=f,I.yGeohashTotal+=p,I.referenceId=u,this._updateStatisticsCursor(a,I,1)),x>=y)return void I.add(u);const R=Math.ceil((x+1)/2),G=Math.floor((x+1)/2),j=1-x%2,te=30-(3*R+2*G),Q=30-(2*R+3*G),se=(f&7*j+3*(1-j)<<te)>>te,ee=(p&3*j+7*(1-j)<<Q)>>Q,ne=se+ee*(8*j+4*(1-j));A=A<<3*j+2*(1-j)|se,P=P<<2*j+3*(1-j)|ee,null==I.children[ne]&&(I.children[ne]=this._acquire(A,P,x+1)),x+=1,I=I.children[ne]}}remove(a,u){const h=ue.fromOptimizedFeatures([a],this._serviceInfo).getCursor();h.next();const d=h.readGeometry();if(!d)return;const[f,p]=d.coords;this.removeCursor(h,f,p,a.geohashX,a.geohashY,u)}removeCursor(a,u,h,d,f,p){let y=this._root,v=0;for(;null!==y;){if(y.count-=1,y.xTotal-=u,y.yTotal-=h,y.xGeohashTotal-=d,y.yGeohashTotal-=f,this._updateStatisticsCursor(a,y,-1),v>=p)return void y.remove(a.getDisplayId());const I=Math.ceil((v+1)/2),x=Math.floor((v+1)/2),A=1-v%2,P=30-(3*I+2*x),R=30-(2*I+3*x),G=((d&7*A+3*(1-A)<<P)>>P)+((f&3*A+7*(1-A)<<R)>>R)*(8*A+4*(1-A)),j=y.children[G];1===j.count&&(this._release(j),y.children[G]=null),v+=1,y=j}}forEach(a){let u=this._root;for(;null!==u;){const h=this._linkChildren(u)||u.next;a(u),u=h}}find(a,u,h){return this._root.find(a,u,h,0,0,0)}findIf(a){let u=null;return this.forEach(h=>{a(h)&&(u=h)}),u}findAllIf(a){const u=[];return this.forEach(h=>{a(h)&&u.push(h)}),u}findSingleOccupancyNode(a,u,h,d,f){let p=this._root;for(;null!==p;){const y=p.depth,v=p.xNode,I=p.yNode,x=1-y%2,A=p.xGeohashTotal/p.count,P=p.yGeohashTotal/p.count;if(1===p.count&&a<A&&A<=h&&u<P&&P<=d)return p;if(y>=f){p=p.next;continue}const R=Math.ceil((y+1)/2),G=Math.floor((y+1)/2),j=30-(3*R+2*G),te=30-(2*R+3*G),Q=~((1<<j)-1),se=~((1<<te)-1),ne=(u&se)>>te,oe=(h&Q)>>j,J=(d&se)>>te,de=v<<3*x+2*(1-x),ye=I<<2*x+3*(1-x),he=de+8*x+4*(1-x),pe=ye+4*x+8*(1-x),ce=Math.max(de,(a&Q)>>j),Ae=Math.max(ye,ne),Te=Math.min(he,oe),be=Math.min(pe,J);let ve=null,Ce=null;for(let Fe=Ae;Fe<=be;Fe++)for(let xe=ce;xe<=Te;xe++){const Ee=p.children[xe-de+(Fe-ye)*(8*x+4*(1-x))];Ee&&(ve||(ve=Ee,ve.next=p.next),Ce&&(Ce.next=Ee),Ce=Ee,Ee.next=p.next)}p=ve||p.next}return null}getRegionDisplayIds(a,u,h,d,f){let p=this._root;const y=[];for(;null!==p;){const v=p.depth,I=p.xNode,x=p.yNode;if(v>=f){const Ce=p.xGeohashTotal/p.count,Fe=p.yGeohashTotal/p.count;a<=Ce&&Ce<=h&&u<=Fe&&Fe<=d&&p.displayIds.forEach(xe=>y.push(xe)),p=p.next;continue}const A=Math.ceil((v+1)/2),P=Math.floor((v+1)/2),R=1-v%2,G=30-(3*A+2*P),j=30-(2*A+3*P),te=~((1<<G)-1),Q=~((1<<j)-1),ee=(u&Q)>>j,ne=(h&te)>>G,oe=(d&Q)>>j,J=I<<3*R+2*(1-R),de=x<<2*R+3*(1-R),ye=J+8*R+4*(1-R),he=de+4*R+8*(1-R),pe=Math.max(J,(a&te)>>G),ce=Math.max(de,ee),Ae=Math.min(ye,ne),Te=Math.min(he,oe);let be=null,ve=null;for(let Ce=ce;Ce<=Te;Ce++)for(let Fe=pe;Fe<=Ae;Fe++){const _e=p.children[Fe-J+(Ce-de)*(8*R+4*(1-R))];_e&&(be||(be=_e,be.next=p.next),ve&&(ve.next=_e),ve=_e,_e.next=p.next)}p=be||p.next}return y}getRegionStatistics(a,u,h,d,f){let p=this._root,y=0,v=0,I=0;const x={};let A=0;for(;null!==p;){const P=p.depth,R=p.xNode,G=p.yNode;if(P>=f){const Ee=p.xGeohashTotal/p.count,He=p.yGeohashTotal/p.count;a<Ee&&Ee<=h&&u<He&&He<=d&&(y+=p.count,v+=p.xTotal,I+=p.yTotal,1===p.count&&(A=p.referenceId),this._aggregateStatistics(x,p.statistics)),p=p.next;continue}const j=Math.ceil((P+1)/2),te=Math.floor((P+1)/2),Q=1-P%2,se=30-(3*j+2*te),ee=30-(2*j+3*te),ne=~((1<<se)-1),oe=~((1<<ee)-1),de=(u&oe)>>ee,ye=(h&ne)>>se,he=(d&oe)>>ee,pe=R<<3*Q+2*(1-Q),ce=G<<2*Q+3*(1-Q),Ae=pe+8*Q+4*(1-Q),Te=ce+4*Q+8*(1-Q),be=Math.max(pe,(a&ne)>>se),ve=Math.max(ce,de),Ce=Math.min(Ae,ye),Fe=Math.min(Te,he);let xe=null,_e=null;for(let Ee=ve;Ee<=Fe;Ee++)for(let He=be;He<=Ce;He++){const Re=p.children[He-pe+(Ee-ce)*(8*Q+4*(1-Q))];if(Re){if(Ee!==ve&&Ee!==Fe&&He!==be&&He!==Ce){const vs=Re.xGeohashTotal/Re.count,xs=Re.yGeohashTotal/Re.count;a<vs&&vs<=h&&u<xs&&xs<=d&&(y+=Re.count,v+=Re.xTotal,I+=Re.yTotal,1===p.count&&(A=p.referenceId),this._aggregateStatistics(x,Re.statistics));continue}xe||(xe=Re,xe.next=p.next),_e&&(_e.next=Re),_e=Re,Re.next=p.next}}p=xe||p.next}return{count:y,attributes:this.normalizeStatistics(x,y),xTotal:v,yTotal:I,referenceId:A}}getBins(a,u,h,d,f){const p=[];let y=this._root;for(;null!==y;){const v=y.depth,I=y.xNode,x=y.yNode;if(v>=f){p.push(y),y=y.next;continue}const A=Math.ceil((v+1)/2),P=Math.floor((v+1)/2),R=1-v%2,G=30-(3*A+2*P),j=30-(2*A+3*P),te=~((1<<G)-1),Q=~((1<<j)-1),ee=(u&Q)>>j,ne=(h&te)>>G,oe=(d&Q)>>j,J=I<<3*R+2*(1-R),de=x<<2*R+3*(1-R),ye=J+8*R+4*(1-R),he=de+4*R+8*(1-R),pe=Math.max(J,(a&te)>>G),ce=Math.max(de,ee),Ae=Math.min(ye,ne),Te=Math.min(he,oe);let be=null,ve=null;for(let Ce=ce;Ce<=Te;Ce++)for(let Fe=pe;Fe<=Ae;Fe++){const _e=y.children[Fe-J+(Ce-de)*(8*R+4*(1-R))];_e&&(be||(be=_e,be.next=y.next),ve&&(ve.next=_e),ve=_e,_e.next=y.next)}y=be||y.next}return p}_linkChildren(a){let u=null,h=null;for(let d=0;d<=a.children.length;d++){const f=a.children[d];f&&(u||(u=f,u.next=a.next),h&&(h.next=f),h=f,f.next=a.next)}return u}_updateStatisticsCursor(a,u,h){for(const d of this._statisticFields){const f=d.name,p=d.inField?a.readAttribute(d.inField):a.getComputedNumericAtIndex(d.inFieldIndex);switch(d.statisticType){case"norm":{u.statistics[f]||(u.statistics[f]={});const v=a.readAttribute(d.inNormalizationField),I=u.statistics[f].onStatisticField||0,x=u.statistics[f].onStatisticNormalizationField||0;null==p||isNaN(p)||null==v||0===v||isNaN(v)||(u.statistics[f].onStatisticField=I+h*p,u.statistics[f].onStatisticNormalizationField=x+h*v);break}case"sum":case"avg":{u.statistics[f]||(u.statistics[f]={value:0,nanCount:0});const y=u.statistics[f].value,v=u.statistics[f].nanCount;null==p||isNaN(p)?u.statistics[f].nanCount=v+h:u.statistics[f].value=y+h*p;break}case"avg_angle":{u.statistics[f]||(u.statistics[f]={x:0,y:0,nanCount:0});const y=u.statistics[f].x,v=u.statistics[f].y,I=u.statistics[f].nanCount,x=Math.PI/180;null==p||isNaN(p)?u.statistics[f].nanCount=I+h:(u.statistics[f].x=y+h*Math.cos(p*x),u.statistics[f].y=v+h*Math.sin(p*x));break}case"mode":u.statistics[f]||(u.statistics[f]={}),u.statistics[f][p]=(u.statistics[f][p]||0)+h}}}_aggregateStatistics(a,u){for(const h of this._statisticFields){const d=h.name;switch(h.statisticType){case"sum":case"avg":case"avg_angle":case"mode":case"norm":a[d]||(a[d]={});for(const f in u[d])a[d][f]=(a[d][f]||0)+u[d][f]}}}normalizeStatistics(a,u){const h={};for(const d of this._statisticFields){const f=d.name;switch(d.statisticType){case"norm":{const p=a[f];if(u&&null==p.onStatisticNormalizationField)break;if(u&&p.onStatisticNormalizationField){h[f]=p.onStatisticField/p.onStatisticNormalizationField;break}h[f]=0;break}case"sum":{if(!u)break;const{value:p,nanCount:y}=a[f];if(!(u-y))break;h[f]=p;break}case"avg":{if(!u)break;const{value:p,nanCount:y}=a[f];if(!(u-y))break;h[f]=p/(u-y);break}case"avg_angle":{if(!u)break;const{x:p,y,nanCount:v}=a[f];if(!(u-v))break;const A=180/Math.PI,P=Math.atan2(y/(u-v),p/(u-v))*A;h[f]=P;break}case"mode":{const p=a[f];let y=0,v=null;for(const I in p){const x=p[I];x>y&&(y=x,v=I)}h[f]="null"===v?null:v;break}}}return h}}class Yt{constructor(a,u,h,d){this.count=0,this.xTotal=0,this.yTotal=0,this.statistics={},this.displayId=0,this.referenceId=0,this.displayIds=new Set,this.next=null,this.depth=0,this.xNode=0,this.yNode=0,this.xGeohashTotal=0,this.yGeohashTotal=0,this._tree=a,this.children=new Array(32);for(let f=0;f<this.children.length;f++)this.children[f]=null;this.xNode=u,this.yNode=h,this.depth=d}realloc(a,u,h){for(let d=0;d<this.children.length;d++)this.children[d]=null;return this.xNode=a,this.yNode=u,this.depth=h,this.next=null,this.xGeohashTotal=0,this.yGeohashTotal=0,this.displayId=0,this.referenceId=0,this.xTotal=0,this.yTotal=0,this.count=0,this.statistics={},this.displayIds.clear(),this}get id(){return`${this.xNode}.${this.yNode}`}add(a){this.displayIds.add(a)}remove(a){this.displayIds.delete(a)}getAttributes(){const a=this._tree.normalizeStatistics(this.statistics,this.count);return a.aggregateId=this.id,a.aggregateCount=this.count,a}getGeometry(a,u){const h=this.getLngLatBounds(),[d,f,p,y]=h,v=(0,Ve.iV)({rings:[[[d,f],[d,y],[p,y],[p,f],[d,f]]]},Xe.Z.WGS84,a),I=(0,E.Uy)(new ie.Z,v,!1,!1);return(0,C.pC)(u)?(0,E.Nh)(new ie.Z,I,!1,!1,"esriGeometryPolygon",u,!1,!1):I}getLngLatBounds(){const a=this.depth,u=Math.ceil(a/2),h=Math.floor(a/2);return function rr(c,a){let u=-90,h=90,d=-180,f=180;for(let p=0;p<a;p++){const y=Math.ceil((p+1)/2),v=Math.floor((p+1)/2),I=1-p%2,x=30-(3*y+2*v),A=30-(2*y+3*v),R=2*I+3*(1-I),j=(7*I+3*(1-I)<<x&c.geohashX)>>x,te=(3*I+7*(1-I)<<A&c.geohashY)>>A;for(let Q=3*I+2*(1-I)-1;Q>=0;Q--){const se=(d+f)/2,ee=j&1<<Q?1:0;d=(1-ee)*d+ee*se,f=(1-ee)*se+ee*f}for(let Q=R-1;Q>=0;Q--){const se=(u+h)/2,ee=te&1<<Q?1:0;u=(1-ee)*u+ee*se,h=(1-ee)*se+ee*h}}return[d,u,f,h]}({geohashX:this.xNode<<30-(3*u+2*h),geohashY:this.yNode<<30-(2*u+3*h)},this.depth)}find(a,u,h,d,f,p){if(d>=h)return this;const y=1-d%2,v=3*y+2*(1-y),I=2*y+3*(1-y),x=30-f-v,A=30-p-I,R=this.children[((a&7*y+3*(1-y)<<x)>>x)+((u&3*y+7*(1-y)<<A)>>A)*(8*y+4*(1-y))];return null==R?null:R.find(a,u,h,d+1,f+v,p+I)}}var qe=T(94425),fs=T(16669),ar=T(37118),ur=T(2004);const Xt=O.Z.getLogger("esri.view.2d.layers.features.support.BinStore");function _s(c){return 57.29577951308232*c}class dr extends fs.J{constructor(a,u,h,d){super(a,h),this._geohashLevel=5,this._geohashBuf=[],this._serviceInfo=d,this.geometryInfo=a.geometryInfo,this._spatialReference=u,this._projectionSupportCheck=(0,Ve._W)(u,Xe.Z.WGS84),this._bitsets.geohash=h.getBitset(h.createBitset()),this._bitsets.inserted=h.getBitset(h.createBitset())}destroy(){this._tree&&this._tree.destroy()}updateSchema(a,u){var h=()=>super.updateSchema,d=this;return(0,B.Z)(function*(){const f=d._schema;try{yield h().call(d,a,u),yield d._projectionSupportCheck}catch{}const p=(0,De.Hg)(f,u);u&&(!(0,C.Wi)(p)||a.source||a.storage.filters)?(((0,De.uD)(p,"params.fields")||(0,De.uD)(p,"params")||!d._tree||a.source)&&(d._tree&&d._tree.destroy(),d._tree=new gs(d._statisticFields,d._serviceInfo),d._tree.onRelease=y=>y.displayId&&d._storage.releaseDisplayId(y.displayId),d._geohashLevel=d._schema.params.fixedBinLevel,d._rebuildTree(),(0,M.Z)("esri-2d-update-debug")&&Xt.info("Aggregate mesh needs update due to tree changing")),(0,M.Z)("esri-2d-update-debug")&&Xt.info("Aggregate mesh needs update due to tree changing"),a.targets[u.name]=!0,a.mesh=!1):f&&(a.mesh=!0)})()}clear(){this._rebuildTree()}sweepFeatures(a,u){this._bitsets.inserted.forEachSet(h=>{if(!a.has(h)){const d=u.lookupByDisplayIdUnsafe(h);this._remove(d)}})}sweepAggregates(a,u,h){}onTileData(a,u,h,d,f=!0){if(!this._schema||(0,C.Wi)(u.addOrUpdate))return u;const p=this._getTransforms(a,this._spatialReference);{const v=u.addOrUpdate.getCursor();for(;v.next();)this._update(v,d)}if(u.status.mesh||!f)return u;const y=new Array;this._getBinsForTile(y,a,p,h),u.addOrUpdate=ue.fromOptimizedFeatures(y,{...this._serviceInfo,geometryType:"esriGeometryPolygon"}),u.addOrUpdate.attachStorage(h),u.clear=!0,u.end=!0;{const v=u.addOrUpdate.getCursor();for(;v.next();){const I=v.getDisplayId();this._bitsets.computed.unset(I),this.setComputedAttributes(h,v,I,a.scale)}}return u}forEach(a){this._tree.forEach(a)}onTileUpdate(a){}getAggregate(a){const u=(0,le.QS)(a,!0),h=this._tree.findIf(d=>d.displayId===u);return(0,C.yw)(h,d=>this._toAggregateGraphic(d))}getAggregates(){return this._tree.findAllIf(a=>a.depth===this._geohashLevel).map(this._toAggregateGraphic.bind(this))}getDisplayId(a){const u=this._tree.findIf(h=>h.id===a);return(0,C.yw)(u,h=>h.displayId)}getFeatureDisplayIdsForAggregate(a){const u=this._tree.findIf(h=>h.id===a);return(0,C.R2)(u,[],h=>Array.from(h.displayIds))}getDisplayIdForReferenceId(a){const u=this._tree.findIf(h=>1===h.displayIds.size&&h.displayIds.has(a));return(0,C.yw)(u,h=>h.displayId)}_toAggregateGraphic(a){const u=this._spatialReference;return{referenceId:null,objectId:a.id,displayId:a.displayId,attributes:a.getAttributes(),geometry:(0,E.di)(a.getGeometry(u),"esriGeometryPolygon",!1,!1),centroid:null}}_rebuildTree(){this._bitsets.computed.clear(),this._bitsets.inserted.clear(),this._tree&&this._tree.clear()}_remove(a){const u=a.getDisplayId(),h=a.getXHydrated(),d=a.getYHydrated(),f=this._geohashBuf[2*u],p=this._geohashBuf[2*u+1];this._bitsets.inserted.has(u)&&(this._bitsets.inserted.unset(u),this._tree.removeCursor(a,h,d,f,p,this._geohashLevel))}_update(a,u){const h=a.getDisplayId(),d=this._bitsets.inserted,f=u.isVisible(h);if(f===d.has(h))return;if(!f)return void this._remove(a);const p=a.getXHydrated(),y=a.getYHydrated();this._setGeohash(h,p,y)&&(this._tree.insertCursor(a,h,p,y,this._geohashBuf[2*h],this._geohashBuf[2*h+1],this._geohashLevel),d.set(h))}_setGeohash(a,u,h){if(this._bitsets.geohash.has(a))return!0;const d=this._geohashBuf;if(this._spatialReference.isWebMercator){const f=_s(u/qe.sv.radius),p=f-360*Math.floor((f+180)/360);Dt(d,a,_s(Math.PI/2-2*Math.atan(Math.exp(-h/qe.sv.radius))),p,12)}else{const f=(0,Ve.iV)({x:u,y:h},this._spatialReference,Xe.Z.WGS84);if(!f)return!1;Dt(d,a,f.y,f.x,12)}return this._bitsets.geohash.set(a),!0}_getBinsForTile(a,u,h,d){try{const{xLL:f,yLL:p,xTR:y,yTR:v,level:I}=this._getGeohashBounds(u),x=this._tree.getBins(f,p,y,v,I);for(const A of x){A.displayId||(A.displayId=d.createDisplayId(!0));const P=A.getGeometry(this._spatialReference,h.tile),R=new H.u_(P,A.getAttributes());R.objectId=A.id,R.displayId=A.displayId,a.push(R)}}catch{return void Xt.error("Unable to get bins for tile",u.key.id)}}_getGeohash(a,u,h){const d={geohashX:0,geohashY:0};return jt(d,u,a,h),d}_getGeohashBounds(a){const u=this._getGeohashLevel(a.key.level),d=ar.Z.fromExtent(ur.Z.fromBounds([a.extent.xmin,a.extent.ymin,a.extent.xmax,a.extent.ymax],this._spatialReference)),f=(0,Ve.iV)(d,this._spatialReference,Xe.Z.WGS84,{densificationStep:64*a.resolution}),p=(0,E.Uy)(new ie.Z,f,!1,!1),y=p.coords.filter((j,te)=>!(te%2)),v=p.coords.filter((j,te)=>te%2),I=Math.min(...y),x=Math.min(...v),A=Math.max(...y),P=Math.max(...v),R=this._getGeohash(I,x,u),G=this._getGeohash(A,P,u);return{xLL:R.geohashX,yLL:R.geohashY,xTR:G.geohashX,yTR:G.geohashY,level:u}}_getGeohashLevel(a){return this._schema.params.fixedBinLevel}_getTransforms(a,u){const h={originPosition:"upperLeft",scale:[a.resolution,a.resolution],translate:[a.bounds[0],a.bounds[3]]},d=(0,$.C5)(u);if(!d)return{tile:h,left:null,right:null};const[f,p]=d.valid;return{tile:h,left:{...h,translate:[p,a.bounds[3]]},right:{...h,translate:[f-p+a.bounds[0],a.bounds[3]]}}}}class qt extends H.nd{constructor(a,u,h,d,f){super(new ie.Z([],[u,h]),d,null,a),this.geohashBoundsInfo=f}get count(){return this.attributes.cluster_count}static create(a,u,h,d,f,p,y,v){const I=new qt(u,h,d,p,y);return I.displayId=a.createDisplayId(!0),I.referenceId=v,I.tileLevel=f,I}update(a,u,h,d,f,p){return this.geometry.coords[0]=a,this.geometry.coords[1]=u,this.tileLevel=h,this.attributes=d,this.geohashBoundsInfo=f,this.referenceId=null,this.referenceId=p,this}toJSON(){return{objectId:this.objectId,referenceId:1===this.attributes.cluster_count?this.referenceId:null,attributes:{...this.attributes,clusterId:this.objectId},geometry:{x:this.geometry.coords[0],y:this.geometry.coords[1]}}}}function It(c){return 57.29577951308232*c}class cr extends fs.J{constructor(a,u,h,d){super(a,h),this.events=new Ft.Z,this._geohashLevel=0,this._tileLevel=0,this._aggregateValueRanges={},this._aggregateValueRangesChanged=!1,this._geohashBuf=[],this._clusters=new Map,this._tiles=new Map,this._serviceInfo=d,this.geometryInfo=a.geometryInfo,this._spatialReference=u,this._projectionSupportCheck=(0,Ve._W)(u,Xe.Z.WGS84),this._bitsets.geohash=h.getBitset(h.createBitset()),this._bitsets.inserted=h.getBitset(h.createBitset())}destroy(){this._tree.destroy()}updateSchema(a,u){var h=()=>super.updateSchema,d=this;return(0,B.Z)(function*(){const f=d._schema;try{yield h().call(d,a,u),yield d._projectionSupportCheck}catch{}const p=(0,De.Hg)(f,u);u&&(!(0,C.Wi)(p)||a.source||a.storage.filters)?(((0,De.uD)(p,"params.fields")||!d._tree||a.source)&&(d._tree&&d._tree.destroy(),d._tree=new gs(d._statisticFields,d._serviceInfo),d._rebuildTree(),(0,M.Z)("esri-2d-update-debug")&&console.debug("Aggregate mesh needs update due to tree changing")),(0,M.Z)("esri-2d-update-debug")&&console.debug("Applying Update - ClusterStore:",p),a.targets[u.name]=!0,a.mesh=!1,d._aggregateValueRanges={}):f&&(a.mesh=!0)})()}clear(){this._rebuildTree()}sweepFeatures(a,u){this._bitsets.inserted.forEachSet(h=>{if(!a.has(h)){const d=u.lookupByDisplayIdUnsafe(h);this._remove(d)}})}sweepAggregates(a,u,h){this._clusters.forEach((d,f)=>{d&&d.tileLevel!==h&&(a.releaseDisplayId(d.displayId),u.unsetAttributeData(d.displayId),this._clusters.delete(f))})}onTileData(a,u,h,d,f=!0){if(!this._schema||(0,C.Wi)(u.addOrUpdate))return u;const p=this._getTransforms(a,this._spatialReference);{const I=u.addOrUpdate.getCursor();for(;I.next();)this._update(I,d)}if(u.status.mesh||!f)return u;const y=new Array;this._getClustersForTile(y,a,this._schema.params.clusterRadius,h,p),u.addOrUpdate=ue.fromOptimizedFeatures(y,this._serviceInfo),u.addOrUpdate.attachStorage(h),u.clear=!0,u.end=!0;{const I=u.addOrUpdate.getCursor();for(;I.next();){const x=I.getDisplayId();this._bitsets.computed.unset(x),this.setComputedAttributes(h,I,x,a.scale)}}return this._aggregateValueRangesChanged&&u.end&&(this.events.emit("valueRangesChanged",{valueRanges:this._aggregateValueRanges}),this._aggregateValueRangesChanged=!1),u}onTileUpdate({added:a,removed:u}){if(a.length){const d=a[0].level;this._tileLevel=d,this._setGeohashLevel(d)}if(!this._schema)return;const h=this._schema.params.clusterRadius;u.forEach(d=>{this._tiles.delete(d.key.id),this._markTileClustersForDeletion(d,h)})}getAggregate(a){for(const u of this._clusters.values())if((u?.displayId&le._I)==(a&le._I))return u.toJSON();return null}getAggregates(){const a=[];for(const u of this._clusters.values())u?.tileLevel===this._tileLevel&&a.push(u.toJSON());return a}getDisplayId(a){const u=this._clusters.get(a);return u?u.displayId:null}getFeatureDisplayIdsForAggregate(a){const u=this._clusters.get(a);if(!u)return[];const h=u.geohashBoundsInfo;return this._tree.getRegionDisplayIds(h.xLL,h.yLL,h.xTR,h.yTR,h.level)}getDisplayIdForReferenceId(a){for(const u of this._clusters.values())if(u?.referenceId===a)return u.displayId;return null}getAggregateValueRanges(){return this._aggregateValueRanges}forEach(a){for(const[u,h]of this._clusters)h&&a(h,u)}size(){let a=0;return this.forEach(u=>a++),a}_rebuildTree(){this._bitsets.computed.clear(),this._bitsets.inserted.clear(),this._tree&&this._tree.clear()}_remove(a){const u=a.getDisplayId(),h=a.getXHydrated(),d=a.getYHydrated(),f=this._geohashBuf[2*u],p=this._geohashBuf[2*u+1];this._bitsets.inserted.has(u)&&(this._bitsets.inserted.unset(u),this._tree.removeCursor(a,h,d,f,p,this._geohashLevel))}_update(a,u){const h=a.getDisplayId(),d=this._bitsets.inserted,f=u.isVisible(h);if(f===d.has(h))return;if(!f)return void this._remove(a);const p=a.getXHydrated(),y=a.getYHydrated();this._setGeohash(h,p,y)&&(this._tree.insertCursor(a,h,p,y,this._geohashBuf[2*h],this._geohashBuf[2*h+1],this._geohashLevel),d.set(h))}_setGeohash(a,u,h){if(this._bitsets.geohash.has(a))return!0;const d=this._geohashBuf;if(this._spatialReference.isWebMercator){const f=It(u/qe.sv.radius),p=f-360*Math.floor((f+180)/360);Dt(d,a,It(Math.PI/2-2*Math.atan(Math.exp(-h/qe.sv.radius))),p,12)}else{const f=(0,Ve.iV)({x:u,y:h},this._spatialReference,Xe.Z.WGS84);if(!f)return!1;Dt(d,a,f.y,f.x,12)}return this._bitsets.geohash.set(a),!0}_getClustersForTile(a,u,h,d,f,p=!0){const y=this._schema.params.clusterPixelBuffer,v=2*h,I=this._getGeohashLevel(u.key.level),x=Math.ceil(2**u.key.level*Me.I_/v),A=Math.ceil(y/v)+0,P=Math.ceil(Me.I_/v),{row:R,col:G}=u.key,te=R*Me.I_,Q=Math.floor(G*Me.I_/v)-A,se=Math.floor(te/v)-A,ee=Q+P+2*A,ne=se+P+2*A,oe=u.tileInfoView.getLODInfoAt(u.key.level);for(let J=Q;J<=ee;J++)for(let de=se;de<=ne;de++){let ye=J;oe.wrap&&(ye=J<0?J+x:J%x);const he=oe.wrap&&J<0,pe=oe.wrap&&J%x!==J,ce=this._lookupCluster(d,oe,u.key.level,ye,de,I);if((0,C.pC)(ce)){const Ae=(0,C.yw)(f,Te=>he?Te.left:pe?Te.right:Te.tile);if(p&&(0,C.Wi)(Ae)||!ce.count)continue;if((0,C.pC)(Ae)&&p){const Te=ce.geometry.clone();let be=ce.attributes;Te.coords[0]=(0,E.Jd)(Ae,Te.coords[0]),Te.coords[1]=(0,E.IN)(Ae,Te.coords[1]),1===ce.count&&(0,C.pC)(ce.referenceId)&&(be={...ce.attributes,referenceId:ce.referenceId});const ve=new H.u_(Te,be);ve.displayId=ce.displayId,a.push(ve)}}}}_getGeohashLevel(a){return Math.min(Math.ceil(a/2+2),12)}_setGeohashLevel(a){const u=this._getGeohashLevel(a),h=1*(Math.floor(u/1)+1)-1;if(this._geohashLevel!==h)return this._geohashLevel=h,this._rebuildTree(),void this._bitsets.geohash.clear()}_getTransforms(a,u){const h={originPosition:"upperLeft",scale:[a.resolution,a.resolution],translate:[a.bounds[0],a.bounds[3]]},d=(0,$.C5)(u);if(!d)return{tile:h,left:null,right:null};const[f,p]=d.valid;return{tile:h,left:{...h,translate:[p,a.bounds[3]]},right:{...h,translate:[f-p+a.bounds[0],a.bounds[3]]}}}_getClusterId(a,u,h){return(15&a)<<28|(16383&u)<<14|16383&h}_markForDeletion(a,u,h){const d=this._getClusterId(a,u,h);this._clusters.delete(d)}_getClusterBounds(a,u,h){const d=this._schema.params.clusterRadius,f=2*d;let p=h%2?u*f:u*f-d;const y=h*f;let v=p+f;const x=2**a.level*Me.I_;a.wrap&&p<0&&(p=0),a.wrap&&v>x&&(v=x);const P=y/Me.I_,R=v/Me.I_,G=(y-f)/Me.I_;return[a.getXForColumn(p/Me.I_),a.getYForRow(P),a.getXForColumn(R),a.getYForRow(G)]}_lookupCluster(a,u,h,d,f,p){const y=this._getClusterId(h,d,f),v=this._clusters.get(y),[I,x,A,P]=this._getClusterBounds(u,d,f),R={x:I,y:x},G={x:A,y:P};let j=0,te=0,Q=0,se=0;if(this._spatialReference.isWebMercator){{const _e=It(R.x/qe.sv.radius);j=_e-360*Math.floor((_e+180)/360),te=It(Math.PI/2-2*Math.atan(Math.exp(-R.y/qe.sv.radius)))}{const _e=It(G.x/qe.sv.radius);Q=_e-360*Math.floor((_e+180)/360),se=It(Math.PI/2-2*Math.atan(Math.exp(-G.y/qe.sv.radius)))}}else{const _e=(0,Ve.iV)(R,this._spatialReference,Xe.Z.WGS84),Ee=(0,Ve.iV)(G,this._spatialReference,Xe.Z.WGS84);if(!_e||!Ee)return null;j=_e.x,te=_e.y,Q=Ee.x,se=Ee.y}const ee={geohashX:0,geohashY:0},ne={geohashX:0,geohashY:0};jt(ee,te,j,p),jt(ne,se,Q,p);const oe=ee.geohashX,J=ee.geohashY,de=ne.geohashX,ye=ne.geohashY,he={xLL:oe,yLL:J,xTR:de,yTR:ye,level:p},pe=this._tree.getRegionStatistics(oe,J,de,ye,p),{count:ce,xTotal:Ae,yTotal:Te,referenceId:be}=pe,ve=ce?Ae/ce:0,Ce=ce?Te/ce:0;if(0===ce)return this._clusters.set(y,null),null;const Fe={cluster_count:ce,...pe.attributes},xe=(0,C.pC)(v)?v.update(ve,Ce,h,Fe,he,be):qt.create(a,y,ve,Ce,h,Fe,he,be);return 0===ce&&(xe.geometry.coords[0]=(I+A)/2,xe.geometry.coords[1]=(x+P)/2),this._clusters.set(y,xe),this._updateAggregateValueRangeForCluster(xe,xe.tileLevel),xe}_updateAggregateValueRangeForCluster(a,u){const h=this._aggregateValueRanges[u]||{minValue:1/0,maxValue:0},d=h.minValue,f=h.maxValue;h.minValue=Math.min(d,a.count),h.maxValue=Math.max(f,a.count),this._aggregateValueRanges[u]=h,d===h.minValue&&f===h.maxValue||(this._aggregateValueRangesChanged=!0)}_markTileClustersForDeletion(a,u){const h=2*u,d=Math.ceil(Me.I_/h),{row:f,col:p}=a.key,v=f*Me.I_,I=Math.floor(p*Me.I_/h),x=Math.floor(v/h);for(let A=I;A<I+d;A++)for(let P=x;P<x+d;P++)this._markForDeletion(a.key.level,A,P)}}class gr{constructor(){this._freeIds=[],this._idCounter=1}createId(a=!1){return(0,le.QS)(this._getFreeId(),a)}releaseId(a){this._freeIds.push(a)}_getFreeId(){return this._freeIds.length?this._freeIds.pop():this._idCounter++}}var fr=T(42797);function Bt(c,a,u){if(!(c.length>a))for(;c.length<=a;)c.push(u)}class pr{constructor(){this._numerics=[],this._strings=[],this._idGenerator=new gr,this._allocatedSize=256,this._bitsets=[],this._instanceIds=[],this._bounds=[]}createBitset(){const a=this._bitsets.length;return this._bitsets.push(fr.p.create(this._allocatedSize,le._I)),a+1}getBitset(a){return this._bitsets[a-1]}_expand(){this._allocatedSize<<=1;for(const a of this._bitsets)a.resize(this._allocatedSize)}_ensureNumeric(a,u){this._numerics[a]||(this._numerics[a]=[]),Bt(this._numerics[a],u,0)}_ensureInstanceId(a){Bt(this._instanceIds,a,0)}_ensureString(a,u){this._strings[a]||(this._strings[a]=[]),Bt(this._strings[a],u,null)}createDisplayId(a=!1){const u=this._idGenerator.createId();return u>this._allocatedSize&&this._expand(),(0,le.QS)(u,a)}releaseDisplayId(a){for(const u of this._bitsets)u.unset(a);return this._idGenerator.releaseId(a&le._I)}getComputedNumeric(a,u){return this.getComputedNumericAtIndex(a&le._I,0)}setComputedNumeric(a,u,h){return this.setComputedNumericAtIndex(a&le._I,h,0)}getComputedString(a,u){return this.getComputedStringAtIndex(a&le._I,0)}setComputedString(a,u,h){return this.setComputedStringAtIndex(a&le._I,0,h)}getComputedNumericAtIndex(a,u){const h=a&le._I;return this._ensureNumeric(u,h),this._numerics[u][h]}setComputedNumericAtIndex(a,u,h){const d=a&le._I;this._ensureNumeric(u,d),this._numerics[u][d]=h}getInstanceId(a){const u=a&le._I;return this._ensureInstanceId(u),this._instanceIds[u]}setInstanceId(a,u){const h=a&le._I;this._ensureInstanceId(h),this._instanceIds[h]=u}getComputedStringAtIndex(a,u){const h=a&le._I;return this._ensureString(u,h),this._strings[u][h]}setComputedStringAtIndex(a,u,h){const d=a&le._I;this._ensureString(u,d),this._strings[u][d]=h}getXMin(a){return this._bounds[4*(a&le._I)]}getYMin(a){return this._bounds[4*(a&le._I)+1]}getXMax(a){return this._bounds[4*(a&le._I)+2]}getYMax(a){return this._bounds[4*(a&le._I)+3]}setBounds(a,u){const h=u.readHydratedGeometry();if(!h||!h.coords.length)return!1;let d=1/0,f=1/0,p=-1/0,y=-1/0;h.forEachVertex((I,x)=>{d=Math.min(d,I),f=Math.min(f,x),p=Math.max(p,I),y=Math.max(y,x)});const v=a&le._I;return Bt(this._bounds,4*v+4,0),this._bounds[4*v]=d,this._bounds[4*v+1]=f,this._bounds[4*v+2]=p,this._bounds[4*v+3]=y,!0}}function Qe(c){if(!(0,N.D_)(c)&&!function vr(c){return"worker:port-closed"===c.name}(c))throw c}function ys(c){return"feature"===c.type&&"snapshot"===c.mode}let Ue=class extends k.r{constructor(){super(...arguments),this._storage=new pr,this._markedIdsBufId=this._storage.createBitset(),this._lastCleanup=performance.now(),this._cleanupNeeded=!1,this._invalidated=!1,this._tileToResolver=new Map,this._didEdit=!1,this._updateVersion=1,this.tileStore=null,this.config=null,this.processor=null,this.remoteClient=null,this.service=null}initialize(){this._initStores(),this._initSource(),this._updateQueue=new zt.e({concurrency:"geoevent"===this._source.type?1:4,process:(c,a)=>this._onTileMessage(c,{signal:a})}),this.handles.add([this.tileStore.on("update",this.onTileUpdate.bind(this)),(0,L.gx)(()=>!this.updating,()=>this.onIdle())]),this._checkUpdating=setInterval(()=>this.notifyChange("updating"),300)}_initSource(){this._source=function ks(c,a,u,h,d,f){const p=function js(c,a,u,h,d,f){switch(c.type){case"snapshot":return{type:"feature",origin:"snapshot",featureCount:(0,C.Pt)(c.featureCount,0),serviceInfo:c,onMessage:h,outSR:a,tileInfoView:u,canAcceptRequest:d,store:f};case"stream":return{type:"geoevent",serviceInfo:c,onMessage:h,outSR:a,canAcceptRequest:d};case"memory":case"on-demand":return{type:"feature",serviceInfo:c,onMessage:h,outSR:a,origin:function p(y){return Array.isArray(y)?"local":"path"in y&&(0,S.M8)(y.path)?"hosted":"unknown"}(c.source),tileInfoView:u,canAcceptRequest:d}}}(c,a,u,h,d,f);switch(p.type){case"feature":switch(p.origin){case"hosted":case"local":return new Os(p);case"snapshot":return new Gs(p);case"unknown":return new Cs(p)}case"geoevent":return new Us(p)}}(this.service,this.spatialReference,this.tileStore.tileScheme,(h,d)=>(this._invalidated=!0,this._patchTile(h,d)),()=>this._updateQueue.length<50,this.featureStore),this._proxyEvents()}_proxyEvents(){if("geoevent"===this._source.type){const c=this._source.events;this.handles.add([c.on("connectionStatus",a=>this.remoteClient.invoke("setProperty",{propertyName:"connectionStatus",value:a}).catch(Qe)),c.on("errorString",a=>this.remoteClient.invoke("setProperty",{propertyName:"errorString",value:a}).catch(Qe)),c.on("feature",a=>this.remoteClient.invoke("emitEvent",{name:"data-received",event:{attributes:a.attributes,centroid:a.centroid,geometry:a.geometry}}).catch(Qe)),c.on("updateRate",a=>this.remoteClient.invoke("emitEvent",{name:"update-rate",event:{...a}}).catch(Qe))])}}_initAttributeStore(c){this.attributeStore?this.attributeStore.invalidateResources():this.attributeStore=new er({type:"remote",initialize:(a,u)=>(0,N.R8)(this.remoteClient.invoke("tileRenderer.featuresView.attributeView.initialize",a,{signal:u}).catch(Qe)),update:(a,u)=>(0,N.R8)(this.remoteClient.invoke("tileRenderer.featuresView.attributeView.requestUpdate",a,{signal:u}).catch(Qe)),render:a=>(0,N.R8)(this.remoteClient.invoke("tileRenderer.featuresView.requestRender",void 0,{signal:a}).catch(Qe))},c,()=>this.notifyChange("updating"))}_initStores(){this.featureStore=new m.p({geometryInfo:{geometryType:this.service.geometryType,hasM:!1,hasZ:!1},spatialReference:this.spatialReference,fieldsIndex:this.fieldsIndex,fields:this.service.fields},this._storage,"snapshot"===this.service.type?"snapshot":"on-demand")}_initQueryEngine(c){const a=this;this.queryEngine?.destroy(),this.queryEngine=new U.q({definitionExpression:c.schema.source.definitionExpression,fields:this.service.fields,geometryType:this.service.geometryType,objectIdField:this.service.objectIdField,hasM:!1,hasZ:!1,spatialReference:this.spatialReference.toJSON(),cacheSpatialQueries:!0,featureStore:this.featureStore,aggregateAdapter:{getFeatureObjectIds:u=>(0,C.Wi)(a.aggregateStore)?[]:a.aggregateStore.getFeatureDisplayIdsForAggregate(u).map(h=>a.getObjectId(h))},timeInfo:this.service.timeInfo})}destroy(){this._updateQueue.destroy(),this._source.destroy(),this.queryEngine.destroy(),this.attributeStore&&this.attributeStore.destroy();for(const c of this.tileStore.tiles)this._source.unsubscribe(c);clearInterval(this._checkUpdating)}get fieldsIndex(){return new _.Z(this.service.fields)}get spatialReference(){return this.tileStore.tileScheme.spatialReference}get updating(){return this.isUpdating()}isUpdating(){const c=this._source.updating,a=!!this._updateQueue.length,u=!this.attributeStore||this.attributeStore.isUpdating(),h=c||a||u;return(0,M.Z)("esri-2d-log-updating")&&console.log(`Updating FeatureController2D: ${h}\n  -> updatingSource ${c}\n  -> updateQueue ${a}\n  -> updatingAttributeStore ${u}\n`),h}enableEvent(c){this._source.enableEvent(c.name,c.value)}pause(){this._updateQueue.pause(),this._updateQueue.clear()}resume(){this._updateQueue.resume()}pauseStream(){"geoevent"===this._source.type&&this._source.pauseStream()}resumeStream(){"geoevent"===this._source.type&&this._source.resumeStream()}_initAggregateStore(c){const a={geometryInfo:{geometryType:this.service.geometryType,hasM:!1,hasZ:!1},spatialReference:this.spatialReference,fieldsIndex:this.fieldsIndex,fields:this.service.fields},u=c.schema.targets?.aggregate?.type;if((0,C.yw)(this.config,d=>d.schema.targets?.aggregate?.type)!==u&&((0,C.pC)(this.aggregateStore)&&(this.handles.remove("valueRangesChanged"),this.aggregateStore.destroy(),this.aggregateStore=null),u)){switch(u){case"cluster":this.aggregateStore=new cr(a,this.spatialReference,this._storage,this.service),this.handles.add(this.aggregateStore.events.on("valueRangesChanged",d=>{this.remoteClient.invoke("emitEvent",{name:"valueRangesChanged",event:{valueRanges:d.valueRanges}}).catch(Qe)}),"valueRangesChanged");break;case"bin":this.aggregateStore=new dr(a,this.spatialReference,this._storage,this.service)}this.aggregateStore.onTileUpdate({added:this.tileStore.tiles,removed:[]})}}update(c,a){var u=this;return(0,B.Z)(function*(){u._updateVersion++,u._initQueryEngine(a),u._initAttributeStore(a),u.pause(),yield Promise.all([u._source.update(c,a.schema.source),u.featureStore.updateSchema(c,a.schema.targets.feature),u.attributeStore.update(c,a),u.attributeStore.updateFilters(c,a,u)]),u._initAggregateStore(a),(0,C.pC)(u.aggregateStore)&&(yield u.aggregateStore.updateSchema(c,a.schema.targets.aggregate)),(0,M.Z)("esri-2d-update-debug")&&c.describe(),u._set("config",a)})()}applyUpdate(c){var a=this;return(0,B.Z)(function*(){c.version=a._updateVersion,(0,M.Z)("esri-2d-update-debug")&&console.debug(`Applying update ${c.version}`),c.mesh&&a.clearTiles(),a._updateQueue.resume(),yield a._source.applyUpdate(c),a.notifyChange("updating"),yield(0,L.N1)(()=>!a.updating),(0,C.pC)(a.aggregateStore)&&(yield(0,N.e4)(10),yield(0,L.N1)(()=>!a.updating))})()}onEdits({edits:c}){var a=this;return(0,B.Z)(function*(){(0,M.Z)("esri-2d-update-debug")&&console.debug("Applying Edit:",c),a._didEdit=!0;try{const u=c.removed.map(d=>d.objectId&&-1!==d.objectId?d.objectId:a._lookupObjectIdByGlobalId(d.globalId)),h=c.addOrModified.map(({objectId:d})=>d);a.featureStore.invalidate(),yield a._source.edit(h,u),a.clearTiles(),a.notifyChange("updating"),(0,C.pC)(a.aggregateStore)&&a.aggregateStore.clear(),yield a._source.resend(),yield(0,L.N1)(()=>!a.updating)}catch{}})()}refresh(c){var a=this;return(0,B.Z)(function*(){if(!c){const u=Se.empty();return u.storage.filters=!0,a.applyUpdate(u)}a.featureStore.invalidate(),a.clearTiles(),a._source.refresh(a._updateVersion),a._cleanupNeeded=!0,a.notifyChange("updating"),yield(0,L.N1)(()=>!a.updating)})()}clearTiles(){for(const c of this.tileStore.tiles)this.processor.onTileClear(c)}onTileUpdate(c){(0,C.pC)(this.aggregateStore)&&this.aggregateStore.onTileUpdate(c);for(const a of c.added)this._source.subscribe(a,this._updateVersion),this._level=a.level;for(const a of c.removed)this._source.unsubscribe(a),this._cleanupNeeded=!0,this._tileToResolver.has(a.id)&&(this._tileToResolver.get(a.id).resolve(),this._tileToResolver.delete(a.id));this.notifyChange("updating")}onIdle(){var c=this;return(0,B.Z)(function*(){c._invalidated&&(c._invalidated=!1,((0,C.pC)(c.aggregateStore)||"heatmap"===c.processor.type)&&(yield c._repushCurrentLevelTiles())),c._markAndSweep()})()}querySummaryStatistics({query:c,params:a}){var u=this;return(0,B.Z)(function*(){return u.queryEngine.executeQueryForSummaryStatistics(c,a)})()}queryUniqueValues({query:c,params:a}){var u=this;return(0,B.Z)(function*(){return u.queryEngine.executeQueryForUniqueValues(c,a)})()}queryClassBreaks({query:c,params:a}){var u=this;return(0,B.Z)(function*(){return u.queryEngine.executeQueryForClassBreaks(c,a)})()}queryHistogram({query:c,params:a}){var u=this;return(0,B.Z)(function*(){return u.queryEngine.executeQueryForHistogram(c,a)})()}queryExtent(c){return this.queryEngine.executeQueryForExtent(c)}queryFeatures(c){return this.queryEngine.executeQuery(c)}queryVisibleFeatures(c){var a=this;return(0,B.Z)(function*(){const u=yield a.queryEngine.executeQuery(c),h=u.objectIdFieldName;return u.features=u.features.filter(d=>{const p=a.getDisplayId(d.attributes[h]);return(0,C.yw)(p,y=>a.attributeStore.isVisible(y))}),u})()}queryFeatureCount(c){return this.queryEngine.executeQueryForCount(c)}queryLatestObservations(c){return this.queryEngine.executeQueryForLatestObservations(c)}queryObjectIds(c){return this.queryEngine.executeQueryForIds(c)}queryStatistics(){var c=this;return(0,B.Z)(function*(){return c.featureStore.storeStatistics})()}getObjectId(c){return this.featureStore.lookupObjectId(c,this._storage)}getDisplayId(c){if((0,C.pC)(this.aggregateStore)){const a=this.aggregateStore.getDisplayId(c);if((0,C.Wi)(a)){const u=this.featureStore.lookupDisplayId(c);return this.aggregateStore.getDisplayIdForReferenceId(u)}return a}return this.featureStore.lookupDisplayId(c)}getFeatures(c){const a=[],u=[];for(const h of c){const d=(0,C.pC)(this.aggregateStore)?this.getAggregate(h):null;if((0,C.pC)(d))if((0,C.pC)(d.referenceId)){const f=this.getFeature(d.referenceId);(0,C.pC)(f)&&a.push(f)}else u.push(d);else{const f=this.getFeature(h);(0,C.pC)(f)&&a.push(f)}}return{features:a,aggregates:u}}getFeature(c){const a=this.featureStore.lookupFeatureByDisplayId(c,this._storage);if((0,C.Wi)(a))return null;const u=a.readHydratedGeometry(),h=(0,E.di)(u,a.geometryType,a.hasZ,a.hasM);return{attributes:a.readAttributes(),geometry:h}}getAggregate(c){return(0,C.Wi)(this.aggregateStore)?null:this.aggregateStore.getAggregate(c)}getAggregates(){return(0,C.Wi)(this.aggregateStore)?[]:this.aggregateStore.getAggregates()}setHighlight(c){var a=this;return(0,B.Z)(function*(){const u=(0,C.lV)(c.map(h=>a.getDisplayId(h)));return a.attributeStore.setHighlight(c,u)})()}_lookupObjectIdByGlobalId(c){const a=this.service.globalIdField;if((0,C.Wi)(a))throw new Error("Expected globalIdField to be defined");let u=null;if(this.featureStore.forEach(h=>{c===h.readAttribute(a)&&(u=h.getObjectId())}),(0,C.Wi)(u))throw new Error(`Expected to find a feature with globalId ${c}`);return u}_repushCurrentLevelTiles(){var c=this;return(0,B.Z)(function*(){const a=c.tileStore.tiles.filter(u=>u.level===c._level).map(function(){var u=(0,B.Z)(function*(h){return c._patchTile({type:"append",id:h.key.id,addOrUpdate:ue.fromOptimizedFeatures([],c.service),remove:[],end:!0,status:Se.empty()})});return function(h){return u.apply(this,arguments)}}());yield Promise.all(a)})()}_maybeForceCleanup(){performance.now()-this._lastCleanup>5e3&&this._markAndSweep()}_patchTile(c,a){const u=this._updateQueue.push(c,a).then(()=>{this.notifyChange("updating")}).catch(h=>{this.notifyChange("updating")});return this.notifyChange("updating"),u}_onTileMessage(c,a){var u=this;return(0,B.Z)(function*(){(0,N.k_)(a);const h=u.tileStore.get(c.id);if(!h)return;if(c.clear)return u.processor.onTileClear(h);const d=c.status;u._cleanupNeeded=!0;const f=[];for(const p of c.remove){const y=u.featureStore.lookupDisplayId(p);y&&f.push(y)}c.remove=f;try{if((0,C.Wi)(c.addOrUpdate))return void u.processor.onTileMessage(h,{...c,addOrUpdate:null},(0,C.pC)(u.aggregateStore),a).catch(N.H9);if(c.addOrUpdate.setArcadeSpatialReference(u.spatialReference),u.featureStore.hasInstance(c.addOrUpdate.instance)&&d.targets.feature||(d.targets.feature=!0,u.featureStore.onTileData(h,c)),(!d.storage.data||!d.storage.filters)&&(d.storage.data=!0,d.storage.filters=!0,u.attributeStore.onTileData(h,c),"geoevent"===u._source.type||u._didEdit?(yield u.attributeStore.sendUpdates(),(0,N.k_)(a)):u.attributeStore.sendUpdates()),(0,C.pC)(u.aggregateStore)&&!d.targets.aggregate){d.targets.aggregate=!0;const p=ys(u._source)&&u._source.loading,y=!ys(u._source)||p||c.end;if(u.aggregateStore.onTileData(h,c,u._storage,u.attributeStore,y),!y)return;d.mesh||(u.attributeStore.onTileData(h,c),yield u.attributeStore.sendUpdates())}d.mesh||(d.mesh=!0,yield u.processor.onTileMessage(h,c,(0,C.pC)(u.aggregateStore),a),(0,N.k_)(a)),u._maybeForceCleanup()}catch(p){(0,N.H9)(p)}})()}_mark(c,a,u){const h=(4294901760&this._storage.getInstanceId(c))>>>16;c&&(a.add(h),u.set(c))}_markAndSweep(){if(this._lastCleanup=performance.now(),"feature"===this._source.type&&"snapshot"===this._source.mode||"geoevent"!==this._source.type&&!this._cleanupNeeded)return;this._cleanupNeeded=!1;const c=this._storage.getBitset(this._markedIdsBufId),a=new Set;c.clear();for(const u of this.tileStore.tiles)for(const h of this._source.readers(u.id)){const d=h.getCursor();for(;d.next();){let f=d.getDisplayId();if(!f){const p=d.getObjectId();f=this.featureStore.lookupDisplayId(p)}this._mark(f,a,c)}}"symbol"===this.processor.type&&this.processor.forEachBufferId(u=>{this._mark(u,a,c)}),this._updateQueue.forEach(u=>{for(const h of u.remove){const d=this.featureStore.lookupDisplayId(h);this._mark(d,a,c)}}),(0,C.pC)(this.aggregateStore)&&(this.aggregateStore.sweepFeatures(c,this.featureStore),"sweepAggregates"in this.aggregateStore&&this.aggregateStore.sweepAggregates(this._storage,this.attributeStore,this._level)),this.featureStore.sweepFeatures(c,this._storage,this.attributeStore),this.featureStore.sweepFeatureSets(a)}};(0,K._)([(0,Y.Cb)({constructOnly:!0})],Ue.prototype,"tileStore",void 0),(0,K._)([(0,Y.Cb)()],Ue.prototype,"config",void 0),(0,K._)([(0,Y.Cb)({readOnly:!0})],Ue.prototype,"fieldsIndex",null),(0,K._)([(0,Y.Cb)()],Ue.prototype,"processor",void 0),(0,K._)([(0,Y.Cb)({constructOnly:!0})],Ue.prototype,"remoteClient",void 0),(0,K._)([(0,Y.Cb)({constructOnly:!0})],Ue.prototype,"service",void 0),(0,K._)([(0,Y.Cb)()],Ue.prototype,"spatialReference",null),(0,K._)([(0,Y.Cb)()],Ue.prototype,"updating",null),Ue=(0,K._)([(0,X.j)("esri.views.2d.layers.features.controllers.FeatureController2D")],Ue);const xr=Ue;var Is=T(81340),Sr=T(84378),br=T(58098);const nt={added:[],removed:[]},Qt=new Set,Cr=new br.Z(0,0,0,0);class Fr extends Ft.Z{constructor(a){super(),this._tiles=new Map,this._index=(0,Jt.r)(9,(0,M.Z)("esri-csp-restrictions")?u=>({minX:u.bounds[0],minY:u.bounds[1],maxX:u.bounds[2],maxY:u.bounds[3]}):[".bounds[0]",".bounds[1]",".bounds[2]",".bounds[3]"]),this.tiles=[],this.tileScheme=a}destroy(){this.clear()}clear(){this.tiles.length=0,this._tiles.clear(),this._index.clear()}has(a){return this._tiles.has(a)}get(a){return this._tiles.get(a)}boundsIntersections(a){return this._index.search({minX:a[0],minY:a[1],maxX:a[2],maxY:a[3]})}updateTiles(a){const u={added:[],removed:[]};for(const h of a.added)if(!this.has(h)){const d=new Is.n(this.tileScheme,h);this._tiles.set(h,d),this._index.insert(d),u.added.push(d)}for(const h of a.removed)if(this.has(h)){const d=this.get(h);this._tiles.delete(h),this._index.remove(d),u.removed.push(d)}this.tiles.length=0,this._tiles.forEach(h=>this.tiles.push(h)),(u.added.length||u.removed.length)&&this.emit("update",u)}setViewState(a){const u=this.tileScheme.getTileCoverage(a,0);if(!u)return;const{spans:h,lodInfo:d}=u,{level:f}=d;if(h.length>0)for(const{row:p,colFrom:y,colTo:v}of h)for(let I=y;I<=v;I++){const x=Cr.set(f,p,d.normalizeCol(I),d.getWorldForColumn(I)).id;if(Qt.add(x),!this.has(x)){const A=new Is.n(this.tileScheme,x);this._tiles.set(x,A),this._index.insert(A),this.tiles.push(A),nt.added.push(A)}}for(let p=this.tiles.length-1;p>=0;p--){const y=this.tiles[p];Qt.has(y.id)||(this._tiles.delete(y.id),this.tiles.splice(p,1),this._index.remove(y),nt.removed.push(y))}(nt.added.length||nt.removed.length)&&this.emit("update",nt),Sr.Z.pool.release(u),Qt.clear(),nt.added.length=0,nt.removed.length=0}}var Mr=T(9598);let ot=class extends k.r{constructor(){super(...arguments),this.controller=null,this.processor=null,this.remoteClient=null,this.tileStore=null,this.service=null,this.viewState=null,this._paused=!1,this._pendingTileUpdates=[]}initialize(){this.handles.add((0,L.YP)(()=>this.updating,c=>{this.remoteClient.invoke("setUpdating",c).catch(a=>{})}))}destroy(){this.stop(),this.controller?.destroy(),this.processor?.destroy(),this.controller=this.processor=this.tileStore=this.remoteClient=null}get updating(){return!this.controller||this.controller.updating}stop(){this._paused=!0,Array.isArray(this.service?.source)&&(this.service.source.forEach(c=>c.close()),this.service.source.length=0),this.tileStore?.updateTiles({added:[],removed:this.tileStore.tiles.map(c=>c.id)}),this.tileStore?.destroy(),this.tileStore=null,this._pendingTileUpdates.length=0}startup({service:c,config:a,tileInfo:u,tiles:h}){var d=this;return(0,B.Z)(function*(){if(d._paused=!0,Array.isArray(d.service?.source)&&(d.service.source.forEach(f=>f.close()),d.service.source.length=0),d.service=c,!d.tileStore||!(0,$.fS)(d.tileStore.tileScheme.spatialReference,u.spatialReference)){const f=new Mr.Z(W.Z.fromJSON(u));h.added.length=h.removed.length=0,d.tileStore?.updateTiles({added:[],removed:d.tileStore.tiles.map(p=>p.id)}),d.tileStore?.destroy(),d.tileStore=new Fr(f),d._pendingTileUpdates.length=0}for(yield d._createProcessorAndController(a),yield d.update({config:a}),d.controller.resume(),d.tileStore.clear(),d.tileStore.updateTiles(h),d._paused=!1;d._pendingTileUpdates.length;)d.tileStore.updateTiles(d._pendingTileUpdates.pop())})()}updateTiles(c){var a=this;return(0,B.Z)(function*(){a._paused?a._pendingTileUpdates.push(c):a.tileStore.updateTiles(c)})()}update({config:c}){var a=this;return(0,B.Z)(function*(){const u=Se.empty();return yield Promise.all([a.processor.update(u,c),a.controller.update(u,c)]),u.toJSON()})()}applyUpdate(c){var a=this;return(0,B.Z)(function*(){return a.controller.applyUpdate(Se.create(c))})()}_createProcessorAndController(c){var a=this;return(0,B.Z)(function*(){yield Promise.all([a._handleControllerConfig(c),a._handleProcessorConfig(c)]),a.controller.processor=a.processor})()}_handleControllerConfig(c){var a=this;return(0,B.Z)(function*(){return a._createController(a.service,c)})()}_handleProcessorConfig(c){var a=this;return(0,B.Z)(function*(){return a._createProcessor(a.service,c)})()}_createController(c,a){var u=this;return(0,B.Z)(function*(){u.controller&&u.controller.destroy();const{tileStore:h,remoteClient:d}=u,f=new xr({service:c,tileStore:h,remoteClient:d});return u.controller=f,f})()}_createProcessor(c,a){var u=this;return(0,B.Z)(function*(){const h=a.schema.processors[0].type,d=(yield function V(c){return"heatmap"===c?Promise.all([T.e(8592),T.e(7434)]).then(T.bind(T,67434)):Promise.all([T.e(3751),T.e(4654),T.e(3141),T.e(4522),T.e(8592),T.e(8460)]).then(T.bind(T,28460))}(h)).default,{remoteClient:f,tileStore:p}=u,y=new d({service:c,config:a,tileStore:p,remoteClient:f});return u.processor&&u.processor.destroy(),u.processor=y,y})()}};(0,K._)([(0,Y.Cb)()],ot.prototype,"controller",void 0),(0,K._)([(0,Y.Cb)()],ot.prototype,"processor",void 0),(0,K._)([(0,Y.Cb)()],ot.prototype,"updating",null),(0,K._)([(0,Y.Cb)()],ot.prototype,"viewState",void 0),ot=(0,K._)([(0,X.j)("esri.views.2d.layers.features.Pipeline")],ot);const Tr=ot},16669:(we,ge,T)=>{T.d(ge,{J:()=>X});var B=T(15861),K=T(8314),k=T(62208),M=T(84682),L=T(46679),Y=T(63290);const Z=Promise.resolve().then(T.bind(T,22445));class X{constructor(W,V){this._canCacheExpressionValue=!1,this._sourceInfo=W,this._storage=V,this._bitsets={computed:V.getBitset(V.createBitset())}}get storage(){return this._storage}invalidate(){this._bitsets.computed.clear()}updateSchema(W,V){var C=this;return(0,B.Z)(function*(){const N=(0,M.Hg)(C._schema,V);if(C._schema=V,!V||(0,k.Wi)(N)||!(0,M.uD)(N,"attributes"))return;(0,K.Z)("esri-2d-update-debug")&&console.debug("Applying Update - Store:",N),C._bitsets.computed.clear(),W.targets[V.name]=!0;const E=V.attributes,U=[],_=[];for(const m in E){const S=E[m];switch(S.type){case"field":break;case"expression":U.push(C._createArcadeComputedField(S));break;case"label-expression":U.push(C._createLabelArcadeComputedField(S));break;case"statistic":_.push(S)}}C._computedFields=yield Promise.all(U),C._canCacheExpressionValue=!C._computedFields.some(m=>"expression"===m.type&&m.expression.referencesScale()),C._statisticFields=_})()}setComputedAttributes(W,V,C,N){const E=this._bitsets.computed;if(!this._canCacheExpressionValue||!E.has(C)){E.set(C);for(const U of this._computedFields){const _=this._evaluateField(V,U,N);switch(U.resultType){case"numeric":W.setComputedNumericAtIndex(C,U.fieldIndex,_);break;case"string":W.setComputedStringAtIndex(C,U.fieldIndex,_)}}}}_createArcadeComputedField(W){var V=this;return(0,B.Z)(function*(){const C=V._sourceInfo.spatialReference,N=V._sourceInfo.fieldsIndex;return{...W,expression:yield(0,L.Yi)(W.valueExpression,C,N)}})()}_createLabelArcadeComputedField(W){var V=this;return(0,B.Z)(function*(){const C=V._sourceInfo.spatialReference,N=V._sourceInfo.fieldsIndex,{createLabelFunction:E}=yield Z,U=yield E(W.label,N,C);return{...W,builder:U}})()}_evaluateField(W,V,C){switch(V.type){case"label-expression":{const N=W.readArcadeFeature();return V.builder.evaluate(N)||""}case"expression":{const{expression:N}=V;return function re($,W,V){$.referencesGeometry();const C=W.readArcadeFeature();try{return $.evaluate({...V,$feature:C})}catch(N){return Y.Z.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",N),null}}(N,W,{$view:{scale:C}})}}}}},25208:(we,ge,T)=>{T.d(ge,{s:()=>w}),T(29132);var K=T(8314),k=T(62208),M=T(77044),L=T(82054),Y=T(88071),re=T(42797),Z=T(91179);let X=0;const $=(0,K.Z)("featurelayer-simplify-thresholds")??[.5,.5,.5,.5],W=$[0],V=$[1],C=$[2],N=$[3],E=(0,K.Z)("featurelayer-simplify-payload-size-factors")??[1,2,4],U=E[0],_=E[1],m=E[2],S=(0,K.Z)("featurelayer-simplify-mobile-factor")??2,F=(0,K.Z)("esri-mobile");class w{constructor(b,D){this.type="FeatureSetReader",this.arcadeDeclaredClass="esri.arcade.Feature",this.seen=!1,this.instance=0,this._tx=0,this._ty=0,this._sx=1,this._sy=1,this._deleted=null,this._joined=[],this._objectIdToIndex=null,this._level=0,this.instance=b,this._layerSchema=D}static createInstance(){return X++,X=X>65535?0:X,X}get isEmpty(){return(0,k.pC)(this._deleted)&&this._deleted.countSet()===this.getSize()}set level(b){this._level=b}getAreaSimplificationThreshold(b,D){let z=1;const q=F?S:1;D>4e6?z=m*q:D>1e6?z=_*q:D>5e5?z=U*q:D>1e5&&(z=q);let H=0;b>4e3?H=N*z:b>2e3?H=C*z:b>100?H=V:b>15&&(H=W);let ae=8;return this._level<4?ae=1:this._level<5?ae=2:this._level<6&&(ae=4),H*ae}setArcadeSpatialReference(b){this._arcadeSpatialReference=b}attachStorage(b){this._storage=b}getQuantizationTransform(){throw new Error("Unable to find transform for featureSet")}getStorage(){return this._storage}getComputedNumeric(b){return this.getComputedNumericAtIndex(0)}setComputedNumeric(b,D){return this.setComputedNumericAtIndex(D,0)}getComputedString(b){return this.getComputedStringAtIndex(0)}setComputedString(b,D){return this.setComputedStringAtIndex(0,D)}getComputedNumericAtIndex(b){return this._storage.getComputedNumericAtIndex(this.getDisplayId(),b)}setComputedNumericAtIndex(b,D){this._storage.setComputedNumericAtIndex(this.getDisplayId(),b,D)}getComputedStringAtIndex(b){return this._storage.getComputedStringAtIndex(this.getDisplayId(),b)}setComputedStringAtIndex(b,D){return this._storage.setComputedStringAtIndex(this.getDisplayId(),b,D)}transform(b,D,z,q){const H=this.copy();return H._tx+=b,H._ty+=D,H._sx*=z,H._sy*=q,H}readAttribute(b,D=!1){const z=this._readAttribute(b,D);if(void 0!==z)return z;for(const q of this._joined){q.setIndex(this.getIndex());const H=q._readAttribute(b,D);if(void 0!==H)return H}}readAttributes(){const b=this._readAttributes();for(const D of this._joined){D.setIndex(this.getIndex());const z=D._readAttributes();for(const q of Object.keys(z))b[q]=z[q]}return b}joinAttributes(b){this._joined.push(b)}readArcadeFeature(){return this}geometry(){const b=this.readHydratedGeometry(),D=(0,L.di)(b,this.geometryType,this.hasZ,this.hasM),z=(0,Z.im)(D);return z&&(z.spatialReference=this._arcadeSpatialReference),z}field(b){if(this.hasField(b))return this.readAttribute(b,!0);for(const D of this._joined)if(D.setIndex(this.getIndex()),D.hasField(b))return D._readAttribute(b,!0);throw new Error(`Field ${b} does not exist`)}setField(b,D){throw new Error("Unable to update feature attribute values, feature is readonly")}keys(){return this.getFieldNames()}castToText(){return JSON.stringify(this.readLegacyFeature())}gdbVersion(){return null}fullSchema(){return this._layerSchema}castAsJson(b=null){return{attributes:this._readAttributes(),geometry:!0===b?.keepGeometryType?this.geometry():this.geometry().toJSON()}}castAsJsonAsync(b=null,D=null){return Promise.resolve(this.castAsJson(D))}removeIds(b){if((0,k.Wi)(this._objectIdToIndex)){const z=new Map,q=this.getCursor();for(;q.next();)z.set(q.getObjectId(),q.getIndex());this._objectIdToIndex=z}const D=this._objectIdToIndex;for(const z of b)D.has(z)&&this.removeAtIndex(D.get(z))}removeAtIndex(b){(0,k.Wi)(this._deleted)&&(this._deleted=re.p.create(this.getSize())),this._deleted.set(b)}readGeometryForDisplay(){return this.readUnquantizedGeometry(!0)}readLegacyGeometryForDisplay(){return this.readLegacyGeometry(!0)}*features(){const b=this.getCursor();for(;b.next();)yield b.readOptimizedFeature()}_getExists(){return(0,k.Wi)(this._deleted)||!this._deleted.has(this.getIndex())}_computeCentroid(){if("esriGeometryPolygon"!==this.geometryType)return null;const b=this.readUnquantizedGeometry();if(!b||b.hasIndeterminateRingOrder)return null;const D=(0,k.Pt)(this.getQuantizationTransform(),null);return(0,M.Y)(new Y.Z,b,this.hasM,this.hasZ,D)}copyInto(b){b.seen=this.seen,b._storage=this._storage,b._arcadeSpatialReference=this._arcadeSpatialReference,b._joined=this._joined,b._tx=this._tx,b._ty=this._ty,b._sx=this._sx,b._sy=this._sy,b._deleted=this._deleted,b._objectIdToIndex=this._objectIdToIndex}}},52397:(we,ge,T)=>{T.d(ge,{t:()=>K});var B=T(25208);class K extends B.s{constructor(M,L){super(B.s.createInstance(),M.fullSchema()),this._currentIndex=-1,this._reader=M,this._indices=L}static from(M,L){return new K(M.copy(),L)}get hasNext(){return this._currentIndex+1<this._indices.length}getSize(){return this._indices.length}getCursor(){return this.copy()}copy(){const M=new K(this._reader.copy(),this._indices);return M._currentIndex=this._currentIndex,M}next(){for(;this._nextIndex()&&!this._reader._getExists(););return this._currentIndex<this._indices.length}_nextIndex(){return++this._currentIndex<this._indices.length&&(this._reader.setIndex(this._indices[this._currentIndex]),!0)}setArcadeSpatialReference(M){this._reader.setArcadeSpatialReference(M)}attachStorage(M){this._reader.attachStorage(M)}get geometryType(){return this._reader.geometryType}get hasFeatures(){return this._reader.hasFeatures}get exceededTransferLimit(){return this._reader.exceededTransferLimit}get hasZ(){return this._reader.hasZ}get hasM(){return this._reader.hasM}getStorage(){return this._reader.getStorage()}getComputedNumeric(M){return this._reader.getComputedNumericAtIndex(0)}setComputedNumeric(M,L){return this._reader.setComputedNumericAtIndex(L,0)}getComputedString(M){return this._reader.getComputedStringAtIndex(0)}setComputedString(M,L){return this._reader.setComputedStringAtIndex(0,L)}getComputedNumericAtIndex(M){return this._reader.getComputedNumericAtIndex(M)}setComputedNumericAtIndex(M,L){this._reader.setComputedNumericAtIndex(M,L)}getComputedStringAtIndex(M){return this._reader.getComputedStringAtIndex(M)}setComputedStringAtIndex(M,L){return this._reader.setComputedStringAtIndex(M,L)}transform(M,L,Y,re){const Z=this.copy();return Z._reader=this._reader.transform(M,L,Y,re),Z}readAttribute(M,L=!1){return this._reader.readAttribute(M,L)}readAttributes(){return this._reader.readAttributes()}joinAttributes(M){return this._reader.joinAttributes(M)}readArcadeFeature(){return this._reader.readArcadeFeature()}geometry(){return this._reader.geometry()}field(M){return this.readAttribute(M,!0)}hasField(M){return this._reader.hasField(M)}setField(M,L){return this._reader.setField(M,L)}keys(){return this._reader.keys()}castToText(){return this._reader.castToText()}getQuantizationTransform(){return this._reader.getQuantizationTransform()}getFieldNames(){return this._reader.getFieldNames()}getAttributeHash(){return this._reader.getAttributeHash()}getObjectId(){return this._reader.getObjectId()}getDisplayId(){return this._reader.getDisplayId()}setDisplayId(M){return this._reader.setDisplayId(M)}getGroupId(){return this._reader.getGroupId()}setGroupId(M){return this._reader.setGroupId(M)}getXHydrated(){return this._reader.getXHydrated()}getYHydrated(){return this._reader.getYHydrated()}getX(){return this._reader.getX()}getY(){return this._reader.getY()}setIndex(M){return this._reader.setIndex(M)}getIndex(){return this._reader.getIndex()}readLegacyFeature(){return this._reader.readLegacyFeature()}readOptimizedFeature(){return this._reader.readOptimizedFeature()}readLegacyPointGeometry(){return this._reader.readLegacyPointGeometry()}readLegacyGeometry(){return this._reader.readLegacyGeometry()}readLegacyCentroid(){return this._reader.readLegacyCentroid()}readGeometryArea(){return this._reader.readGeometryArea()}readUnquantizedGeometry(){return this._reader.readUnquantizedGeometry()}readHydratedGeometry(){return this._reader.readHydratedGeometry()}readGeometry(){return this._reader.readGeometry()}readCentroid(){return this._reader.readCentroid()}_readAttribute(M,L){throw new Error("Error: Should not be called. Underlying _reader should be used instead")}_readAttributes(){throw new Error("Error: Should not be called. Underlying _reader should be used instead")}}},42797:(we,ge,T)=>{T.d(ge,{p:()=>B});class B{constructor(k,M){this._mask=0,this._buf=k,this._mask=M}static fromBuffer(k,M){return new B(k,M)}static create(k,M=4294967295){const L=new Uint32Array(Math.ceil(k/32));return new B(L,M)}_getIndex(k){return Math.floor(k/32)}has(k){const M=this._mask&k;return!!(this._buf[this._getIndex(M)]&1<<M%32)}hasRange(k,M){let L=k,Y=M;for(;L%32&&L!==Y;){if(this.has(L))return!0;L++}for(;Y%32&&L!==Y;){if(this.has(L))return!0;Y--}if(L===Y)return!1;for(let re=L/32;re!==Y/32;re++)if(this._buf[re])return!0;return!1}set(k){const M=this._mask&k,L=this._getIndex(M);this._buf[L]|=1<<M%32}setRange(k,M){let L=k,Y=M;for(;L%32&&L!==Y;)this.set(L++);for(;Y%32&&L!==Y;)this.set(Y--);if(L!==Y)for(let re=L/32;re!==Y/32;re++)this._buf[re]=4294967295}unset(k){const M=this._mask&k,L=this._getIndex(M);this._buf[L]&=4294967295^1<<M%32}resize(k){const M=this._buf,L=new Uint32Array(Math.ceil(k/32));L.set(M),this._buf=L}or(k){for(let M=0;M<this._buf.length;M++)this._buf[M]|=k._buf[M];return this}and(k){for(let M=0;M<this._buf.length;M++)this._buf[M]&=k._buf[M];return this}xor(k){for(let M=0;M<this._buf.length;M++)this._buf[M]^=k._buf[M];return this}ior(k){for(let M=0;M<this._buf.length;M++)this._buf[M]|=~k._buf[M];return this}iand(k){for(let M=0;M<this._buf.length;M++)this._buf[M]&=~k._buf[M];return this}ixor(k){for(let M=0;M<this._buf.length;M++)this._buf[M]^=~k._buf[M];return this}any(){for(let k=0;k<this._buf.length;k++)if(this._buf[k])return!0;return!1}copy(k){for(let M=0;M<this._buf.length;M++)this._buf[M]=k._buf[M];return this}clone(){return new B(this._buf.slice(),this._mask)}clear(){for(let k=0;k<this._buf.length;k++)this._buf[k]=0}forEachSet(k){for(let M=0;M<this._buf.length;M++){let L=this._buf[M],Y=32*M;if(L)for(;L;)1&L&&k(Y),L>>>=1,Y++}}countSet(){let k=0;return this.forEachSet(M=>{k++}),k}}},81340:(we,ge,T)=>{T.d(ge,{n:()=>Y});var B=T(35575),K=T(2004),k=T(65401),M=T(89621),L=T(58098);class Y{constructor(Z,X){this.key=new L.Z(0,0,0,0),this.bounds=(0,k.Ue)(),this.objectIds=new Set,this.key.set(X);const $=Z.getLODInfoAt(this.key);this.tileInfoView=Z,this.tileInfoView.getTileBounds(this.bounds,this.key,!0),this.resolution=$.resolution,this.scale=$.scale,this.level=$.level}get id(){return this.key.id}get extent(){return K.Z.fromBounds(this.bounds,this.tileInfoView.tileInfo.spatialReference)}get transform(){return{originPosition:"upperLeft",scale:[this.resolution,this.resolution],translate:[this.bounds[0],this.bounds[3]]}}createChildTiles(){const Z=this.key.getChildKeys(),X=B.Z.acquire();for(let $=0;$<Z.length;$++)X[$]=new Y(this.tileInfoView,Z[$]);return X}getQuantizationParameters(){return M.Z.fromJSON({mode:"view",originPosition:"upperLeft",tolerance:this.resolution,extent:{xmin:this.bounds[0],ymin:this.bounds[1],xmax:this.bounds[2],ymax:this.bounds[3],spatialReference:this.tileInfoView.tileInfo.spatialReference}})}}},84378:(we,ge,T)=>{T.d(ge,{Z:()=>K});var B=T(27899);class K{constructor(){this.spans=[]}acquire(M){this.lodInfo=M}release(){this.lodInfo=null,this.spans.length=0}forEach(M,L){const{spans:Y,lodInfo:re}=this,{level:Z}=re;if(0!==Y.length)for(const{row:X,colFrom:$,colTo:W}of Y)for(let V=$;V<=W;V++)M.call(L,Z,X,re.normalizeCol(V),re.getWorldForColumn(V))}}K.pool=new B.Z(K)},9598:(we,ge,T)=>{T.d(ge,{Z:()=>E});var B=T(37053),K=T(62208),k=T(58098);function M(U,_){return[U,_]}function L(U,_,m){return U[0]=_,U[1]=m,U}const re=new k.Z("0/0/0/0");class Z{constructor(_,m,S,F,w,O,b,D,z,q,H,ae){this.level=_,this.resolution=m,this.scale=S,this.origin=F,this.first=w,this.last=O,this.size=b,this.norm=D,this.worldStart=z,this.worldEnd=q,this.worldSize=H,this.wrap=ae}static create(_,m,S=null){const F=(0,B.C5)(_.spatialReference),w=m.origin||M(_.origin.x,_.origin.y),O=M(_.size[0]*m.resolution,_.size[1]*m.resolution),b=M(-1/0,-1/0),D=M(1/0,1/0),z=M(1/0,1/0);(0,K.pC)(S)&&(L(b,Math.max(0,Math.floor((S.xmin-w[0])/O[0])),Math.max(0,Math.floor((w[1]-S.ymax)/O[1]))),L(D,Math.max(0,Math.floor((S.xmax-w[0])/O[0])),Math.max(0,Math.floor((w[1]-S.ymin)/O[1]))),L(z,D[0]-b[0]+1,D[1]-b[1]+1));const{cols:q,rows:H}=m;let ae,Ie,ue,fe;return!S&&q&&H&&(L(b,q[0],H[0]),L(D,q[1],H[1]),L(z,q[1]-q[0]+1,H[1]-H[0]+1)),_.isWrappable?(ae=M(Math.ceil(Math.round((F.valid[1]-F.valid[0])/m.resolution)/_.size[0]),z[1]),Ie=M(Math.floor((F.origin[0]-w[0])/O[0]),b[1]),ue=M(ae[0]+Ie[0]-1,D[1]),fe=!0):(Ie=b,ue=D,ae=z,fe=!1),new Z(m.level,m.resolution,m.scale,w,b,D,z,O,Ie,ue,ae,fe)}normalizeCol(_){if(!this.wrap)return _;const m=this.worldSize[0];return _<0?m-1-Math.abs((_+1)%m):_%m}denormalizeCol(_,m){return this.wrap?this.worldSize[0]*m+_:_}getWorldForColumn(_){return this.wrap?Math.floor(_/this.worldSize[0]):0}getFirstColumnForWorld(_){return _*this.worldSize[0]+this.first[0]}getLastColumnForWorld(_){return _*this.worldSize[0]+this.first[0]+this.size[0]-1}getColumnForX(_){return(_-this.origin[0])/this.norm[0]}getXForColumn(_){return this.origin[0]+_*this.norm[0]}getRowForY(_){return(this.origin[1]-_)/this.norm[1]}getYForRow(_){return this.origin[1]-_*this.norm[1]}getTileBounds(_,m,S=!1){re.set(m);const F=S?re.col:this.denormalizeCol(re.col,re.world),w=re.row;return function Y(U,_,m,S,F){U[0]=_,U[1]=m,U[2]=S,U[3]=F}(_,this.getXForColumn(F),this.getYForRow(w+1),this.getXForColumn(F+1),this.getYForRow(w)),_}getTileCoords(_,m,S=!1){re.set(m);const F=S?re.col:this.denormalizeCol(re.col,re.world);return Array.isArray(_)?L(_,this.getXForColumn(F),this.getYForRow(re.row)):(_.x=this.getXForColumn(F),_.y=this.getYForRow(re.row)),_}}var X=T(84378);class ${constructor(_,m,S){this.row=_,this.colFrom=m,this.colTo=S}}const W=new k.Z("0/0/0/0");class V{constructor(_,m,S,F,w,O,b,D){this.x=_,this.ymin=m,this.ymax=S,this.invM=F,this.leftAdjust=w,this.rightAdjust=O,this.leftBound=b,this.rightBound=D}static create(_,m){_[1]>m[1]&&([_,m]=[m,_]);const[S,F]=_,[w,O]=m,b=w-S,D=O-F,z=0!==D?b/D:0,q=(Math.ceil(F)-F)*z,H=(Math.floor(F)-F)*z;return new V(S,Math.floor(F),Math.ceil(O),z,b<0?q:H,b<0?H:q,b<0?w:S,b<0?S:w)}incrRow(){this.x+=this.invM}getLeftCol(){return Math.max(this.x+this.leftAdjust,this.leftBound)}getRightCol(){return Math.min(this.x+this.rightAdjust,this.rightBound)}}const C=[[0,0],[0,0],[0,0],[0,0]];class E{constructor(_,m=null){this.tileInfo=_,this.fullExtent=m,this.scales=[],this._lodInfos=null,this._infoByScale={},this._infoByLevel={};const S=_.lods.slice();S.sort((w,O)=>O.scale-w.scale);const F=this._lodInfos=S.map(w=>Z.create(_,w,m));S.forEach((w,O)=>{this._infoByLevel[w.level]=F[O],this._infoByScale[w.scale]=F[O],this.scales[O]=w.scale},this),this._wrap=_.isWrappable}get spatialReference(){return this.tileInfo.spatialReference}getLODInfoAt(_){return this._infoByLevel["number"==typeof _?_:_.level]}getTileBounds(_,m,S=!1){W.set(m);const F=this._infoByLevel[W.level];return F?F.getTileBounds(_,W,S):_}getTileCoords(_,m,S=!1){W.set(m);const F=this._infoByLevel[W.level];return F?F.getTileCoords(_,W,S):_}getTileCoverage(_,m=192,S="closest"){const F="closest"===S?this.getClosestInfoForScale(_.scale):this.getSmallestInfoForScale(_.scale),w=X.Z.pool.acquire(F),O=this._wrap;let b,D,z,q=1/0,H=-1/0;const ae=w.spans;C[0][0]=C[0][1]=C[1][1]=C[3][0]=-m,C[1][0]=C[2][0]=_.size[0]+m,C[2][1]=C[3][1]=_.size[1]+m;for(const ie of C)_.toMap(ie,ie),ie[0]=F.getColumnForX(ie[0]),ie[1]=F.getRowForY(ie[1]);const Ie=[];let ue=3;for(let ie=0;ie<4;ie++){if(C[ie][1]===C[ue][1]){ue=ie;continue}const me=V.create(C[ie],C[ue]);q=Math.min(me.ymin,q),H=Math.max(me.ymax,H),void 0===Ie[me.ymin]&&(Ie[me.ymin]=[]),Ie[me.ymin].push(me),ue=ie}if(null==q||null==H||H-q>100)return null;let fe=[];for(b=q;b<H;){null!=Ie[b]&&(fe=fe.concat(Ie[b])),D=1/0,z=-1/0;for(let ie=fe.length-1;ie>=0;ie--){const me=fe[ie];D=Math.min(D,me.getLeftCol()),z=Math.max(z,me.getRightCol())}if(D=Math.floor(D),z=Math.floor(z),b>=F.first[1]&&b<=F.last[1])if(O)if(F.size[0]<F.worldSize[0]){const ie=Math.floor(z/F.worldSize[0]);for(let me=Math.floor(D/F.worldSize[0]);me<=ie;me++)ae.push(new $(b,Math.max(F.getFirstColumnForWorld(me),D),Math.min(F.getLastColumnForWorld(me),z)))}else ae.push(new $(b,D,z));else D>F.last[0]||z<F.first[0]||(D=Math.max(D,F.first[0]),z=Math.min(z,F.last[0]),ae.push(new $(b,D,z)));b+=1;for(let ie=fe.length-1;ie>=0;ie--){const me=fe[ie];me.ymax>=b?me.incrRow():fe.splice(ie,1)}}return w}getTileParentId(_){W.set(_);const S=this._lodInfos.indexOf(this._infoByLevel[W.level])-1;return S<0?null:(this._getTileIdAtLOD(W,this._lodInfos[S],W),W.id)}getTileResolution(_){const m=this._infoByLevel["object"==typeof _?_.level:_];return m?m.resolution:-1}getTileScale(_){const m=this._infoByLevel[_.level];return m?m.scale:-1}intersects(_,m){W.set(m);const S=this._infoByLevel[W.level],F=_.lodInfo;if(F.resolution>S.resolution){this._getTileIdAtLOD(W,F,W);const O=F.denormalizeCol(W.col,W.world);for(const b of _.spans)if(b.row===W.row&&b.colFrom<=O&&b.colTo>=O)return!0}if(F.resolution<S.resolution){const[O,b,D,z]=_.spans.reduce((fe,ie)=>(fe[0]=Math.min(fe[0],ie.row),fe[1]=Math.max(fe[1],ie.row),fe[2]=Math.min(fe[2],ie.colFrom),fe[3]=Math.max(fe[3],ie.colTo),fe),[1/0,-1/0,1/0,-1/0]),q=S.denormalizeCol(W.col,W.world),H=F.getColumnForX(S.getXForColumn(q)),ae=F.getRowForY(S.getYForRow(W.row)),Ie=F.getColumnForX(S.getXForColumn(q+1))-1,ue=F.getRowForY(S.getYForRow(W.row+1))-1;return!(H>z||Ie<D||ae>b||ue<O)}const w=F.denormalizeCol(W.col,W.world);return _.spans.some(O=>O.row===W.row&&O.colFrom<=w&&O.colTo>=w)}normalizeBounds(_,m,S){if(_[0]=m[0],_[1]=m[1],_[2]=m[2],_[3]=m[3],this._wrap){const F=(0,B.C5)(this.tileInfo.spatialReference),w=-S*(F.valid[1]-F.valid[0]);_[0]+=w,_[2]+=w}return _}getSmallestInfoForScale(_){const m=this.scales;if(this._infoByScale[_])return this._infoByScale[_];if(_>m[0])return this._infoByScale[m[0]];for(let S=1;S<m.length-1;S++)if(_>m[S]+1e-6)return this._infoByScale[m[S-1]];return this._infoByScale[m[m.length-1]]}getClosestInfoForScale(_){const m=this.scales;return this._infoByScale[_]||(_=m.reduce((S,F)=>Math.abs(F-_)<Math.abs(S-_)?F:S,m[0])),this._infoByScale[_]}scaleToLevel(_){const m=this.scales;if(this._infoByScale[_])return this._infoByScale[_].level;for(let S=m.length-1;S>=0;S--)if(_<m[S])return S===m.length-1?this._infoByScale[m[m.length-1]].level:this._infoByScale[m[S]].level+(m[S]-_)/(m[S]-m[S+1]);return this._infoByScale[m[0]].level}scaleToZoom(_){return this.tileInfo.scaleToZoom(_)}_getTileIdAtLOD(_,m,S){const F=this._infoByLevel[S.level];return _.set(S),m.resolution<F.resolution?null:(m.resolution===F.resolution||(_.level=m.level,_.col=Math.floor(S.col*F.resolution/m.resolution+.01),_.row=Math.floor(S.row*F.resolution/m.resolution+.01)),_)}}},71251:(we,ge,T)=>{T.d(ge,{e:()=>Y});var B=T(62208),K=T(10699),k=T(35133),M=T(50618);class L{constructor(Z,X){this.item=Z,this.controller=X,this.promise=null}}class Y{constructor(Z){this._deferreds=new Map,this._controllers=new Map,this._processingItems=new Map,this._isPaused=!1,this._schedule=null,this._task=null,this.concurrency=1,Z.concurrency&&(this.concurrency=Z.concurrency),this._queue=new k.Z(Z.peeker),this.process=Z.process;const X=Z.scheduler;Z.priority&&(0,B.pC)(X)&&(this._task=X.registerTask(Z.priority,this))}destroy(){this.clear(),this._schedule&&(this._schedule.remove(),this._schedule=null),this._task&&(this._task.remove(),this._task=null)}get length(){return this._processingItems.size+this._queue.length}abort(Z){const X=this._controllers.get(Z);X&&X.abort()}clear(){this._queue.clear();const Z=[];this._controllers.forEach(X=>Z.push(X)),this._controllers.clear(),Z.forEach(X=>X.abort()),this._processingItems.clear(),this._cancelNext()}forEach(Z){this._deferreds.forEach((X,$)=>Z($))}get(Z){const X=this._deferreds.get(Z);return X?X.promise:void 0}isOngoing(Z){return this._processingItems.has(Z)}has(Z){return this._deferreds.has(Z)}pause(){this._isPaused||(this._isPaused=!0,this._cancelNext())}push(Z,X){const $=this.get(Z);if($)return $;const W=new AbortController;let V=null;X&&(V=(0,K.fu)(X,()=>W.abort()));const N=()=>{E.remove(),(0,B.pC)(V)&&V.remove(),this._deferreds.delete(Z),this._controllers.delete(Z),this._queue.remove(Z),this._processingItems.delete(Z),this._scheduleNext()},E=(0,K.$F)(W.signal,()=>{const _=this._processingItems.get(Z);_&&_.controller.abort(),N(),U.reject((0,K.zE)())}),U=(0,K.dD)();return this._deferreds.set(Z,U),this._controllers.set(Z,W),U.promise.then(N,N),this._queue.push(Z),this._scheduleNext(),U.promise}last(){return this._queue.last()}peek(){return this._queue.peek()}popLast(){return this._queue.popLast()}reset(){const Z=[];this._processingItems.forEach(X=>Z.push(X)),this._processingItems.clear();for(const X of Z)this._queue.push(X.item),X.controller.abort();this._scheduleNext()}resume(){this._isPaused&&(this._isPaused=!1,this._scheduleNext())}takeAll(){const Z=[];for(;this._queue.length;)Z.push(this._queue.pop());return this.clear(),Z}get running(){return!this._isPaused&&this._queue.length>0&&this._processingItems.size<this.concurrency}runTask(Z){for(;!Z.done&&this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop()),Z.madeProgress()}_scheduleNext(){this._task||this._isPaused||this._schedule||(this._schedule=(0,M.Os)(()=>{this._schedule=null,this._next()}))}_next(){for(;this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop())}_cancelNext(){this._schedule&&(this._schedule.remove(),this._schedule=null)}_processResult(Z,X){this._canProcessFulfillment(Z)&&(this._scheduleNext(),this._deferreds.get(Z.item).resolve(X))}_processError(Z,X){this._canProcessFulfillment(Z)&&(this._scheduleNext(),this._deferreds.get(Z.item).reject(X))}_canProcessFulfillment(Z){return!!this._deferreds.get(Z.item)&&this._processingItems.get(Z.item)===Z}_process(Z){if((0,B.Wi)(Z))return;let X;const $=new AbortController,W=new L(Z,$);this._processingItems.set(Z,W);try{X=this.process(Z,$.signal)}catch(V){this._processError(W,V)}(0,K.y8)(X)?(W.promise=X,X.then(V=>this._processResult(W,V),V=>this._processError(W,V))):this._processResult(W,X)}get test(){return{update:Z=>this.runTask(Z)}}}}}]);