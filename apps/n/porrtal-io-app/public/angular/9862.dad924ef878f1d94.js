/*
Copyright 2022 Comcast Cable Communications Management, LLC

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at
    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
"use strict";(self.webpackChunka_porrtal_io_app=self.webpackChunka_porrtal_io_app||[]).push([[9862],{40405:(Lt,tt,c)=>{c.d(tt,{B:()=>bt});var o=c(15861),w=c(62208),dt=c(22558),N=c(21726),s=c(35948),a=c(34117),st=c(31283),at=c(77712);function pt(h){return mt[function E(h){return h instanceof Blob?h.type:function b(h){const T=(0,N.Ml)(h);return ft[T]||v}(h.url)}(h)]||H}const mt={},v="text/plain",H=mt[v],ft={png:"image/png",jpeg:"image/jpeg",jpg:"image/jpg",bmp:"image/bmp",gif:"image/gif",json:"application/json",txt:"text/plain",xml:"application/xml",svg:"image/svg+xml",zip:"application/zip",pbf:"application/vnd.mapbox-vector-tile",gz:"application/gzip"};for(const h in ft)mt[ft[h]]=h;var lt=c(29840);function bt(h){const T=(0,w.pC)(h)&&h.origins?h.origins:[void 0];return(_,P)=>{const R=function et(h,T,_){if((0,w.pC)(h)&&"resource"===h.type)return function it(h,T,_){const P=(0,a.VZ)(T,_);return{type:String,read:(R,A,V)=>{const y=(0,lt.r)(R,A,V);return P.type===String?y:"function"==typeof P.type?new P.type({url:y}):void 0},write:{writer(R,A,V,y){if(!y||!y.resources)return"string"==typeof R?void(A[V]=(0,lt.t)(R,y)):void(A[V]=R.write({},y));const Q=function ht(h){return(0,w.Wi)(h)?null:"string"==typeof h?h:h.url}(R),D=Q?(0,lt.t)(Q,{...y,verifyItemRelativeUrls:y&&y.verifyItemRelativeUrls?{writtenUrls:y.verifyItemRelativeUrls.writtenUrls,rootPath:null}:null},lt.M.NO):null,ct=P.type!==String&&(!(0,dt.l)(this)||y&&y.origin&&this.originIdOf(_)>(0,st.M9)(y.origin));y&&y.portalItem&&(0,w.pC)(D)&&!(0,N.YP)(D)?ct?function _t(h,T,_,P,R,A,V,y){const Q=V.portalItem.resourceFromPath(P),D=g(_,P,V);pt(D)===(0,N.Ml)(Q.path)?(O(h,T,Q,D,V.resources.toUpdate),R[A]=P):K(h,T,_,P,R,A,V,y)}(this,_,R,D,A,V,y,h):function Tt(h,T,_,P){P.resources.toKeep.push({resource:P.portalItem.resourceFromPath(h)}),T[_]=h}(D,A,V,y):y&&y.portalItem&&((0,w.Wi)(D)||(0,w.pC)((0,lt.i)(D))||(0,N.jc)(D)||ct)?K(this,_,R,D,A,V,y,h):A[V]=D}}}}(h,T,_);switch((0,w.pC)(h)&&h.type?h.type:"other"){case"other":return{read:!0,write:!0};case"url":{const{read:P,write:R}=lt.p;return{read:P,write:R}}}}(h,_,P);for(const A of T){const V=(0,at.CJ)(_,A,P);for(const y in R)V[y]=R[y]}}}function K(h,T,_,P,R,A,V,y){const Q=(0,s.D)(),D=g(_,P,V),ct=(0,N.v_)((0,w.U2)(y,"prefix"),Q),Vt=`${ct}.${pt(D)}`,W=V.portalItem.resourceFromPath(Vt);(0,N.jc)(P)&&V.resources.pendingOperations.push(function Pt(h){return k.apply(this,arguments)}(P).then(nt=>{W.path=`${ct}.${pt(nt)}`,R[A]=W.itemRelativeUrl}).catch(()=>{})),O(h,T,W,D,V.resources.toAdd),R[A]=W.itemRelativeUrl}function O(h,T,_,P,R){R.push({resource:_,content:P,finish:A=>{!function B(h,T,_){"string"==typeof h[T]?h[T]=_.url:h[T].url=_.url}(h,T,A)}})}function g(h,T,_){return"string"==typeof h?{url:T}:new Blob([JSON.stringify(h.toJSON(_))],{type:"application/json"})}function k(){return(k=(0,o.Z)(function*(h){const T=(yield Promise.resolve().then(c.bind(c,84792))).default,{data:_}=yield T(h,{responseType:"blob"});return _})).apply(this,arguments)}},22558:(Lt,tt,c)=>{function o(w){return w&&"getAtOrigin"in w&&"originOf"in w}c.d(tt,{l:()=>o})},11467:(Lt,tt,c)=>{c.r(tt),c.d(tt,{default:()=>ve});var o=c(17626),w=c(14517),dt=c(46160),N=c(61885),s=c(62208),a=c(77712),st=c(85931),E=(c(8314),c(90912),c(76898)),b=c(28093),mt=c(1437),v=c(91558);let H=class extends w.Z{constructor(t){super(t),this.innerWidth=2,this.outerWidth=8,this.visibleInnerColor=new v.Z([3,252,111,1]),this.visibleOuterColor=new v.Z([3,252,111,.15]),this.occludedInnerColor=new v.Z([252,3,69,1]),this.occludedOuterColor=new v.Z([252,3,69,.1]),this.undefinedInnerColor=new v.Z([255,255,255,1]),this.undefinedOuterColor=new v.Z([127,127,127,.2])}};(0,o._)([(0,a.Cb)({type:Number})],H.prototype,"innerWidth",void 0),(0,o._)([(0,a.Cb)({type:Number})],H.prototype,"outerWidth",void 0),(0,o._)([(0,a.Cb)({type:v.Z})],H.prototype,"visibleInnerColor",void 0),(0,o._)([(0,a.Cb)({type:v.Z})],H.prototype,"visibleOuterColor",void 0),(0,o._)([(0,a.Cb)({type:v.Z})],H.prototype,"occludedInnerColor",void 0),(0,o._)([(0,a.Cb)({type:v.Z})],H.prototype,"occludedOuterColor",void 0),(0,o._)([(0,a.Cb)({type:v.Z})],H.prototype,"undefinedInnerColor",void 0),(0,o._)([(0,a.Cb)({type:v.Z})],H.prototype,"undefinedOuterColor",void 0),H=(0,o._)([(0,E.j)("esri.views.3d.analysis.LineOfSight.LineOfSightConfiguration")],H);var ft=c(15861),bt=(c(29132),c(8425)),et=c(72392),it=c(54024),K=c(58817),_t=c(63290),Tt=c(10699),O=c(32917),g=c(84161),Pt=c(17760),k=c(55915),ht=c(65401),B=c(70562),h=c(60507);let T=class extends w.Z{constructor(t){super(t),this.target=null,this.intersectedGraphic=null,this.intersectedLocation=null,this.elevationAlignedTargetLocation=null,this.visible=void 0}};(0,o._)([(0,a.Cb)()],T.prototype,"target",void 0),(0,o._)([(0,a.Cb)()],T.prototype,"intersectedGraphic",void 0),(0,o._)([(0,a.Cb)()],T.prototype,"intersectedLocation",void 0),(0,o._)([(0,a.Cb)()],T.prototype,"elevationAlignedTargetLocation",void 0),(0,o._)([(0,a.Cb)({type:Boolean})],T.prototype,"visible",void 0),T=(0,o._)([(0,E.j)("esri.views.3d.analysis.LineOfSightAnalysisResult")],T);let _=class extends w.Z{constructor(t){super(t),this.elevationAlignedTargetLocation=null,this.inputPoints={isValid:!1,observer:(0,b.c)(),observerSurfaceNormal:null,observerFeatureId:null,target:(0,b.c)(),targetSurfaceNormal:null,targetFeatureId:null,observerAdjusted:(0,b.c)(),targetAdjusted:(0,b.c)()},this.computationResult={start:(0,b.c)(),end:(0,b.c)(),intersection:(0,b.c)(),isValid:!1,isTargetVisible:!1},this.result=null}notifyResultChanged(){this.notifyChange("computationResult")}notifyInputPointsChanged(){this.notifyChange("inputPoints")}};(0,o._)([(0,a.Cb)()],_.prototype,"target",void 0),(0,o._)([(0,a.Cb)()],_.prototype,"elevationAlignedTargetLocation",void 0),(0,o._)([(0,a.Cb)()],_.prototype,"inputPoints",void 0),(0,o._)([(0,a.Cb)()],_.prototype,"computationResult",void 0),(0,o._)([(0,a.Cb)()],_.prototype,"result",void 0),_=(0,o._)([(0,E.j)("esri.views.3d.analysis.LineOfSight.LineOfSightComputation")],_);var V,P=c(23841),R=c(26242),A=c(38114);let y=V=class extends w.Z{constructor(t){super(t)}clone(){return new V({type:this.type,id:(0,K.d9)(this.id),point:(0,K.d9)(this.point),normal:(0,K.d9)(this.normal),ray:(0,K.d9)(this.ray),graphic:this.graphic})}equals(t){return this.type===t.type&&this.id===t.id&&(0,s._W)(this.point,t.point)&&(0,st.fS)(this.normal,t.normal)&&(0,B.fS)(this.ray,t.ray)&&this.graphic===t.graphic}};(0,o._)([(0,a.Cb)()],y.prototype,"type",void 0),(0,o._)([(0,a.Cb)({constructOnly:!0})],y.prototype,"id",void 0),(0,o._)([(0,a.Cb)({constructOnly:!0})],y.prototype,"point",void 0),(0,o._)([(0,a.Cb)({constructOnly:!0})],y.prototype,"normal",void 0),(0,o._)([(0,a.Cb)({constructOnly:!0})],y.prototype,"graphic",void 0),(0,o._)([(0,a.Cb)({constructOnly:!0})],y.prototype,"ray",void 0),y=V=(0,o._)([(0,E.j)("esri.views.3d.analysis.LineOfSight.LineOfSightIntersectionResult")],y);var Q=c(77926),D=c(26046),ct=c(90793),Vt=c(62483),W=c(67857),nt=c(55314);let vt=class extends w.Z{constructor(t){super(t),this._terrainIntersectionOptionsLayerUids=new Set(["terrain"])}initialize(){this.intersector=(0,Vt.Z8)(this.view.state.viewingMode),this.intersector.options.hud=!1,this.intersector.options.store=W.eC.MIN}getScreenPointIntersection(t){const i=(0,P.md)(t,R.qW.get()),n=(0,D.u4)(this.view.state.camera,i,Et);return this._getRayIntersection(n)}_getRayIntersection(t,i){if((0,s.Wi)(t)||(0,s.Wi)(this.view.sceneIntersectionHelper))return null;this.intersector.options.store=W.eC.MIN,this.view.sceneIntersectionHelper.intersectToolIntersectorRay(t,this.intersector,i);const n=this.intersector.results.min;if(!n.getIntersectionPoint(Rt))return null;const l=this.view.renderCoordsHelper.fromRenderCoords(Rt,this.view.spatialReference),u=(0,b.d)(n.normal);if((0,Q.G)(n))return new y({type:W.q7.OBJECT,id:`${n.target.layerUid}/${n.target.nodeIndex}/${n.target.componentIndex}`,point:l,normal:u,ray:(0,B.JG)(t),graphic:null});if((0,ct.T)(n))return new y({type:W.q7.TERRAIN,id:n.target.lij.slice(),point:l,normal:u,ray:(0,B.JG)(t),graphic:null});const d=(0,nt.tB)(n,this.view);if((0,s.pC)(d)){const p=d.layer,I=d.sourceLayer;let C;return C=I&&"scene"===I.type?(0,A.MS)(d,I.objectIdField):d.uid,new y({type:W.q7.OBJECT,id:`${p.uid}/${C}`,point:l,normal:u,ray:(0,B.JG)(t),graphic:d})}return null}updateFromGroundIntersection(t,i,n){const l=Rt,u=$t,d=Jt,p=Kt,I=kt;(0,g.c)(u,t),this.view.renderCoordsHelper.worldUpAtPosition(u,d),(0,g.n)(d,d);const C=this.view.basemapTerrain.elevationBounds,f=this.view.renderCoordsHelper.getAltitude(u),m=C?Math.abs(C.max-C.min):100,L=f>0?1:-1;(0,g.g)(p,d,L*(m+Math.abs(i))),(0,g.a)(l,u,p),(0,B.zk)(l,u,Et);const S=this._getRayIntersection(Et,{include:this._terrainIntersectionOptionsLayerUids});return(0,s.pC)(S)&&(0,s.pC)(S.point)?(this.view.renderCoordsHelper.toRenderCoords(S.point,I),(0,g.g)(p,d,L*i),(0,g.a)(n,I,p),(0,b.a)(S.normal)):((0,g.c)(n,t),null)}};(0,o._)([(0,a.Cb)()],vt.prototype,"view",void 0),(0,o._)([(0,a.Cb)()],vt.prototype,"intersector",void 0),vt=(0,o._)([(0,E.j)("esri.views.3d.analysis.LineOfSight.LineOfSightRayIntersector")],vt);const Rt=(0,b.c)(),$t=(0,b.c)(),Jt=(0,b.c)(),Kt=(0,b.c)(),kt=(0,b.c)(),Et=(0,B.Ue)();var Dt=c(54865),gt=c(87091),Qt=c(49672);const zt=_t.Z.getLogger("esri.views.3d.analysis.LineOfSight.LineOfSightController");let M=class extends(N.Z.EventedMixin(w.Z)){constructor(t){super(t),this.updateOnCameraChange=!0,this._effectiveObserverElevationMode="absolute-height",this._observerFeatureId=null,this._updatingHandles=new Pt.t,this._frameTask=gt.sq,this._handles=new et.Z,this._computationHandles=new et.Z,this._externalObserverUpdate=!0}initialize(){const t=this.view.resourceController?.scheduler;this._frameTask=t?t.registerTask(gt.T8.LINE_OF_SIGHT_TOOL):gt.sq,this._intersector=new vt({view:this.view}),this._handles.add([this._connectObserver(),this._connectComputations(),this._connectTargets()])}destroy(){this._handles.destroy(),this._computationHandles.destroy(),this._computations.removeAll(),this._updatingHandles.destroy()}get updating(){return this._frameTask.updating||this._updatingHandles.updating}get priority(){return this._frameTask.priority}set priority(t){this._frameTask.priority=t}get _computations(){return this.analysisViewData.computations}get _elevationAlignedObserverPositionRenderSpace(){return this.analysisViewData.observerEngineLocation}set _elevationAlignedObserverPositionRenderSpace(t){this.analysisViewData.observerEngineLocation=t}get _screenPixelSize(){return this.view.state.camera.computeScreenPixelSizeAt(this._elevationAlignedObserverPositionRenderSpace)}getLineOfSightComputationDependencies(t){const{inputPoints:i}=t;return{inputPoints:i}}_computeResult(t){const i=t.computation,{inputPoints:n,computationResult:l}=i,{observerAdjusted:u,targetAdjusted:d}=n,{start:p,end:I}=l;(0,g.c)(p,u),(0,g.c)(I,d),this._canCompute(i)?this._computeIntersection(t):this._interpolateIntersection(t),i.notifyResultChanged(),this.emit("result-changed",{target:t.computation.target,result:i.result})}_updateAdjustedPointsFromFeatures(t){const i=this.view,{sceneIntersectionHelper:n}=i,{inputPoints:l}=t,{observerAdjusted:u,observerFeatureId:d,targetFeatureId:p,targetAdjusted:I}=l;if((0,s.Wi)(d)&&(0,s.Wi)(p))return;const C=(0,g.i)(u,I),f=this._intersector.intersector,m=(0,B.zk)(l.observer,l.target,jt);f.options.store=W.eC.ALL,n.intersectToolIntersectorRay(m,f);let L=null,S=null,F=null,x=null;for(const U of f.results.all){const Z=(0,nt.tB)(U,this.view);if((0,s.Wi)(Z)||(0,s.Wi)(U.distanceInRenderSpace))continue;const Y=(0,bt.pD)(Z);(0,s.Wi)(Y)||((0,s.pC)(d)&&Y===d&&((0,s.Wi)(L)&&(L=this._getFeatureDistanceThreshold(U,i,C)),U.distanceInRenderSpace<L&&(F=U)),(0,s.pC)(p)&&Y===p&&((0,s.Wi)(S)&&(S=this._getFeatureDistanceThreshold(U,i,C)),(0,s.Wi)(x)&&U.distanceInRenderSpace<C&&C-U.distanceInRenderSpace<S&&(x=U)))}(0,s.pC)(F)&&F.getIntersectionPoint(u)&&(l.observerSurfaceNormal=F.getTransformedNormal((0,b.c)())),(0,s.pC)(x)&&x.getIntersectionPoint(I)&&(l.targetSurfaceNormal=x.getTransformedNormal((0,b.c)()))}_getFeatureDistanceThreshold(t,i,n){if((0,nt._s)(t)){const l=(0,nt.VB)(t,i);if((0,s.pC)(l))return Math.min(l*te,n)}return 1e-5*n}_adjustStartEndPositions(t){const i=this._screenPixelSize,n=this.view,{inputPoints:l}=t,{observer:u,observerSurfaceNormal:d,target:p,targetSurfaceNormal:I,observerAdjusted:C,targetAdjusted:f}=l,m=It;(0,g.c)(C,u),(0,g.c)(f,p),this._updateAdjustedPointsFromFeatures(t),(0,s.pC)(d)?(0,g.c)(m,d):(0,g.b)(m,f,C);const L=i;(0,g.n)(m,m),(0,g.g)(m,m,Math.min(L,1)),(0,g.a)(C,C,m),(0,s.pC)(I)?(0,g.c)(m,I):(0,g.b)(m,C,f);const S=n.state.camera.computeScreenPixelSizeAt(f);(0,g.n)(m,m),(0,g.g)(m,m,Math.min(S,1)),(0,g.a)(f,f,m)}_computeIntersection({computation:t,interpolationInfo:i}){const{view:n}=this,{sceneIntersectionHelper:l,renderCoordsHelper:u}=n;if((0,s.Wi)(l))return;const d=this._intersector.intersector,{computationResult:p,inputPoints:I}=t,{observer:C,target:f}=I,{start:m,end:L}=p,S=(0,B.zk)(m,L,jt);d.options.store=W.eC.MIN,l.intersectToolIntersectorRay(S,d);const F=d.results.min,x=p.intersection,U=It;let Z=!0;if((0,s.pC)(F)&&F.getIntersectionPoint(x)){(0,g.c)(i.originalIntersection,x),(0,g.c)(i.originalObserver,m),(0,g.c)(i.originalTarget,L),u.fromRenderCoords(x,U,n.spatialReference);const G=1-(0,g.j)(L,f)/(0,g.j)(m,f);Z=(0,g.j)(C,x)>=G*(0,g.j)(C,f)}const Y=new Qt.Z(U,n.spatialReference);{const{result:G,target:q}=t;(0,s.pC)(G)?(G.target=q,G.intersectedGraphic=Z?null:(0,nt.tB)(F,n),G.intersectedLocation=Z?null:Y,G.visible=Z):t.result=new T({target:q,elevationAlignedTargetLocation:t.elevationAlignedTargetLocation,intersectedGraphic:Z?null:(0,nt.tB)(F,n),intersectedLocation:Z?null:Y,visible:Z})}p.isValid=I.isValid=!0,p.isTargetVisible=Z}_interpolateIntersection({computation:t,interpolationInfo:i}){const{computationResult:n,inputPoints:l}=t,{start:u,end:d,intersection:p}=n,{originalIntersection:I,originalObserver:C,originalTarget:f}=i;if((0,g.c)(p,I),l.isValid){const m=It,L=(0,g.j)(C,I)/(0,g.j)(C,f);(0,g.v)(m,u,C),(0,g.g)(m,m,1-L),(0,g.a)(p,p,m),(0,g.v)(m,d,f),(0,g.g)(m,m,L),(0,g.a)(p,p,m),n.isValid=!0}else t.result=null,n.isValid=!1,n.isTargetVisible=!1}_canCompute(t){const n=this.view.frustum;if((0,s.Wi)(this.analysisViewData.elevationAlignedObserver)||(0,s.Wi)(t.elevationAlignedTargetLocation)||(0,s.Wi)(n))return!1;const{observerAdjusted:l,targetAdjusted:u}=t.inputPoints,d=n.intersectsPoint(l),p=n.intersectsPoint(u);return d&&p}_onObserverPositionChange(t,i,n,l,u){if(this._externalObserverUpdate=u,(0,s.Wi)(t))return this.analysisViewData.elevationAlignedObserver=null,void(this._observerFeatureId=null);if((0,s.Wi)(i))return(0,Dt.e)(this.analysis,t.spatialReference,zt),void(this.analysisViewData.elevationAlignedObserver=null);const d=this._getEffectiveElevationInfo(i,n),{absoluteZ:p,elevation:I}=(0,h.tq)(i.x,i.y,i.z,this.view.spatialReference,this.view,d),C=i.clone();C.z=p,this._effectiveObserverElevationMode=d.mode,this.analysisViewData.elevationAlignedObserver=C;const f=(0,b.c)();this.view.renderCoordsHelper.toRenderCoords(C,f),this._elevationAlignedObserverPositionRenderSpace=f,this._observerGroundOffsetRenderSpace=p-I,this._observerFeatureId=(0,bt.pD)(l),this.priority=gt.T8.LINE_OF_SIGHT_TOOL_INTERACTIVE}_onObserverRenderSpacePositionChangeForComputation(t,i,n,l,u){const{inputPoints:d}=t;switch((0,g.c)(d.observer,i),d.observerFeatureId=u,d.observerSurfaceNormal=null,l){case"on-the-ground":case"relative-to-ground":{const p=this._intersector.updateFromGroundIntersection(d.observer,n,d.observer);(0,s.Wi)(d.observerFeatureId)&&(d.observerSurfaceNormal=p)}}this._adjustStartEndPositions(t),t.notifyInputPointsChanged(),this.priority=gt.T8.LINE_OF_SIGHT_TOOL_INTERACTIVE}_onTargetPositionChange(t,i,n,l,u,d=!0){const p=t.inputPoints;if(d&&(p.isValid=!1),(0,s.Wi)(n))return(0,s.pC)(i)&&(0,Dt.e)(this.analysis,i.spatialReference,zt),t.elevationAlignedTargetLocation=null,void t.notifyInputPointsChanged();const I=this._getEffectiveElevationInfo(n,l),{absoluteZ:C,elevation:f}=(0,h.tq)(n.x,n.y,n.z,this.view.spatialReference,this.view,I),m=n.clone();switch(m.z=C,t.elevationAlignedTargetLocation=m,this.view.renderCoordsHelper.toRenderCoords(t.elevationAlignedTargetLocation,p.target),p.targetFeatureId=(0,bt.pD)(u),p.targetSurfaceNormal=null,I.mode){case"on-the-ground":case"relative-to-ground":{const L=this._intersector.updateFromGroundIntersection(p.target,C-f,p.target);(0,s.Wi)(p.targetFeatureId)&&(p.targetSurfaceNormal=L)}}this._adjustStartEndPositions(t),t.notifyInputPointsChanged(),this.priority=gt.T8.LINE_OF_SIGHT_TOOL_INTERACTIVE}_connectComputationToTarget(t){return(0,it.AL)([(0,O.YP)(()=>({computation:t,targetPosition:t.target.position,targetElevationInfo:t.target.elevationInfo,targetFeatureInfo:t.target.feature,projectedTargetPosition:(0,k.dz)(t.target.position,this.view.spatialReference)}),({computation:i,targetPosition:n,targetElevationInfo:l,targetFeatureInfo:u,projectedTargetPosition:d})=>{(0,s.pC)(d.pending)?this._updatingHandles.addPromise(d.pending):this._onTargetPositionChange(i,n,d.geometry,l,u)},O.tX)])}_connectComputationToObserver(t){return(0,O.YP)(()=>({computation:t,observer:this.analysisViewData.elevationAlignedObserver}),({computation:i})=>{this._externalObserverUpdate&&(i.inputPoints.isValid=!1,i.notifyInputPointsChanged())},O.tX)}_connectComputationToRenderSpaceObserver(t){return(0,O.YP)(()=>({computation:t,observer:this._elevationAlignedObserverPositionRenderSpace,observerGroundOffset:this._observerGroundOffsetRenderSpace,observerElevationMode:this._effectiveObserverElevationMode,observerFeatureId:this._observerFeatureId}),({computation:i,observer:n,observerGroundOffset:l,observerElevationMode:u,observerFeatureId:d})=>{this._onObserverRenderSpacePositionChangeForComputation(i,n,l,u,d)},O.tX)}_connectComputationToCamera(t){return(0,O.YP)(()=>({camera:this.view.state.camera,isDirty:this._isCameraDirty}),({isDirty:i})=>{!this.updateOnCameraChange||t.inputPoints.isValid&&!i||t.notifyInputPointsChanged()},O.Z_)}_connectComputationToSlicePlane(t){return(0,O.YP)(()=>this.view.slicePlane,()=>{t.inputPoints.isValid=!1,t.notifyInputPointsChanged()})}_connectComputationToElevation(t){const i=(n,l)=>{const u=this.analysis.observer,d=t.target;let p=null,I=null,C=null,f=null,m=null,L=null;if((0,s.pC)(u)&&(0,s.pC)(u.position)){const S=(0,k.dz)(u.position,this.view.spatialReference);if((0,s.pC)(S.pending))return this._updatingHandles.addPromise(S.pending),void S.pending.finally(()=>i(n,l));p=S.geometry,I=u.elevationInfo,C=u.feature}if((0,s.pC)(d.position)){const S=(0,k.dz)(d.position,this.view.spatialReference);if((0,s.pC)(S.pending))return this._updatingHandles.addPromise(S.pending),void S.pending.finally(()=>i(n,l));f=S.geometry,m=d.elevationInfo,L=d.feature}(0,s.Wi)(p)&&(0,s.Wi)(f)||((0,k.dH)(n,l,St,this.view.spatialReference),(0,s.pC)(p)&&(0,ht.Qn)(St,p)&&this._onObserverPositionChange((0,s.pC)(u)?u.position:null,p,I,C,!1),(0,s.pC)(f)&&(0,ht.Qn)(St,f)&&this._onTargetPositionChange(t,d.position,f,m,L,!1),(0,s.pC)(p)&&(0,s.pC)(f)&&(0,ht.I7)(St,p,f)&&t.notifyInputPointsChanged())};return this.view.elevationProvider.on("elevation-change",n=>i(n.extent,n.spatialReference))}_connectComputationToTask(t){var i=this;let n=s.YP;const l={computation:t,interpolationInfo:{originalIntersection:(0,b.c)(),originalObserver:(0,b.c)(),originalTarget:(0,b.c)()}};return(0,it.AL)([(0,O.YP)(()=>this.getLineOfSightComputationDependencies(t),()=>{n=(0,s.IM)(n),n=(0,Tt.vr)(function(){var u=(0,ft.Z)(function*(d){yield(0,Tt.R8)(i._frameTask.schedule(()=>i._computeResult(l),d))});return function(d){return u.apply(this,arguments)}}())},{sync:!0,initial:!0,equals:K.fS}),(0,it.kB)(()=>n=(0,s.IM)(n))])}_connectComputation(t){const i=this._computationHandles;i.has(t)||i.add([this._connectComputationToTarget(t),this._connectComputationToObserver(t),this._connectComputationToRenderSpaceObserver(t),this._connectComputationToCamera(t),this._connectComputationToSlicePlane(t),this._connectComputationToElevation(t),this._connectComputationToTask(t)],t)}_disconnectComputation(t){this._computationHandles.remove(t)}_onComputationCollectionChange({added:t,removed:i}){for(const n of i)this._disconnectComputation(n);for(const n of t)this._connectComputation(n)}_onTargetCollectionChange({added:t,removed:i}){for(const n of i)this._removeTarget(n);for(const n of t)this._addTarget(n)}_onCursorTargetChange(t,i){(0,s.pC)(i)&&this._removeTarget(i),(0,s.pC)(t)&&this._addTarget(t)}_addTarget(t){this._computations.some(i=>i.target===t)||this._computations.add(new _({target:t}))}_removeTarget(t){const i=this._computations.findIndex(n=>n.target===t);this._computations.removeAt(i)}_connectObserver(){return(0,it.AL)([(0,O.YP)(()=>({observerPosition:(0,s.pC)(this.analysis.observer)?this.analysis.observer.position:null,projectedObserverPosition:(0,k.dz)((0,s.pC)(this.analysis.observer)?this.analysis.observer.position:null,this.view.spatialReference),observerElevationInfo:(0,s.pC)(this.analysis.observer)?this.analysis.observer.elevationInfo:null,observerFeatureInfo:(0,s.pC)(this.analysis.observer)?this.analysis.observer.feature:null}),({observerPosition:t,projectedObserverPosition:i,observerElevationInfo:n,observerFeatureInfo:l})=>{(0,s.pC)(i.pending)?this._updatingHandles.addPromise(i.pending):this._onObserverPositionChange(t,i.geometry,n,l,!0)},O.tX)])}_connectComputations(){return(0,O.on)(()=>this._computations,"change",t=>this._onComputationCollectionChange(t),{onListenerAdd:t=>{for(const i of t)this._connectComputation(i)},onListenerRemove:t=>{for(const i of t)this._disconnectComputation(i)},sync:!0})}_connectTargets(){return(0,it.AL)([this._updatingHandles.addOnCollectionChange(()=>this.analysis.targets,t=>this._onTargetCollectionChange(t),{initial:!0,final:!0}),(0,O.YP)(()=>this.analysisViewData.cursorTarget,(t,i)=>{this._onCursorTargetChange(t,i)})])}get _isCameraDirty(){const t=this.analysisViewData.elevationAlignedObserver,{view:i}=this,{renderCoordsHelper:n}=i;if((0,s.Wi)(t)||(0,s.Wi)(n))return!1;const l=It;n.toRenderCoords(t,l);const u=i.state.camera.computeScreenPixelSizeAt(l);return Math.abs((u-this._screenPixelSize)/this._screenPixelSize)>qt}_getEffectiveElevationInfo(t,i){return t.hasZ?(0,s.Pt)(i,{mode:"absolute-height",offset:0}):{mode:"on-the-ground",offset:0}}};(0,o._)([(0,a.Cb)({constructOnly:!0})],M.prototype,"analysis",void 0),(0,o._)([(0,a.Cb)({constructOnly:!0})],M.prototype,"analysisViewData",void 0),(0,o._)([(0,a.Cb)({constructOnly:!0})],M.prototype,"view",void 0),(0,o._)([(0,a.Cb)()],M.prototype,"updating",null),(0,o._)([(0,a.Cb)()],M.prototype,"priority",null),(0,o._)([(0,a.Cb)()],M.prototype,"updateOnCameraChange",void 0),(0,o._)([(0,a.Cb)()],M.prototype,"_computations",null),(0,o._)([(0,a.Cb)()],M.prototype,"_elevationAlignedObserverPositionRenderSpace",null),(0,o._)([(0,a.Cb)()],M.prototype,"_observerGroundOffsetRenderSpace",void 0),(0,o._)([(0,a.Cb)()],M.prototype,"_effectiveObserverElevationMode",void 0),(0,o._)([(0,a.Cb)()],M.prototype,"_observerFeatureId",void 0),(0,o._)([(0,a.Cb)()],M.prototype,"_screenPixelSize",null),(0,o._)([(0,a.Cb)({readOnly:!0})],M.prototype,"_updatingHandles",void 0),(0,o._)([(0,a.Cb)()],M.prototype,"_frameTask",void 0),(0,o._)([(0,a.Cb)()],M.prototype,"_isCameraDirty",null),M=(0,o._)([(0,E.j)("esri.views.3d.analysis.LineOfSight.LineOfSightController")],M);const qt=.1,It=(0,b.c)(),jt=(0,B.Ue)(),St=(0,ht.cS)(),te=.05;var Wt=c(61642),At=c(57574),Ut=c(13777),xt=c(82706);let X=class extends w.Z{constructor(t){super(t),this.enabled=!0,this.glowColor=new v.Z([255,127,0]),this.glowWidth=8,this.innerColor=new v.Z([255,255,255]),this.innerWidth=.75,this.globalAlpha=.75}};(0,o._)([(0,a.Cb)({type:Boolean})],X.prototype,"enabled",void 0),(0,o._)([(0,a.Cb)({type:v.Z})],X.prototype,"glowColor",void 0),(0,o._)([(0,a.Cb)({type:Number})],X.prototype,"glowWidth",void 0),(0,o._)([(0,a.Cb)({type:v.Z})],X.prototype,"innerColor",void 0),(0,o._)([(0,a.Cb)({type:Number})],X.prototype,"innerWidth",void 0),(0,o._)([(0,a.Cb)({type:Number})],X.prototype,"globalAlpha",void 0),X=(0,o._)([(0,E.j)("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightLaserLineConfiguration")],X);let yt=class extends w.Z{constructor(t){super(t),this.size=.5,this.color=new v.Z([255,127,0,.75])}};(0,o._)([(0,a.Cb)({type:Number})],yt.prototype,"size",void 0),(0,o._)([(0,a.Cb)({type:v.Z})],yt.prototype,"color",void 0),yt=(0,o._)([(0,E.j)("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightObserverConfiguration")],yt);let ot=class extends w.Z{constructor(t){super(t),this.size=.5,this.visibleColor=new v.Z([3,252,111,.75]),this.occludedColor=new v.Z([252,3,69,.75]),this.undefinedColor=new v.Z([127,127,127,.75])}};(0,o._)([(0,a.Cb)({type:Number})],ot.prototype,"size",void 0),(0,o._)([(0,a.Cb)({type:v.Z})],ot.prototype,"visibleColor",void 0),(0,o._)([(0,a.Cb)({type:v.Z})],ot.prototype,"occludedColor",void 0),(0,o._)([(0,a.Cb)({type:v.Z})],ot.prototype,"undefinedColor",void 0),ot=(0,o._)([(0,E.j)("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightTargetConfiguration")],ot);class $ extends w.Z{constructor(i){super(i),this.innerWidth=2,this.outerWidth=8,this.visibleInnerColor=new v.Z([3,252,111,1]),this.visibleOuterColor=new v.Z([3,252,111,.15]),this.occludedInnerColor=new v.Z([252,3,69,1]),this.occludedOuterColor=new v.Z([252,3,69,.1]),this.undefinedInnerColor=new v.Z([255,255,255,1]),this.undefinedOuterColor=new v.Z([127,127,127,.2])}}(0,o._)([(0,a.Cb)({type:Number})],$.prototype,"innerWidth",void 0),(0,o._)([(0,a.Cb)({type:Number})],$.prototype,"outerWidth",void 0),(0,o._)([(0,a.Cb)({type:v.Z})],$.prototype,"visibleInnerColor",void 0),(0,o._)([(0,a.Cb)({type:v.Z})],$.prototype,"visibleOuterColor",void 0),(0,o._)([(0,a.Cb)({type:v.Z})],$.prototype,"occludedInnerColor",void 0),(0,o._)([(0,a.Cb)({type:v.Z})],$.prototype,"occludedOuterColor",void 0),(0,o._)([(0,a.Cb)({type:v.Z})],$.prototype,"undefinedInnerColor",void 0),(0,o._)([(0,a.Cb)({type:v.Z})],$.prototype,"undefinedOuterColor",void 0);let rt=class extends w.Z{constructor(t){super(t),this.laserLine=new X,this.observer=new yt,this.target=new ot,this.lineOfSight=new $}};(0,o._)([(0,a.Cb)({type:X})],rt.prototype,"laserLine",void 0),(0,o._)([(0,a.Cb)({type:yt})],rt.prototype,"observer",void 0),(0,o._)([(0,a.Cb)({type:ot})],rt.prototype,"target",void 0),(0,o._)([(0,a.Cb)({type:$})],rt.prototype,"lineOfSight",void 0),rt=(0,o._)([(0,E.j)("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightToolConfiguration")],rt);var ee=c(45403),ie=c(35754),oe=c(57521),Ct=c(33786);function wt(t,i,n){return{geometry:oe.Z.createSphereGeometry(t,32,32),material:(0,ie.EA)(v.Z.toUnitRGBA(i)),stateMask:n}}function Ht(t){const i=[];return t.customColor1&&i.push(wt(t.size,t.customColor1,Ct.jg.Custom1)),t.customColor2&&i.push(wt(t.size,t.customColor2,Ct.jg.Custom2)),t.customColor3&&i.push(wt(t.size,t.customColor3,Ct.jg.Custom3)),t.color&&i.push(wt(t.size,t.color)),i}var ut,t,se=c(23018),ae=(c(45458),c(58997)),Ft=c(30260),Gt=c(41900),Zt=c(85112);(t=ut||(ut={})).Ready="ready",t.Creating="creating",t.Created="created",dt.Z.ofType(At.Z);const Nt=_t.Z.getLogger("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightTool");let z=class extends ae.f{constructor(t){super(t),this.preferManipulatorCursor=!0,this.removeIncompleteOnCancel=!1,this.configuration=new rt,this.analysisViewData=null,this._laserlineVisualElement=null,this._grabbedManipulator=null,this._analysisHandles=new et.Z,this._handles=new et.Z,this._manipulatorHandles=new et.Z,this._targetTrackerManipulator=null}initialize(){this._intersector=new vt({view:this.view}),this._handles.add((0,O.YP)(()=>this.state,t=>{t===ut.Created&&this.finishToolCreation()},O.tX)),this._observerManipulator=this._createObserverManipulator(),this._handles.add([(0,O.YP)(()=>({...this.configuration.observer}),()=>this._updateObserverManipulatorStyle(),O.Z_),(0,O.YP)(()=>this.analysisViewData.elevationAlignedObserver,t=>this._onObserverLocationChange(t),O.tX),(0,O.YP)(()=>({...this.configuration.laserLine}),()=>this._createVisualElements(),O.tX),(0,O.YP)(()=>this._laserLineRendererDependencies(),t=>this._updateLaserLineRenderer(t)),this._connectComputations()])}destroy(){this._handles=(0,s.SC)(this._handles),this._manipulatorHandles=(0,s.SC)(this._manipulatorHandles),this._analysisHandles=(0,s.SC)(this._analysisHandles),this._observerManipulator=null,this._clearCursorTracker(),this._removeVisualElements(),this._intersector=null,this._set("analysis",null)}get state(){return this.active?(0,s.pC)(this._grabbedManipulator)?ut.Created:ut.Creating:(0,s.pC)(this.analysis.observer)&&(0,s.pC)(this.analysis.observer.position)?ut.Created:ut.Ready}get cursor(){return this.active&&this._showTracker?"crosshair":null}get updating(){return!!(0,s.pC)(this.analysisViewData)&&this.analysisViewData.updating}get _showTracker(){return this.active&&"mouse"===this._latestPointerMovePointerType}get _shouldRenderTracker(){return this._showTracker&&(0,s.pC)(this.analysis.observer)&&(0,s.pC)(this.analysis.observer.position)&&!this.hasFocusedManipulators}continue(){this.view.activeTool=this}stop(){this.view.activeTool=null}onEditableChange(){this.analysisViewData.editable=this.internallyEditable}onInputEvent(t){switch(t.type){case"immediate-double-click":this._doubleClickHandler(t);break;case"key-down":this._keyDownHandler(t);break;case"pointer-move":this._pointerMoveHandler(t)}}onInputEventAfter(t){"immediate-click"===t.type&&this._clickHandler(t)}onShow(){}onHide(){this._grabbedManipulator=null}onDeactivate(){this._clearCursorTracker()}_connectComputations(){return(0,O.on)(()=>this.analysisViewData.computations,"change",t=>this._onComputationsCollectionChange(t),{onListenerAdd:t=>{for(const i of t)this._connectComputation(i)},onListenerRemove:t=>{for(const i of t)this._disconnectComputation(i)},sync:!0})}_onComputationsCollectionChange({added:t,removed:i}){for(const n of i)this._disconnectComputation(n);for(const n of t)this._connectComputation(n)}_connectComputation(t){if(this.destroyed)return void Nt.warn("Attempting to connect an analysis to a destroyed LineOfSight tool. Ignoring.");const i=this._analysisHandles;if(i.has(t))return;const n=this._createTargetManipulator(t.target);(0,s.Wi)(this._targetTrackerManipulator)&&n.metadata.target===this.analysisViewData.cursorTarget&&(this._targetTrackerManipulator=n,this._targetTrackerManipulator.available=!1,this._targetTrackerManipulator.interactive=!1,this._updateLaserLineRenderer()),i.add([(0,O.YP)(()=>this._getLineOfSightManipulatorStateDependencies(t),()=>this._updateManipulatorState(n,t),O.tX),(0,O.YP)(()=>t.elevationAlignedTargetLocation,l=>this._onTargetLocationChange(l,n),O.tX)],t)}_disconnectComputation(t){if(this.destroyed)return void Nt.warn("Attempting to disconnect an analysis from a destroyed LineOfSight tool. Ignoring.");this._analysisHandles.remove(t);const i=this._getTargetManipulator(t.target);(0,s.pC)(i)&&(this.manipulators.remove(i),this._manipulatorHandles.remove(i),(0,s.pC)(this._targetTrackerManipulator)&&this._targetTrackerManipulator===i&&(this._targetTrackerManipulator=null))}_clearCursorTracker(){this.analysisViewData.cursorTarget=(0,s.SC)(this.analysisViewData.cursorTarget)}_createManipulator(t,i,n){const l=function re(t,i){const n=Ht(i),l=new ee.Z({view:t,renderObjects:n,elevationInfo:{mode:"absolute-height",offset:0}});return function ne(t,i){let n=null;t.events.on("grab-changed",u=>{(0,s.pC)(n)&&(n.remove(),n=null),"start"===u.action&&(n=t.disableDisplay()),i&&i(u)})}(l),l}(this.view,t);return l.metadata=n,this._manipulatorHandles.add([i(l),l.events.on("grab-changed",u=>this._manipulatorGrabChanged(l,u)),l.events.on("immediate-click",u=>this._manipulatorClick(l,u))],l),this.manipulators.add(l),l}_createTargetManipulator(t){const i=this.configuration,u=this._createManipulator({size:i.target.size,customColor1:i.target.visibleColor,customColor2:i.target.occludedColor,customColor3:i.target.undefinedColor,visible:!0},d=>this._createTargetManipulatorDragPipeline(d),{target:t,type:"target"});return(0,s.pC)(t.position)?u.elevationAlignedLocation=t.position:u.available=!1,u}_getTargetManipulator(t){let i=null;return this.manipulators.forEach(n=>{const l=n.manipulator;(0,s.Wi)(i)&&"target"===l.metadata.type&&l.metadata.target===t&&(i=l)}),i}_createObserverManipulator(){const t=this.configuration;return this._createManipulator({size:t.observer.size,color:t.observer.color,visible:!0},n=>this._createObserverManipulatorDragPipeline(n),{type:"observer",intersection:null})}_updateObserverManipulatorStyle(){const t=this._observerManipulator,i=this.configuration.observer;t.renderObjects=Ht({size:i.size,color:i.color,visible:t.available})}_screenToIntersection(){return t=>{const i=this._intersector.getScreenPointIntersection(t.screenEnd);return(0,s.Wi)(i)?null:{...t,intersection:i}}}_createTargetManipulatorDragPipeline(t){return(0,Ft.Xd)(t,(i,n,l)=>{n.next(this._screenToIntersection()).next(this._updateTargetDragStep(t)).next(()=>this._updateLaserLineRenderer()),l.next(this._cancelTargetDragStep(t.metadata.target)).next(()=>this._updateLaserLineRenderer())})}_createObserverManipulatorDragPipeline(t){return(0,Ft.Xd)(t,(i,n,l)=>{n.next(this._screenToIntersection()).next(this._updateObserverDragStep()).next(()=>this._updateLaserLineRenderer()),l.next(this._cancelObserverDragStep()).next(()=>this._updateLaserLineRenderer())})}_updateObserverDragStep(){return t=>((0,s.pC)(t.intersection.point)?((0,s.Wi)(this.analysis.observer)&&(this.analysis.observer=new Wt.Z),this._updateFromIntersection(this.analysis.observer,t.intersection)):this.analysis.observer=null,t)}_cancelObserverDragStep(){const t=(0,s.pC)(this.analysis.observer)&&(0,s.pC)(this.analysis.observer.position)?this.analysis.observer.clone():null;return i=>(this.analysis.observer=t,i)}_updateTargetDragStep(t){return i=>{this._updateFromIntersection(t.metadata.target,i.intersection);const n=i.intersection.point;return(0,s.pC)(n)&&(t.elevationAlignedLocation=n),i}}_cancelTargetDragStep(t){const i=(0,s.yw)(t.position,n=>n.clone());return n=>(t.position=i,n)}_manipulatorGrabChanged(t,i){switch(i.action){case"start":this._grabbedManipulator=t;break;case"end":this._grabbedManipulator===t&&(this._grabbedManipulator=null)}}_updateManipulatorState(t,i){const{isValid:n,isTargetVisible:l}=i.computationResult;t.state=n?l?Ct.jg.Custom1:Ct.jg.Custom2:Ct.jg.Custom3}_getLineOfSightManipulatorStateDependencies(t){const{isValid:i,isTargetVisible:n}=t.computationResult;return{isValid:i,isTargetVisible:n}}_laserLineRendererDependencies(){return{laserlineVisualElement:this._laserlineVisualElement,grabbedManipulator:this._grabbedManipulator,shouldRenderTracker:this._shouldRenderTracker,observerPosition:(0,s.pC)(this.analysis.observer)?this.analysis.observer.position:null,visible:this.visible}}_updateLaserLineRenderer(t=this._laserLineRendererDependencies()){const{laserlineVisualElement:i,grabbedManipulator:n,shouldRenderTracker:l,observerPosition:u,visible:d}=t;if((0,s.Wi)(i))return;const p=(0,s.pC)(n)?n:l&&(0,s.pC)(u)?this._targetTrackerManipulator:null;this.configuration.laserLine.enabled&&(0,s.pC)(p)&&d?(i.visible=!0,i.heightManifoldTarget=p.renderLocation,i.lineVerticalPlaneSegment=p!==this._observerManipulator?(0,Ut.zk)(this._observerManipulator.renderLocation,p.renderLocation,le):null):(i.visible=!1,i.heightManifoldTarget=null,i.lineVerticalPlaneSegment=null)}_createVisualElements(){const t=this.configuration.laserLine;this._removeVisualElements(),this._laserlineVisualElement=new se.W({view:this.view,attached:!0,visible:this.visible,style:{glowColor:v.Z.toUnitRGB(t.glowColor),glowWidth:t.glowWidth,innerColor:v.Z.toUnitRGB(t.innerColor),innerWidth:t.innerWidth,globalAlpha:t.globalAlpha}})}_removeVisualElements(){(0,s.pC)(this._laserlineVisualElement)&&(this._laserlineVisualElement.destroy(),this._laserlineVisualElement=null)}_onObserverLocationChange(t){(0,s.Wi)(t)?this._observerManipulator.available=!1:(this._observerManipulator.metadata.intersection=null,this._observerManipulator.available=!0,this._observerManipulator.elevationAlignedLocation=t)}_onTargetLocationChange(t,i){(0,s.pC)(t)?(i.elevationAlignedLocation=t,i!==this._targetTrackerManipulator&&(i.available=!0)):i.available=!1}_addPointFromClickEvent(t){const i=this._intersector.getScreenPointIntersection(t);if(!(0,s.Wi)(i)&&!(0,s.Wi)(i.point))if((0,s.pC)(this.analysis.observer)&&(0,s.pC)(this.analysis.observer.position)){this._clearCursorTracker();const n=new At.Z;this._updateFromIntersection(n,i),this.analysis.targets.add(n)}else{const n=new Wt.Z;this._updateFromIntersection(n,i),this.analysis.observer=n}}_clickHandler(t){this.active&&t.button!==Zt.t.Right&&(this._addPointFromClickEvent((0,Gt.vT)(t)),t.stopPropagation())}_doubleClickHandler(t){this.active&&t.button!==Zt.t.Right&&(this.stop(),t.stopPropagation())}_keyDownHandler(t){this.active&&"Escape"===t.key&&(this.stop(),t.stopPropagation())}_pointerMoveHandler(t){if(this.hasFocusedManipulators||(this._latestPointerMovePointerType=t.pointerType,this._updateLaserLineRenderer(),!this._showTracker||(0,s.Wi)(this.analysis.observer)||(0,s.Wi)(this.analysis.observer.position)))return;const i=(0,Gt.vT)(t),n=this._intersector.getScreenPointIntersection(i);(0,s.pC)(n)&&(0,s.pC)(n.point)&&((0,s.Wi)(this.analysisViewData.cursorTarget)&&(this.analysisViewData.cursorTarget=new At.Z),this._updateFromIntersection(this.analysisViewData.cursorTarget,n),this._updateLaserLineRenderer())}_updateFromIntersection(t,i){if((0,s.Wi)(i.point))return t.position=null,t.elevationInfo=null,void(t.feature=null);switch(i.type){case W.q7.OBJECT:if((0,s.pC)(i.graphic)){const l=i.graphic,u=(0,h.RL)(l);"on-the-ground"===u.mode&&(u.mode="relative-to-ground",u.offset=0),t.elevationInfo=new xt.ZP(u),t.feature=l}else t.elevationInfo=null,t.feature=null;break;case W.q7.TERRAIN:case W.q7.I3S:t.elevationInfo=new xt.ZP({mode:"on-the-ground"}),t.feature=null;break;default:t.elevationInfo=null,t.feature=null}const n=i.point.clone();n.z=(0,h.vQ)(this.view,n,{mode:"absolute-height",offset:0},t.elevationInfo),t.position=n}_manipulatorClick(t,i){if("observer"===t.metadata.type||t.grabbing||t.dragging||i.button!==Zt.t.Right||this.analysis.targets.length<=1)return;const{target:n}=t.metadata;this.analysis.targets.remove(n),i.stopPropagation()}get testInfo(){return{laserLineVisualElement:this._laserlineVisualElement}}};(0,o._)([(0,a.Cb)({constructOnly:!0})],z.prototype,"view",void 0),(0,o._)([(0,a.Cb)({constructOnly:!0})],z.prototype,"analysis",void 0),(0,o._)([(0,a.Cb)({readOnly:!0})],z.prototype,"state",null),(0,o._)([(0,a.Cb)({readOnly:!0})],z.prototype,"cursor",null),(0,o._)([(0,a.Cb)({readOnly:!0})],z.prototype,"preferManipulatorCursor",void 0),(0,o._)([(0,a.Cb)()],z.prototype,"removeIncompleteOnCancel",void 0),(0,o._)([(0,a.Cb)({readOnly:!0})],z.prototype,"updating",null),(0,o._)([(0,a.Cb)({type:rt})],z.prototype,"configuration",void 0),(0,o._)([(0,a.Cb)({constructOnly:!0})],z.prototype,"analysisViewData",void 0),(0,o._)([(0,a.Cb)({readOnly:!0})],z.prototype,"_showTracker",null),(0,o._)([(0,a.Cb)()],z.prototype,"_latestPointerMovePointerType",void 0),(0,o._)([(0,a.Cb)()],z.prototype,"_shouldRenderTracker",null),(0,o._)([(0,a.Cb)()],z.prototype,"_laserlineVisualElement",void 0),(0,o._)([(0,a.Cb)()],z.prototype,"_grabbedManipulator",void 0),z=(0,o._)([(0,E.j)("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightTool")],z);const le=(0,Ut.Ue)();var ce=c(43703),Mt=c(87469),Bt=c(21232);let J=class extends w.Z{constructor(t){super(t),this._lineOfSightVisualizations=[],this._computationHandles=new et.Z}initialize(){this.own(this._connectComputations()),this._createObserverVisualization()}destroy(){this._computationHandles=(0,s.SC)(this._computationHandles),this._observerVisualElement=(0,s.SC)(this._observerVisualElement)}get visible(){return this.analysisViewData.visible}get interactiveAndEditable(){return this.analysisViewData.interactive&&this.analysisViewData.editable}get testInfo(){return{visualizations:this._lineOfSightVisualizations}}get _configuration(){return this.analysisViewData.configuration}_createLineOfSightVisualization(){const t=this._configuration,i=this.view,n={view:i,attached:!0,width:t.outerWidth,innerWidth:t.innerWidth},l=v.Z.toUnitRGBA(t.visibleOuterColor),u=v.Z.toUnitRGBA(t.visibleInnerColor),d=v.Z.toUnitRGBA(t.occludedOuterColor),p=v.Z.toUnitRGBA(t.occludedInnerColor),I=v.Z.toUnitRGBA(t.undefinedOuterColor),C=v.Z.toUnitRGBA(t.undefinedInnerColor),f={visibleLineVisualElement:new Mt.r({...n,color:l,innerColor:u}),occludedLineVisualElement:new Mt.r({...n,color:d,innerColor:p}),undefinedLineVisualElement:new Mt.r({...n,color:I,innerColor:C}),targetVisualElement:new Bt.L({view:i,attached:!0,...Yt,size:8})};return this._lineOfSightVisualizations.push(f),f}_destroyLineOfSightVisualization(t){t.visibleLineVisualElement=(0,s.SC)(t.visibleLineVisualElement),t.occludedLineVisualElement=(0,s.SC)(t.occludedLineVisualElement),t.undefinedLineVisualElement=(0,s.SC)(t.undefinedLineVisualElement),t.targetVisualElement=(0,s.SC)(t.targetVisualElement),this._lineOfSightVisualizations.splice(this._lineOfSightVisualizations.indexOf(t),1)}_updateLineOfSightVisualization(t,i,n){const l=this._configuration,{computationResult:u,inputPoints:d}=t,{start:p,end:I,intersection:C,isValid:f,isTargetVisible:m}=u,{observer:L}=d,S=he;S[12]=L[0],S[13]=L[1],S[14]=L[2];const F=(0,g.b)(ue,p,L),x=(0,g.b)(de,I,L),U=(0,g.b)(pe,C,L),{visibleLineVisualElement:Z,occludedLineVisualElement:Y,undefinedLineVisualElement:G,targetVisualElement:q}=i,ge=(0,s.Wi)(this.analysisViewData.elevationAlignedObserver)||(0,s.Wi)(t.elevationAlignedTargetLocation),Ot=this.visible&&!ge;Z.visible=Ot,Y.visible=Ot,G.visible=Ot,q.visible=Ot,q.attached=!n.interactiveAndEditable,Ot&&(Z.geometry=null,Y.geometry=null,G.geometry=null,q.geometry=t.elevationAlignedTargetLocation,f?m?(Z.geometry=[[(0,b.d)(F),(0,b.d)(x)]],Z.transform=S,Z.color=v.Z.toUnitRGBA(l.visibleOuterColor),q.color=v.Z.toUnitRGBA(l.visibleInnerColor)):(Z.geometry=[[(0,b.d)(F),(0,b.d)(U)]],Z.transform=S,Z.color=v.Z.toUnitRGBA(l.occludedOuterColor),Y.geometry=[[(0,b.d)(U),(0,b.d)(x)]],Y.transform=S,q.color=v.Z.toUnitRGBA(l.occludedInnerColor)):(G.geometry=[[(0,b.d)(F),(0,b.d)(x)]],G.transform=S,q.color=v.Z.toUnitRGBA(l.undefinedInnerColor)))}_getLineOfSightVisualizationDependencies(t){const{computationResult:i}=t,{occludedOuterColor:n,visibleOuterColor:l}=this._configuration;return{computationResult:i,occludedOuterColor:n,visibleOuterColor:l,visible:this.visible,interactiveAndEditable:this.interactiveAndEditable}}_connectComputation(t){const i=this._computationHandles;if(i.has(t))return;const n=this._createLineOfSightVisualization();i.add([(0,O.YP)(()=>this._getLineOfSightVisualizationDependencies(t),l=>this._updateLineOfSightVisualization(t,n,l),{sync:!0,initial:!0,equals:K.fS}),(0,it.kB)(()=>this._destroyLineOfSightVisualization(n))],t)}_disconnectComputation(t){this._computationHandles.remove(t)}_connectComputations(){return(0,O.on)(()=>this.analysisViewData.computations,"change",t=>this._onComputationsCollectionChange(t),{sync:!0,onListenerAdd:t=>{for(const i of t)this._connectComputation(i)},onListenerRemove:t=>{for(const i of t)this._disconnectComputation(i)}})}_onComputationsCollectionChange({added:t,removed:i}){for(const n of i)this._disconnectComputation(n);for(const n of t)this._connectComputation(n)}_createObserverVisualization(){const t=v.Z.toUnitRGBA(this._configuration.visibleInnerColor),i=new Bt.L({view:this.view,attached:!1,color:t,...Yt});this._observerVisualElement=i,this.own((0,O.YP)(()=>({observer:this.analysisViewData.elevationAlignedObserver,interactiveAndEditable:this.interactiveAndEditable,visible:this.visible}),({observer:n,interactiveAndEditable:l,visible:u})=>{(0,s.Wi)(n)||l||!u?i.attached=!1:(i.geometry=n,this._observerVisualElement.attached=!0)},O.nn))}};(0,o._)([(0,a.Cb)({constructOnly:!0})],J.prototype,"analysis",void 0),(0,o._)([(0,a.Cb)({constructOnly:!0})],J.prototype,"analysisViewData",void 0),(0,o._)([(0,a.Cb)({constructOnly:!0})],J.prototype,"view",void 0),(0,o._)([(0,a.Cb)({readOnly:!0})],J.prototype,"visible",null),(0,o._)([(0,a.Cb)()],J.prototype,"interactiveAndEditable",null),(0,o._)([(0,a.Cb)()],J.prototype,"testInfo",null),(0,o._)([(0,a.Cb)()],J.prototype,"_configuration",null),J=(0,o._)([(0,E.j)("esri.views.3d.analysis.LineOfSight.LineOfSightVisualization")],J);const Yt={size:6,pixelSnappingEnabled:!1,primitive:"circle",elevationInfo:{mode:"absolute-height",offset:0},outlineSize:0},ue=(0,b.c)(),de=(0,b.c)(),pe=(0,b.c)(),he=(0,ce.c)();var Xt=c(95925);let j=class extends((0,mt.p)(N.Z.EventedMixin(w.Z))){constructor(t){super(t),this.type="line-of-sight-view-3d",this.analysis=null,this.tool=null,this.computations=new dt.Z,this.elevationAlignedObserver=null,this.configuration=new H,this.observerEngineLocation=(0,b.c)(),this.cursorTarget=null,this.editable=!0}initialize(){const t=this.view,i=this.analysis;this._analysisController=new M({analysis:i,analysisViewData:this,view:t}),this._analysisVisualization=new J({analysis:i,analysisViewData:this,view:t}),this.own([this._analysisController.on("result-changed",n=>{n.target!==this.cursorTarget&&this.emit("result-changed",n)}),(0,Xt.Lp)(this,z)])}destroy(){(0,Xt.Yq)(this),this._analysisController=(0,s.SC)(this._analysisController),this._analysisVisualization=(0,s.SC)(this._analysisVisualization)}get results(){return this.computations.map(t=>t.result)}get priority(){return this._analysisController.priority}set priority(t){this._analysisController.priority=t}get updating(){return(0,s.pC)(this._analysisController)&&this._analysisController.updating}getResultForTarget(t){const i=this.computations.find(n=>n.target===t);return(0,s.yw)(i,n=>n.result)}get testInfo(){return{visualization:this._analysisVisualization,controller:this._analysisController}}};(0,o._)([(0,a.Cb)({readOnly:!0})],j.prototype,"type",void 0),(0,o._)([(0,a.Cb)({constructOnly:!0,nonNullable:!0})],j.prototype,"analysis",void 0),(0,o._)([(0,a.Cb)()],j.prototype,"tool",void 0),(0,o._)([(0,a.Cb)({readOnly:!0})],j.prototype,"results",null),(0,o._)([(0,a.Cb)()],j.prototype,"priority",null),(0,o._)([(0,a.Cb)()],j.prototype,"computations",void 0),(0,o._)([(0,a.Cb)()],j.prototype,"elevationAlignedObserver",void 0),(0,o._)([(0,a.Cb)()],j.prototype,"configuration",void 0),(0,o._)([(0,a.Cb)()],j.prototype,"observerEngineLocation",void 0),(0,o._)([(0,a.Cb)()],j.prototype,"cursorTarget",void 0),(0,o._)([(0,a.Cb)()],j.prototype,"updating",null),(0,o._)([(0,a.Cb)()],j.prototype,"editable",void 0),(0,o._)([(0,a.Cb)()],j.prototype,"_analysisController",void 0),(0,o._)([(0,a.Cb)()],j.prototype,"_analysisVisualization",void 0),j=(0,o._)([(0,E.j)("esri.views.3d.analysis.LineOfSightAnalysisView3D")],j);const ve=j},54865:(Lt,tt,c)=>{c.d(tt,{G:()=>N,e:()=>s});var o=c(62208),w=c(55915),dt=c(53929);function N(a,st,at,pt=!1){const E=(0,w.fM)(a,st);return(0,o.Wi)(E)?null:(E.hasZ&&!pt||!(0,o.pC)(at)||(E.z=(0,o.Pt)((0,dt.KO)(at,E),0)),E)}function s(a,st,at){at.warnOnce(`Failed to project analysis geometry (id: '${a.id}'), projection from spatial reference (wkid: '${st.wkid}') to view spatial reference is not supported. Projection may be possible after calling projection.load().`)}}}]);