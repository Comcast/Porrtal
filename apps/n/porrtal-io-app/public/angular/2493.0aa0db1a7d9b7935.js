"use strict";(self.webpackChunka_porrtal_io_app=self.webpackChunka_porrtal_io_app||[]).push([[2493],{42493:(j,D,p)=>{p.r(D),p.d(D,{ElevationQuery:()=>Q,GeometryDescriptor:()=>T,getFinestLodIndex:()=>Z});var h=p(15861),P=p(59213),y=p(26584),v=p(62208),x=p(10699),z=p(16730),w=p(72854),_=p(49672),b=p(55214),g=p(55915),E=p(65401),q=p(13762);class F{constructor(e,t=null){if(this.tile=e,this.zmin=0,this.zmax=0,(0,v.pC)(t)){const i=e.extent;this.samplerData={pixelData:t.values,width:t.width,height:t.height,safeWidth:.99999999*(t.width-1),noDataValue:t.noDataValue,dx:(t.width-1)/(i[2]-i[0]),dy:(t.width-1)/(i[3]-i[1]),x0:i[0],y1:i[3]},this.zmin=t.minValue,this.zmax=t.maxValue}}sample(e,t){if((0,v.Wi)(this.samplerData))return;const{safeWidth:i,width:n,pixelData:o,noDataValue:l,dx:s,dy:a,y1:r,x0:c}=this.samplerData,u=M(a*(r-t),0,i),d=M(s*(e-c),0,i),f=Math.floor(u),V=Math.floor(d),I=f*n+V,L=I+n,C=o[I],A=o[L],O=o[I+1],G=o[L+1];if(C!==l&&A!==l&&O!==l&&G!==l){const U=d-V,W=C+(O-C)*U;return W+(A+(G-A)*U-W)*(u-f)}}}function M(m,e,t){return m<e?e:m>t?t:m}class Q{queryAll(e,t,i){var n=this;return(0,h.Z)(function*(){if(!(e=i&&i.ignoreInvisibleLayers?e.filter(c=>c.visible):e.slice()).length)throw new y.Z("elevation-query:invalid-layer","Elevation queries require at least one elevation layer to fetch tiles from");const o=T.fromGeometry(t);let l=!1;i&&i.returnSampleInfo||(l=!0);const s={...R,...i,returnSampleInfo:!0},a=yield n.query(e[e.length-1],o,s),r=yield n._queryAllContinue(e,a,s);return r.geometry=r.geometry.export(),l&&delete r.sampleInfo,r})()}query(e,t,i){var n=this;return(0,h.Z)(function*(){if(!e)throw new y.Z("elevation-query:invalid-layer","Elevation queries require an elevation layer to fetch tiles from");if(!t||!(t instanceof T)&&"point"!==t.type&&"multipoint"!==t.type&&"polyline"!==t.type)throw new y.Z("elevation-query:invalid-geometry","Only point, polyline and multipoint geometries can be used to query elevation");const o={...R,...i},l=new $(e,t.spatialReference,o),s=o.signal;return yield e.load({signal:s}),yield n._createGeometryDescriptor(l,t,s),yield n._selectTiles(l,s),yield n._populateElevationTiles(l,s),n._sampleGeometryWithElevation(l),n._createQueryResult(l,s)})()}createSampler(e,t,i){var n=this;return(0,h.Z)(function*(){if(!e)throw new y.Z("elevation-query:invalid-layer","Elevation queries require an elevation layer to fetch tiles from");if(!t||"extent"!==t.type)throw new y.Z("elevation-query:invalid-extent","Invalid or undefined extent");const o={...R,...i};return n._createSampler(e,t,o)})()}createSamplerAll(e,t,i){var n=this;return(0,h.Z)(function*(){if(!(e=i&&i.ignoreInvisibleLayers?e.filter(s=>s.visible):e.slice()).length)throw new y.Z("elevation-query:invalid-layer","Elevation queries require at least one elevation layer to fetch tiles from");if(!t||"extent"!==t.type)throw new y.Z("elevation-query:invalid-extent","Invalid or undefined extent");const o={...R,...i,returnSampleInfo:!0},l=yield n._createSampler(e[e.length-1],t,o);return n._createSamplerAllContinue(e,t,l,o)})()}_createSampler(e,t,i,n){var o=this;return(0,h.Z)(function*(){const l=i.signal;yield e.load({signal:l});const s=t.spatialReference,a=e.tileInfo.spatialReference;s.equals(a)||(yield(0,g.iQ)([{source:s,dest:a}],{signal:l}),t=(0,g.iV)(t,a));const r=new N(e,t,i,n);return yield o._selectTiles(r,l),yield o._populateElevationTiles(r,l),new q.Tl(r.elevationTiles,r.layer.tileInfo,r.options.noDataValue)})()}_createSamplerAllContinue(e,t,i,n){var o=this;return(0,h.Z)(function*(){if(e.pop(),!e.length)return i;const l=i.samplers.map(c=>(0,E.oJ)(c.extent)),s=yield o._createSampler(e[e.length-1],t,n,l);if(0===s.samplers.length)return i;const a=i.samplers.concat(s.samplers),r=new q.Tl(a,n.noDataValue);return o._createSamplerAllContinue(e,t,r,n)})()}_queryAllContinue(e,t,i){var n=this;return(0,h.Z)(function*(){const o=e.pop(),l=t.geometry.coordinates,s=[],a=[];for(let u=0;u<l.length;u++){const d=t.sampleInfo[u];d.demResolution>=0?d.source||(d.source=o):e.length&&(s.push(l[u]),a.push(u))}if(!e.length||0===s.length)return t;const r=t.geometry.clone(s),c=yield n.query(e[e.length-1],r,i);return a.forEach((u,d)=>{l[u].z=c.geometry.coordinates[d].z,t.sampleInfo[u].demResolution=c.sampleInfo[d].demResolution}),n._queryAllContinue(e,t,i)})()}_createQueryResult(e,t){var i=this;return(0,h.Z)(function*(){const n={geometry:(yield e.geometry.project(e.outSpatialReference,t)).export(),noDataValue:e.options.noDataValue};return e.options.returnSampleInfo&&(n.sampleInfo=i._extractSampleInfo(e)),e.geometry.coordinates.forEach(o=>{o.tile=null,o.elevationTile=null}),n})()}_createGeometryDescriptor(e,t,i){return(0,h.Z)(function*(){let n;const o=e.layer.tileInfo.spatialReference;if(t instanceof T?n=yield t.project(o,i):(yield(0,g.iQ)([{source:t.spatialReference,dest:o}],{signal:i}),n=(0,g.iV)(t,o)),!n)throw new y.Z("elevation-query:spatial-reference-mismatch",`Cannot query elevation in '${t.spatialReference.wkid}' on an elevation service in '${o.wkid}'`);e.geometry=T.fromGeometry(n)})()}_selectTiles(e,t){var i=this;return(0,h.Z)(function*(){const n=e.options.demResolution;if("geometry"===e.type&&i._preselectOutsideLayerExtent(e),"number"==typeof n)i._selectTilesClosestResolution(e);else if("finest-contiguous"===n)yield i._selectTilesFinestContiguous(e,t);else{if("auto"!==n)throw new y.Z("elevation-query:invalid-dem-resolution",`Invalid dem resolution value '${n}', expected a number, "finest-contiguous" or "auto"`);yield i._selectTilesAuto(e,t)}})()}_preselectOutsideLayerExtent(e){if((0,v.Wi)(e.layer.fullExtent))return;const t=new F(null);t.sample=()=>e.options.noDataValue,e.outsideExtentTile=t;const i=e.layer.fullExtent;e.geometry.coordinates.forEach(n=>{const o=n.x,l=n.y;(o<i.xmin||o>i.xmax||l<i.ymin||l>i.ymax)&&(n.elevationTile=t)})}_selectTilesClosestResolution(e){const i=this._findNearestDemResolutionLODIndex(e.layer.tileInfo,e.options.demResolution);e.selectTilesAtLOD(i)}_findNearestDemResolutionLODIndex(e,t){const i=t/(0,z.c9)(e.spatialReference);let n=e.lods[0],o=0;for(let l=1;l<e.lods.length;l++){const s=e.lods[l];Math.abs(s.resolution-i)<Math.abs(n.resolution-i)&&(n=s,o=l)}return o}_selectTilesFinestContiguous(e,t){var i=this;return(0,h.Z)(function*(){const n=Z(e.layer.tileInfo,e.options.minDemResolution);yield i._selectTilesFinestContiguousAt(e,n,t)})()}_selectTilesFinestContiguousAt(e,t,i){var n=this;return(0,h.Z)(function*(){const o=e.layer;if(e.selectTilesAtLOD(t),t<0)return;const l=o.tilemapCache,s=e.getTilesToFetch();try{if(l)yield(0,x.Hl)(Promise.all(s.map(a=>l.fetchAvailability(a.level,a.row,a.col,{signal:i}))),i);else if(yield n._populateElevationTiles(e,i),!e.allElevationTilesFetched())throw e.clearElevationTiles(),new y.Z("elevation-query:has-unavailable-tiles")}catch(a){(0,x.r9)(a),yield n._selectTilesFinestContiguousAt(e,t-1,i)}})()}_populateElevationTiles(e,t){return(0,h.Z)(function*(){const i=e.getTilesToFetch(),n={},o=e.options.cache,l=e.options.noDataValue,s=i.map(function(){var a=(0,h.Z)(function*(r){const c=`${e.layer.uid}:${r.id}:${l}`,u=(0,v.pC)(o)?o.get(c):null,d=(0,v.pC)(u)?u:yield e.layer.fetchTile(r.level,r.row,r.col,{noDataValue:l,signal:t});(0,v.pC)(o)&&o.put(c,d),n[r.id]=new F(r,d)});return function(r){return a.apply(this,arguments)}}());yield(0,x.Hl)((0,x.as)(s),t),e.populateElevationTiles(n)})()}_selectTilesAuto(e,t){var i=this;return(0,h.Z)(function*(){i._selectTilesAutoFinest(e),i._reduceTilesForMaximumRequests(e);const n=e.layer.tilemapCache;if(!n)return i._selectTilesAutoPrefetchUpsample(e,t);const o=e.getTilesToFetch(),l={},s=o.map(function(){var a=(0,h.Z)(function*(r){const c={id:null,level:0,row:0,col:0,extent:(0,E.Ue)()},u=yield(0,P.q6)(n.fetchAvailabilityUpsample(r.level,r.row,r.col,c,{signal:t}));!1===u.ok?(0,x.r9)(u.error):l[r.id]=c});return function(r){return a.apply(this,arguments)}}());yield(0,x.Hl)(Promise.all(s),t),e.remapTiles(l)})()}_reduceTilesForMaximumRequests(e){const t=e.layer.tileInfo;let i=0;const n={},o=a=>{a.id in n?n[a.id]++:(n[a.id]=1,i++)},l=a=>{const r=n[a.id];1===r?(delete n[a.id],i--):n[a.id]=r-1};e.forEachTileToFetch(o,l);let s=!0;for(;s&&(s=!1,e.forEachTileToFetch(a=>{i<=e.options.maximumAutoTileRequests||(l(a),t.upsampleTile(a)&&(s=!0),o(a))},l),s););}_selectTilesAutoFinest(e){const t=Z(e.layer.tileInfo,e.options.minDemResolution);e.selectTilesAtLOD(t,e.options.maximumAutoTileRequests)}_selectTilesAutoPrefetchUpsample(e,t){var i=this;return(0,h.Z)(function*(){const n=e.layer.tileInfo;yield i._populateElevationTiles(e,t);let o=!1;e.forEachTileToFetch((l,s)=>{n.upsampleTile(l)?o=!0:s()}),o&&(yield i._selectTilesAutoPrefetchUpsample(e,t))})()}_sampleGeometryWithElevation(e){e.geometry.coordinates.forEach(t=>{const i=t.elevationTile;let n=e.options.noDataValue;if(i){const o=i.sample(t.x,t.y);(0,v.pC)(o)?n=o:t.elevationTile=null}t.z=n})}_extractSampleInfo(e){const t=e.layer.tileInfo,i=(0,z.c9)(t.spatialReference);return e.geometry.coordinates.map(n=>{let o=-1;return n.elevationTile&&n.elevationTile!==e.outsideExtentTile&&(o=t.lodAt(n.elevationTile.tile.level).resolution*i),{demResolution:o}})}}class T{export(){return this._exporter(this.coordinates,this.spatialReference)}clone(e){const t=new T;return t.geometry=this.geometry,t.spatialReference=this.spatialReference,t.coordinates=e||this.coordinates.map(i=>this._cloneCoordinate(i)),t._exporter=this._exporter,t}project(e,t){var i=this;return(0,h.Z)(function*(){if(i.spatialReference.equals(e))return i.clone();yield(0,g.iQ)([{source:i.spatialReference,dest:e}],{signal:t});const n=new w.Z({spatialReference:i.spatialReference,points:i.coordinates.map(a=>[a.x,a.y])}),o=(0,g.iV)(n,e);if(!o)return null;const l=i.coordinates.map((a,r)=>{const c=i._cloneCoordinate(a),u=o.points[r];return c.x=u[0],c.y=u[1],c}),s=i.clone(l);return s.spatialReference=e,s})()}_cloneCoordinate(e){return{x:e.x,y:e.y,z:e.z,m:e.m,tile:null,elevationTile:null}}static fromGeometry(e){const t=new T;if(t.geometry=e,t.spatialReference=e.spatialReference,e instanceof T)t.coordinates=e.coordinates.map(i=>t._cloneCoordinate(i)),t._exporter=(i,n)=>{const o=e.clone(i);return o.spatialReference=n,o};else switch(e.type){case"point":{const i=e,{hasZ:n,hasM:o}=i;t.coordinates=n&&o?[{x:i.x,y:i.y,z:i.z,m:i.m}]:n?[{x:i.x,y:i.y,z:i.z}]:o?[{x:i.x,y:i.y,m:i.m}]:[{x:i.x,y:i.y}],t._exporter=(l,s)=>e.hasM?new _.Z(l[0].x,l[0].y,l[0].z,l[0].m,s):new _.Z(l[0].x,l[0].y,l[0].z,s);break}case"multipoint":{const i=e,{hasZ:n,hasM:o}=i;t.coordinates=i.points.map(n&&o?l=>({x:l[0],y:l[1],z:l[2],m:l[3]}):n?l=>({x:l[0],y:l[1],z:l[2]}):o?l=>({x:l[0],y:l[1],m:l[2]}):l=>({x:l[0],y:l[1]})),t._exporter=(l,s)=>e.hasM?new w.Z({points:l.map(a=>[a.x,a.y,a.z,a.m]),hasZ:!0,hasM:!0,spatiaReference:s}):new w.Z(l.map(a=>[a.x,a.y,a.z]),s);break}case"polyline":{const i=e,n=[],o=[],{hasZ:l,hasM:s}=e;let a=0;for(const r of i.paths)if(o.push([a,a+r.length]),a+=r.length,l&&s)for(const c of r)n.push({x:c[0],y:c[1],z:c[2],m:c[3]});else if(l)for(const c of r)n.push({x:c[0],y:c[1],z:c[2]});else if(s)for(const c of r)n.push({x:c[0],y:c[1],m:c[2]});else for(const c of r)n.push({x:c[0],y:c[1]});t.coordinates=n,t._exporter=(r,c)=>{const u=r.map(e.hasM?f=>[f.x,f.y,f.z,f.m]:f=>[f.x,f.y,f.z]),d=o.map(f=>u.slice(f[0],f[1]));return new b.Z({paths:d,hasM:e.hasM,hasZ:!0,spatialReference:c})};break}}return t}}class S{constructor(e,t){this.layer=e,this.options=t}}class $ extends S{constructor(e,t,i){super(e,i),this.outSpatialReference=t,this.type="geometry"}selectTilesAtLOD(e){if(e<0)this.geometry.coordinates.forEach(t=>t.tile=null);else{const t=this.layer.tileInfo,i=t.lods[e].level;this.geometry.coordinates.forEach(n=>{n.tile=t.tileAt(i,n.x,n.y)})}}allElevationTilesFetched(){return!this.geometry.coordinates.some(e=>!e.elevationTile)}clearElevationTiles(){for(const e of this.geometry.coordinates)e.elevationTile!==this.outsideExtentTile&&(e.elevationTile=null)}populateElevationTiles(e){for(const t of this.geometry.coordinates)!t.elevationTile&&t.tile&&(t.elevationTile=e[t.tile.id])}remapTiles(e){for(const t of this.geometry.coordinates)t.tile=e[t.tile.id]}getTilesToFetch(){const e={},t=[];for(const i of this.geometry.coordinates){const n=i.tile;i.elevationTile||!i.tile||e[n.id]||(e[n.id]=n,t.push(n))}return t}forEachTileToFetch(e){for(const t of this.geometry.coordinates)t.tile&&!t.elevationTile&&e(t.tile,()=>t.tile=null)}}class N extends S{constructor(e,t,i,n){super(e,i),this.type="extent",this.elevationTiles=[],this.candidateTiles=[],this.fetchedCandidates=new Set,this.extent=t.intersection(e.fullExtent),this.maskExtents=n}selectTilesAtLOD(e,t){const i=this._maximumLodForRequests(t),n=Math.min(i,e);n<0?this.candidateTiles.length=0:this._selectCandidateTilesCoveringExtentAt(n)}_maximumLodForRequests(e){const t=this.layer.tileInfo;if(!e)return t.lods.length-1;const i=this.extent;if((0,v.Wi)(i))return-1;for(let n=t.lods.length-1;n>=0;n--){const o=t.lods[n],s=o.resolution*t.size[1];if(Math.ceil(i.width/(o.resolution*t.size[0]))*Math.ceil(i.height/s)<=e)return n}return-1}allElevationTilesFetched(){return this.candidateTiles.length===this.elevationTiles.length}clearElevationTiles(){this.elevationTiles.length=0,this.fetchedCandidates.clear()}populateElevationTiles(e){for(const t of this.candidateTiles){const i=e[t.id];i&&(this.fetchedCandidates.add(t),this.elevationTiles.push(i))}}remapTiles(e){this.candidateTiles=this._uniqueNonOverlappingTiles(this.candidateTiles.map(t=>e[t.id]))}getTilesToFetch(){return this.candidateTiles}forEachTileToFetch(e,t){const i=this.candidateTiles;this.candidateTiles=[],i.forEach(n=>{if(this.fetchedCandidates.has(n))return void(t&&t(n));let o=!1;e(n,()=>o=!0),o?t&&t(n):this.candidateTiles.push(n)}),this.candidateTiles=this._uniqueNonOverlappingTiles(this.candidateTiles,t)}_uniqueNonOverlappingTiles(e,t){const i={},n=[];for(const l of e)i[l.id]?t&&t(l):(i[l.id]=l,n.push(l));const o=n.sort((l,s)=>l.level-s.level);return o.filter((l,s)=>{for(let a=0;a<s;a++)if((0,E.r3)(o[a].extent,l.extent))return t&&t(l),!1;return!0})}_selectCandidateTilesCoveringExtentAt(e){this.candidateTiles.length=0;const t=this.extent;if((0,v.Wi)(t))return;const i=this.layer.tileInfo,n=i.lods[e],o=i.tileAt(n.level,t.xmin,t.ymin),s=n.resolution*i.size[1],a=Math.ceil((t.xmax-o.extent[0])/(n.resolution*i.size[0])),r=Math.ceil((t.ymax-o.extent[1])/s);for(let c=0;c<r;c++)for(let u=0;u<a;u++){const d={id:null,level:o.level,row:o.row-c,col:o.col+u};i.updateTileInfo(d),this._tileIsMasked(d)||this.candidateTiles.push(d)}}_tileIsMasked(e){return!!this.maskExtents&&this.maskExtents.some(t=>(0,E.r3)(t,e.extent))}}function Z(m,e){let t=m.lods.length-1;if(e>0){const i=m.lods.findIndex(n=>n.resolution<e);0===i?t=0:i>0&&(t=i-1)}return t}const R={maximumAutoTileRequests:20,noDataValue:0,returnSampleInfo:!1,demResolution:"auto",minDemResolution:0}}}]);