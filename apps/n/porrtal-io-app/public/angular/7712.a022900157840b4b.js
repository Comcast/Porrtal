/*
Copyright 2022 Comcast Cable Communications Management, LLC

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at
    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
"use strict";(self.webpackChunka_porrtal_io_app=self.webpackChunka_porrtal_io_app||[]).push([[7712],{90512:(te,H,y)=>{y.d(H,{Z:()=>Q});var F=y(15861);class Q{constructor(){this.declaredRootClass="esri.arcade.featureSetCollection",this._layerById={},this._layerByName={}}add(E,P,N){this._layerById[P]=N,this._layerByName[E]=N}featureSetByName(E,P=!0,N=["*"]){var S=this;return(0,F.Z)(function*(){return void 0===S._layerByName[E]?null:S._layerByName[E]})()}featureSetById(E,P=!0,N=["*"]){var S=this;return(0,F.Z)(function*(){return void 0===S._layerById[E]?null:S._layerById[E]})()}castToText(){return"object, FeatureSetCollection"}}},7712:(te,H,y)=>{y.r(H),y.d(H,{constructAssociationMetaDataFeatureSetFromUrl:()=>qe,constructFeatureSet:()=>ie,constructFeatureSetFromPortalItem:()=>tt,constructFeatureSetFromRelationship:()=>ze,constructFeatureSetFromUrl:()=>de,convertToFeatureSet:()=>et,createFeatureSetCollectionFromMap:()=>Xe,createFeatureSetCollectionFromService:()=>He,getPortal:()=>$e,initialiseMetaDataCache:()=>Ke,lookupUser:()=>Ye});var F=y(15861),Q=y(24263),G=y(84792),E=y(90512),P=y(53997),N=y(88879),S=y(47562),w=y(52724),R=y(95896),x=y(49086),g=y(91510),_=y(57366),C=y(77132),d=y(83947),D=y(45333),m=y(10410);class l{clone(){const e=new l;return e.field=this.field,e.tofieldname=this.tofieldname,e.typeofstat=this.typeofstat,e.workingexpr=this.workingexpr,e}static parseStatField(e,t,n){const r=new l;r.field=e;const s=m.WhereClause.create(t,n),i=function f(u){if("function"===u.parseTree.type){if(0===u.parseTree.args.value.length)return{name:u.parseTree.name,expr:null};if(u.parseTree.args.value.length>1)throw new Error("Statistic does not have 1 or 0 Parameters");const e=m.WhereClause.create((0,d.XF)(u.parseTree.args.value[0],C.Bj.Standardised,u.parameters),u.fieldsIndex);return{name:u.parseTree.name,expr:e}}return null}(s);if(null===i)throw new Error("Invalid Statistic Function");const o=i.name.toUpperCase().trim();if("MIN"===o){if(r.typeofstat="MIN",r.workingexpr=i.expr,null===s)throw new Error("Invalid Statistic Function Parameters")}else if("MAX"===o){if(r.typeofstat="MAX",r.workingexpr=i.expr,null===s)throw new Error("Invalid Statistic Function Parameters")}else if("COUNT"===o)r.typeofstat="COUNT",r.workingexpr=i.expr;else if("STDEV"===o){if(r.typeofstat="STDDEV",r.workingexpr=i.expr,null===s)throw new Error("Invalid Statistic Function Parameters")}else if("SUM"===o){if(r.typeofstat="SUM",r.workingexpr=i.expr,null===s)throw new Error("Invalid Statistic Function Parameters")}else if("MEAN"===o){if(r.typeofstat="AVG",r.workingexpr=i.expr,null===s)throw new Error("Invalid Statistic Function Parameters")}else if("AVG"===o){if(r.typeofstat="AVG",r.workingexpr=i.expr,null===s)throw new Error("Invalid Statistic Function Parameters")}else{if("VAR"!==o)throw new Error("Invalid Statistic Function");if(r.typeofstat="VAR",r.workingexpr=i.expr,null===s)throw new Error("Invalid Statistic Function Parameters")}return r}toStatisticsName(){switch(this.typeofstat.toUpperCase()){case"MIN":return"min";case"MAX":return"max";case"SUM":return"sum";case"COUNT":default:return"count";case"VAR":return"var";case"STDDEV":return"stddev";case"AVG":return"avg"}}}function I(u,e){const t=(65535&u)+(65535&e);return(u>>16)+(e>>16)+(t>>16)<<16|65535&t}function B(u,e,t,n,r,s){return I(function T(u,e){return u<<e|u>>>32-e}(I(I(e,u),I(n,s)),r),t)}function L(u,e,t,n,r,s,i){return B(e&t|~e&n,u,e,r,s,i)}function J(u,e,t,n,r,s,i){return B(e&n|t&~n,u,e,r,s,i)}function V(u,e,t,n,r,s,i){return B(e^t^n,u,e,r,s,i)}function $(u,e,t,n,r,s,i){return B(t^(e|~n),u,e,r,s,i)}function Se(u,e=1){const t=e||0,n=function De(u,e){u[e>>5]|=128<<e%32,u[14+(e+64>>>9<<4)]=e;let t=1732584193,n=-271733879,r=-1732584194,s=271733878;for(let i=0;i<u.length;i+=16){const o=t,a=n,p=r,c=s;t=L(t,n,r,s,u[i+0],7,-680876936),s=L(s,t,n,r,u[i+1],12,-389564586),r=L(r,s,t,n,u[i+2],17,606105819),n=L(n,r,s,t,u[i+3],22,-1044525330),t=L(t,n,r,s,u[i+4],7,-176418897),s=L(s,t,n,r,u[i+5],12,1200080426),r=L(r,s,t,n,u[i+6],17,-1473231341),n=L(n,r,s,t,u[i+7],22,-45705983),t=L(t,n,r,s,u[i+8],7,1770035416),s=L(s,t,n,r,u[i+9],12,-1958414417),r=L(r,s,t,n,u[i+10],17,-42063),n=L(n,r,s,t,u[i+11],22,-1990404162),t=L(t,n,r,s,u[i+12],7,1804603682),s=L(s,t,n,r,u[i+13],12,-40341101),r=L(r,s,t,n,u[i+14],17,-1502002290),n=L(n,r,s,t,u[i+15],22,1236535329),t=J(t,n,r,s,u[i+1],5,-165796510),s=J(s,t,n,r,u[i+6],9,-1069501632),r=J(r,s,t,n,u[i+11],14,643717713),n=J(n,r,s,t,u[i+0],20,-373897302),t=J(t,n,r,s,u[i+5],5,-701558691),s=J(s,t,n,r,u[i+10],9,38016083),r=J(r,s,t,n,u[i+15],14,-660478335),n=J(n,r,s,t,u[i+4],20,-405537848),t=J(t,n,r,s,u[i+9],5,568446438),s=J(s,t,n,r,u[i+14],9,-1019803690),r=J(r,s,t,n,u[i+3],14,-187363961),n=J(n,r,s,t,u[i+8],20,1163531501),t=J(t,n,r,s,u[i+13],5,-1444681467),s=J(s,t,n,r,u[i+2],9,-51403784),r=J(r,s,t,n,u[i+7],14,1735328473),n=J(n,r,s,t,u[i+12],20,-1926607734),t=V(t,n,r,s,u[i+5],4,-378558),s=V(s,t,n,r,u[i+8],11,-2022574463),r=V(r,s,t,n,u[i+11],16,1839030562),n=V(n,r,s,t,u[i+14],23,-35309556),t=V(t,n,r,s,u[i+1],4,-1530992060),s=V(s,t,n,r,u[i+4],11,1272893353),r=V(r,s,t,n,u[i+7],16,-155497632),n=V(n,r,s,t,u[i+10],23,-1094730640),t=V(t,n,r,s,u[i+13],4,681279174),s=V(s,t,n,r,u[i+0],11,-358537222),r=V(r,s,t,n,u[i+3],16,-722521979),n=V(n,r,s,t,u[i+6],23,76029189),t=V(t,n,r,s,u[i+9],4,-640364487),s=V(s,t,n,r,u[i+12],11,-421815835),r=V(r,s,t,n,u[i+15],16,530742520),n=V(n,r,s,t,u[i+2],23,-995338651),t=$(t,n,r,s,u[i+0],6,-198630844),s=$(s,t,n,r,u[i+7],10,1126891415),r=$(r,s,t,n,u[i+14],15,-1416354905),n=$(n,r,s,t,u[i+5],21,-57434055),t=$(t,n,r,s,u[i+12],6,1700485571),s=$(s,t,n,r,u[i+3],10,-1894986606),r=$(r,s,t,n,u[i+10],15,-1051523),n=$(n,r,s,t,u[i+1],21,-2054922799),t=$(t,n,r,s,u[i+8],6,1873313359),s=$(s,t,n,r,u[i+15],10,-30611744),r=$(r,s,t,n,u[i+6],15,-1560198380),n=$(n,r,s,t,u[i+13],21,1309151649),t=$(t,n,r,s,u[i+4],6,-145523070),s=$(s,t,n,r,u[i+11],10,-1120210379),r=$(r,s,t,n,u[i+2],15,718787259),n=$(n,r,s,t,u[i+9],21,-343485551),t=I(t,o),n=I(n,a),r=I(r,p),s=I(s,c)}return[t,n,r,s]}(function k(u){const e=[];for(let t=0,n=8*u.length;t<n;t+=8)e[t>>5]|=(255&u.charCodeAt(t/8))<<t%32;return e}(u),8*u.length);switch(t){case 3:return n;case 1:return function U(u){const e="0123456789abcdef",t=[];for(let n=0,r=4*u.length;n<r;n++)t.push(e.charAt(u[n>>2]>>n%4*8+4&15)+e.charAt(u[n>>2]>>n%4*8&15));return t.join("")}(n);case 2:return function M(u){const e=[];for(let t=0,n=32*u.length;t<n;t+=8)e.push(String.fromCharCode(u[t>>5]>>>t%32&255));return e.join("")}(n);case 0:return function O(u){const n=[];for(let r=0,s=4*u.length;r<s;r+=3){const i=(u[r>>2]>>r%4*8&255)<<16|(u[r+1>>2]>>(r+1)%4*8&255)<<8|u[r+2>>2]>>(r+2)%4*8&255;for(let o=0;o<4;o++)n.push(8*r+6*o>32*u.length?"=":"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(i>>6*(3-o)&63))}return n.join("")}(n)}}var be=y(65234),ae=y(36255),Ee=y(60466);function Re(u){if(!u)return"COUNT";switch(u.toLowerCase()){case"max":return"MAX";case"var":case"variance":return"VAR";case"avg":case"average":case"mean":return"AVG";case"min":return"MIN";case"sum":return"SUM";case"stdev":case"stddev":return"STDDEV";case"count":return"COUNT"}return"COUNT"}class le extends x.Z{constructor(e){super(e),this._decodedStatsfield=[],this._decodedGroupbyfield=[],this._candosimplegroupby=!0,this.phsyicalgroupbyfields=[],this.objectIdField="ROW__ID",this._internalObjectIdField="ROW__ID",this._adaptedFields=[],this.declaredClass="esri.arcade.featureset.actions.Aggregate",this._uniqueIds=1,this._maxQuery=10,this._maxProcessing=10,this._parent=e.parentfeatureset,this._config=e}isTable(){return!0}_getSet(e){var t=this;return(0,F.Z)(function*(){if(null===t._wset){const n=yield t._getFilteredSet("",null,null,null,e);return t._wset=n,t._wset}return t._wset})()}_isInFeatureSet(){return C.dj.InFeatureSet}_nextUniqueName(e){for(;1===e["T"+this._uniqueIds.toString()];)this._uniqueIds++;const t="T"+this._uniqueIds.toString();return e[t]=1,t}_convertToEsriFieldType(e){return e}_initialiseFeatureSet(){const e={};let t=!1,n=1;const r=this._parent?this._parent.getFieldsIndex():new Ee.Z([]);for(this.objectIdField="ROW__ID",this.globalIdField="";!1===t;){let i=!1;for(let o=0;o<this._config.groupbyfields.length;o++)if(this._config.groupbyfields[o].name.toLowerCase()===this.objectIdField.toLowerCase()){i=!0;break}if(!1===i)for(let o=0;o<this._config.statsfields.length;o++)if(this._config.statsfields[o].name.toLowerCase()===this.objectIdField.toLowerCase()){i=!0;break}!1===i?t=!0:(this.objectIdField="ROW__ID"+n.toString(),n++)}for(const i of this._config.statsfields){const o=new l;o.field=i.name,o.tofieldname=i.name,o.workingexpr=i.expression instanceof m.WhereClause?i.expression:m.WhereClause.create(i.expression,r),o.typeofstat=Re(i.statistic),this._decodedStatsfield.push(o)}this._decodedGroupbyfield=[];for(const i of this._config.groupbyfields){const o={name:i.name,singlefield:null,tofieldname:i.name,expression:i.expression instanceof m.WhereClause?i.expression:m.WhereClause.create(i.expression,r)};this._decodedGroupbyfield.push(o)}if(null!==this._parent){this.geometryType=this._parent.geometryType,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField="";for(const i of this._parent.fields)e[i.name.toUpperCase()]=1;this.types=null}else this.geometryType=C.Qk.point,this.typeIdField="",this.types=null,this.spatialReference=new be.Z({wkid:4326});this.fields=[];const s=new l;s.field=this._nextUniqueName(e),s.tofieldname=this.objectIdField,s.workingexpr=m.WhereClause.create(this._parent.objectIdField,this._parent.getFieldsIndex()),s.typeofstat="MIN",this._decodedStatsfield.push(s);for(const i of this._decodedGroupbyfield){const o=new ae.Z;if(i.name=this._nextUniqueName(e),o.name=i.tofieldname,o.alias=o.name,(0,d.y5)(i.expression)){const a=this._parent.getField((0,d.zR)(i.expression,C.Bj.Standardised));if(!a)throw new Error("Field is not present for Aggregation");i.name=a.name,i.singlefield=a.name,this.phsyicalgroupbyfields.push(a.name),o.type=a.type}else{o.type=this._convertToEsriFieldType((0,d.DT)(i.expression,this._parent.fields));const a=new ae.Z;a.name=i.name,a.alias=a.name,this.phsyicalgroupbyfields.push(i.name),this._adaptedFields.push(new w.yN(a,i.expression)),this._candosimplegroupby=!1}this.fields.push(o)}if(this._adaptedFields.length>0)for(const i of this._parent.fields)this._adaptedFields.push(new w.$X(i));for(let i=0;i<this._decodedStatsfield.length;i++){const o=new ae.Z;let a=null;const p=this._decodedStatsfield[i];p.field=this._nextUniqueName(e),p.tofieldname===this.objectIdField&&(this._internalObjectIdField=p.field),o.name=p.tofieldname,o.alias=o.name;const c=null!==p.workingexpr&&(0,d.y5)(p.workingexpr)?(0,d.zR)(p.workingexpr,C.Bj.Standardised):"";switch(this._decodedStatsfield[i].typeofstat){case"SUM":if(""!==c){if(a=this._parent.getField(c),!a)throw new Error("Field is not present for Aggregation");o.type=a.type}else o.type="double";break;case"MIN":case"MAX":if(""!==c){if(a=this._parent.getField(c),!a)throw new Error("Field is not present for Aggregation");o.type=a.type}else o.type="double";break;case"COUNT":o.type="integer";break;case"STDDEV":case"VAR":case"AVG":if(""!==c&&(a=this._parent.getField(c),!a))throw new Error("Field is not present for Aggregation");o.type="double"}this.fields.push(o)}}_canDoAggregates(){return(0,F.Z)(function*(){return!1})()}_getFeatures(e,t,n,r){var s=this;return(0,F.Z)(function*(){const i=s._maxQuery;return!0===s._checkIfNeedToExpandKnownPage(e,i)?(yield s._expandPagedSet(e,i,0,0,r),s._getFeatures(e,t,n,r)):"success"})()}_getFilteredSet(e,t,n,r,s){var i=this;return(0,F.Z)(function*(){if(""!==e)return new g.Z([],[],!0,null);let o=null;const a={ordered:!1,nowhereclause:!1};if(yield i._ensureLoaded(),null!==n)for(let c=0;c<i._decodedStatsfield.length;c++)if(!0===(0,d.hq)(n,i._decodedStatsfield[c].tofieldname)){a.nowhereclause=!0,n=null;break}if(null!==r){a.ordered=!0;for(let c=0;c<i._decodedStatsfield.length;c++)if(!0===r.scanForField(i._decodedStatsfield[c].tofieldname)){r=null,a.ordered=!1;break}if(null!==r)for(const c of i._decodedGroupbyfield)if(null===c.singlefield&&!0===r.scanForField(c.tofieldname)){r=null,a.ordered=!1;break}}if(!1!==i._candosimplegroupby&&(yield i._parent._canDoAggregates(i.phsyicalgroupbyfields,i._decodedStatsfield,"",null,null))){let c=null;n&&(c=i._reformulateWhereClauseWithoutGroupByFields(n));let A=null;r&&(A=i._reformulateOrderClauseWithoutGroupByFields(r));const Z=yield i._parent._getAggregatePagesDataSourceDefinition(i.phsyicalgroupbyfields,i._decodedStatsfield,"",null,c,A,i._internalObjectIdField);return i._checkCancelled(s),o=!0===a.nowhereclause?new g.Z(Z._candidates.slice(0).concat(Z._known.slice(0)),[],!0===a.ordered&&Z._ordered,i._clonePageDefinition(Z.pagesDefinition)):new g.Z(Z._candidates.slice(0),Z._known.slice(0),!0===a.ordered&&Z._ordered,i._clonePageDefinition(Z.pagesDefinition)),o}let p=i._parent;if(i._adaptedFields.length>0&&(p=new w.Xx({parentfeatureset:i._parent,adaptedFields:i._adaptedFields,extraFilter:null})),!0===a.nowhereclause)o=new g.Z(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:i._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new R.Z({parentfeatureset:p,orderbyclause:new _.Z(i.phsyicalgroupbyfields.join(",")+","+i._parent.objectIdField+" ASC")})}});else{let c=p;if(null!==n){let A=null;n&&(A=i._reformulateWhereClauseWithoutGroupByFields(n)),c=new P.Z({parentfeatureset:c,whereclause:A})}o=new g.Z(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:i._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new R.Z({parentfeatureset:c,orderbyclause:new _.Z(i.phsyicalgroupbyfields.join(",")+","+i._parent.objectIdField+" ASC")})}})}return o})()}_reformulateWhereClauseWithoutStatsFields(e){for(const t of this._decodedStatsfield)e=(0,d.bB)(e,t.tofieldname,(0,d.zR)(t.workingexpr,C.Bj.Standardised),this._parent.getFieldsIndex());return e}_reformulateWhereClauseWithoutGroupByFields(e){for(const t of this._decodedGroupbyfield)t.tofieldname!==t.name&&(e=(0,d.bB)(e,t.tofieldname,(0,d.zR)(t.expression,C.Bj.Standardised),this._parent.getFieldsIndex()));return e}_reformulateOrderClauseWithoutGroupByFields(e){const t=[];for(const n of this._decodedGroupbyfield)n.tofieldname!==n.name&&t.push({field:n.tofieldname,newfield:n.name});return t.length>0?e.replaceFields(t):e}_clonePageDefinition(e){return null===e?null:!0===e.aggregatefeaturesetpagedefinition?{aggregatefeaturesetpagedefinition:!0,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,internal:e.internal}:this._parent._clonePageDefinition(e)}_refineSetBlock(e,t,n){var r=this;return(0,F.Z)(function*(){return!0===r._checkIfNeedToExpandCandidatePage(e,r._maxQuery)?(yield r._expandPagedSet(e,r._maxQuery,0,0,n),r._refineSetBlock(e,t,n)):(r._checkCancelled(n),r._refineKnowns(e,t),e)})()}_expandPagedSet(e,t,n,r,s){return this._expandPagedSetFeatureSet(e,t,n,r,s)}_getPhysicalPage(e,t,n){var r=this;return(0,F.Z)(function*(){if(!0===e.pagesDefinition.aggregatefeaturesetpagedefinition)return r._sequentialGetPhysicalItem(e,e.pagesDefinition.resultRecordCount,n,[]);const s=yield r._getAgregagtePhysicalPage(e,t,n);for(const i of s){const o={geometry:i.geometry,attributes:{}};for(const a of r._decodedGroupbyfield)o.attributes[a.tofieldname]=i.attributes[a.name];for(const a of r._decodedStatsfield)o.attributes[a.tofieldname]=i.attributes[a.field];r._featureCache[o.attributes[r.objectIdField]]=new N.Z(o)}return s.length})()}_sequentialGetPhysicalItem(e,t,n,r){return new Promise((s,i)=>{null===e.pagesDefinition.internal.iterator&&(e.pagesDefinition.internal.iterator=e.pagesDefinition.internal.subfeatureset.iterator(n)),!0===e.pagesDefinition.internal.fullyResolved||0===t?s(r.length):this._nextAggregateItem(e,t,n,r,o=>{s(null===o?r.length:this._sequentialGetPhysicalItem(e,t-=1,n,r))},i)})}_nextAggregateItem(e,t,n,r,s,i){try{(0,S.X)(e.pagesDefinition.internal.iterator.next()).then(o=>{if(null===o)if(null!==e.pagesDefinition.internal.workingItem){const a=this._calculateAndAppendAggregateItem(e.pagesDefinition.internal.workingItem);r.push(a),e.pagesDefinition.internal.workingItem=null,e.pagesDefinition.internal.set.push(a.attributes[this.objectIdField]),e.pagesDefinition.internal.fullyResolved=!0,s(null)}else e.pagesDefinition.internal.fullyResolved=!0,s(null);else{const a=this._generateAggregateHash(o);if(null===e.pagesDefinition.internal.workingItem)e.pagesDefinition.internal.workingItem={features:[o],id:a};else{if(a!==e.pagesDefinition.internal.workingItem.id){const p=this._calculateAndAppendAggregateItem(e.pagesDefinition.internal.workingItem);return r.push(p),e.pagesDefinition.internal.workingItem=null,e.pagesDefinition.internal.set.push(p.attributes[this.objectIdField]),t-=1,e.pagesDefinition.internal.workingItem={features:[o],id:a},void s(p)}e.pagesDefinition.internal.workingItem.features.push(o)}this._nextAggregateItem(e,t,n,r,s,i)}},i)}catch(o){i(o)}}_calculateFieldStat(e,t,n){const r=[];for(let s=0;s<e.features.length;s++)if(null!==t.workingexpr){const i=t.workingexpr.calculateValue(e.features[s]);null!==i&&r.push(i)}else r.push(null);switch(t.typeofstat){case"MIN":n.attributes[t.tofieldname]=(0,D.tj)("min",r,-1);break;case"MAX":n.attributes[t.tofieldname]=(0,D.tj)("max",r,-1);break;case"SUM":n.attributes[t.tofieldname]=(0,D.tj)("sum",r,-1);break;case"COUNT":n.attributes[t.tofieldname]=r.length;break;case"VAR":n.attributes[t.tofieldname]=(0,D.tj)("var",r,-1);break;case"STDDEV":n.attributes[t.tofieldname]=(0,D.tj)("stddev",r,-1);break;case"AVG":n.attributes[t.tofieldname]=(0,D.tj)("avg",r,-1)}return!0}_calculateAndAppendAggregateItem(e){const t={attributes:{},geometry:null};for(const r of this._decodedGroupbyfield){const s=r.singlefield?e.features[0].attributes[r.singlefield]:r.expression.calculateValue(e.features[0]);t.attributes[r.tofieldname]=s}for(const r of this._decodedStatsfield)this._calculateFieldStat(e,r,t);const n=[];for(let r=0;r<this._decodedStatsfield.length;r++)n.push(this._calculateFieldStat(e,this._decodedStatsfield[r],t));return this._featureCache[t.attributes[this.objectIdField]]=new N.Z({attributes:t.attributes,geometry:t.geometry}),t}_generateAggregateHash(e){let t="";for(const n of this._decodedGroupbyfield){const r=n.singlefield?e.attributes[n.singlefield]:n.expression.calculateValue(e);t+=null==r?":":":"+r.toString()}return Se(t,2)}_stat(){return(0,F.Z)(function*(){return{calculated:!1}})()}getFeatureByObjectId(){return(0,F.Z)(function*(){return null})()}static registerAction(){x.Z._featuresetFunctions.groupby=function(e,t){return new le({parentfeatureset:this,groupbyfields:e,statsfields:t})}}}var Te=y(3482),xe=y(79429),Oe=y(22386),Pe=y(91179),ee=y(32258),Ae=y(82054),Ie=(y(26584),y(8314),y(63290),y(15283),y(2865)),Ze=(y(85931),y(21726),y(16730),y(37053),y(20477)),Le=y(17253),re=y(84952),Ne=(y(87183),y(67736),y(90463)),je=(y(29132),y(24865)),we=y(67010),Be=(y(13924),y(6871),y(98558)),ve=y(60776),ke=y(6729);class se extends x.Z{constructor(e){super(e),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerDynamic",this._removeGeometry=!1,this._overrideFields=null,this.formulaCredential=null,this._pageJustIds=!1,this._requestStandardised=!1,this._useDefinitionExpression=!0,e.spatialReference&&(this.spatialReference=e.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=e.layer,this._wset=null,void 0!==e.outFields&&(this._overrideFields=e.outFields),void 0!==e.includeGeometry&&(this._removeGeometry=!1===e.includeGeometry)}_maxQueryRate(){return C.tI}end(){return this._layer}optimisePagingFeatureQueries(e){this._pageJustIds=e}convertQueryToLruCacheKey(e){return Se((0,C.hd)(e.toJSON()),2)}loadImpl(){var e=this;return(0,F.Z)(function*(){return!0===e._layer.loaded?(e._initialiseFeatureSet(),e):(yield e._layer.load(),e._initialiseFeatureSet(),e)})()}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),this._layer.outFields&&(1!==this._layer.outFields.length||"*"!==this._layer.outFields[0])){const e=[];for(const t of this.fields)if("oid"===t.type)e.push(t);else for(const n of this._layer.outFields)if(n.toLowerCase()===t.name.toLowerCase()){e.push(t);break}this.fields=e}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const e=[],t=[];for(const n of this.fields)if("oid"===n.type)e.push(n),t.push(n.name);else for(const r of this._overrideFields)if(r.toLowerCase()===n.name.toLowerCase()){e.push(n),t.push(n.name);break}this.fields=e,this._overrideFields=t}if(this._layer.source&&this._layer.source.sourceJSON){const e=this._layer.source.sourceJSON.currentVersion;!0===this._layer.source.sourceJSON.useStandardizedQueries?(this._databaseType=C.Bj.StandardisedNoInterval,null!=e&&e>=10.61&&(this._databaseType=C.Bj.Standardised)):null!=e&&(e>=10.5&&(this._databaseType=C.Bj.StandardisedNoInterval,this._requestStandardised=!0),e>=10.61&&(this._databaseType=C.Bj.Standardised))}this.objectIdField=this._layer.objectIdField;for(const e of this.fields)"global-id"===e.type&&(this.globalIdField=e.name);this.hasM=this._layer.supportsM,this.hasZ=this._layer.supportsZ,this.typeIdField=this._layer.typeIdField,this.types=this._layer.types}_isInFeatureSet(){return C.dj.InFeatureSet}_refineSetBlock(e){return(0,F.Z)(function*(){return e})()}_candidateIdTransform(e){return e}_getSet(e){var t=this;return(0,F.Z)(function*(){if(null===t._wset){yield t._ensureLoaded();const n=yield t._getFilteredSet("",null,null,null,e);return t._wset=n,n}return t._wset})()}_runDatabaseProbe(e){var t=this;return(0,F.Z)(function*(){yield t._ensureLoaded();const n=new re.Z;n.where=e.replace("OBJECTID",t._layer.objectIdField);try{return yield t._layer.queryObjectIds(n),!0}catch{return!1}})()}_canUsePagination(){return!(!this._layer.capabilities||!this._layer.capabilities.query||!0!==this._layer.capabilities.query.supportsPagination)}_cacheableFeatureSetSourceKey(){return this._layer.url}pbfSupportedForQuery(e){return!e.outStatistics&&this._layer&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsFormatPBF&&!0===this._layer.capabilities.query.supportsQuantizationEditMode}queryPBF(e){var t=this;return(0,F.Z)(function*(){e.quantizationParameters={mode:"edit"};const n=yield(0,Ze.executeQueryPBF)(t._layer.parsedUrl,e,new Be.J({}));return Le.default.fromJSON((0,Ae.cn)(n.data)).unquantize()})()}get gdbVersion(){return this._layer&&this._layer.capabilities&&this._layer.capabilities.data&&this._layer.capabilities.data.isVersioned?this._layer.gdbVersion?this._layer.gdbVersion:"SDE.DEFAULT":""}nativeCapabilities(){return{title:this._layer.title,source:this,canQueryRelated:!0,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:this._requestStandardised}}executeQuery(e,t){const n="execute"===t?Ie.e:"executeForCount"===t?Ne.P:je.G,r="execute"===t&&this.pbfSupportedForQuery(e);let s=null;if(this.recentlyUsedQueries){const i=this.convertQueryToLruCacheKey(e);s=this.recentlyUsedQueries.getFromCache(i),null===s&&(s=!0!==r?n(this._layer.parsedUrl.path,e):this.queryPBF(e),this.recentlyUsedQueries.addToCache(i,s),s=s.catch(o=>{throw this.recentlyUsedQueries.removeFromCache(i),o}))}return this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:e,method:t}),null===s&&(s=!0!==r?n(this._layer.parsedUrl.path,e):this.queryPBF(e)),s}_getFilteredSet(e,t,n,r,s){var i=this;return(0,F.Z)(function*(){const o=yield i.databaseType();if(i.isTable()&&t&&null!==e&&""!==e)return new g.Z([],[],!0,null);if(i._canUsePagination())return i._getFilteredSetUsingPaging(e,t,n,r,s);let a="",p=!1;null!==r&&i._layer.capabilities&&i._layer.capabilities.query&&!0===i._layer.capabilities.query.supportsOrderBy&&(a=r.constructClause(),p=!0);const c=new re.Z;c.where=null===n?null===t?"1=1":"":(0,d.zR)(n,o),i._requestStandardised&&(c.sqlFormat="standard"),c.spatialRelationship=i._makeRelationshipEnum(e),c.outSpatialReference=i.spatialReference,c.orderByFields=""!==a?a.split(","):null,c.geometry=null===t?null:t,c.relationParameter=i._makeRelationshipParam(e);let A=yield i.executeQuery(c,"executeForIds");return null===A&&(A=[]),i._checkCancelled(s),new g.Z([],A,p,null)})()}_expandPagedSet(e,t,n,r,s){return this._expandPagedSetFeatureSet(e,t,n,r,s)}_getFilteredSetUsingPaging(e,t,n,r,s){var i=this;return(0,F.Z)(function*(){let o="",a=!1;null!==r&&i._layer.capabilities&&i._layer.capabilities.query&&!0===i._layer.capabilities.query.supportsOrderBy&&(o=r.constructClause(),a=!0);const p=yield i.databaseType();let c=null===n?null===t?"1=1":"":(0,d.zR)(n,p);i._layer.definitionExpression&&i._useDefinitionExpression&&(c=""!==c?"(("+i._layer.definitionExpression+") AND ("+c+"))":i._layer.definitionExpression);let A=i._maxQueryRate();const Z=i._layer.capabilities.query.maxRecordCount;void 0!==Z&&Z<A&&(A=Z);let j=null;if(!0===i._pageJustIds)j=new g.Z([],["GETPAGES"],a,{spatialRel:i._makeRelationshipEnum(e),relationParam:i._makeRelationshipParam(e),outFields:i._layer.objectIdField,resultRecordCount:A,resultOffset:0,geometry:null===t?null:t,where:c,orderByFields:o,returnGeometry:!1,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}});else{let z=!0;!0===i._removeGeometry&&(z=!1);const q=null!==i._overrideFields?i._overrideFields:i._fieldsIncludingObjectId(i._layer.outFields?i._layer.outFields:["*"]);j=new g.Z([],["GETPAGES"],a,{spatialRel:i._makeRelationshipEnum(e),relationParam:i._makeRelationshipParam(e),outFields:q.join(","),resultRecordCount:A,resultOffset:0,geometry:null===t?null:t,where:c,orderByFields:o,returnGeometry:z,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}return yield i._expandPagedSet(j,A,0,1,s),j})()}_clonePageDefinition(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}}_getPhysicalPage(e,t,n){var r=this;return(0,F.Z)(function*(){const s=e.pagesDefinition.internal.lastRetrieved,i=s,o=e.pagesDefinition.internal.lastPage,a=new re.Z;r._requestStandardised&&(a.sqlFormat="standard"),a.spatialRelationship=e.pagesDefinition.spatialRel,a.relationParameter=e.pagesDefinition.relationParam,a.outFields=e.pagesDefinition.outFields.split(","),a.num=e.pagesDefinition.resultRecordCount,a.start=e.pagesDefinition.internal.lastPage,a.geometry=e.pagesDefinition.geometry,a.where=e.pagesDefinition.where,a.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,a.returnGeometry=e.pagesDefinition.returnGeometry,a.outSpatialReference=r.spatialReference;const p=yield r.executeQuery(a,"execute");if(r._checkCancelled(n),e.pagesDefinition.internal.lastPage!==o)return"done";for(let c=0;c<p.features.length;c++)e.pagesDefinition.internal.set[i+c]=p.features[c].attributes[r._layer.objectIdField];if(!1===r._pageJustIds)for(let c=0;c<p.features.length;c++)r._featureCache[p.features[c].attributes[r._layer.objectIdField]]=p.features[c];return(void 0===p.exceededTransferLimit&&p.features.length!==e.pagesDefinition.resultRecordCount||!1===p.exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=s+p.features.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,"done"})()}_fieldsIncludingObjectId(e){if(null===e)return[this.objectIdField];const t=e.slice(0);if(t.includes("*"))return t;let n=!1;for(const r of t)if(r.toUpperCase()===this.objectIdField.toUpperCase()){n=!0;break}return!1===n&&t.push(this.objectIdField),t}_getFeatures(e,t,n,r){var s=this;return(0,F.Z)(function*(){const i=[];if(-1!==t&&void 0===s._featureCache[t]&&i.push(t),!0===s._checkIfNeedToExpandKnownPage(e,s._maxProcessingRate()))return yield s._expandPagedSet(e,s._maxProcessingRate(),0,0,r),s._getFeatures(e,t,n,r);let o=0;for(let c=e._lastFetchedIndex;c<e._known.length;c++){if(e._lastFetchedIndex+=1,o++,void 0===s._featureCache[e._known[c]]){let A=!1;if(null!=s._layer._mode){const Z=s._layer._mode;if(void 0!==Z._featureMap[e._known[c]]){const j=Z._featureMap[e._known[c]];null!==j&&(A=!0,s._featureCache[e._known[c]]=j)}}if(!1===A&&(e._known[c]!==t&&i.push(e._known[c]),i.length>=s._maxProcessingRate()-1))break}if(o>=n&&0===i.length)break}if(0===i.length)return"success";const a=new re.Z;s._requestStandardised&&(a.sqlFormat="standard"),a.objectIds=i,a.outFields=null!==s._overrideFields?s._overrideFields:s._fieldsIncludingObjectId(s._layer.outFields?s._layer.outFields:["*"]),a.returnGeometry=!0,!0===s._removeGeometry&&(a.returnGeometry=!1),a.outSpatialReference=s.spatialReference;const p=yield s.executeQuery(a,"execute");if(s._checkCancelled(r),void 0!==p.error)throw new Error(p.error);for(let c=0;c<p.features.length;c++)s._featureCache[p.features[c].attributes[s._layer.objectIdField]]=p.features[c];return"success"})()}_getDistinctPages(e,t,n,r,s,i,o,a,p){var c=this;return(0,F.Z)(function*(){yield c._ensureLoaded();const A=yield c.databaseType();let Z=n.parseTree.column;for(let W=0;W<c._layer.fields.length;W++)if(c._layer.fields[W].name.toLowerCase()===Z.toLowerCase()){Z=c._layer.fields[W].name;break}const j=new re.Z;c._requestStandardised&&(j.sqlFormat="standard");let z=null===i?null===s?"1=1":"":(0,d.zR)(i,A);c._layer.definitionExpression&&c._useDefinitionExpression&&(z=""!==z?"(("+c._layer.definitionExpression+") AND ("+z+"))":c._layer.definitionExpression),j.where=z,j.spatialRelationship=c._makeRelationshipEnum(r),j.relationParameter=c._makeRelationshipParam(r),j.geometry=null===s?null:s,j.returnDistinctValues=!0,j.returnGeometry=!1,j.outFields=[Z];const q=yield c.executeQuery(j,"execute");if(c._checkCancelled(p),!q.hasOwnProperty("features"))throw new Error("Unnexected Result querying statistics from layer");let Y=!1;for(let W=0;W<c._layer.fields.length;W++)if(c._layer.fields[W].name===Z){"date"===c._layer.fields[W].type&&(Y=!0);break}for(let W=0;W<q.features.length;W++){if(Y){const X=q.features[W].attributes[Z];a.push(null!==X?new Date(X):X)}else a.push(q.features[W].attributes[Z]);if(a.length>=o)break}return 0===q.features.length?a:q.features.length===c._layer.capabilities.query.maxRecordCount&&a.length<o?{calculated:!0,result:yield c._getDistinctPages(e+q.features.length,t,n,r,s,i,o,a,p)}:a})()}_distinctStat(e,t,n,r,s,i,o){var a=this;return(0,F.Z)(function*(){return{calculated:!0,result:yield a._getDistinctPages(0,e,t,n,r,s,i,[],o)}})()}isTable(){return this._layer.isTable||null===this._layer.geometryType||"table"===this._layer.type||""===this._layer.geometryType}_countstat(e,t,n,r){var s=this;return(0,F.Z)(function*(){const i=yield s.databaseType(),o=new re.Z;if(s._requestStandardised&&(o.sqlFormat="standard"),s.isTable()&&n&&null!==t&&""!==t)return{calculated:!0,result:0};let a=null===r?null===n?"1=1":"":(0,d.zR)(r,i);return s._layer.definitionExpression&&s._useDefinitionExpression&&(a=""!==a?"(("+s._layer.definitionExpression+") AND ("+a+"))":s._layer.definitionExpression),o.where=a,o.where=a,o.spatialRelationship=s._makeRelationshipEnum(t),o.relationParameter=s._makeRelationshipParam(t),o.geometry=null===n?null:n,o.returnGeometry=!1,{calculated:!0,result:yield s.executeQuery(o,"executeForCount")}})()}_stats(e,t,n,r,s,i,o){var a=this;return(0,F.Z)(function*(){yield a._ensureLoaded();const p=a._layer.capabilities&&a._layer.capabilities.query&&!0===a._layer.capabilities.query.supportsSqlExpression,c=a._layer.capabilities&&a._layer.capabilities.query&&!0===a._layer.capabilities.query.supportsStatistics,A=a._layer.capabilities&&a._layer.capabilities.query&&!0===a._layer.capabilities.query.supportsDistinct;if("count"===e)return A?a._countstat(e,n,r,s):{calculated:!1};if(!1===c||!1===(0,d.y5)(t)&&!1===p||!1===t.isStandardized)return""!==n||null!==s?{calculated:!1}:a._manualStat(e,t,i,o);if("distinct"===e)return!1===A?""!==n||null!==s?{calculated:!1}:a._manualStat(e,t,i,o):a._distinctStat(e,t,n,r,s,i,o);const Z=yield a.databaseType();if(a.isTable()&&r&&null!==n&&""!==n)return{calculated:!0,result:null};const j=new re.Z;a._requestStandardised&&(j.sqlFormat="standard");let z=null===s?null===r?"1=1":"":(0,d.zR)(s,Z);a._layer.definitionExpression&&a._useDefinitionExpression&&(z=""!==z?"(("+a._layer.definitionExpression+") AND ("+z+"))":a._layer.definitionExpression),j.where=z,j.spatialRelationship=a._makeRelationshipEnum(n),j.relationParameter=a._makeRelationshipParam(n),j.geometry=null===r?null:r;const q=new ve.Z;q.statisticType=(0,D.g3)(e),q.onStatisticField=(0,d.zR)(t,Z),q.outStatisticFieldName="ARCADE_STAT_RESULT",j.returnGeometry=!1;let Y="ARCADE_STAT_RESULT";j.outStatistics=[q];const W=yield a.executeQuery(j,"execute");if(!W.hasOwnProperty("features")||0===W.features.length)throw new Error("Unnexected Result querying statistics from layer");let X=!1;for(let ne=0;ne<W.fields.length;ne++)if("ARCADE_STAT_RESULT"===W.fields[ne].name.toUpperCase()){Y=W.fields[ne].name,"date"===W.fields[ne].type&&(X=!0);break}if(X){let ne=W.features[0].attributes[Y];return null!==ne&&(ne=new Date(W.features[0].attributes[Y])),{calculated:!0,result:ne}}return{calculated:!0,result:W.features[0].attributes[Y]}})()}_stat(e,t,n,r,s,i,o){return this._stats(e,t,n,r,s,i,o)}_canDoAggregates(e,t){var n=this;return(0,F.Z)(function*(){yield n._ensureLoaded();let r=!1;const s=n._layer.capabilities&&n._layer.capabilities.query&&!0===n._layer.capabilities.query.supportsSqlExpression;if(void 0!==n._layer.capabilities&&null!==n._layer.capabilities.query&&!0===n._layer.capabilities.query.supportsStatistics&&!0===n._layer.capabilities.query.supportsOrderBy&&(r=!0),r)for(let i=0;i<t.length-1;i++)null!==t[i].workingexpr&&(!1===t[i].workingexpr.isStandardized||!1===(0,d.y5)(t[i].workingexpr)&&!1===s)&&(r=!1);return!1!==r})()}_makeRelationshipEnum(e){if(e.includes("esriSpatialRelRelation"))return"relation";switch(e){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return e}_makeRelationshipParam(e){return e.includes("esriSpatialRelRelation")?e.split(":")[1]:""}_getAggregatePagesDataSourceDefinition(e,t,n,r,s,i,o){var a=this;return(0,F.Z)(function*(){yield a._ensureLoaded();const p=yield a.databaseType();let c="",A=!1,Z=!1;null!==i&&a._layer.capabilities&&a._layer.capabilities.query&&!0===a._layer.capabilities.query.supportsOrderBy&&(c=i.constructClause(),Z=!0),a._layer.capabilities&&a._layer.capabilities.query&&!1===a._layer.capabilities.query.supportsPagination&&(Z=!1,A=!0,c=a._layer.objectIdField);const j=[];for(let W=0;W<t.length;W++){const X=new ve.Z;X.onStatisticField=null!==t[W].workingexpr?(0,d.zR)(t[W].workingexpr,p):"",X.outStatisticFieldName=t[W].field,X.statisticType=t[W].toStatisticsName(),j.push(X)}""===c&&(c=e.join(","));let z=a._maxQueryRate();const q=a._layer.capabilities.query.maxRecordCount;void 0!==q&&q<z&&(z=q);let Y=null===s?null===r?"1=1":"":(0,d.zR)(s,p);return a._layer.definitionExpression&&a._useDefinitionExpression&&(Y=""!==Y?"(("+a._layer.definitionExpression+") AND ("+Y+"))":a._layer.definitionExpression),new g.Z([],["GETPAGES"],Z,{groupbypage:!0,spatialRel:a._makeRelationshipEnum(n),relationParam:a._makeRelationshipParam(n),outFields:["*"],useOIDpagination:A,generatedOid:o,resultRecordCount:z,resultOffset:0,groupByFieldsForStatistics:e,outStatistics:j,geometry:null===r?null:r,where:Y,orderByFields:c,returnGeometry:!1,returnIdsOnly:!1,internal:{lastMaxId:-1,set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})})()}_getAgregagtePhysicalPage(e,t,n){var r=this;return(0,F.Z)(function*(){let s=e.pagesDefinition.where;!0===e.pagesDefinition.useOIDpagination&&(s=""!==s?"("+s+") AND ("+e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString()+")":e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString());const i=e.pagesDefinition.internal.lastRetrieved,o=i,a=e.pagesDefinition.internal.lastPage,p=new re.Z;if(r._requestStandardised&&(p.sqlFormat="standard"),p.where=s,p.spatialRelationship=e.pagesDefinition.spatialRel,p.relationParameter=e.pagesDefinition.relationParam,p.outFields=e.pagesDefinition.outFields,p.outStatistics=e.pagesDefinition.outStatistics,p.geometry=e.pagesDefinition.geometry,p.groupByFieldsForStatistics=e.pagesDefinition.groupByFieldsForStatistics,p.num=e.pagesDefinition.resultRecordCount,p.start=e.pagesDefinition.internal.lastPage,p.returnGeometry=e.pagesDefinition.returnGeometry,p.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,r.isTable()&&p.geometry&&p.spatialRelationship)return[];const c=yield r.executeQuery(p,"execute");if(r._checkCancelled(n),!c.hasOwnProperty("features"))throw new Error("Unnexected Result querying aggregates from layer");const A=[];if(e.pagesDefinition.internal.lastPage!==a)return[];for(let Z=0;Z<c.features.length;Z++)e.pagesDefinition.internal.set[o+Z]=c.features[Z].attributes[e.pagesDefinition.generatedOid];for(let Z=0;Z<c.features.length;Z++)A.push(new N.Z({attributes:c.features[Z].attributes,geometry:null}));return!0===e.pagesDefinition.useOIDpagination?0===c.features.length?e.pagesDefinition.internal.fullyResolved=!0:e.pagesDefinition.internal.lastMaxId=c.features[c.features.length-1].attributes[e.pagesDefinition.generatedOid]:(void 0===c.exceededTransferLimit&&c.features.length!==e.pagesDefinition.resultRecordCount||!1===c.exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=i+c.features.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,A})()}static create(e,t,n,r,s){const i=new ee.default({url:e,outFields:null===t?["*"]:t});return new se({layer:i,spatialReference:n,lrucache:r,interceptor:s})}relationshipMetaData(){return this._layer&&this._layer.source&&this._layer.source.sourceJSON&&this._layer.source.sourceJSON.relationships?this._layer.source.sourceJSON.relationships:[]}serviceUrl(){return(0,C.US)(this._layer.parsedUrl.path)}queryAttachments(e,t,n,r,s){var i=this;return(0,F.Z)(function*(){if(i._layer.capabilities.data.supportsAttachment&&i._layer.capabilities.operations.supportsQueryAttachments){const o={objectIds:[e],returnMetadata:s};(t&&t>0||n&&n>0)&&(o.size=[t&&t>0?t:0,n&&n>0?n:t+1]),r&&r.length>0&&(o.attachmentTypes=r),i.featureSetQueryInterceptor&&i.featureSetQueryInterceptor.preLayerQueryCallback({layer:i._layer,query:o,method:"attachments"});const a=yield i._layer.queryAttachments(o),p=[];return a&&a[e]&&a[e].forEach(c=>{const A=i._layer.parsedUrl.path+"/"+e.toString()+"/attachments/"+c.id.toString();let Z=null;s&&c.exifInfo&&(Z=ke.Z.convertJsonToArcade(c.exifInfo,!0)),p.push(new Oe.Z(c.id,c.name,c.contentType,c.size,A,Z))}),p}return[]})()}queryRelatedFeatures(e){var t=this;return(0,F.Z)(function*(){const n={f:"json",relationshipId:e.relationshipId.toString(),definitionExpression:e.where,outFields:e.outFields.join(","),returnGeometry:e.returnGeometry.toString()};null!=e.resultOffset&&(n.resultOffset=e.resultOffset.toString()),null!=e.resultRecordCount&&(n.resultRecordCount=e.resultRecordCount.toString()),e.orderByFields&&(n.orderByFields=e.orderByFields.join(",")),e.objectIds.length>0&&(n.objectIds=e.objectIds.join(",")),e.outSpatialReference&&(n.outSR=JSON.stringify(e.outSpatialReference.toJSON())),t.featureSetQueryInterceptor&&t.featureSetQueryInterceptor.preRequestCallback({layer:t._layer,queryPayload:n,method:"relatedrecords",url:t._layer.parsedUrl.path+"/queryRelatedRecords"});const r=yield(0,G.default)(t._layer.parsedUrl.path+"/queryRelatedRecords",{responseType:"json",query:n});if(r.data){const s={},i=r.data;if(i&&i.relatedRecordGroups){const o=i.spatialReference;for(const a of i.relatedRecordGroups){const p=a.objectId,c=[];for(const A of a.relatedRecords){A.geometry&&(A.geometry.spatialReference=o);const Z=new N.Z({geometry:A.geometry?(0,Pe.im)(A.geometry):null,attributes:A.attributes});c.push(Z)}s[p]={features:c,exceededTransferLimit:!0===i.exceededTransferLimit}}}return s}throw new Error("Invalid Request")})()}getFeatureByObjectId(e,t){var n=this;return(0,F.Z)(function*(){const r=new re.Z;r.outFields=t,r.returnGeometry=!1,r.outSpatialReference=n.spatialReference,r.where=n.objectIdField+"="+e.toString(),n.featureSetQueryInterceptor&&n.featureSetQueryInterceptor.preLayerQueryCallback({layer:n._layer,query:r,method:"execute"});const s=yield(0,Ie.e)(n._layer.parsedUrl.path,r);return 1===s.features.length?s.features[0]:null})()}getIdentityUser(){var e=this;return(0,F.Z)(function*(){yield e.load();const t=Q.id?.findCredential(e._layer.url);return t?t.userId:null})()}getOwningSystemUrl(){var e=this;return(0,F.Z)(function*(){yield e.load();const t=Q.id?.findServerInfo(e._layer.url);if(t)return t.owningSystemUrl;let n=e._layer.url;const r=n.toLowerCase().indexOf("/rest/services");if(n=r>-1?n.substring(0,r):n,n){n+="/rest/info";try{const s=yield(0,G.default)(n,{query:{f:"json"}});let i="";return s.data&&s.data.owningSystemUrl&&(i=s.data.owningSystemUrl),i}catch{return""}}return""})()}getDataSourceFeatureSet(){const e=new se({layer:this._layer,spatialReference:this.spatialReference,outFields:this._overrideFields,includeGeometry:!this._removeGeometry,lrucache:this.recentlyUsedQueries,interceptor:this.featureSetQueryInterceptor});return e._useDefinitionExpression=!1,e}}var Ue=y(16776);class Me extends x.Z{constructor(e){super(e),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerRelated",this._findObjectId=-1,this._requestStandardised=!1,this._removeGeometry=!1,this._overrideFields=null,this.featureObjectId=null,this.relatedLayer=null,this.relationship=null,e.spatialReference&&(this.spatialReference=e.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=e.layer,this._wset=null,this._findObjectId=e.objectId,this.featureObjectId=e.objectId,this.relationship=e.relationship,this.relatedLayer=e.relatedLayer,void 0!==e.outFields&&(this._overrideFields=e.outFields),void 0!==e.includeGeometry&&(this._removeGeometry=!1===e.includeGeometry)}_maxQueryRate(){return C.tI}end(){return this._layer}optimisePagingFeatureQueries(){}loadImpl(){var e=this;return(0,F.Z)(function*(){return yield Promise.all([e._layer.load(),e.relatedLayer.load()]),e._initialiseFeatureSet(),e})()}nativeCapabilities(){return this.relatedLayer.nativeCapabilities()}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this.relatedLayer.geometryType,this.fields=this.relatedLayer.fields.slice(0),null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const t=[],n=[];for(const r of this.fields)if("oid"===r.type)t.push(r),n.push(r.name);else for(const s of this._overrideFields)if(s.toLowerCase()===r.name.toLowerCase()){t.push(r),n.push(r.name);break}this.fields=t,this._overrideFields=n}const e=this._layer.nativeCapabilities();e&&(this._databaseType=e.databaseType,this._requestStandardised=e.requestStandardised),this.objectIdField=this.relatedLayer.objectIdField,this.globalIdField=this.relatedLayer.globalIdField,this.hasM=this.relatedLayer.supportsM,this.hasZ=this.relatedLayer.supportsZ,this.typeIdField=this.relatedLayer.typeIdField,this.types=this.relatedLayer.types}databaseType(){var e=this;return(0,F.Z)(function*(){return yield e.relatedLayer.databaseType(),e._databaseType=e.relatedLayer._databaseType,e._databaseType})()}isTable(){return this.relatedLayer.isTable()}_isInFeatureSet(){return C.dj.InFeatureSet}_candidateIdTransform(e){return e}_getSet(e){var t=this;return(0,F.Z)(function*(){if(null===t._wset){yield t._ensureLoaded();const n=yield t._getFilteredSet("",null,null,null,e);return t._wset=n,n}return t._wset})()}_changeFeature(e){const t={};for(const n of this.fields)t[n.name]=e.attributes[n.name];return new N.Z({geometry:!0===this._removeGeometry?null:e.geometry,attributes:t})}_getFilteredSet(e,t,n,r,s){var i=this;return(0,F.Z)(function*(){if(yield i.databaseType(),i.isTable()&&t&&null!==e&&""!==e)return new g.Z([],[],!0,null);const o=i._layer.nativeCapabilities();if(!1===o.canQueryRelated)return new g.Z([],[],!0,null);if(o.capabilities.queryRelated&&o.capabilities.queryRelated.supportsPagination)return i._getFilteredSetUsingPaging(e,t,n,r,s);let a="",p=!1;null!==r&&o.capabilities&&o.capabilities.queryRelated&&!0===o.capabilities.queryRelated.supportsOrderBy&&(a=r.constructClause(),p=!0);const c=new we.Z;c.objectIds=[i._findObjectId];const A=null!==i._overrideFields?i._overrideFields:i._fieldsIncludingObjectId(i.relatedLayer.fields?i.relatedLayer.fields.map(X=>X.name):["*"]);c.outFields=A,c.relationshipId=i.relationship.id,c.where="1=1";let Z=!0;!0===i._removeGeometry&&(Z=!1),c.returnGeometry=Z,i._requestStandardised&&(c.sqlFormat="standard"),c.outSpatialReference=i.spatialReference,c.orderByFields=""!==a?a.split(","):null;const j=yield o.source.queryRelatedFeatures(c);i._checkCancelled(s);const z=j[i._findObjectId]?j[i._findObjectId].features:[],q=[];for(let X=0;X<z.length;X++)i._featureCache[z[X].attributes[i.relatedLayer.objectIdField]]=z[X],q.push(z[X].attributes[i.relatedLayer.objectIdField]);const Y=t&&null!==e&&""!==e,W=null!=n;return new g.Z(Y||W?q:[],Y||W?[]:q,p,null)})()}_fieldsIncludingObjectId(e){if(null===e)return[this.objectIdField];const t=e.slice(0);if(t.includes("*"))return t;let n=!1;for(const r of t)if(r.toUpperCase()===this.objectIdField.toUpperCase()){n=!0;break}return!1===n&&t.push(this.objectIdField),t}_getFilteredSetUsingPaging(e,t,n,r,s){var i=this;return(0,F.Z)(function*(){let o="",a=!1;const p=i._layer.nativeCapabilities();null!==r&&p&&p.capabilities.queryRelated&&!0===p.capabilities.queryRelated.supportsOrderBy&&(o=r.constructClause(),a=!0),yield i.databaseType();let A=i._maxQueryRate();const Z=p.capabilities.query.maxRecordCount;void 0!==Z&&Z<A&&(A=Z);const j=t&&null!==e&&""!==e,z=null!=n;let q=null,Y=!0;!0===i._removeGeometry&&(Y=!1);const W=null!==i._overrideFields?i._overrideFields:i._fieldsIncludingObjectId(i.relatedLayer.fields?i.relatedLayer.fields.map(X=>X.name):["*"]);return q=new g.Z(j||z?["GETPAGES"]:[],j||z?[]:["GETPAGES"],a,{outFields:W.join(","),resultRecordCount:A,resultOffset:0,objectIds:[i._findObjectId],where:"1=1",orderByFields:o,returnGeometry:Y,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}}),yield i._expandPagedSet(q,A,0,0,s),q})()}_expandPagedSet(e,t,n,r,s){return this._expandPagedSetFeatureSet(e,t,n,r,s)}_clonePageDefinition(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}}_getPhysicalPage(e,t,n){var r=this;return(0,F.Z)(function*(){const s=e.pagesDefinition.internal.lastRetrieved,i=s,o=e.pagesDefinition.internal.lastPage,a=r._layer.nativeCapabilities(),p=new we.Z;!0===r._requestStandardised&&(p.sqlFormat="standard"),p.relationshipId=r.relationship.id,p.objectIds=e.pagesDefinition.objectIds,p.resultOffset=e.pagesDefinition.internal.lastPage,p.resultRecordCount=e.pagesDefinition.resultRecordCount,p.outFields=e.pagesDefinition.outFields.split(","),p.where=e.pagesDefinition.where,p.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,p.returnGeometry=e.pagesDefinition.returnGeometry,p.outSpatialReference=r.spatialReference;const c=yield a.source.queryRelatedFeatures(p);if(r._checkCancelled(n),e.pagesDefinition.internal.lastPage!==o)return 0;const A=c[r._findObjectId]?c[r._findObjectId].features:[];for(let j=0;j<A.length;j++)e.pagesDefinition.internal.set[i+j]=A[j].attributes[r.relatedLayer.objectIdField];for(let j=0;j<A.length;j++)r._featureCache[A[j].attributes[r.relatedLayer.objectIdField]]=A[j];return A.length!==e.pagesDefinition.resultRecordCount&&(!c[r._findObjectId]||!1===c[r._findObjectId].exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=s+A.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,A.length})()}_getFeatures(e,t,n,r){var s=this;return(0,F.Z)(function*(){const i=[];-1!==t&&void 0===s._featureCache[t]&&i.push(t);const o=s._maxQueryRate();if(!0===s._checkIfNeedToExpandKnownPage(e,o))return yield s._expandPagedSet(e,o,0,0,r),s._getFeatures(e,t,n,r);let a=0;for(let p=e._lastFetchedIndex;p<e._known.length&&(a++,a<=n&&(e._lastFetchedIndex+=1),!("GETPAGES"!==e._known[p]&&void 0===s._featureCache[e._known[p]]&&(e._known[p]!==t&&i.push(e._known[p]),i.length>n)))&&!(a>=n&&0===i.length);p++);if(0===i.length)return"success";throw new Error("Unaccounted for Features. Not in Feature Collection")})()}_refineSetBlock(e,t,n){return(0,F.Z)(function*(){return e})()}_stat(e,t,n,r,s,i,o){return(0,F.Z)(function*(){return{calculated:!1}})()}get gdbVersion(){return this.relatedLayer.gdbVersion}_canDoAggregates(e,t,n,r,s){return(0,F.Z)(function*(){return!1})()}relationshipMetaData(){return this.relatedLayer.relationshipMetaData()}serviceUrl(){return this.relatedLayer.serviceUrl()}queryAttachments(e,t,n,r,s){return this.relatedLayer.queryAttachments(e,t,n,r,s)}getFeatureByObjectId(e,t){return this.relatedLayer.getFeatureByObjectId(e,t)}getOwningSystemUrl(){return this.relatedLayer.getOwningSystemUrl()}getIdentityUser(){return this.relatedLayer.getIdentityUser()}getDataSourceFeatureSet(){return this.relatedLayer}}var K=y(53791),We=y(84687),Ge=y(55463);function Ke(){null===K.Z.applicationCache&&(K.Z.applicationCache=new K.Z)}function oe(u,e){return ue.apply(this,arguments)}function ue(){return(ue=(0,F.Z)(function*(u,e){if(K.Z.applicationCache){const t=K.Z.applicationCache.getLayerInfo(u);if(t){const s=yield t;return new ee.default({url:u,outFields:e,sourceJSON:s})}const n=new ee.default({url:u,outFields:e}),r=(0,F.Z)(function*(){return yield n.load(),n.sourceJSON})();if(K.Z.applicationCache){K.Z.applicationCache.setLayerInfo(u,r);try{return yield r,n}catch(s){throw K.Z.applicationCache.clearLayerInfo(u),s}}return yield r,n}return new ee.default({url:u,outFields:e})})).apply(this,arguments)}function de(u,e,t,n,r){return ce.apply(this,arguments)}function ce(){return(ce=(0,F.Z)(function*(u,e,t,n,r,s=null){return ie(yield oe(u,["*"]),e,t,n,r,s)})).apply(this,arguments)}function ie(u,e=null,t=null,n=!0,r=null,s=null){return!0===u._hasMemorySource()?new Ue.Z({layer:u,spatialReference:e,outFields:t,includeGeometry:n,lrucache:r,interceptor:s}):new se({layer:u,spatialReference:e,outFields:t,includeGeometry:n,lrucache:r,interceptor:s})}function Qe(u){return he.apply(this,arguments)}function he(){return(he=(0,F.Z)(function*(u){if(null!==K.Z.applicationCache){const t=K.Z.applicationCache.getLayerInfo(u);if(null!==t)return t}const e=(0,F.Z)(function*(){const t=yield(0,G.default)(u,{responseType:"json",query:{f:"json"}});return t.data?t.data:null})();if(null!==K.Z.applicationCache){K.Z.applicationCache.setLayerInfo(u,e);try{return yield e}catch(t){throw K.Z.applicationCache.clearLayerInfo(u),t}}return e})).apply(this,arguments)}function Ve(u,e){return fe.apply(this,arguments)}function fe(){return(fe=(0,F.Z)(function*(u,e){const t="QUERYDATAELEMTS:"+e.toString()+":"+u;if(null!==K.Z.applicationCache){const r=K.Z.applicationCache.getLayerInfo(t);if(null!==r)return r}const n=(0,F.Z)(function*(){const r=yield(0,G.default)(u+"/queryDataElements",{method:"post",responseType:"json",query:{layers:JSON.stringify([e.toString()]),f:"json"}});if(r.data){const s=r.data;if(s.layerDataElements&&s.layerDataElements[0])return s.layerDataElements[0]}throw new Error("Not Found")})();if(null!==K.Z.applicationCache){K.Z.applicationCache.setLayerInfo(t,n);try{return yield n}catch(r){throw K.Z.applicationCache.clearLayerInfo(t),r}}return n})).apply(this,arguments)}function Ce(u){return _e.apply(this,arguments)}function _e(){return(_e=(0,F.Z)(function*(u){if(null!==K.Z.applicationCache){const t=K.Z.applicationCache.getLayerInfo(u);if(null!==t)return t}const e=(0,F.Z)(function*(){const t=yield(0,G.default)(u,{responseType:"json",query:{f:"json"}});if(t.data){const n=t.data;return n.layers||(n.layers=[]),n.tables||(n.tables=[]),n}return{layers:[],tables:[]}})();if(null!==K.Z.applicationCache){K.Z.applicationCache.setLayerInfo(u,e);try{return yield e}catch(t){throw K.Z.applicationCache.clearLayerInfo(u),t}}return e})).apply(this,arguments)}function qe(u,e){return pe.apply(this,arguments)}function pe(){return(pe=(0,F.Z)(function*(u,e){const t={metadata:null,networkId:-1,unVersion:3,terminals:[],queryelem:null,layerNameLkp:{},lkp:null},n=yield Ce(u);if(t.metadata=n,n.controllerDatasetLayers&&null!=n.controllerDatasetLayers.utilityNetworkLayerId){if(n.layers)for(const i of n.layers)t.layerNameLkp[i.id]=i.name;if(n.tables)for(const i of n.tables)t.layerNameLkp[i.id]=i.name;const r=n.controllerDatasetLayers.utilityNetworkLayerId;t.networkId=r;const s=yield Ve(u,r);if(s){t.queryelem=s,t.queryelem&&t.queryelem.dataElement&&void 0!==t.queryelem.dataElement.schemaGeneration&&(t.unVersion=t.queryelem.dataElement.schemaGeneration),t.lkp={},t.queryelem.dataElement.domainNetworks||(t.queryelem.dataElement.domainNetworks=[]);for(const o of t.queryelem.dataElement.domainNetworks){for(const a of o.edgeSources?o.edgeSources:[]){const p={layerId:a.layerId,sourceId:a.sourceId,className:t.layerNameLkp[a.layerId]?t.layerNameLkp[a.layerId]:null};p.className&&(t.lkp[p.className]=p)}for(const a of o.junctionSources?o.junctionSources:[]){const p={layerId:a.layerId,sourceId:a.sourceId,className:t.layerNameLkp[a.layerId]?t.layerNameLkp[a.layerId]:null};p.className&&(t.lkp[p.className]=p)}}if(t.queryelem.dataElement.terminalConfigurations)for(const o of t.queryelem.dataElement.terminalConfigurations)for(const a of o.terminals)t.terminals.push({terminalId:a.terminalId,terminalName:a.terminalName});const i=yield Qe(u+"/"+r);if(i.systemLayers&&null!=i.systemLayers.associationsTableId){const o=[];t.unVersion>=4&&(o.push("STATUS"),o.push("PERCENTALONG"));let a=yield de(u+"/"+i.systemLayers.associationsTableId.toString(),e,["OBJECTID","FROMNETWORKSOURCEID","TONETWORKSOURCEID","FROMGLOBALID","TOGLOBALID","TOTERMINALID","FROMTERMINALID","ASSOCIATIONTYPE","ISCONTENTVISIBLE","GLOBALID",...o],!1,null,null);return yield a.load(),t.unVersion>=4&&(a=a.filter(m.WhereClause.create("STATUS NOT IN (1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15, 17, 18, 19, 20, 21, 22, 23, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38, 39, 41, 42, 43, 44, 45, 46, 47, 49, 50, 51, 52, 53, 54, 55, 57, 58, 59, 60, 61, 62,63)",a.getFieldsIndex())),yield a.load()),{lkp:t.lkp,associations:a,unVersion:t.unVersion,terminals:t.terminals}}return{associations:null,unVersion:t.unVersion,lkp:null,terminals:[]}}return{associations:null,unVersion:t.unVersion,lkp:null,terminals:[]}}return{associations:null,unVersion:t.unVersion,lkp:null,terminals:[]}})).apply(this,arguments)}function ze(u,e,t){return ye.apply(this,arguments)}function ye(){return(ye=(0,F.Z)(function*(u,e,t,n=null,r=null,s=!0,i=null,o=null){let a=u.serviceUrl();if(!a)return null;a="/"===a.charAt(a.length-1)?a+e.relatedTableId.toString():a+"/"+e.relatedTableId.toString();const p=yield de(a,n,r,s,i,o);return new Me({layer:u,relatedLayer:p,relationship:e,objectId:t,spatialReference:n,outFields:r,includeGeometry:s,lrucache:i,interceptor:o})})).apply(this,arguments)}P.Z.registerAction(),le.registerAction(),R.Z.registerAction(),Te.Z.registerAction(),xe.Z.registerAction();class Je extends E.Z{constructor(e,t=null,n=null,r=null){super(),this._map=e,this._overridespref=t,this.lrucache=n,this.interceptor=r,this._instantLayers=[]}_makeAndAddFeatureSet(e,t=!0,n=null){const r=ie(e,this._overridespref,null===n?["*"]:n,t,this.lrucache,this.interceptor);return this._instantLayers.push({featureset:r,opitem:e,includeGeometry:t,outFields:JSON.stringify(n)}),r}featureSetByName(e,t=!0,n=null){var r=this;return(0,F.Z)(function*(){if(void 0!==r._map.loaded&&void 0!==r._map.load&&!1===r._map.loaded)return yield r._map.load(),r.featureSetByName(e,t,n);null===n&&(n=["*"]),n=(n=n.slice(0)).sort();const s=JSON.stringify(n);for(let o=0;o<r._instantLayers.length;o++){const a=r._instantLayers[o];if(a.opitem.title===e&&a.includeGeometry===t&&a.outFields===s)return r._instantLayers[o].featureset}const i=r._map.allLayers.find(o=>o instanceof ee.default&&o.title===e);if(i)return r._makeAndAddFeatureSet(i,t,n);if(r._map.tables){const o=r._map.tables.find(a=>!!(a.title&&a.title===e||a.title&&a.title===e));if(o){if(o instanceof ee.default)return r._makeAndAddFeatureSet(o,t,n);if(!o._materializedTable){const a=o.outFields?o:{...o,outFields:["*"]};o._materializedTable=new ee.default(a)}return yield o._materializedTable.load(),r._makeAndAddFeatureSet(o._materializedTable,t,n)}}return null})()}featureSetById(e,t=!0,n=["*"]){var r=this;return(0,F.Z)(function*(){if(void 0!==r._map.loaded&&void 0!==r._map.load&&!1===r._map.loaded)return yield r._map.load(),r.featureSetById(e,t,n);null===n&&(n=["*"]),n=(n=n.slice(0)).sort();const s=JSON.stringify(n);for(let o=0;o<r._instantLayers.length;o++){const a=r._instantLayers[o];if(a.opitem.id===e&&a.includeGeometry===t&&a.outFields===s)return r._instantLayers[o].featureset}const i=r._map.allLayers.find(o=>o instanceof ee.default&&o.id===e);if(i)return r._makeAndAddFeatureSet(i,t,n);if(r._map.tables){const o=r._map.tables.find(a=>a.id===e);if(o){if(o instanceof ee.default)return r._makeAndAddFeatureSet(o,t,n);if(!o._materializedTable){const a={...o,outFields:["*"]};o._materializedTable=new ee.default(a)}return yield o._materializedTable.load(),r._makeAndAddFeatureSet(o._materializedTable,t,n)}}return null})()}}class ge extends E.Z{constructor(e,t=null,n=null,r=null){super(),this._url=e,this._overridespref=t,this.lrucache=n,this.interceptor=r,this.metadata=null,this._instantLayers=[]}get url(){return this._url}_makeAndAddFeatureSet(e,t=!0,n=null){const r=ie(e,this._overridespref,null===n?["*"]:n,t,this.lrucache);return this._instantLayers.push({featureset:r,opitem:e,includeGeometry:t,outFields:JSON.stringify(n)}),r}_loadMetaData(){var e=this;return(0,F.Z)(function*(){const t=yield Ce(e._url);return e.metadata=t,t})()}load(){return this._loadMetaData()}clone(){return new ge(this._url,this._overridespref,this.lrucache,this.interceptor)}featureSetByName(e,t=!0,n=null){var r=this;return(0,F.Z)(function*(){null===n&&(n=["*"]),n=(n=n.slice(0)).sort();const s=JSON.stringify(n);for(let a=0;a<r._instantLayers.length;a++){const p=r._instantLayers[a];if(p.opitem.title===e&&p.includeGeometry===t&&p.outFields===s)return r._instantLayers[a].featureset}const i=yield r._loadMetaData();let o=null;for(const a of i.layers?i.layers:[])a.name===e&&(o=a);if(!o)for(const a of i.tables?i.tables:[])a.name===e&&(o=a);if(o){const a=yield oe(r._url+"/"+o.id,["*"]);return r._makeAndAddFeatureSet(a,t,n)}return null})()}featureSetById(e,t=!0,n=["*"]){var r=this;return(0,F.Z)(function*(){null===n&&(n=["*"]),n=(n=n.slice(0)).sort();const s=JSON.stringify(n);e=null!=e?e.toString():"";for(let a=0;a<r._instantLayers.length;a++){const p=r._instantLayers[a];if(p.opitem.id===e&&p.includeGeometry===t&&p.outFields===s)return r._instantLayers[a].featureset}const i=yield r._loadMetaData();let o=null;for(const a of i.layers?i.layers:[])null!=a.id&&a.id.toString()===e&&(o=a);if(!o)for(const a of i.tables?i.tables:[])null!=a.id&&a.id.toString()===e&&(o=a);if(o){const a=yield oe(r._url+"/"+o.id,["*"]);return r._makeAndAddFeatureSet(a,t,n)}return null})()}}function Xe(u,e,t=null,n=null){return new Je(u,e,t,n)}function He(u,e,t=null,n=null){return new ge(u,e,t,n)}function $e(u,e){return null===u?e:new We.Z({url:u.field("url")})}function Ye(u,e,t){return me.apply(this,arguments)}function me(){return(me=(0,F.Z)(function*(u,e,t){if(!Q.id.findCredential(u.restUrl))return null;if("loaded"===u.loadStatus&&""===e&&u.user&&u.user.sourceJSON&&!1===t)return u.user.sourceJSON;if(""===e){const r=yield(0,G.default)(u.restUrl+"/community/self",{responseType:"json",query:{f:"json",...!1===t?{}:{returnUserLicenseTypeExtensions:!0}}});if(r.data){const s=r.data;if(s&&s.username)return s}return null}const n=yield(0,G.default)(u.restUrl+"/community/users/"+e,{responseType:"json",query:{f:"json"}});if(n.data){const r=n.data;return r.error?null:r}return null})).apply(this,arguments)}function et(u,e,t,n,r){if(null===u)return null;if(u instanceof ee.default){switch(e){case"datasource":return ie(u,r,u.outFields,!0,t,n).getDataSourceFeatureSet();case"parent":case"root":return ie(u,r,u.outFields,!0,t,n)}return null}if(u instanceof x.Z)switch(e){case"datasource":return u.getDataSourceFeatureSet();case"parent":return u;case"root":return u.getRootFeatureSet()}return null}function tt(u,e,t,n,r,s,i){return Fe.apply(this,arguments)}function Fe(){return(Fe=(0,F.Z)(function*(u,e,t,n,r,s,i,o=null){if(K.Z.applicationCache){const p=K.Z.applicationCache.getLayerInfo(u+":"+s.url);if(p){const c=yield p;return ie(new ee.default({url:(0,C.US)(c.url)+"/"+e,outFields:["*"]}),t,n,r,i,o)}}const a=new Ge.default({id:u,portal:s}).load();K.Z.applicationCache&&K.Z.applicationCache.setLayerInfo(u+":"+s.url,a);try{const p=yield a;return ie(new ee.default({url:(0,C.US)(p.url)+"/"+e,outFields:["*"]}),t,n,r,i,o)}catch(p){throw K.Z.applicationCache&&K.Z.applicationCache.clearLayerInfo(u+":"+s.url),p}})).apply(this,arguments)}},52724:(te,H,y)=>{y.d(H,{$X:()=>g,QP:()=>_,TO:()=>C,Xx:()=>D,yN:()=>d});var F=y(15861),Q=y(88879),G=y(27187),E=y(49086),P=y(91510),N=y(77132),S=y(83947),w=y(10410),R=y(65234);class x{constructor(f){this.field=f,this.sqlRewritable=!1}postInitialization(f,l){}}class g extends x{constructor(f){super(f),this.sqlRewritable=!0}extractValue(f){return f.attributes[this.field.name]}rewriteSql(f){return{rewritten:this.sqlRewritable,where:f}}}class _ extends x{constructor(f,l,h){super((0,N.JW)(f)),this.originalField=f,this.sqlRewritable=!0,this.field.name=l,this.field.alias=h}rewriteSql(f,l){return{rewritten:this.sqlRewritable,where:(0,S.bB)(f,this.field.name,this.originalField.name,l.getFieldsIndex())}}extractValue(f){return f.attributes[this.originalField.name]}}let C=(()=>{class m extends x{constructor(l,h,v){super(l),this.codefield=h,this.lkp=v,this.reverseLkp={};for(const b in v)this.reverseLkp[v[b]]=b;this.sqlRewritable=!0}rewriteSql(l,h){const v=this.evaluateNodeToWhereClause(l.parseTree,N.Bj.Standardised,this.field.name,this.codefield instanceof w.WhereClause?(0,S.zR)(this.codefield,N.Bj.Standardised):this.codefield,l.parameters);return v.includes(m.BADNESS)?{rewritten:!1,where:l}:{rewritten:this.sqlRewritable,where:w.WhereClause.create(v,h._parent.getFieldsIndex())}}evaluateNodeToWhereClause(l,h,v=null,b=null,I){let k,M,U,O;switch(l.type){case"interval":return(0,S.TE)(this.evaluateNodeToWhereClause(l.value,h,v,b,I),l.qualifier,l.op);case"case-expression":{let T=" CASE ";"simple"===l.format&&(T+=this.evaluateNodeToWhereClause(l.operand,h,v,m.BADNESS,I));for(let B=0;B<l.clauses.length;B++)T+=" WHEN "+this.evaluateNodeToWhereClause(l.clauses[B].operand,h,v,m.BADNESS,I)+" THEN "+this.evaluateNodeToWhereClause(l.clauses[B].value,h,v,m.BADNESS,I);return null!==l.else&&(T+=" ELSE "+this.evaluateNodeToWhereClause(l.else,h,v,m.BADNESS,I)),T+=" END ",T}case"parameter":{const T=I[l.value.toLowerCase()];if("string"==typeof T)return"'"+I[l.value.toLowerCase()].toString().replace(/'/g,"''")+"'";if(T instanceof Date)return(0,S.oX)(T,h);if(T instanceof Array){const B=[];for(let L=0;L<T.length;L++)"string"==typeof T[L]?B.push("'"+T[L].toString().replace(/'/g,"''")+"'"):T[L]instanceof Date?B.push((0,S.oX)(T[L],h)):B.push(T[L].toString());return B}return T.toString()}case"expression-list":M=[];for(const T of l.value)M.push(this.evaluateNodeToWhereClause(T,h,v,b,I));return M;case"unary-expression":return" ( NOT "+this.evaluateNodeToWhereClause(l.expr,h,v,m.BADNESS,I)+" ) ";case"binary-expression":switch(l.operator){case"AND":return" ("+this.evaluateNodeToWhereClause(l.left,h,v,b,I)+" AND "+this.evaluateNodeToWhereClause(l.right,h,v,b,I)+") ";case"OR":return" ("+this.evaluateNodeToWhereClause(l.left,h,v,b,I)+" OR "+this.evaluateNodeToWhereClause(l.right,h,v,b,I)+") ";case"IS":if("null"!==l.right.type)throw new Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(l.left,h,v,b,I)+" IS NULL )";case"ISNOT":if("null"!==l.right.type)throw new Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(l.left,h,v,b,I)+" IS NOT NULL )";case"IN":if(k=[],"expression-list"===l.right.type){if("column-reference"===l.left.type&&l.left.column.toUpperCase()===this.field.name.toUpperCase()){const T=[];let B=!0;for(const L of l.right.value){if("string"!==L.type){B=!1;break}if(void 0===this.lkp[L.value]){B=!1;break}T.push(this.lkp[L.value].toString())}if(B)return" ("+this.evaluateNodeToWhereClause(l.left,h,v,b,I)+" IN ("+T.join(",")+")) "}return k=this.evaluateNodeToWhereClause(l.right,h,v,b,I)," ("+this.evaluateNodeToWhereClause(l.left,h,v,b,I)+" IN ("+k.join(",")+")) "}return O=this.evaluateNodeToWhereClause(l.right,h,v,b,I),O instanceof Array?" ("+this.evaluateNodeToWhereClause(l.left,h,v,b,I)+" IN ("+O.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(l.left,h,v,b,I)+" IN ("+O+")) ";case"NOT IN":if(k=[],"expression-list"===l.right.type){if("column-reference"===l.left.type&&l.left.column.toUpperCase()===this.field.name.toUpperCase()){const T=[];let B=!0;for(const L of l.right.value){if("string"!==L.type){B=!1;break}if(void 0===this.lkp[L.value]){B=!1;break}T.push(this.lkp[L.value].toString())}if(B)return" ("+this.evaluateNodeToWhereClause(l.left,h,v,b,I)+" NOT IN ("+T.join(",")+")) "}return k=this.evaluateNodeToWhereClause(l.right,h,v,b,I)," ("+this.evaluateNodeToWhereClause(l.left,h,v,b,I)+" NOT IN ("+k.join(",")+")) "}return O=this.evaluateNodeToWhereClause(l.right,h,v,b,I),O instanceof Array?" ("+this.evaluateNodeToWhereClause(l.left,h,v,b,I)+" NOT IN ("+O.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(l.left,h,v,b,I)+" NOT IN ("+O+")) ";case"BETWEEN":return U=this.evaluateNodeToWhereClause(l.right,h,v,m.BADNESS,I)," ("+this.evaluateNodeToWhereClause(l.left,h,v,m.BADNESS,I)+" BETWEEN "+U[0]+" AND "+U[1]+" ) ";case"NOTBETWEEN":return U=this.evaluateNodeToWhereClause(l.right,h,v,m.BADNESS,I)," ("+this.evaluateNodeToWhereClause(l.left,h,v,m.BADNESS,I)+" NOT BETWEEN "+U[0]+" AND "+U[1]+" ) ";case"LIKE":return""!==l.escape?" ("+this.evaluateNodeToWhereClause(l.left,h,v,m.BADNESS,I)+" LIKE "+this.evaluateNodeToWhereClause(l.right,h,v,m.BADNESS,I)+" ESCAPE '"+l.escape+"') ":" ("+this.evaluateNodeToWhereClause(l.left,h,v,m.BADNESS,I)+" LIKE "+this.evaluateNodeToWhereClause(l.right,h,v,m.BADNESS,I)+") ";case"NOT LIKE":return""!==l.escape?" ("+this.evaluateNodeToWhereClause(l.left,h,v,m.BADNESS,I)+" NOT LIKE "+this.evaluateNodeToWhereClause(l.right,h,v,m.BADNESS,I)+" ESCAPE '"+l.escape+"') ":" ("+this.evaluateNodeToWhereClause(l.left,h,v,m.BADNESS,I)+" NOT LIKE "+this.evaluateNodeToWhereClause(l.right,h,v,m.BADNESS,I)+") ";case"<>":case"=":if("column-reference"===l.left.type&&"string"===l.right.type){if(l.left.column.toUpperCase()===this.field.name.toUpperCase()&&void 0!==this.lkp[l.right.value.toString()])return" ("+b+" "+l.operator+" "+this.lkp[l.right.value.toString()].toString()+") "}else if("column-reference"===l.right.type&&"string"===l.left.type&&l.right.column.toUpperCase()===this.field.name.toUpperCase())return" ("+this.lkp[l.right.value.toString()].toString()+" "+l.operator+" "+b+") ";return" ("+this.evaluateNodeToWhereClause(l.left,h,v,m.BADNESS,I)+" "+l.operator+" "+this.evaluateNodeToWhereClause(l.right,h,v,m.BADNESS,I)+") ";case"<":case">":case">=":case"<=":case"*":case"-":case"+":case"/":return" ("+this.evaluateNodeToWhereClause(l.left,h,v,m.BADNESS,I)+" "+l.operator+" "+this.evaluateNodeToWhereClause(l.right,h,v,m.BADNESS,I)+") "}case"null":return"null";case"boolean":return!0===l.value?"1":"0";case"string":return"'"+l.value.toString().replace(/'/g,"''")+"'";case"timestamp":case"date":return(0,S.oX)(l.value,h);case"number":return l.value.toString();case"current-time":return(0,S.vR)("date"===l.mode,h);case"column-reference":return v&&v.toLowerCase()===l.column.toLowerCase()?"("+b+")":l.column;case"function":{const T=this.evaluateNodeToWhereClause(l.args,h,v,m.BADNESS,I);return(0,S.fz)(l.name,T,h)}}throw new Error("Unsupported sql syntax "+l.type)}extractValue(l){return this.codefield instanceof w.WhereClause?this.reverseLkp[this.codefield.calculateValueCompiled(l)]:this.reverseLkp[l.attributes[this.codefield]]}}return m.BADNESS="_!!!_BAD_LKP_!!!!",m})();class d extends x{constructor(f,l){super(f),this.sql=l}rewriteSql(f,l){return{rewritten:!0,where:(0,S.bB)(f,this.field.name,(0,S.zR)(this.sql,N.Bj.Standardised),l.getFieldsIndex())}}extractValue(f){return this.sql.calculateValueCompiled(f)}}class D extends E.Z{constructor(f){super(f),this._calcFunc=null,this.declaredClass="esri.arcade.featureset.actions.Adapted",this.adaptedFields=null,this._extraFilter=null,this._extraFilter=f.extraFilter,this._parent=f.parentfeatureset,this._maxProcessing=30,this.adaptedFields=f.adaptedFields}static findField(f,l){for(const h of f)if(h.name.toLowerCase()===l.toString().toLowerCase())return h;return null}_initialiseFeatureSet(){null!==this._parent?(this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.spatialReference=new R.Z({wkid:4326}),this.objectIdField="",this.globalIdField="",this.geometryType=N.Qk.point,this.typeIdField="",this.types=null),this.fields=[];for(const f of this.adaptedFields)f.postInitialization(this,this._parent),this.fields.push(f.field)}_getSet(f){var l=this;return(0,F.Z)(function*(){if(null===l._wset){yield l._ensureLoaded();let h=null;return h=l._extraFilter?yield l._getFilteredSet("",null,null,null,f):yield l._parent._getSet(f),l._checkCancelled(f),l._wset=new P.Z(h._candidates.slice(0),h._known.slice(0),h._ordered,l._clonePageDefinition(h.pagesDefinition)),l._wset}return l._wset})()}_isInFeatureSet(f){return this._parent._isInFeatureSet(f)}_getFeatures(f,l,h,v){var b=this;return(0,F.Z)(function*(){const I=[];-1!==l&&void 0===b._featureCache[l]&&I.push(l);const k=b._maxQueryRate();if(!0===b._checkIfNeedToExpandKnownPage(f,k))return yield b._expandPagedSet(f,k,0,0,v),b._getFeatures(f,l,h,v);let M=0;for(let T=f._lastFetchedIndex;T<f._known.length&&(M++,M<=h&&(f._lastFetchedIndex+=1),!(void 0===b._featureCache[f._known[T]]&&(f._known[T]!==l&&I.push(f._known[T]),I.length>=k)));T++);if(0===I.length)return"success";f=new P.Z([],I,f._ordered,null);const U=Math.min(I.length,h);yield b._parent._getFeatures(f,-1,U,v),b._checkCancelled(v);const O=[];for(let T=0;T<U;T++){const B=b._parent._featureFromCache(I[T]);void 0!==B&&O.push({geometry:B.geometry,attributes:B.attributes,id:I[T]})}for(const T of O){const B=[];for(const L of b.adaptedFields)B[L.field.name]=L.extractValue(T);b._featureCache[T.id]=new Q.Z({attributes:B,geometry:(0,G.r1)(T.geometry)})}return"success"})()}_fetchAndRefineFeatures(){return(0,F.Z)(function*(){throw new Error("Fetch and Refine should not be called in this featureset")})()}_getFilteredSet(f,l,h,v,b){var I=this;return(0,F.Z)(function*(){let k=!1;const M=I._reformulateWithoutAdaptions(h);k=M.cannot,h=M.where;let U=!1;if(null!==v){U=!0;const B=[];for(const L of I.adaptedFields)if(!(L instanceof g)&&!0===v.scanForField(L.field.name)){if(!(L instanceof _)){v=null,U=!1;break}B.push({field:L.field.name,newfield:L.originalField.name})}v&&B.length>0&&(v=v.replaceFields(B))}null!==h?null!==I._extraFilter&&(h=(0,S.$e)(I._extraFilter,h)):h=I._extraFilter,yield I._ensureLoaded();const O=yield I._parent._getFilteredSet(f,l,h,v,b);let T;return I._checkCancelled(b),T=!0===k?new P.Z(O._candidates.slice(0).concat(O._known.slice(0)),[],!0===U&&O._ordered,I._clonePageDefinition(O.pagesDefinition)):new P.Z(O._candidates.slice(0),O._known.slice(0),!0===U&&O._ordered,I._clonePageDefinition(O.pagesDefinition)),T})()}_reformulateWithoutAdaptions(f){const l={cannot:!1,where:f};if(null!==f)for(const h of this.adaptedFields)if(!0===(0,S.hq)(f,h.field.name)){const v=h.rewriteSql(f,this);if(!0!==v.rewritten){l.cannot=!0,l.where=null;break}l.where=v.where}return l}_stat(f,l,h,v,b,I,k){var M=this;return(0,F.Z)(function*(){let U=!1,O=M._reformulateWithoutAdaptions(l);if(U=O.cannot,l=O.where,O=M._reformulateWithoutAdaptions(b),U=U||O.cannot,null!==(b=O.where)?null!==M._extraFilter&&(b=(0,S.$e)(M._extraFilter,b)):b=M._extraFilter,!0===U)return null===b&&""===h&&null===v?M._manualStat(f,l,I,k):{calculated:!1};const T=yield M._parent._stat(f,l,h,v,b,I,k);return!1===T.calculated?null===b&&""===h&&null===v?M._manualStat(f,l,I,k):{calculated:!1}:T})()}_canDoAggregates(f,l,h,v,b){var I=this;return(0,F.Z)(function*(){if(null===I._parent)return!1;for(let U=0;U<f.length;U++)for(const O of I.adaptedFields)if(f[U].toLowerCase()===O.field.name.toLowerCase()&&!(O instanceof g))return!1;const k=[];for(let U=0;U<l.length;U++){const O=l[U];if(null!==O.workingexpr){const T=I._reformulateWithoutAdaptions(O.workingexpr);if(T.cannot)return!1;const B=O.clone();B.workingexpr=T.where,k.push(B)}else k.push(O)}const M=I._reformulateWithoutAdaptions(b);return!M.cannot&&(null!==(b=M.where)?null!==I._extraFilter&&(b=(0,S.$e)(I._extraFilter,b)):b=I._extraFilter,I._parent._canDoAggregates(f,k,h,v,b))})()}_getAggregatePagesDataSourceDefinition(f,l,h,v,b,I,k){var M=this;return(0,F.Z)(function*(){if(null===M._parent)throw new Error("Should never be called");const U=[];for(let T=0;T<l.length;T++){const B=l[T];if(null!==B.workingexpr){const L=M._reformulateWithoutAdaptions(B.workingexpr);if(L.cannot)throw new Error("Should never be called");const J=B.clone();J.workingexpr=L.where,U.push(J)}else U.push(B)}const O=M._reformulateWithoutAdaptions(b);if(O.cannot)throw new Error("Should never be called");return null!==(b=O.where)?null!==M._extraFilter&&(b=(0,S.$e)(M._extraFilter,b)):b=M._extraFilter,M._parent._getAggregatePagesDataSourceDefinition(f,U,h,v,b,I,k)})()}}},53997:(te,H,y)=>{y.d(H,{Z:()=>R});var F=y(15861),Q=y(49086),G=y(91510),E=y(77132),P=y(83947),N=y(10699),S=y(10410),w=y(65234);class R extends Q.Z{constructor(g){super(g),this.declaredClass="esri.arcade.featureset.actions.AttributeFilter",this._maxProcessing=1e3,this._parent=g.parentfeatureset,g.whereclause instanceof S.WhereClause?(this._whereclause=g.whereclause,this._whereClauseFunction=null):(this._whereClauseFunction=g.whereclause,this._whereclause=null)}_initialiseFeatureSet(){null!==this._parent?(this.fields=this._parent.fields.slice(0),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.fields=[],this.typeIdField="",this.objectIdField="",this.globalIdField="",this.spatialReference=new w.Z({wkid:4326}),this.geometryType=E.Qk.point)}_getSet(g){var _=this;return(0,F.Z)(function*(){if(null===_._wset){yield _._ensureLoaded();const C=yield _._parent._getFilteredSet("",null,_._whereclause,null,g);return _._checkCancelled(g),_._wset=null!==_._whereClauseFunction?new G.Z(C._candidates.slice(0).concat(C._known.slice(0)),[],C._ordered,_._clonePageDefinition(C.pagesDefinition)):new G.Z(C._candidates.slice(0),C._known.slice(0),C._ordered,_._clonePageDefinition(C.pagesDefinition)),_._wset}return _._wset})()}_isInFeatureSet(g){let _=this._parent._isInFeatureSet(g);return _===E.dj.NotInFeatureSet?_:(_=this._idstates[g],void 0===_?E.dj.Unknown:_)}_getFeature(g,_,C){return this._parent._getFeature(g,_,C)}_getFeatures(g,_,C,d){return this._parent._getFeatures(g,_,C,d)}_featureFromCache(g){return this._parent._featureFromCache(g)}executeWhereClause(g){return this._whereclause.testFeature(g)}executeWhereClauseDeferred(g){var _=this;return(0,F.Z)(function*(){if(null!==_._whereClauseFunction){const C=_._whereClauseFunction(g);return(0,N.y8)(C),C}return _.executeWhereClause(g)})()}_fetchAndRefineFeatures(g,_,C){var d=this;return(0,F.Z)(function*(){const D=new G.Z([],g,!1,null),m=Math.min(_,g.length);if(yield d._parent._getFeatures(D,-1,m,C),d._checkCancelled(C),null==d._whereClauseFunction){for(let l=0;l<m;l++){const h=d._parent._featureFromCache(g[l]);d._idstates[g[l]]=!0===d.executeWhereClause(h)?E.dj.InFeatureSet:E.dj.NotInFeatureSet}return"success"}const f=[];for(let l=0;l<m;l++){const h=d._parent._featureFromCache(g[l]);f.push(yield d.executeWhereClauseDeferred(h))}for(let l=0;l<_;l++)d._idstates[g[l]]=!0===f[l]?E.dj.InFeatureSet:E.dj.NotInFeatureSet;return"success"})()}_getFilteredSet(g,_,C,d,D){var m=this;return(0,F.Z)(function*(){null!==m._whereClauseFunction||(null!==C?null!==m._whereclause&&(C=(0,P.$e)(m._whereclause,C)):C=m._whereclause),yield m._ensureLoaded();const f=yield m._parent._getFilteredSet(g,_,C,d,D);let l;return m._checkCancelled(D),l=null!==m._whereClauseFunction?new G.Z(f._candidates.slice(0).concat(f._known.slice(0)),[],f._ordered,m._clonePageDefinition(f.pagesDefinition)):new G.Z(f._candidates.slice(0),f._known.slice(0),f._ordered,m._clonePageDefinition(f.pagesDefinition)),l})()}_stat(g,_,C,d,D,m,f){var l=this;return(0,F.Z)(function*(){if(null!==l._whereClauseFunction)return null===D&&""===C&&null===d?l._manualStat(g,_,m,f):{calculated:!1};let h=l._whereclause;null!==D&&null!==l._whereclause&&(h=(0,P.$e)(l._whereclause,D));const v=yield l._parent._stat(g,_,C,d,h,m,f);return!1===v.calculated?null===D&&""===C&&null===d?l._manualStat(g,_,m,f):{calculated:!1}:v})()}_canDoAggregates(g,_,C,d,D){var m=this;return(0,F.Z)(function*(){return null===m._whereClauseFunction&&(null!==D?null!==m._whereclause&&(D=(0,P.$e)(m._whereclause,D)):D=m._whereclause,null!==m._parent&&m._parent._canDoAggregates(g,_,C,d,D))})()}_getAggregatePagesDataSourceDefinition(g,_,C,d,D,m,f){var l=this;return(0,F.Z)(function*(){if(null===l._parent)throw new Error("Should never be called");return null!==D?null!==l._whereclause&&(D=(0,P.$e)(l._whereclause,D)):D=l._whereclause,l._parent._getAggregatePagesDataSourceDefinition(g,_,C,d,D,m,f)})()}static registerAction(){Q.Z._featuresetFunctions.filter=function(g){if("function"==typeof g)return new R({parentfeatureset:this,whereclause:g});let _=null;return g instanceof S.WhereClause&&(_=g),new R({parentfeatureset:this,whereclause:_})}}}},95896:(te,H,y)=>{y.d(H,{Z:()=>N});var F=y(15861),Q=y(47562),G=y(49086),E=y(91510),P=y(57366);class N extends G.Z{constructor(w){super(w),this._orderbyclause=null,this.declaredClass="esri.arcade.featureset.actions.OrderBy",this._maxProcessing=100,this._orderbyclause=w.orderbyclause,this._parent=w.parentfeatureset}_getSet(w){var R=this;return(0,F.Z)(function*(){if(null===R._wset){yield R._ensureLoaded();const x=yield R._getFilteredSet("",null,null,R._orderbyclause,w);return R._checkCancelled(w),R._wset=x,R._wset}return R._wset})()}manualOrderSet(w,R){var x=this;return(0,F.Z)(function*(){const g=yield x.getIdColumnDictionary(w,[],-1,R);x._orderbyclause.order(g);const _=new E.Z([],[],!0,null);for(let C=0;C<g.length;C++)_._known.push(g[C].id);return _})()}getIdColumnDictionary(w,R,x,g){var _=this;return(0,F.Z)(function*(){if(x<w._known.length-1){const C=_._maxQueryRate();if("GETPAGES"===w._known[x+1])return yield(0,Q.X)(_._parent._expandPagedSet(w,C,0,0,g)),_.getIdColumnDictionary(w,R,x,g);let d=x+1;const D=[];for(;d<w._known.length&&"GETPAGES"!==w._known[d];)D.push(w._known[d]),d++;x+=D.length;const m=yield(0,Q.X)(_._parent._getFeatureBatch(D,g));_._checkCancelled(g);for(const f of m)R.push({id:f.attributes[_.objectIdField],feature:f});return _.getIdColumnDictionary(w,R,x,g)}return w._candidates.length>0?(yield(0,Q.X)(_._refineSetBlock(w,_._maxProcessingRate(),g)),_._checkCancelled(g),_.getIdColumnDictionary(w,R,x,g)):R})()}_isInFeatureSet(w){return this._parent._isInFeatureSet(w)}_getFeatures(w,R,x,g){return this._parent._getFeatures(w,R,x,g)}_featureFromCache(w){if(void 0===this._featureCache[w]){const R=this._parent._featureFromCache(w);return void 0===R?void 0:null===R?null:(this._featureCache[w]=R,R)}return this._featureCache[w]}_fetchAndRefineFeatures(){return(0,F.Z)(function*(){throw new Error("Fetch and Refine should not be called in this featureset")})()}_getFilteredSet(w,R,x,g,_){var C=this;return(0,F.Z)(function*(){yield C._ensureLoaded();const d=yield C._parent._getFilteredSet(w,R,x,null===g?C._orderbyclause:g,_);C._checkCancelled(_);const D=new E.Z(d._candidates.slice(0),d._known.slice(0),d._ordered,C._clonePageDefinition(d.pagesDefinition));let m=!0;if(d._candidates.length>0&&(m=!1),!1===D._ordered){let f=yield C.manualOrderSet(D,_);return!1===m&&(null===R&&null===x||(f=new E.Z(f._candidates.slice(0).concat(f._known.slice(0)),[],f._ordered,C._clonePageDefinition(f.pagesDefinition)))),f}return D})()}static registerAction(){G.Z._featuresetFunctions.orderBy=function(w){return""===w?this:new N({parentfeatureset:this,orderbyclause:new P.Z(w)})}}}},79429:(te,H,y)=>{y.d(H,{Z:()=>P});var F=y(15861),Q=y(49086),G=y(91510),E=y(77132);class P extends Q.Z{constructor(S){super(S),this._topnum=0,this.declaredClass="esri.arcade.featureset.actions.Top",this._countedin=0,this._maxProcessing=100,this._topnum=S.topnum,this._parent=S.parentfeatureset}_getSet(S){var w=this;return(0,F.Z)(function*(){if(null===w._wset){yield w._ensureLoaded();const R=yield w._parent._getSet(S);return w._wset=new G.Z(R._candidates.slice(0),R._known.slice(0),!1,w._clonePageDefinition(R.pagesDefinition)),w._setKnownLength(w._wset)>w._topnum&&(w._wset._known=w._wset._known.slice(0,w._topnum)),w._setKnownLength(w._wset)>=w._topnum&&(w._wset._candidates=[]),w._wset}return w._wset})()}_setKnownLength(S){return S._known.length>0&&"GETPAGES"===S._known[S._known.length-1]?S._known.length-1:S._known.length}_isInFeatureSet(S){const w=this._parent._isInFeatureSet(S);if(w===E.dj.NotInFeatureSet)return w;const R=this._idstates[S];return R===E.dj.InFeatureSet||R===E.dj.NotInFeatureSet?R:w===E.dj.InFeatureSet&&void 0===R?this._countedin<this._topnum?(this._idstates[S]=E.dj.InFeatureSet,this._countedin++,E.dj.InFeatureSet):(this._idstates[S]=E.dj.NotInFeatureSet,E.dj.NotInFeatureSet):E.dj.Unknown}_expandPagedSet(S,w,R,x,g){var _=this;return(0,F.Z)(function*(){if(null===_._parent)throw new Error("Parent Paging not implemented");if(w>_._topnum&&(w=_._topnum),_._countedin>=_._topnum&&S.pagesDefinition.internal.set.length<=S.pagesDefinition.resultOffset){let d=S._known.length;return d>0&&"GETPAGES"===S._known[d-1]&&(S._known.length=d-1),d=S._candidates.length,d>0&&"GETPAGES"===S._candidates[d-1]&&(S._candidates.length=d-1),"success"}const C=yield _._parent._expandPagedSet(S,w,R,x,g);return _._setKnownLength(S)>_._topnum&&(S._known.length=_._topnum),_._setKnownLength(S)>=_._topnum&&(S._candidates.length=0),C})()}_getFeatures(S,w,R,x){var g=this;return(0,F.Z)(function*(){const _=[],C=g._maxQueryRate();if(!0===g._checkIfNeedToExpandKnownPage(S,C))return yield g._expandPagedSet(S,C,0,0,x),g._getFeatures(S,w,R,x);-1!==w&&void 0===g._featureCache[w]&&_.push(w);let d=0;for(let f=S._lastFetchedIndex;f<S._known.length&&(d++,d<=R&&(S._lastFetchedIndex+=1),!(void 0===g._featureCache[S._known[f]]&&(S._known[f]!==w&&_.push(S._known[f]),_.length>C)));f++);if(0===_.length)return"success";const D=new G.Z([],_,!1,null),m=Math.min(_.length,R);yield g._parent._getFeatures(D,-1,m,x);for(let f=0;f<m;f++){const l=g._parent._featureFromCache(_[f]);void 0!==l&&(g._featureCache[_[f]]=l)}return"success"})()}_getFilteredSet(S,w,R,x,g){var _=this;return(0,F.Z)(function*(){yield _._ensureLoaded();const C=yield _._getSet(g);return new G.Z(C._candidates.slice(0).concat(C._known.slice(0)),[],!1,_._clonePageDefinition(C.pagesDefinition))})()}_refineKnowns(S,w){let R=0,x=null;const g=[];for(let _=0;_<S._candidates.length;_++){const C=this._isInFeatureSet(S._candidates[_]);if(C===E.dj.InFeatureSet){if(S._known.push(S._candidates[_]),R+=1,null===x?x={start:_,end:_}:x.end===_-1?x.end=_:(g.push(x),x={start:_,end:_}),S._known.length>=this._topnum)break}else if(C===E.dj.NotInFeatureSet)null===x?x={start:_,end:_}:x.end===_-1?x.end=_:(g.push(x),x={start:_,end:_}),R+=1;else if(C===E.dj.Unknown)break;if(R>=w)break}null!==x&&g.push(x);for(let _=g.length-1;_>=0;_--)S._candidates.splice(g[_].start,g[_].end-g[_].start+1);this._setKnownLength(S)>this._topnum&&(S._known=S._known.slice(0,this._topnum)),this._setKnownLength(S)>=this._topnum&&(S._candidates=[])}_stat(){return(0,F.Z)(function*(){return{calculated:!1}})()}_canDoAggregates(){return(0,F.Z)(function*(){return!1})()}static registerAction(){Q.Z._featuresetFunctions.top=function(S){return new P({parentfeatureset:this,topnum:S})}}}},16776:(te,H,y)=>{y.d(H,{Z:()=>_});var F=y(15861),Q=y(88879),G=y(49086),E=y(91510),P=y(77132),N=y(83947),S=y(21674),w=y(32258),R=y(41638),x=y(36255),g=y(84952);class _ extends G.Z{constructor(d){super(d),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerMemory",this._removeGeometry=!1,this._overrideFields=null,this._forceIsTable=!1,d.spatialReference&&(this.spatialReference=d.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=d.layer,this._wset=null,!0===d.isTable&&(this._forceIsTable=!0),void 0!==d.outFields&&(this._overrideFields=d.outFields),void 0!==d.includeGeometry&&(this._removeGeometry=!1===d.includeGeometry)}_maxQueryRate(){return P.tI}end(){return this._layer}optimisePagingFeatureQueries(){}loadImpl(){var d=this;return(0,F.Z)(function*(){return!0===d._layer.loaded?(d._initialiseFeatureSet(),d):(yield d._layer.load(),d._initialiseFeatureSet(),d)})()}get gdbVersion(){return""}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),this._layer.outFields&&(1!==this._layer.outFields.length||"*"!==this._layer.outFields[0])){const d=[];for(const D of this.fields)if("oid"===D.type)d.push(D);else for(const m of this._layer.outFields)if(m.toLowerCase()===D.name.toLowerCase()){d.push(D);break}this.fields=d}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const d=[],D=[];for(const m of this.fields)if("oid"===m.type)d.push(m),D.push(m.name);else for(const f of this._overrideFields)if(f.toLowerCase()===m.name.toLowerCase()){d.push(m),D.push(m.name);break}this.fields=d,this._overrideFields=D}this.objectIdField=this._layer.objectIdField;for(const d of this.fields)"global-id"===d.type&&(this.globalIdField=d.name);this.hasM=this._layer.supportsM,this.hasZ=this._layer.supportsZ,this._databaseType=P.Bj.Standardised,this.typeIdField=this._layer.typeIdField,this.types=this._layer.types}isTable(){return this._forceIsTable||this._layer.isTable||"table"===this._layer.type||!this._layer.geometryType}_isInFeatureSet(){return P.dj.InFeatureSet}_candidateIdTransform(d){return d}_getSet(d){var D=this;return(0,F.Z)(function*(){if(null===D._wset){yield D._ensureLoaded();const m=yield D._getFilteredSet("",null,null,null,d);return D._wset=m,m}return D._wset})()}_changeFeature(d){const D={};for(const m of this.fields)D[m.name]=d.attributes[m.name];return new Q.Z({geometry:!0===this._removeGeometry?null:d.geometry,attributes:D})}_getFilteredSet(d,D,m,f,l){var h=this;return(0,F.Z)(function*(){let v="",b=!1;if(null!==f&&(v=f.constructClause(),b=!0),h.isTable()&&D&&null!==d&&""!==d)return new E.Z([],[],!0,null);const I=new g.Z;I.where=null===m?null===D?"1=1":"":(0,N.zR)(m,P.Bj.Standardised),I.spatialRelationship=h._makeRelationshipEnum(d),I.outSpatialReference=h.spatialReference,I.orderByFields=""!==v?v.split(","):null,I.geometry=null===D?null:D,I.returnGeometry=!0,I.relationParameter=h._makeRelationshipParam(d);const k=yield h._layer.queryFeatures(I);if(null===k)return new E.Z([],[],b,null);h._checkCancelled(l);const M=[];return k.features.forEach(U=>{const O=U.attributes[h._layer.objectIdField];M.push(O),h._featureCache[O]=h._changeFeature(U)}),new E.Z([],M,b,null)})()}_makeRelationshipEnum(d){if(d.includes("esriSpatialRelRelation"))return"relation";switch(d){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return d}_makeRelationshipParam(d){return d.includes("esriSpatialRelRelation")?d.split(":")[1]:""}_queryAllFeatures(){var d=this;return(0,F.Z)(function*(){if(d._wset)return d._wset;const D=new g.Z;if(D.where="1=1",yield d._ensureLoaded(),d._layer.source&&d._layer.source.items){const l=[];return d._layer.source.items.forEach(h=>{const v=h.attributes[d._layer.objectIdField];l.push(v),d._featureCache[v]=d._changeFeature(h)}),d._wset=new E.Z([],l,!1,null),d._wset}const m=yield d._layer.queryFeatures(D),f=[];return m.features.forEach(l=>{const h=l.attributes[d._layer.objectIdField];f.push(h),d._featureCache[h]=d._changeFeature(l)}),d._wset=new E.Z([],f,!1,null),d._wset})()}_getFeatures(d,D,m){var f=this;return(0,F.Z)(function*(){const l=[];-1!==D&&void 0===f._featureCache[D]&&l.push(D);for(let h=d._lastFetchedIndex;h<d._known.length&&(d._lastFetchedIndex+=1,!(void 0===f._featureCache[d._known[h]]&&(d._known[h]!==D&&l.push(d._known[h]),l.length>m)));h++);if(0===l.length)return"success";throw new Error("Unaccounted for Features. Not in Feature Collection")})()}_refineSetBlock(d){return(0,F.Z)(function*(){return d})()}_stat(){return(0,F.Z)(function*(){return{calculated:!1}})()}_canDoAggregates(){return(0,F.Z)(function*(){return!1})()}relationshipMetaData(){return[]}static _cloneAttr(d){const D={};for(const m in d)D[m]=d[m];return D}nativeCapabilities(){return{title:this._layer.title,canQueryRelated:!1,source:this,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:!0}}static create(d,D){let m=d.layerDefinition.objectIdField;const f=d.layerDefinition.typeIdField?d.layerDefinition.typeIdField:"",l=[];if(d.layerDefinition.types)for(const O of d.layerDefinition.types)l.push(R.Z.fromJSON(O));let h=d.layerDefinition.geometryType;void 0===h&&(h=d.featureSet.geometryType||"");let v=d.featureSet.features;const b=D.toJSON();if(""===m||void 0===m){let O=!1;for(const T of d.layerDefinition.fields)if("oid"===T.type||"esriFieldTypeOID"===T.type){m=T.name,O=!0;break}if(!1===O){let T="FID",B=!0,L=0;for(;B;){let V=!0;for(const $ of d.layerDefinition.fields)if($.name===T){V=!1;break}!0===V?B=!1:(L++,T="FID"+L.toString())}d.layerDefinition.fields.push({type:"esriFieldTypeOID",name:T,alias:T});const J=[];for(let V=0;V<v.length;V++)J.push({geometry:d.featureSet.features[V].geometry,attributes:d.featureSet.features[V].attributes?this._cloneAttr(d.featureSet.features[V].attributes):{}}),J[V].attributes[T]=V;v=J,m=T}}const I=[];for(const O of d.layerDefinition.fields)I.push(O instanceof x.Z?O:x.Z.fromJSON(O));let k=h;switch(k){case"esriGeometryPoint":k="point";break;case"esriGeometryPolyline":k="polyline";break;case"esriGeometryPolygon":k="polygon";break;case"esriGeometryExtent":k="extent";break;case"esriGeometryMultipoint":k="multipoint"}for(const O of v)O.geometry&&!(O.geometry instanceof S.Z)&&(O.geometry.type=k,void 0===O.geometry.spatialReference&&(O.geometry.spatialReference=b));const M={outFields:["*"],source:v,fields:I,types:l,typeIdField:f,objectIdField:m,spatialReference:D};M.geometryType=k||"point";const U=new w.default(M);return new _({layer:U,spatialReference:D,isTable:null===k||""===k})}queryAttachments(){return(0,F.Z)(function*(){return[]})()}getFeatureByObjectId(d){var D=this;return(0,F.Z)(function*(){const m=new g.Z;m.where=D.objectIdField+"="+d.toString();const f=yield D._layer.queryFeatures(m);return 1===f.features.length?f.features[0]:null})()}getOwningSystemUrl(){return(0,F.Z)(function*(){return""})()}getIdentityUser(){return(0,F.Z)(function*(){return""})()}}},57366:(te,H,y)=>{function F(G,E){return G===E?0:null===G?-1:null===E?1:G<E?-1:1}y.d(H,{Z:()=>Q});class Q{constructor(E){const P=E.split(",");this._fields=[],this._directions=[];for(let N=0;N<P.length;N++){const S=P[N].match(/\S+/g);this._fields.push(S[0]),2===S.length?"asc"===S[1].toLowerCase()?this._directions.push(1):this._directions.push(0):this._directions.push(1)}}constructClause(){let E="";for(let P=0;P<this._fields.length;P++)0!==P&&(E+=","),E+=this._fields[P],E+=1===this._directions[P]?" ASC":" DESC";return E}order(E){E.sort((P,N)=>{for(let S=0;S<this._fields.length;S++){const w=this.featureValue(P.feature,this._fields[S],S),R=this.featureValue(N.feature,this._fields[S],S);let x=0;if(x=1===this._directions[S]?F(w,R):-1*F(w,R),0!==x)return x}return 0})}scanForField(E){for(let P=0;P<this._fields.length;P++)if(this._fields[P].toLowerCase().trim()===E.toLowerCase().trim())return!0;return!1}replaceFields(E){let P="";for(let N=0;N<this._fields.length;N++){0!==N&&(P+=",");let S=this._fields[N];for(const w of E)if(S.toLowerCase()===w.field.toLowerCase()){S=w.newfield;break}P+=S,P+=1===this._directions[N]?" ASC":" DESC"}return new Q(P)}featureValue(E,P,N){const S=E.attributes[P];if(void 0!==S)return S;for(const w in E.attributes)if(P.toLowerCase()===w.toLowerCase())return this._fields[N]=w,E.attributes[w];return null}}},90463:(te,H,y)=>{y.d(H,{P:()=>P});var F=y(15861),Q=y(2618),G=y(20477),E=y(84952);function P(S,w,R){return N.apply(this,arguments)}function N(){return(N=(0,F.Z)(function*(S,w,R){const x=(0,Q.en)(S);return(0,G.executeQueryForCount)(x,E.Z.from(w),{...R}).then(g=>g.data.count)})).apply(this,arguments)}},24865:(te,H,y)=>{y.d(H,{G:()=>P});var F=y(15861),Q=y(2618),G=y(20477),E=y(84952);function P(S,w,R){return N.apply(this,arguments)}function N(){return(N=(0,F.Z)(function*(S,w,R){const x=(0,Q.en)(S);return(0,G.executeQueryForIds)(x,E.Z.from(w),{...R}).then(g=>g.data.objectIds)})).apply(this,arguments)}}}]);