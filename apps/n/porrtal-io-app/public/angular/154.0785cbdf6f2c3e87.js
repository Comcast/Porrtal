"use strict";(self.webpackChunka_porrtal_io_app=self.webpackChunka_porrtal_io_app||[]).push([[154],{1956:(me,Z,r)=>{r.d(Z,{P:()=>ye,a:()=>Pe,b:()=>be,c:()=>Ie,g:()=>he});var g=r(21286),c=r(28347),j=r(43703),K=r(67831),F=r(99770),u=r(84161),b=r(28093),v=r(5548),M=r(52382),w=r(13934),H=r(78925),E=r(62952),P=r(19278),C=r(32181),S=r(95285),h=r(77739),A=r(17625),k=r(47205),z=r(63123),ve=r(22355),re=r(16396);class ye extends A.K{constructor(){super(...arguments),this.clipBox=(0,v.Ue)(v.bd),this.useFixedSizes=!1,this.useRealWorldSymbolSizes=!1,this.scaleFactor=1,this.minSizePx=0,this.size=0,this.sizePx=0}get fixedSize(){return this.drawScreenSpace?this.sizePx:this.size}get screenMinSize(){return this.useFixedSizes?0:this.minSizePx}get drawScreenSpace(){return this.useFixedSizes&&!this.useRealWorldSymbolSizes}}class Pe extends H.UT{constructor(L,oe,ie){super(L),this.origin=L,this.isLeaf=oe,this.splatSize=ie}}function Ie(U){const L=new ve.kG,oe=U.output===w.H.Color,ie=U.output===w.H.Depth,Ce=U.output===w.H.Highlight,{vertex:$,fragment:xe}=L;return L.extensions.add("GL_OES_standard_derivatives"),L.include(H.f5,U),L.attributes.add(re.T.POSITION,"vec3"),L.attributes.add(re.T.COLOR,"vec3"),$.uniforms.add([new k.K("modelView",(O,x)=>(0,c.m)(Me,x.camera.viewMatrix,(0,c.f)(Me,O.origin))),new z.g("proj",(O,x)=>x.camera.projectionMatrix),new C.q("screenMinMaxSize",(O,x,W)=>(0,K.s)(Se,W.useFixedSizes?0:W.minSizePx*x.camera.pixelRatio,he(O.isLeaf)*x.camera.pixelRatio))]),$.uniforms.add(U.useFixedSizes?new S.A("pointScale",(O,x)=>(0,K.s)(Se,O.fixedSize*x.camera.pixelRatio,x.camera.fullHeight)):new C.q("pointScale",(O,x,W)=>(0,K.s)(Se,O.splatSize*W.scaleFactor*x.camera.pixelRatio,x.camera.fullHeight/x.camera.pixelRatio))),U.clippingEnabled?$.uniforms.add([new h.B("clipMin",(O,x,W)=>(0,u.s)(Oe,W.clipBox[0]-O.origin[0],W.clipBox[1]-O.origin[1],W.clipBox[2]-O.origin[2])),new h.B("clipMax",(O,x,W)=>(0,u.s)(Oe,W.clipBox[3]-O.origin[0],W.clipBox[4]-O.origin[1],W.clipBox[5]-O.origin[2]))]):($.constants.add("clipMin","vec3",[-g._3,-g._3,-g._3]),$.constants.add("clipMax","vec3",[g._3,g._3,g._3])),ie?((0,M.Zu)(L),(0,M.bA)(L),L.varyings.add("depth","float")):U.output!==w.H.Highlight&&L.varyings.add("vColor","vec3"),$.code.add(A.H`
    void main(void) {
      // Move clipped points outside of clipspace
      if (position.x < clipMin.x || position.y < clipMin.y || position.z < clipMin.z ||
        position.x > clipMax.x || position.y > clipMax.y || position.z > clipMax.z) {
        gl_Position = vec4(0.0,0.0,0.0,2.0);
        gl_PointSize = 0.0;
        return;
      }

      if (rejectBySlice(position)) {
        gl_Position = vec4(0.0,0.0,0.0,2.0);
        gl_PointSize = 0.0;
        return;
      }

      // Position in camera space
      vec4 camera = modelView * vec4(position, 1.0);

      float pointSize = pointScale.x;
      vec4 position = proj * camera;
     ${U.drawScreenSize?A.H`
      float clampedScreenSize = pointSize;`:A.H`
      float pointRadius = 0.5 * pointSize;
      vec4 cameraOffset = camera + vec4(0.0, pointRadius, 0.0, 0.0);
      vec4 positionOffset = proj * cameraOffset;
      float radius = abs(positionOffset.y - position.y);
      float viewHeight = pointScale.y;
      // screen diameter = (2 * r / w) * (h / 2)
      float screenPointSize = (radius / position.w) * viewHeight;
      float clampedScreenSize = clamp(screenPointSize, screenMinMaxSize.x, screenMinMaxSize.y);
      // Shift towards camera, to move rendered point out of terrain i.e. to
      // the camera-facing end of the virtual point when considering it as a
      // 3D sphere.
      camera.xyz -= normalize(camera.xyz) * pointRadius * clampedScreenSize / screenPointSize;
      position = proj * camera;`}

     gl_PointSize = clampedScreenSize;
     gl_Position = position;

     ${ie?A.H`depth = calculateLinearDepth(nearFar, camera.z);`:""}
     ${oe?A.H`vColor = color;`:""}
    }
  `),xe.include(P.n,U),Ce&&L.include(E.bA,U),xe.code.add(A.H`
    void main(void) {
      vec2 vOffset = gl_PointCoord - vec2(0.5, 0.5);
      float r2 = dot(vOffset, vOffset);

      if (r2 > 0.25) {
        discard;
      }
      ${ie?A.H`gl_FragColor = float2rgba(depth);`:""}
      ${Ce?A.H`outputHighlight();`:""}
      ${oe?A.H`gl_FragColor = vec4(vColor, 1.0);`:""}
    }
  `),L}function he(U){return U?256:64}const Me=(0,j.c)(),Oe=(0,b.c)(),Se=(0,F.a)(),be=Object.freeze(Object.defineProperty({__proto__:null,PointRendererPassParameters:ye,PointRendererDrawParameters:Pe,build:Ie,getMaxPointSizeScreenspace:he},Symbol.toStringTag,{value:"Module"}))},19702:(me,Z,r)=>{r.d(Z,{A:()=>H});var g=r(15861),c=r(17626),j=r(54024),K=r(10699),F=r(32917),u=r(77712),M=(r(85931),r(90912),r(76898)),w=r(36947);const H=E=>{let P=class extends E{constructor(){super(...arguments),this.slicePlaneEnabled=!1,this.supportsHeightUnitConversion=!1}postscript(C){super.postscript(C),(0,w.qC)(this.layer)&&this.addResolvingPromise(this._validateHeightModelInfo())}_validateHeightModelInfo(){var C=this;return(0,g.Z)(function*(){const S=new AbortController,h=S.signal;C.handles.add((0,j.kB)(()=>S.abort())),yield(0,F.N1)(()=>C.view.defaultsFromMap?.heightModelInfoReady,h),(0,K.k_)(h);const A=(0,w.Wt)(C.layer,C.view.heightModelInfo,C.supportsHeightUnitConversion);if(A)throw A})()}canResume(){const C=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;return super.canResume()&&(!C||!C.minScale||!C.maxScale||C.minScale>=C.maxScale)}getSuspendInfo(){const C=super.getSuspendInfo(),S=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;return S&&S.minScale&&S.maxScale&&S.minScale<S.maxScale&&(C.outsideScaleRange=!0),C}};return(0,c._)([(0,u.Cb)()],P.prototype,"view",void 0),(0,c._)([(0,u.Cb)()],P.prototype,"slicePlaneEnabled",void 0),P=(0,c._)([(0,M.j)("esri.views.3d.layers.LayerView3D")],P),P}},61525:(me,Z,r)=>{r.r(Z),r.d(Z,{default:()=>jt});var g=r(15861),c=r(17626),j=r(59213),K=r(46160),F=r(63290),u=r(62208),b=r(10699),v=r(32917),M=r(23841),w=r(55713),H=r(16730),E=r(77712),S=(r(85931),r(90912),r(76898)),h=r(84161),A=r(14658),k=r(55915),z=r(5548),ve=r(65401),re=r(90014),ye=r(38114),Pe=r(86219),he=(r(8314),r(26036)),be=(r(50028),r(90336),r(68155),r(36630)),U=r(41291),L=r(29505),oe=r(19702),ie=r(42930);class Ce extends ie.q{constructor(e){super("PointCloudWorker","transform",{transform:i=>this._getTransferList(i)},e)}_getTransferList(e){const i=[e.geometryBuffer];if((0,u.pC)(e.primaryAttributeData)&&e.primaryAttributeData.buffer&&i.push(e.primaryAttributeData.buffer),(0,u.pC)(e.modulationAttributeData)&&e.modulationAttributeData.buffer&&i.push(e.modulationAttributeData.buffer),(0,u.pC)(e.filterAttributesData))for(const s of e.filterAttributesData)(0,u.pC)(s)&&s.buffer&&i.push(s.buffer);for(const s of e.userAttributesData)s.buffer&&i.push(s.buffer);return i}}var $=r(42964);const O=[!1],x=[null],W=[!1],X=[null];function Ve(t,e,i){let s=t;for(;s>0;){const n=e.indexOf(s);if(n>=0)return n;s=i.getParentId(s)}return e.indexOf(s)}function ot(t,e,i){const s=[e.remove[0]],n=[];for(;1===s.length;){const o=s.pop();n.length=0;for(let a=0;a<e.load.length;a++){let l=e.load[a],d=i.getParentId(l);for(;d!==o;)l=d,d=i.getParentId(l);let p=s.indexOf(l);p<0&&(p=s.length,s.push(l),n.push([])),n[p].push(e.load[a])}}e.load=s;for(let o=0;o<s.length;o++)n[o].length>1?t.push({remove:[s[o]],load:n[o]}):s[o]=n[o][0]}var Y=r(93394);class at{constructor(e,i,s){this._pages=[],this.pageSize=0,this._nodeSR=null,this._renderSR=null,this._nodeSR=e,this._renderSR=i,this.pageSize=s}addPage(e,i,s=0){for(;this._pages.length<e;)this._pages.push(null);const n=function dt(t,e,i,s){const n=new Y.JF(t.length);for(let o=0;o<t.length;o++)(0,$.jv)(t[o].obb,e,n.obbs[o],i,s);return n.obbs}(i,this._nodeSR,this._renderSR,s);this._pages[e]={nodes:i,renderObbs:n,parents:new Uint32Array(this.pageSize)},function ht(t,e){const i=[0];for(;i.length;){const s=i.pop(),n=t[Q(s,e)].nodes[ae(s,e)];for(let o=0;o<n.childCount;o++){const a=n.firstChild+o;null!=t[Q(a,e)]&&(t[Q(a,e)].parents[ae(a,e)]=s,i.push(a))}}}(this._pages,this.pageSize)}hasPage(e){return!!this._pages[e]}getNode(e){const i=this.pageSize;return this._pages[Q(e,i)].nodes[ae(e,i)]}getRenderObb(e){const i=this.pageSize;return this._pages[Q(e,i)].renderObbs[ae(e,i)]}getRenderCenter(e){return this.getRenderObb(e).center}setRenderObb(e,i){const s=this.pageSize;(0,Y.t8)(i,this._pages[Q(e,s)].renderObbs[ae(e,s)])}getParentId(e){const i=this.pageSize;return this._pages[Q(e,i)].parents[ae(e,i)]}hasNodes(e,i){const s=Q(e,this.pageSize),n=Q(e+i-1,this.pageSize);for(let o=s;o<=n;o++)if(null==this._pages[o])return!1;return!0}forEachNodeId(e){for(let i=0;i<this._pages.length;i++){const s=this._pages[i];if(s)for(let n=0;n<s.nodes.length;n++)e(i*this.pageSize+n)}}createVisibilityTraverse(){const e={index:this,queue:[],masks:[],tempAabb:(0,z.Ue)()};return(i,s)=>function lt(t,e,i){const s=t.index;if(!s.hasNodes(0,1))return;const n=t.queue;n.length=0,n.push(0);const o=t.masks;for(o.length=0,o.push(0);n.length>0;){const a=n.pop();let l=o.pop();const d=s.getNode(a),p=s.getRenderObb(a);let f=!0;if(null!=e.clippingBox){const y=1<<e.frustum.length;if(0==(l&y)){const I=(0,Y.mr)(p,t.tempAabb);(0,z.r3)(e.clippingBox,I)?l|=y:(0,z.kK)(e.clippingBox,I)||(f=!1)}}for(let y=0;y<e.frustum.length&&f;y++){const I=1<<y;if(0==(l&I)){const m=(0,Y.hZ)(p,e.frustum[y]);m>0?f=!1:m<0&&(l|=I)}}if(i.predicate(a,d,f)){const y=d.firstChild,I=d.childCount;let m=!1;const R=Q(y,s.pageSize),V=Q(y+I-1,s.pageSize);for(let D=R;D<=V;D++)if(!s.hasPage(D)){i.pageMiss(a,D),m=!0;break}if(!m)for(let D=0;D<I;D++)n.push(y+D),o.push(l)}}}(e,i,s)}}function Q(t,e){return t/e|0}function ae(t,e){return t%e}function je(t){const e=t.renderer,i=e&&e.type,s=e&&t.renderer.toJSON()||null;let n=null,o=!1;"point-cloud-unique-value"===i||"point-cloud-stretch"===i||"point-cloud-class-breaks"===i?n=ue(t.attributeStorageInfo,e.field):"point-cloud-rgb"===i?(n=Ge(t.attributeStorageInfo,e.field),o=null!=n):(n=Ge(t.attributeStorageInfo,"RGB"),o=null!=n);let a=null;return e&&e.colorModulation&&(a=ue(t.attributeStorageInfo,e.colorModulation.field)),{rendererJSON:s,isRGBRenderer:o,primaryAttribute:n,modulationAttribute:a}}function Ke(t){const e=t.filters;return e?e.map(i=>({filterJSON:i.toJSON(),attributeInfo:ue(t.attributeStorageInfo,i.field)})):[]}function Qe(t){const e=t&&t.pointSizeAlgorithm;return e&&"fixed-size"===e.type?e:null}function Ge(t,e){for(const i of t)if(i.name===e&&null!=i.attributeValues&&"UInt8"===i.attributeValues.valueType&&3===i.attributeValues.valuesPerElement)return{name:e,storageInfo:i,useElevation:!1};return null}function ue(t,e){for(const i of t)if(i.name===e){const s="embedded-elevation"===i.encoding;return{name:e,storageInfo:s?null:i,useElevation:s}}return"elevation"===e.toLowerCase()?{name:e,storageInfo:null,useElevation:!0}:null}var Ae=r(14471),pt=r(88879);let ce=class extends pt.Z{constructor(t){super(t)}};(0,c._)([(0,E.Cb)({constructOnly:!0,clonable:"reference"})],ce.prototype,"pointCloudMetadata",void 0),ce=(0,c._)([(0,S.j)("esri.views.3d.layers.i3s.PointGraphic")],ce);var gt=r(77029),pe=r(28093),_t=r(993),ft=r(70562),mt=r(54024),vt=r(42743),yt=r(7167);class Pt{constructor(e){this._context=e,this._highlights=new Set}get hasHighlights(){return this._highlights.size>0}destroy(){this._highlights=null}add(e){const i=new St(e);return this._highlights.add(i),this._enableSet(i),(0,mt.kB)(()=>this._removeSet(i))}_removeSet(e){this._disableSet(e),this._highlights.delete(e)}_enableSet(e){e.enabled||(e.enabled=!0,this._context.forEachNode(i=>this._enableSetForNode(e,i)))}_enableSetForNode(e,i){if(!e.enabled)return;const s=e.ids.get(i.id);s&&s.forEach(n=>this._context.addHighlight(i,n,e.id))}_disableSet(e){e.enabled&&(e.enabled=!1,this._context.forEachNode(i=>this._disableSetForNode(e,i)))}_disableSetForNode(e,i){e.enabled||this._context.removeHighlight(i,e.id)}nodeAdded(e){this._highlights.forEach(i=>this._enableSetForNode(i,e))}nodeRemoved(e){this._highlights.forEach(i=>this._disableSetForNode(i,e))}removeAll(){this._highlights.forEach(e=>this._disableSet(e))}}class St{constructor(e){this.id=new yt.O(vt.V_.Highlight),this.ids=new Map,this.enabled=!1;for(const i of e)(0,u.pC)(i)&&this._add(i.nodeId,i.pointId)}_add(e,i){const s=this.ids.get(e);s?s.add(i):this.ids.set(e,new Set([i]))}}var G=r(13934),Ze=r(39114),bt=r(62483),ge=r(67857),Ct=r(15197),$e=r(16396),Ee=r(1956),xt=r(651),Et=r(91056),Rt=r(12407),Je=r(64127),q=r(67969),De=r(2078);class Re extends Et.A{constructor(e,i,s){super(e,i,s)}initializeProgram(e){return new Rt.$(e.rctx,Re.shader.get().build(this.configuration),Ze.i)}initializePipeline(){return(0,De.sm)({depthTest:{func:q.wb.LESS},depthWrite:De.LZ,colorWrite:De.BK,stencilWrite:this.configuration.hasOccludees?Je.s3:null,stencilTest:this.configuration.hasOccludees?Je.RY:null})}}Re.shader=new xt.J(Ee.b,()=>r.e(9298).then(r.bind(r,99298)));var se=r(87601),It=r(41528);class ee extends It.W{constructor(){super(...arguments),this.output=G.H.Color,this.hasSlicePlane=!1,this.drawScreenSize=!1,this.useFixedSizes=!1,this.hasOccludees=!1,this.clippingEnabled=!1}}(0,c._)([(0,se.o)({count:G.H.COUNT})],ee.prototype,"output",void 0),(0,c._)([(0,se.o)()],ee.prototype,"hasSlicePlane",void 0),(0,c._)([(0,se.o)()],ee.prototype,"drawScreenSize",void 0),(0,c._)([(0,se.o)()],ee.prototype,"useFixedSizes",void 0),(0,c._)([(0,se.o)()],ee.prototype,"hasOccludees",void 0),(0,c._)([(0,se.o)()],ee.prototype,"clippingEnabled",void 0),(0,c._)([(0,se.o)({constValue:!0})],ee.prototype,"hasSliceInVertexProgram",void 0);var Xe=r(83994),Ye=r(40852);const Mt={positions:[new Ye.G($e.T.POSITION,3,q.g.FLOAT,0,12)],colors:[new Ye.G($e.T.COLOR,3,q.g.UNSIGNED_BYTE,0,3,!0)]};class Ot{constructor(e){this._params=e,this.type=ge.q7.PCL,this.isGround=!1,this._passParameters=new Ee.P,this._highlights=new Pt({forEachNode:i=>this.forEachNode(i),addHighlight:(i,s,n)=>this._addHighlight(i,s,n),removeHighlight:(i,s)=>this._removeHighlight(i,s)}),this.canRender=!0,this.layerUid="",this._slicePlaneEnabled=!1,this._techniqueConfig=new ee,this._nodes=new gt.Z}get needsHighlight(){return this._highlights.hasHighlights}initializeRenderContext(e){this._context=e,this._techniqueRep=this._context.shaderTechniqueRepository,e.requestRender()}uninitializeRenderContext(){}intersect(e,i,s,n){const o=(0,pe.c)(),a=(0,pe.c)(),l=(0,pe.c)(),d=(0,pe.c)(),p=(0,re.Ue)(),f=e.camera.perScreenPixelRatio/2,y=e.camera.near;(0,h.b)(a,n,s);const I=1/(0,h.l)(a);(0,h.g)(a,a,I),(0,h.o)(l,a),(0,_t.s)(p,a[0],a[1],a[2],-(0,h.e)(a,s));const m=new Ue,R=new Ue,V=new Array,D=(0,z.Ue)(),le=(0,z.Ue)(this._passParameters.clipBox);(0,z.cv)(le,-s[0],-s[1],-s[2],le),this._nodes.forAll(_=>{const T=_.splatSize*this._passParameters.scaleFactor;let B=(0,Y.JH)(_.obb,p),te=(0,Y.n3)(_.obb,p);if(B-=ze(T,B+y,this._passParameters,f,_.isLeaf),te-=ze(T,te+y,this._passParameters,f,_.isLeaf),te<0||null!=m.dist&&null!=R.dist&&m.dist<B*I&&R.dist>te*I)return;const we=Ne(T,te+y,this._passParameters,f,_.isLeaf);if(!(0,Y.fn)(_.obb,s,a,we))return;const Zt=we*we;(0,Y.mr)(_.obb,D),(0,z.cv)(D,-s[0],-s[1],-s[2],D);const $t=!(0,z.r3)(le,D);(0,h.b)(d,_.origin,s);const Jt=_.coordinates.length/3;for(let ne=0;ne<Jt;ne++){if(o[0]=d[0]+_.coordinates[3*ne],o[1]=d[1]+_.coordinates[3*ne+1],o[2]=d[2]+_.coordinates[3*ne+2],$t&&!(0,z.BD)(le,o))continue;const fe=(0,h.e)(o,a),it=(0,h.p)(o)-fe*fe;if(it>Zt)continue;let Be=fe+y;const Fe=ze(T,Be,this._passParameters,f,_.isLeaf);if(fe-Fe<0)continue;Be-=Fe;const st=Ne(T,Be,this._passParameters,f,_.isLeaf);if(it>st*st)continue;const de=(fe-Fe)*I,He=J=>(J.point=Nt(_,ne,J.point),J.dist=de,J.normal=l,J.node=_,J.pointId=ne,J.layerUid=this.layerUid,J);if((null==m.dist||de<m.dist)&&(null==i||i(s,n,de))&&He(m),e.options.store!==ge.eC.MIN&&(null==R.dist||de>R.dist)&&(null==i||i(s,n,de))&&He(R),e.options.store===ge.eC.ALL&&(null==i||i(s,n,de))){const J=new Ue;V.push(He(J))}}});const Te=_=>{const{layerUid:T,node:B,pointId:te}=_;return{point:_.point,layerUid:T,graphicUid:te,createGraphic:()=>this._params.createGraphic(B,te,_.point)}},_e=(_,T)=>{const B=Te(T);_.set(this.type,B,T.dist,T.normal)};if(qe(m)){const _=e.results.min;(null==_.dist||m.dist<_.dist)&&_e(_,m)}if(qe(R)&&e.options.store!==ge.eC.MIN){const _=e.results.max;(null==_.dist||R.dist>_.dist)&&_e(_,R)}if(e.options.store===ge.eC.ALL){const _=(0,ft.zk)(s,n);for(const T of V){const B=(0,bt.LP)(_);_e(B,T),e.results.all.push(B)}}}prepareTechnique(e){return 0===this._nodes.length||e.output!==G.H.Color&&e.output!==G.H.Depth&&e.output!==G.H.Highlight?null:(this._nodes.forAll(i=>{null==i.vao&&this._initNode(e,i)}),this._techniqueConfig.drawScreenSize=this._passParameters.drawScreenSpace,this._techniqueConfig.useFixedSizes=this._passParameters.useFixedSizes,this._techniqueConfig.hasSlicePlane=this._slicePlaneEnabled,this._techniqueConfig.hasOccludees=e.bindParameters.hasOccludees,this._techniqueConfig.clippingEnabled=this._clippingEnabled,this._techniqueConfig.output=e.output===G.H.Depth?G.H.Depth:e.output===G.H.Highlight?G.H.Highlight:G.H.Color,this._techniqueRep.releaseAndAcquire(Re,this._techniqueConfig,this._technique))}render(e,i){const s=e.rctx,n=s.bindTechnique(i,this._passParameters,e.bindParameters),o=e.output===G.H.Highlight;this._nodes.forAll(a=>{0===a.coordinates.length||o&&!a.highlights||(n.bindDraw(a,e.bindParameters,this._passParameters),s.bindVAO(a.vao),o?this._renderHighlightFragments(s,a):s.drawArrays(q.MX.POINTS,0,a.coordinates.length/3))})}_renderHighlightFragments(e,i){const s=i.highlights;if((0,u.Wi)(s))return;let n=(0,u.Wg)(s[0].component),o=n+1;for(let l=1;l<s.length;l++){const d=(0,u.Wg)(s[l].component);if(d!==o){const p=o-n;p>0&&e.drawArrays(q.MX.POINTS,n,p),n=d}o=d+1}const a=o-n;a>0&&e.drawArrays(q.MX.POINTS,n,a)}set useFixedSizes(e){this._passParameters.useFixedSizes!==e&&(this._passParameters.useFixedSizes=e,this._requestRender())}get useFixedSizes(){return this._passParameters.useFixedSizes}set scaleFactor(e){this._passParameters.scaleFactor!==e&&(this._passParameters.scaleFactor=e,this._requestRender())}get scaleFactor(){return this._passParameters.scaleFactor}set minSizePx(e){this._passParameters.minSizePx!==e&&(this._passParameters.minSizePx=e,this._requestRender())}get minSizePx(){return this._passParameters.minSizePx}set useRealWorldSymbolSizes(e){this._passParameters.useRealWorldSymbolSizes!==e&&(this._passParameters.useRealWorldSymbolSizes=e,this._requestRender())}get useRealWorldSymbolSizes(){return this._passParameters.useRealWorldSymbolSizes}set size(e){this._passParameters.size!==e&&(this._passParameters.size=e,this._requestRender())}get size(){return this._passParameters.size}set sizePx(e){this._passParameters.sizePx!==e&&(this._passParameters.sizePx=e,this._requestRender())}get sizePx(){return this._passParameters.sizePx}set clippingBox(e){(0,z.t8)(this._passParameters.clipBox,e||z.bd)}get _clippingEnabled(){return!(0,z.fS)(this._passParameters.clipBox,z.bd,(e,i)=>e===i)}get slicePlaneEnabled(){return this._slicePlaneEnabled}set slicePlaneEnabled(e){this._slicePlaneEnabled!==e&&(this._slicePlaneEnabled=e,this._requestRender())}addNode(e){this._nodes.push(e),this._highlights.nodeAdded(e),this._requestRender()}removeNode(e){let i=null;return this._nodes.filterInPlace(s=>s.id!==e||(i=s,s.vao=(0,u.M2)(s.vao),this._highlights.nodeRemoved(s),!1)),this._requestRender(),i}forEachNode(e){this._nodes.forAll(e)}removeAll(){this._nodes.forAll(e=>e.vao=(0,u.M2)(e.vao)),this._highlights.removeAll(),this._nodes.clear(),this._requestRender()}highlight(e){return this._highlights.add(e)}_addHighlight(e,i,s){e.highlights=function zt(t,e,i){(0,u.Wi)(t)&&(t=[]);const s={component:e,id:i};t.push(s);const n=ke(s);let o=t.length-1;for(;o>0&&n<ke(t[o-1]);)[t[o-1],t[o]]=[t[o],t[o-1]],--o;return t}(e.highlights,i,s),this._requestRender()}_removeHighlight(e,i){e.highlights=function Ut(t,e){if((0,u.Wi)(t))return t;const i=t.filter(s=>s.id!==e);return 0===i.length?null:i}(e.highlights,i),this._requestRender()}_initNode(e,i){const s=e.rctx;i.vao=new Ct.U(s,Ze.i,Mt,{positions:Xe.f.createVertex(s,q.l1.STATIC_DRAW,i.coordinates),colors:Xe.f.createVertex(s,q.l1.STATIC_DRAW,i.rgb)})}_requestRender(){this._context&&this._context.requestRender()}}class At extends Ee.a{constructor(e,i,s,n,o,a,l,d,p=null,f=null){super(s,o,i),this.id=e,this.obb=n,this.coordinates=a,this.rgb=l,this.attributes=d,this.pointIdFilterMap=p,this.highlights=f}}function Ne(t,e,i,s,n){if(i.drawScreenSpace)return i.fixedSize*e*s;const o=(0,Ee.g)(n)*e*s;return i.useFixedSizes?Math.min(i.fixedSize/2,o):i.screenMinSize>0?Math.min(Math.max(i.screenMinSize*e*s,t/2),o):Math.min(t/2,o)}function ze(t,e,i,s,n){return i.drawScreenSpace?0:Ne(t,e,i,s,n)}function Nt(t,e,i){return(0,u.Wi)(i)&&(i=(0,pe.c)()),i[0]=t.origin[0]+t.coordinates[3*e],i[1]=t.origin[1]+t.coordinates[3*e+1],i[2]=t.origin[2]+t.coordinates[3*e+2],i}function ke(t){return(0,u.pC)(t.component)?t.component:-1}class Ue{constructor(){this.node=null,this.pointId=null,this.point=null,this.dist=null,this.normal=null,this.layerUid=""}}function qe(t){return(0,u.pC)(t.dist)&&(0,u.pC)(t.point)&&(0,u.pC)(t.pointId)&&(0,u.pC)(t.node)}var Lt=r(40465),Wt=r(55745),et=r(39135),Tt=r(41632),wt=r(5894),Bt=r(45611),Le=r(93579),Ft=r(87091);const Vt=(0,re.Ue)();let N=class extends((0,Lt.i)((0,oe.A)(Bt.Z))){constructor(){super(...arguments),this.type="point-cloud-3d",this.maximumPointCount=4e6,this.slicePlaneEnabled=!1,this._renderer=null,this._rendererAdded=!1,this._renderedNodes=new Set,this._nodeScales=new Map,this._updateViewNeeded=!0,this._lodFactor=1,this._maxLoggedBoxWarnings=5,this._pageMultiplier=1,this._nodeLoadEpoch=0,this._indexQueue=[],this._workQueue=new Array,this._idleQueue=new U.b,this._indexPagesLoading=new Map,this._loadingNodes=new Map,this._recalcWork=!0,this._layerIsVisible=!1,this._codedDomainPopulationPromise=null,this._codedDomainPopulationAbortController=null,this._totalWork=0,this._index=null,this._loadingInitNodePage=!1,this._nodeIdArray=[]}get baseUrl(){return this.layer.parsedUrl.path}get pointScale(){const t=function ut(t){const e=t&&t.pointSizeAlgorithm;return e&&"splat"===e.type?e:null}(this.layer&&this.layer.renderer);return t&&null!=t.scaleFactor?t.scaleFactor:1}get useRealWorldSymbolSizes(){const t=Qe(this.layer&&this.layer.renderer);return!(!t||null==t.useRealWorldSymbolSizes)&&t.useRealWorldSymbolSizes}get pointSize(){const t=Qe(this.layer&&this.layer.renderer);return t&&null!=t.size?t.size:0}get inverseDensity(){return this.layer&&this.layer.renderer?96/this.layer.renderer.pointsPerInch:5}get availableFields(){const t=je(this.layer),e=new Set;t.primaryAttribute&&e.add(t.primaryAttribute.name),t.modulationAttribute&&e.add(t.primaryAttribute.name);const i=Ke(this.layer);if(i)for(const s of i)e.add(s.attributeInfo.name);if(this.layer.outFields)for(const s of(0,be.Lk)(this.layer.fieldsIndex,this.layer.outFields))e.add(s);return Array.from(e)}get _clippingBox(){if(!this.view||!this.view.clippingArea)return null;const t=(0,z.Ue)();return(0,Wt.O)(this.view.clippingArea,t,this.view.renderSpatialReference)?t:null}get _elevationOffset(){const t=this.layer&&this.layer.elevationInfo;if(t&&"absolute-height"===t.mode){const e=(0,H._R)(this.layer.spatialReference),i=(0,L.Z7)(t.unit);return(0,u.Pt)(t.offset,0)*i/e}return 0}initialize(){const t=this.view.resourceController;this._worker=new Ce(s=>t.schedule(s)),this.addResolvingPromise(this._worker.promise),this._tmpPoint=(0,ye.Tx)(0,0,0,this.layer.spatialReference),(0,$.zW)(this.layer),(0,$.yS)(this.layer,this.view),this._indexRequester=t.createStreamDataRequester(et.Bh.I3S_INDEX),this._dataRequester=t.createStreamDataRequester(et.Bh.I3S_DATA),this._initRenderer();const e=this._initNodePages(),i=this.view.resourceController.memoryController;this._memCache=i.newCache(this.layer.uid),this.updatingHandles.add(()=>this._clippingBox,()=>this._setUpdateViewNeeded(),v.nn),this.updatingHandles.add(()=>this._elevationOffset,()=>this._elevationOffsetChanged(),v.nn),this.updatingHandles.add(()=>this.layer.renderer,()=>this._rendererChanged(),v.nn),this.updatingHandles.add(()=>this.layer.filters,()=>this._reload(),v.nn),this.updatingHandles.add(()=>this.layer.outFields,()=>this._reload(),v.nn),this.updatingHandles.add(()=>this.layer.effectiveScaleRange,()=>this._setUpdateViewNeeded()),this.updatingHandles.add(()=>this.view.state.contentCamera,()=>this._setUpdateViewNeeded()),this.handles.add([this.view.basemapTerrain.on("scale-change",s=>this._scaleUpdateHandler(s)),(0,v.YP)(()=>i.memoryFactor,()=>this._setUpdateViewNeeded(),v.Z_)]),this.addResolvingPromise(e),this.when(()=>{this.handles.add([t.scheduler.registerTask(Ft.T8.POINT_CLOUD_LAYER,this),t.scheduler.registerIdleStateCallbacks(()=>this._idleBegin(),()=>this._idleEnd()),this.updatingHandles.add(()=>this.suspended,s=>{s?this._clearNodeState():this._setUpdateViewNeeded()},v.nn)])},()=>{this.updatingHandles.removeAll(),this.handles.removeAll()})}_setUpdateViewNeeded(){this._updateViewNeeded=!0,this._updateLoading()}destroy(){this.cancelLoading(),this._worker&&(this._worker.destroy(),this._worker=null),this._destroyRenderer(),this._memCache.destroy(),this._memCache=null,this._codedDomainPopulationAbortController&&(this._codedDomainPopulationAbortController.abort(),this._codedDomainPopulationAbortController=null),this._codedDomainPopulationPromise=null}_initRenderer(){this._renderer=new Ot({createGraphic:(t,e,i)=>this._createGraphic(t,e,i)}),this._renderer.layerUid=this.layer.uid,this.updatingHandles.add(()=>this._clippingBox,t=>this._renderer.clippingBox=t,v.nn),this.updatingHandles.add(()=>this.suspended,t=>this._setPointsVisible(!t),v.nn),this.updatingHandles.add(()=>this.pointScale,t=>this._renderer.scaleFactor=t,v.nn),this._renderer.minSizePx=Math.sqrt(2),this.updatingHandles.add(()=>this.useRealWorldSymbolSizes,t=>this._renderer.useRealWorldSymbolSizes=t,v.nn),this.updatingHandles.add(()=>this.pointSize,t=>{const e=(0,M.F2)(t);this._renderer.size=t,this._renderer.sizePx=e},v.nn),this.updatingHandles.add(()=>this.slicePlaneEnabled,t=>this._renderer.slicePlaneEnabled=t,v.nn),this.updatingHandles.add(()=>this.inverseDensity,()=>this._setUpdateViewNeeded(),v.nn),this.updatingHandles.add(()=>this.maximumPointCount,()=>this._setUpdateViewNeeded(),v.nn),this.updatingHandles.add(()=>this.view.qualitySettings.sceneService.pointCloud.lodFactor,t=>{this._lodFactor=t,this._setUpdateViewNeeded()},v.nn)}_destroyRenderer(){this._renderer.removeAll(),this._setPointsVisible(!1)}_createGraphic(t,e,i){const s=(0,u.pC)(t.pointIdFilterMap)?t.pointIdFilterMap[e]:e,n=this.view.computeMapPointFromVec3d(i),o=this._createGraphicAttributes(t,s);return new ce({pointCloudMetadata:{nodeId:t.id,pointIndexInNode:e,attributePointIndexInNode:s,epoch:this._nodeLoadEpoch},geometry:n,attributes:o,layer:this.layer,sourceLayer:this.layer})}_createGraphicAttributes(t,e){const i={};for(const s of t.attributes)this._encodeGraphicAttribute(s.attributeInfo,s.values,e,i);return i}_encodeGraphicAttribute(t,e,i,s){const n=t.storageInfo&&t.storageInfo.attributeValues,o=n?n.valuesPerElement:1;if(1===o)s[t.name]=e[i];else if("UInt8"===n.valueType&&o<=4){let a=0;const l=i*o;for(let d=l;d<l+o;d++)a=(a<<8)+e[d];s[t.name]=a}else s[t.name]=void 0}_setPointsVisible(t){t&&!this._rendererAdded?(this.view._stage.addRenderPlugin([wt.r.OPAQUE_MATERIAL],this._renderer),this._rendererAdded=!0):!t&&this._rendererAdded&&(this.view._stage.removeRenderPlugin(this._renderer),this._rendererAdded=!1)}_rendererChanged(){this._renderer.useFixedSizes=function ct(t){const e=t&&t.pointSizeAlgorithm;return!(!e||!e.type)&&"fixed-size"===e.type}(this.layer.renderer),this._reload()}_reload(){this._clearNodeState(),this._memCache.clear(),this._setUpdateViewNeeded()}_elevationOffsetChanged(){this._clearNodeState(),this._memCache.clear(),this._initNodePages()}_scaleUpdateHandler(t){const e=this.layer.effectiveScaleRange;(0,Le.Av)(e.minScale,e.maxScale)?(0,k.dH)(t.extent,t.spatialReference,tt,this.layer.spatialReference)&&(this._nodeScales.forEach((i,s)=>{if(!this._renderedNodes.has(s))return void this._nodeScales.delete(s);const n=this._index.getNode(s);(0,ve.BD)(tt,n.obb.center)&&this._nodeScales.set(s,t.scale)}),this._setUpdateViewNeeded()):this._nodeScales.clear()}_displayNodes(t){this._workQueue=function xe(t,e,i){for(let n=0;n<e.length;n++)W[n]=!1,X[n]=null;for(let n=0;n<t.length;n++)O[n]=!1,x[n]=null;for(let n=0;n<e.length;n++){const o=Ve(e[n],t,i);o>=0&&(W[n]=!0,null!=x[o]?x[o].push(e[n]):x[o]=[e[n]])}for(let n=0;n<t.length;n++){const o=Ve(t[n],e,i);o>=0&&(O[n]=!0,null!=X[o]?X[o].push(t[n]):X[o]=[t[n]])}const s=[];for(let n=0;n<t.length;n++)null!=x[n]||O[n]||s.push({load:[],remove:[t[n]]});for(let n=0;n<e.length;n++)null!=X[n]||W[n]||s.push({load:[e[n]],remove:[]});for(let n=0;n<e.length;n++)null!=X[n]&&(X[n].length>1||X[n][0]!==e[n])&&s.push({load:[e[n]],remove:X[n]});for(let n=0;n<t.length;n++)null!=x[n]&&(x[n].length>1||x[n][0]!==t[n])&&s.push({load:x[n],remove:[t[n]]});return s}([...this._renderedNodes],t,this._index),function nt(t,e,i){t.sort((s,n)=>{if(0===s.load.length&&0===n.load.length)return 0;if(0===s.load.length)return-1;if(0===n.load.length)return 1;if(0===s.remove.length&&0===n.remove.length){const o=i.getRenderCenter(s.load[0]),a=i.getRenderCenter(n.load[0]);return(0,h.e)(o,e)-(0,h.e)(a,e)}if(0===s.remove.length)return-1;if(0===n.remove.length)return 1;if(1===s.load.length&&1===n.load.length){const o=i.getRenderCenter(s.load[0]),a=i.getRenderCenter(n.load[0]);return(0,h.e)(o,e)-(0,h.e)(a,e)}if(1===s.load.length)return-1;if(1===n.load.length)return 1;{const o=i.getRenderCenter(s.remove[0]),a=i.getRenderCenter(n.remove[0]);return(0,h.e)(o,e)-(0,h.e)(a,e)}})}(this._workQueue,this.view.state.contentCamera.viewForward,this._index),function rt(t,e,i){for(let s=0;s<t.length;++s){const n=t[s];n.load.length>e&&1===n.remove.length&&ot(t,n,i)}}(this._workQueue,8,this._index),this._updateQueues(),this._totalWork=this._computeWork(),this._updateLoading(),this._layerIsVisible=t.length>0||this._loadingInitNodePage,this.notifyChange("suspended")}cancelLoading(){this._cancelNodeLoading(),this._cancelIndexLoading()}_cancelNodeLoading(){const t=new Array;this._loadingNodes.forEach(({abortController:e})=>t.push(e)),this._loadingNodes.clear();for(const e of t)e.abort();this._workQueue=[],this._idleQueue.cancelAll(),this._totalWork=this._computeWork(),this._updateLoading()}_updateQueues(){const t=new Set;this._workQueue.forEach(s=>s.load.forEach(n=>t.add(n)));const e=new Array,i=new Map;this._loadingNodes.forEach((s,n)=>{t.has(n)?i.set(n,s):e.push(s)}),this._loadingNodes=i;for(const{abortController:s}of e)s.abort();this._workQueue=this._workQueue.filter(s=>{for(const n of s.load)if(this._loadingNodes.has(n))return this._recalcWork=!0,!1;return!0}),this._totalWork=this._computeWork(),this._updateLoading()}_cancelIndexLoading(){this._indexQueue=[],this._indexPagesLoading.forEach(({abortController:t})=>t.abort()),this._indexPagesLoading.clear(),this._totalWork=this._computeWork(),this._updateLoading()}_clearNodeState(){this._nodeLoadEpoch++,this._renderedNodes.forEach(t=>this._removeFromRenderer(t)),this._cancelNodeLoading()}_idleBegin(){this._setUpdateViewNeeded()}_idleEnd(){this._setUpdateViewNeeded()}get running(){return this.suspended?this._updateViewNeeded:this._updateViewNeeded||this._indexQueue.length>0||this._workQueue.length>0||this._idleQueue.running}runTask(t){if(this.suspended){if(this._updateViewNeeded){this._updateViewNeeded=!1;const e=this._isRootNodeVisible();e!==this._layerIsVisible&&(this._layerIsVisible=e,this.notifyChange("suspended")),this._updateLoading()}}else{for(t.run(()=>this._updateWorkQueues());this._indexQueue.length>0&&t.run(()=>this._processIndexQueue()););this._processWorkQueue(t),this._idleQueue.runTask(t)}}_processIndexQueue(){const t=this._indexQueue.shift(),e=this._loadNodePage(t);return this._indexPagesLoading.set(t,e),e.promise.then(i=>{this._index.addPage(t,i,this._elevationOffset),this._setUpdateViewNeeded()}).then(()=>{this._indexPagesLoading.delete(t)},()=>{this._indexPagesLoading.delete(t)}),!0}_processWorkQueue(t){for(;!t.done;){const e=this._scheduleWorkEntry();if((0,u.Wi)(e))return;this._processWorkEntry(e),t.madeProgress()}}_scheduleWorkEntry(){let t=this._workQueue.length;for(;t--;){const e=this._workQueue.shift();if(!e.remove.find(i=>!this._renderedNodes.has(i)))return e;this._workQueue.push(e)}return null}_processWorkEntry(t){if(0!==t.load.length)Promise.all(t.load.map(e=>{const i=new AbortController,s=this._memCache.pop(e.toString());return(0,u.pC)(s)?this._loadingNodes.set(e,{abortController:i,promise:Promise.resolve(s)}):this._loadingNodes.has(e)||this._loadingNodes.set(e,{abortController:i,promise:this._loadNode(e,i.signal)}),this._loadingNodes.get(e).promise})).then(e=>{for(let i=0;i<t.load.length;i++)if(e[i]){const s=this._setupRendererData(t.load[i],e[i]);this._addToRenderer(s)}for(const i of t.remove)this._removeFromRenderer(i)}).catch(()=>{}).then(()=>{for(const e of t.load)this._loadingNodes.delete(e);this._updateLoading(),this._recalcWork&&!this._idleQueue.running&&0===this._indexQueue.length&&0===this._loadingNodes.size&&(this._recalcWork=!1,this._setUpdateViewNeeded())}),this._updateLoading();else for(const e of t.remove)this._removeFromRenderer(e)}_populateClassCodeCodedDomain(t,e){var i=this;return(0,g.Z)(function*(){const s="CLASS_CODE",n=i.layer.fieldsIndex.get(s);if(!n||n.domain||!t.includes(n.name))return;const o=yield(0,j.q6)(i.layer.queryCachedStatistics(s,{signal:e}));if(!1===o.ok)return;const a=o.value,l=a&&a.labels&&a.labels.labels;l&&Array.isArray(l)&&(n.domain=new he.Z({name:"CLASS_CODE",codedValues:l.map(d=>new Pe.u({code:d.value,name:d.label}))}))})()}prepareFetchPopupFeatures(t){var e=this;return(0,g.Z)(function*(){return e._codedDomainPopulationPromise||(e._codedDomainPopulationAbortController=new AbortController,e._codedDomainPopulationPromise=e._populateClassCodeCodedDomain(t,e._codedDomainPopulationAbortController.signal).then(()=>{e._codedDomainPopulationAbortController=null})),e._codedDomainPopulationPromise})()}whenGraphicAttributes(t,e){var i=this;return(0,g.Z)(function*(){const s=i._splitGraphicsPerNode(t),n=i.layer.attributeStorageInfo,o=e.map(d=>ue(n,d)),a=function(){var d=(0,g.Z)(function*(p,f){const y=i._index.getNode(f);yield(0,j.Ed)(o,function(){var I=(0,g.Z)(function*(m){const R=m.useElevation?yield i._loadElevationAttributeFromGeometry(y.resourceId):yield i._loadAndParseAttribute(y,m);if(R)for(const V of p)i._isValidPointGraphic(V)&&i._encodeGraphicAttribute(m,R,V.pointCloudMetadata.attributePointIndexInNode,V.attributes)});return function(m){return I.apply(this,arguments)}}())});return function(f,y){return d.apply(this,arguments)}}(),l=[];return s.forEach((d,p)=>{l.push(a(d,p))}),yield(0,b.as)(l),t})()}_isValidPointGraphic(t){return t instanceof ce&&t.pointCloudMetadata&&t.pointCloudMetadata.epoch===this._nodeLoadEpoch}_splitGraphicsPerNode(t){const e=new Map;for(const i of t){if(!this._isValidPointGraphic(i))continue;const s=i.pointCloudMetadata,n=e.get(s.nodeId);n?n.push(i):e.set(s.nodeId,[i])}return e}_loadAndParseAttribute(t,e){var i=this;return(0,g.Z)(function*(){const s=yield i._loadAttribute(t.resourceId,e,null);return(0,u.pC)(s)?(0,Ae.dH)({attributeInfo:e,buffer:s},null,t.vertexCount):null})()}_loadElevationAttributeFromGeometry(t){var e=this;return(0,g.Z)(function*(){const s=(0,Ae.Ym)(e.layer.store.defaultGeometrySchema,yield e._loadGeometry(t,null));return(0,Ae.et)(s,s.length/3)})()}highlight(t){if(!t)return{remove(){}};const e=K.Z.isCollection(t)?t.toArray():Array.isArray(t)?t:[t];return this._renderer.highlight(e.map(i=>this._graphicToPointDefinition(i)))}_graphicToPointDefinition(t){if(!this._isValidPointGraphic(t))return null;const{nodeId:e,pointIndexInNode:i}=t.pointCloudMetadata;return null!=e&&null!=i?{nodeId:e,pointId:i}:null}_computeWork(){let t=0;for(const e of this._workQueue)t+=e.load.length+e.remove.length;return t+=this._loadingNodes.size,t+=(this._indexQueue.length+this._indexPagesLoading.size)*this._index.pageSize,t+=this._loadingInitNodePage?100:0,t+=this._updateViewNeeded?100:0,t}get updatingProgressValue(){if(this.suspended)return this._updateViewNeeded?0:1;const t=this._computeWork();return 1-Math.min(this._totalWork,t)/this._totalWork}_updateLoading(){this.notifyChange("updating"),this.notifyChange("updatingProgressValue")}canResume(){return super.canResume()&&this._layerIsVisible}isUpdating(){return this.suspended?this._updateViewNeeded:this._computeWork()>0}_initNodePages(){const t=this.layer.store.index;return this._index=new at(this.layer.spatialReference,this.view.renderCoordsHelper.spatialReference,t.nodesPerPage||t.nodePerIndexBlock),this._cancelIndexLoading(),this._traverseVisible=this._index.createVisibilityTraverse(),this._loadingInitNodePage=!0,this._layerIsVisible=!0,this.notifyChange("suspended"),this._updateLoading(),this._pageMultiplier=null!=t.nodesPerPage?1:t.nodePerIndexBlock,this._loadNodePage(0).promise.then(i=>{this._index.addPage(0,i,this._elevationOffset),this._loadingInitNodePage=!1,this._setUpdateViewNeeded()})}_loadNodePage(t){const e=new AbortController;return{promise:this._requestNodePage(`${this.baseUrl}/nodepages/${t*this._pageMultiplier}`,e.signal).then(s=>s.nodes.map((n,o)=>({resourceId:null!=n.resourceId?n.resourceId:t*this._index.pageSize+o,obb:n.obb,firstChild:n.firstChild,childCount:n.childCount,vertexCount:null!=n.vertexCount?n.vertexCount:n.pointCount,lodThreshold:null!=n.lodThreshold?n.lodThreshold:n.effectiveArea}))),abortController:e}}_updateWorkQueues(){if(!this._updateViewNeeded)return!1;let t=this.inverseDensity/this._lodFactor*this._getLodMemoryFactor();const e=this.maximumPointCount*this._lodFactor*this._getLodMemoryFactor();let i=this._computeNodesForMinimumDensity(t),s=this._computePointCount(i),n=Math.sqrt(s/(.75*e));for(;s>e;)t*=n,i=this._computeNodesForMinimumDensity(t),s=this._computePointCount(i),n=Math.sqrt(2);return this._displayNodes(i),this._updateViewNeeded=!1,this._updateLoading(),!0}_computePointCount(t){let e=0;for(let i=0;i<t.length;i++){const s=this._index.getNode(t[i]);s&&(e+=s.vertexCount)}return e}_getLodMemoryFactor(){return this.view.resourceController.memoryController.memoryFactor}_isRootNodeVisible(){let t=!1;return this._traverseVisible({frustum:this.view.state.contentCamera.frustum,clippingBox:this._clippingBox},{predicate:(e,i,s)=>(t=s,!1),pageMiss:()=>{}}),t}_computeNodesForMinimumDensity(t){const e=this.view.state.contentCamera,i=e.frustum,s=this._clippingBox,n=e.viewForward,o=(0,h.e)(n,e.eye),a=(0,re.Oy)(n,-o,Vt),l=e.perScreenPixelRatio/2,d=t*t,p=this._nodeIdArray;p.length=0;const{minScale:f,maxScale:y}=(0,Le.lu)(this.layer),I=0===f&&0===y?m=>p.push(m):m=>{const R=this._getScale(m);(0,Le.rs)(R,f,y)&&p.push(m)};return this._traverseVisible({frustum:i,clippingBox:s},{predicate:(m,R,V)=>{if(!V)return!1;if(0===R.childCount)return I(m),!1;const D=this._index.getRenderObb(m);return!(this._computeAveragePixelArea(D,R.lodThreshold,R.vertexCount,a,l)<=d&&(I(m),1))},pageMiss:(m,R)=>{I(m),this._indexQueue.includes(R)||this._indexQueue.push(R)}}),p}_getScale(t){let e=this._nodeScales.get(t);if(null==e){const i=this._index.getNode(t).obb.center;this._tmpPoint.x=i[0],this._tmpPoint.y=i[1],this._tmpPoint.z=i[2],e=this.view.basemapTerrain.getScale(this._tmpPoint),this._nodeScales.set(t,e)}return e}_computeAveragePixelArea(t,e,i,s,n){const a=Math.max(1e-7,(0,Y.JH)(t,s));return e/(a*a)/(4*n*n)/i}_loadNode(t,e){try{return this._loadNodeAsync(t,e)}catch(i){throw(0,b.D_)(i)||F.Z.getLogger(this.declaredClass).error(i),i}}_loadAdditionalUserAttributes(t,e,i){var s=this;return(0,g.Z)(function*(){const n=s.layer.outFields;if(!n)return[];const o=(0,be.Lk)(s.layer.fieldsIndex,n),a=new Set(t.map(f=>(0,u.pC)(f)?f.name:null)),l=s.layer.attributeStorageInfo,d=[];for(const f of o){if(a.has(f))continue;const y=ue(l,f);y&&d.push(e(y))}const p=yield(0,b.WW)(d);return(0,b.k_)(i),(0,u.e8)(p,f=>f)})()}_loadNodeAsync(t,e){var i=this;return(0,g.Z)(function*(){const s=i._index.getNode(t),n=je(i.layer),o=Ke(i.layer),a=s.resourceId,l=function(){var d=(0,g.Z)(function*(p){if((0,u.Wi)(p))return null;if(p.useElevation)return{attributeInfo:p,buffer:null};const f=yield i._loadAttribute(a,p,e);return(0,u.pC)(f)?{attributeInfo:p,buffer:f}:null});return function(f){return d.apply(this,arguments)}}();return i._idleQueue.push((0,g.Z)(function*(){const d=i._loadGeometry(a,e),{primaryAttribute:p,modulationAttribute:f}=n,y=l(p),I=l(f),m=o.map(B=>B.attributeInfo),R=m.map(B=>l(B)),V=i._loadAdditionalUserAttributes([p,f,...m],l,e),[D,le,Te,_e,_]=yield Promise.all([d,y,I,Promise.all(R),V]);(0,b.k_)(e);const T={geometryBuffer:D,primaryAttributeData:le,modulationAttributeData:Te,filterAttributesData:_e,userAttributesData:_,schema:i.layer.store.defaultGeometrySchema,rendererInfo:n,filterInfo:o,obb:i._index.getRenderObb(t),elevationOffset:i._elevationOffset,inSR:i.layer.spatialReference.toJSON(),outSR:i.view.renderCoordsHelper.spatialReference.toJSON()};return i._worker.invoke(T,e)}),e)})()}_loadGeometry(t,e){var i=this;return(0,g.Z)(function*(){return i._requestData(`${i.baseUrl}/nodes/${t}/geometries/0`,e)})()}_loadAttribute(t,e,i){var s=this;return(0,g.Z)(function*(){return(0,u.Wi)(e)||!e.storageInfo?null:s._requestData(`${s.baseUrl}/nodes/${t}/attributes/${e.storageInfo.key}`,i)})()}_requestNodePage(t,e){return this._indexRequester.request(t,"json",{query:{f:"json",token:this.layer.apiKey},signal:e})}_requestData(t,e){return this._dataRequester.request(t,"binary",{query:{token:this.layer.apiKey},signal:e})}_removeFromRenderer(t){if(this._renderedNodes.has(t)){const e=this._renderer.removeNode(t);this._renderedNodes.delete(t),this._nodeScales.delete(t),this._memCache.put(e.id.toString(),e,function Kt(t){return 5*t.coordinates.length+128}(e))}}_addToRenderer(t){this._renderedNodes.has(t.id)||(this._renderedNodes.add(t.id),this._renderer.addNode(t))}_setupRendererData(t,e){const i=this._index.getNode(t),s=Math.sqrt(i.lodThreshold/i.vertexCount),n=this._index.getRenderObb(t);if(function Dt(t){return t.hasOwnProperty("splatSize")}(e))return e.splatSize=s,e.obb=n,(0,h.c)(e.origin,e.obb.center),e;const o=.01*Math.max(n.halfSize[0],n.halfSize[1],n.halfSize[2]);if(e.obb.halfSize[0]>n.halfSize[0]+o||e.obb.halfSize[1]>n.halfSize[1]+o||e.obb.halfSize[2]>n.halfSize[2]+o){if(this._maxLoggedBoxWarnings>0){const a=l=>`[${l.halfSize[0]}, ${l.halfSize[1]}, ${l.halfSize[2]}]`;F.Z.getLogger(this.declaredClass).warn(`Node ${t} reported bounding box too small. got ${a(n)} but points cover ${a(e.obb)}`),0==--this._maxLoggedBoxWarnings&&F.Z.getLogger(this.declaredClass).warn("  Too many bounding box errors, stopping reporting for this layer.")}this._index.setRenderObb(t,e.obb)}return new At(t,s,(0,A.b)(n.center),n,0===i.childCount,e.points,e.rgb,e.attributes,e.pointIdFilterMap)}getUsedMemory(){let t=0;return this._renderer.forEachNode(e=>{t+=We,t+=(0,w.Xw)(e.coordinates);for(const i of e.attributes){const s=i.values;(0,w.eP)(s.buffer)&&(t+=(0,w.Xw)(s))}}),t}getUnloadedMemory(){const t=this._renderedNodes.size;if(t<4)return 0;const e=[...this._renderedNodes].reduce((s,n)=>s+this._index.getNode(n).vertexCount);let i=this._loadingNodes.size;for(let s=0;s<this._workQueue.length;s++)i+=this._workQueue[s].load.length,i-=this._workQueue[s].remove.length;return i<0?0:i*e/t*((this.getUsedMemory()-t*We)/e)+i*We}ignoresMemoryFactor(){return!1}get performanceInfo(){return{nodes:this._renderedNodes.size,displayedNumberOfFeatures:[...this._renderedNodes].reduce((t,e)=>t+this._index.getNode(e).vertexCount,0),maximumNumberOfFeatures:this.maximumPointCount,totalNumberOfFeatures:-1,core:null,"Loading Nodes":this._loadingNodes.size,"Index Queue":this._indexQueue.length,"Work Queue":this._workQueue.length,"Idle Queue":this._idleQueue.length}}get test(){return{index:this._index,visibleNodes:this._renderedNodes}}};(0,c._)([(0,E.Cb)()],N.prototype,"layer",void 0),(0,c._)([(0,E.Cb)()],N.prototype,"baseUrl",null),(0,c._)([(0,E.Cb)()],N.prototype,"pointScale",null),(0,c._)([(0,E.Cb)()],N.prototype,"useRealWorldSymbolSizes",null),(0,c._)([(0,E.Cb)()],N.prototype,"pointSize",null),(0,c._)([(0,E.Cb)()],N.prototype,"inverseDensity",null),(0,c._)([(0,E.Cb)()],N.prototype,"maximumPointCount",void 0),(0,c._)([(0,E.Cb)({readOnly:!0})],N.prototype,"availableFields",null),(0,c._)([(0,E.Cb)({readOnly:!0})],N.prototype,"_clippingBox",null),(0,c._)([(0,E.Cb)({readOnly:!0})],N.prototype,"_elevationOffset",null),(0,c._)([(0,E.Cb)({type:Boolean})],N.prototype,"slicePlaneEnabled",void 0),(0,c._)([(0,E.Cb)()],N.prototype,"updating",void 0),(0,c._)([(0,E.Cb)(Tt.q)],N.prototype,"updatingProgress",void 0),(0,c._)([(0,E.Cb)({readOnly:!0})],N.prototype,"updatingProgressValue",null),N=(0,c._)([(0,S.j)("esri.views.3d.layers.PointCloudLayerView3D")],N);const jt=N,tt=(0,ve.Ue)(),We=160},45611:(me,Z,r)=>{r.d(Z,{Z:()=>C});var g=r(17626),c=r(14517),j=r(61885),K=r(80542),F=r(61996),u=r(63290),b=r(62208),v=r(60330),M=r(77712),E=(r(85931),r(90912),r(76898));let P=class extends((0,K.p)((0,F.IG)((0,v.v)(j.Z.EventedMixin(c.Z))))){constructor(S){super(S),this.layer=null,this.parent=null}initialize(){this.when().catch(S=>{if("layerview:create-error"!==S.name){const h=this.layer&&this.layer.id||"no id",A=this.layer&&this.layer.title||"no title";u.Z.getLogger(this.declaredClass).error("#resolve()",`Failed to resolve layer view (layer title: '${A}', id: '${h}')`,S)}})}get fullOpacity(){return(0,b.Pt)(this.get("layer.opacity"),1)*(0,b.Pt)(this.get("parent.fullOpacity"),1)}get suspended(){return!this.canResume()}get suspendInfo(){return this.getSuspendInfo()}get legendEnabled(){return!this.suspended&&!0===this.layer?.legendEnabled}get updating(){return!(!this.updatingHandles?.updating&&!this.isUpdating())}get updatingProgress(){return this.updating?0:1}get visible(){return!0===this.layer?.visible}set visible(S){this._overrideIfSome("visible",S)}canResume(){return this.visible&&this.layer?.loaded&&!this.parent?.suspended&&this.view?.ready||!1}getSuspendInfo(){const S=this.parent&&this.parent.suspended?this.parent.suspendInfo:{};return this.view&&this.view.ready||(S.viewNotReady=!0),this.layer&&this.layer.loaded||(S.layerNotLoaded=!0),this.visible||(S.layerInvisible=!0),S}isUpdating(){return!1}};(0,g._)([(0,M.Cb)()],P.prototype,"fullOpacity",null),(0,g._)([(0,M.Cb)()],P.prototype,"layer",void 0),(0,g._)([(0,M.Cb)()],P.prototype,"parent",void 0),(0,g._)([(0,M.Cb)({readOnly:!0})],P.prototype,"suspended",null),(0,g._)([(0,M.Cb)({readOnly:!0})],P.prototype,"suspendInfo",null),(0,g._)([(0,M.Cb)({readOnly:!0})],P.prototype,"legendEnabled",null),(0,g._)([(0,M.Cb)({type:Boolean,readOnly:!0})],P.prototype,"updating",null),(0,g._)([(0,M.Cb)({readOnly:!0})],P.prototype,"updatingProgress",null),(0,g._)([(0,M.Cb)()],P.prototype,"visible",null),(0,g._)([(0,M.Cb)()],P.prototype,"view",void 0),P=(0,g._)([(0,E.j)("esri.views.layers.LayerView")],P);const C=P},10023:(me,Z,r)=>{r.d(Z,{V:()=>u,e:()=>K});var g=r(15861),c=r(62208),j=r(36630);function K(b){return F.apply(this,arguments)}function F(){return(F=(0,g.Z)(function*(b,v=b.popupTemplate){if((0,c.Wi)(v))return[];const M=yield v.getRequiredFields(b.fieldsIndex),{lastEditInfoEnabled:w}=v,{objectIdField:H,typeIdField:E,globalIdField:P,relationships:C}=b;if(M.includes("*"))return["*"];const S=w?yield(0,j.CH)(b):[],h=(0,j.Q0)(b.fieldsIndex,[...M,...S]);return E&&h.push(E),h&&H&&b.fieldsIndex.has(H)&&!h.includes(H)&&h.push(H),h&&P&&b.fieldsIndex.has(P)&&!h.includes(P)&&h.push(P),C&&C.forEach(A=>{const{keyField:k}=A;h&&k&&b.fieldsIndex.has(k)&&!h.includes(k)&&h.push(k)}),h})).apply(this,arguments)}function u(b,v){return b.popupTemplate?b.popupTemplate:(0,c.pC)(v)&&v.defaultPopupTemplateEnabled&&(0,c.pC)(b.defaultPopupTemplate)?b.defaultPopupTemplate:null}}}]);