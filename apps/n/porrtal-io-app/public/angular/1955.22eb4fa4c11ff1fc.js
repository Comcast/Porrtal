"use strict";(self.webpackChunka_porrtal_io_app=self.webpackChunka_porrtal_io_app||[]).push([[1955],{81955:(se,V,t)=>{t.r(V),t.d(V,{default:()=>Oe});var s=t(17626),D=(t(63290),t(90912)),R=(t(85931),t(8314)),v=(t(82255),t(76898)),N=t(69759),j=t(15861),A=t(26584),I=t(62208),J=t(10699),a=t(77712),T=t(2004),G=t(83137),C=t(13812),$=t(14772),S=t(59990),Y=t(22264),ne=t(84792),oe=t(13924),Q=t(2618),ie=t(95737),k=t(91179),ae=t(13410);const q=n=>n.spatialReference.wkid||JSON.stringify(n.spatialReference);function le(n,r){const{dpi:i,gdbVersion:o,geometry:e,geometryPrecision:p,height:c,layerOption:b,mapExtent:h,maxAllowableOffset:l,returnFieldName:x,returnGeometry:d,returnUnformattedValues:m,returnZ:P,spatialReference:u,timeExtent:w,tolerance:f,width:g}=n.toJSON(),{dynamicLayers:O,layerDefs:U,layerIds:L}=function pe(n){const{mapExtent:r,floors:i,width:o,sublayers:e,layerIds:p,layerOption:c,gdbVersion:b}=n,h=e?.find(u=>null!=u.layer)?.layer?.serviceSublayers,l="popup"===c,x={},d=(0,G.yZ)({extent:r,width:o,spatialReference:r?.spatialReference}),m=[],P=u=>{if(u.visible&&(0===d||(0===u.minScale||d<=u.minScale)&&(0===u.maxScale||d>=u.maxScale)))if(u.sublayers)u.sublayers.forEach(P);else{if(!1===p?.includes(u.id)||l&&(!u.popupTemplate||!u.popupEnabled))return;m.unshift(u)}};if(e?.forEach(P),e&&!m.length)x.layerIds=[];else{const u=(0,ae.FN)(m,h,b),w=m.map(f=>{const g=(0,S.f)(i,f);return f.toExportImageJSON(g)});if(u)x.dynamicLayers=JSON.stringify(w);else{if(e){let g=m.map(({id:O})=>O);p&&(g=g.filter(O=>p.includes(O))),x.layerIds=g}else p?.length&&(x.layerIds=p);const f=function ue(n,r){const i=!!n?.length,o=r.filter(e=>null!=e.definitionExpression||i&&null!=e.floorInfo);return o.length?o.map(e=>{const p=(0,S.f)(n,e),c=(0,ie._)(p,e.definitionExpression);return{id:e.id,definitionExpression:c}}):null}(i,m);if((0,I.pC)(f)&&f.length){const g={};for(const O of f)O.definitionExpression&&(g[O.id]=O.definitionExpression);Object.keys(g).length&&(x.layerDefs=JSON.stringify(g))}}}return x}(n),z=r&&(0,I.pC)(r.geometry)?r.geometry:null,E={geometryPrecision:p,maxAllowableOffset:l,returnFieldName:x,returnGeometry:d,returnUnformattedValues:m,returnZ:P,tolerance:f},Z=z&&z.toJSON()||e;if(E.imageDisplay=`${g},${c},${i}`,o&&(E.gdbVersion=o),Z&&(delete Z.spatialReference,E.geometry=JSON.stringify(Z),E.geometryType=(0,k.Ji)(Z)),u?E.sr=u.wkid||JSON.stringify(u):Z&&Z.spatialReference?E.sr=q(Z):h&&h.spatialReference&&(E.sr=q(h)),E.time=w?[w.start,w.end].join(","):null,h){const{xmin:je,ymin:we,xmax:Fe,ymax:Ne}=h;E.mapExtent=`${je},${we},${Fe},${Ne}`}return U&&(E.layerDefs=U),O&&!U&&(E.dynamicLayers=O),E.layers="popup"===b?"visible":b,L&&!O&&(E.layers+=`:${L.join(",")}`),E}var B,ye=t(29132),de=t(97478),_=t(86810),me=t(65234);let y=B=class extends _.wq{constructor(n){super(n),this.dpi=96,this.floors=null,this.gdbVersion=null,this.geometry=null,this.geometryPrecision=null,this.height=400,this.layerIds=null,this.layerOption="top",this.mapExtent=null,this.maxAllowableOffset=null,this.returnFieldName=!0,this.returnGeometry=!1,this.returnM=!1,this.returnUnformattedValues=!0,this.returnZ=!1,this.spatialReference=null,this.sublayers=null,this.timeExtent=null,this.tolerance=null,this.width=400}static from(n){return(0,D.TJ)(B,n)}};(0,s._)([(0,a.Cb)({type:Number,json:{write:!0}})],y.prototype,"dpi",void 0),(0,s._)([(0,a.Cb)()],y.prototype,"floors",void 0),(0,s._)([(0,a.Cb)({type:String,json:{write:!0}})],y.prototype,"gdbVersion",void 0),(0,s._)([(0,a.Cb)({types:ye.qM,json:{read:k.im,write:!0}})],y.prototype,"geometry",void 0),(0,s._)([(0,a.Cb)({type:Number,json:{write:!0}})],y.prototype,"geometryPrecision",void 0),(0,s._)([(0,a.Cb)({type:Number,json:{write:!0}})],y.prototype,"height",void 0),(0,s._)([(0,a.Cb)({type:[Number],json:{write:!0}})],y.prototype,"layerIds",void 0),(0,s._)([(0,a.Cb)({type:["top","visible","all","popup"],json:{write:!0}})],y.prototype,"layerOption",void 0),(0,s._)([(0,a.Cb)({type:T.Z,json:{write:!0}})],y.prototype,"mapExtent",void 0),(0,s._)([(0,a.Cb)({type:Number,json:{write:!0}})],y.prototype,"maxAllowableOffset",void 0),(0,s._)([(0,a.Cb)({type:Boolean,json:{write:!0}})],y.prototype,"returnFieldName",void 0),(0,s._)([(0,a.Cb)({type:Boolean,json:{write:!0}})],y.prototype,"returnGeometry",void 0),(0,s._)([(0,a.Cb)({type:Boolean,json:{write:!0}})],y.prototype,"returnM",void 0),(0,s._)([(0,a.Cb)({type:Boolean,json:{write:!0}})],y.prototype,"returnUnformattedValues",void 0),(0,s._)([(0,a.Cb)({type:Boolean,json:{write:!0}})],y.prototype,"returnZ",void 0),(0,s._)([(0,a.Cb)({type:me.Z,json:{write:!0}})],y.prototype,"spatialReference",void 0),(0,s._)([(0,a.Cb)()],y.prototype,"sublayers",void 0),(0,s._)([(0,a.Cb)({type:de.Z,json:{write:!0}})],y.prototype,"timeExtent",void 0),(0,s._)([(0,a.Cb)({type:Number,json:{write:!0}})],y.prototype,"tolerance",void 0),(0,s._)([(0,a.Cb)({type:Number,json:{write:!0}})],y.prototype,"width",void 0),y=B=(0,s._)([(0,v.j)("esri.rest.support.IdentifyParameters")],y);const ee=y;var te=t(88879),fe=t(68653),ce=t(99433),he=t(71774);let F=class extends _.wq{constructor(n){super(n),this.displayFieldName=null,this.feature=null,this.layerId=null,this.layerName=null}readFeature(n,r){return te.Z.fromJSON({attributes:{...r.attributes},geometry:{...r.geometry}})}writeFeature(n,r){if(!n)return;const{attributes:i,geometry:o}=n;i&&(r.attributes={...i}),(0,I.pC)(o)&&(r.geometry=o.toJSON(),r.geometryType=he.P$.toJSON(o.type))}};(0,s._)([(0,a.Cb)({type:String,json:{write:!0}})],F.prototype,"displayFieldName",void 0),(0,s._)([(0,a.Cb)({type:te.Z})],F.prototype,"feature",void 0),(0,s._)([(0,fe.r)("feature",["attributes","geometry"])],F.prototype,"readFeature",null),(0,s._)([(0,ce.c)("feature")],F.prototype,"writeFeature",null),(0,s._)([(0,a.Cb)({type:Number,json:{write:!0}})],F.prototype,"layerId",void 0),(0,s._)([(0,a.Cb)({type:String,json:{write:!0}})],F.prototype,"layerName",void 0),F=(0,s._)([(0,v.j)("esri.rest.support.IdentifyResult")],F);const ve=F;function W(){return(W=(0,j.Z)(function*(n,r,i){const o=(r=be(r)).geometry?[r.geometry]:[],e=(0,Q.en)(n);return e.path+="/identify",(0,oe.aX)(o).then(p=>{const c=le(r,{geometry:p&&p[0]}),b=(0,Q.cv)({...e.query,f:"json",...c}),h=(0,Q.lA)(b,i);return(0,ne.default)(e.path,h).then(xe).then(l=>Pe(l,r.sublayers))})})).apply(this,arguments)}function xe(n){const r=n.data;r.results=r.results||[];const i={results:[]};return i.results=r.results.map(o=>ve.fromJSON(o)),i}function be(n){return ee.from(n)}function Pe(n,r){if(!r?.length)return n;const i=new Map;r.forEach(function o(e){i.set(e.id,e),e.sublayers&&e.sublayers.forEach(o)});for(const e of n.results)e.feature.sourceLayer=i.get(e.layerId);return n}var Ee=t(46679),re=t(10023);const Ie=n=>{let r=class extends n{initialize(){this.exportImageParameters=new $.R({layer:this.layer})}destroy(){this.exportImageParameters.destroy(),this.exportImageParameters=null}get exportImageVersion(){return this.exportImageParameters?.commitProperty("version"),this.commitProperty("timeExtent"),(this._get("exportImageVersion")||0)+1}fetchPopupFeatures(i,o){var e=this;return(0,j.Z)(function*(){const{layer:p}=e;if(!i)throw new A.Z("mapimagelayer:fetchPopupFeatures","Nothing to fetch without area",{layer:p});const c=e.layer.capabilities?.operations?.supportsQuery??!0;if(!((e.layer.capabilities?.operations?.supportsIdentify??1)&&e.layer.version>=10.5||c))throw new A.Z("mapimagelayer:fetchPopupFeatures-not-supported","query operation is disabled for this service",{layer:p});return c?e._fetchPopupFeaturesUsingQueries(i,o):e._fetchPopupFeaturesUsingIdentify(i,o)})()}canResume(){return!!super.canResume()&&!this.timeExtent?.isEmpty}_fetchPopupFeaturesUsingIdentify(i,o){var e=this;return(0,j.Z)(function*(){const p=yield e._createIdentifyParameters(i,o);if((0,I.Wi)(p))return[];const{results:c}=yield function ge(n,r,i){return W.apply(this,arguments)}(e.layer.parsedUrl,p);return c.map(b=>b.feature)})()}_createIdentifyParameters(i,o){var e=this;return(0,j.Z)(function*(){const{floors:p,spatialReference:c,scale:b}=e.view,h=(0,I.pC)(o)?o.event:null,l=yield e._collectPopupProviders(e.layer.sublayers,b,o);if(!l.length)return null;yield Promise.all(l.map(({sublayer:f})=>f.load().catch(()=>{})));const x=Math.min((0,R.Z)("mapimagelayer-popup-identify-max-tolerance"),e.layer.allSublayers.reduce((f,g)=>g.renderer?(0,Y.k)({renderer:g.renderer,event:h}):f,2)),d=e.createFetchPopupFeaturesQueryGeometry(i,x),m=(0,G.dp)(b,c),P=Math.round(d.width/m),u=new T.Z({xmin:d.center.x-m*P,ymin:d.center.y-m*P,xmax:d.center.x+m*P,ymax:d.center.y+m*P,spatialReference:d.spatialReference}),w=!1===e.layer.capabilities?.operations?.supportsQuery||(yield new Promise(f=>{let g=!1;Promise.all(l.map(function(){var O=(0,j.Z)(function*({popupTemplate:U}){if(U){const L=yield e._loadArcadeModules(U);if(g)return;L?.arcadeUtils.hasGeometryOperations(U)&&(g=!0,f(!0))}});return function(U){return O.apply(this,arguments)}}())).finally(()=>f(!1))}));return new ee({floors:p,gdbVersion:e.layer.gdbVersion,geometry:i,height:P,layerOption:"popup",mapExtent:u,maxAllowableOffset:w?0:m,returnGeometry:!0,spatialReference:c,sublayers:e.layer.sublayers,timeExtent:e.timeExtent,tolerance:x,width:P})})()}_fetchPopupFeaturesUsingQueries(i,o){var e=this;return(0,j.Z)(function*(){const p=yield e._collectPopupProviders(e.layer.sublayers,e.view.scale,o),c=(0,I.pC)(o)?o.event:null,b=p.map(function(){var h=(0,j.Z)(function*({sublayer:l,popupTemplate:x}){yield l.load().catch(()=>{});const d=l.createQuery(),m=(0,Y.k)({renderer:l.renderer,event:c}),P=e.createFetchPopupFeaturesQueryGeometry(i,m);if(d.geometry=P,d.outFields=yield(0,re.e)(l,x),"floors"in e.view){const w=e.view?.floors?.clone(),f=(0,S.f)(w,l);(0,I.pC)(f)&&(d.where=d.where?`(${d.where}) AND (${f})`:f)}const u=yield e._loadArcadeModules(x);return u&&u.arcadeUtils.hasGeometryOperations(x)||(d.maxAllowableOffset=P.width/m),(yield l.queryFeatures(d)).features});return function(l){return h.apply(this,arguments)}}());return(yield(0,J.as)(b)).reduce((h,l)=>l.value?[...h,...l.value]:h,[]).filter(h=>null!=h)})()}_collectPopupProviders(i,o,e){return(0,j.Z)(function*(){const p=[],c=function(){var h=(0,j.Z)(function*(l){if(l.visible&&(0===l.minScale||o<=l.minScale)&&(0===l.maxScale||o>=l.maxScale))if(l.sublayers)l.sublayers.forEach(c);else if(l.popupEnabled){const m=(0,re.V)(l,{...e,defaultPopupTemplateEnabled:!1});(0,I.pC)(m)&&p.unshift({sublayer:l,popupTemplate:m})}});return function(x){return h.apply(this,arguments)}}(),b=i.toArray().reverse().map(c);return yield Promise.all(b),p})()}_loadArcadeModules(i){if(i.expressionInfos?.length||Array.isArray(i.content)&&i.content.some(o=>"expression"===o.type))return(0,Ee.LC)()}};return(0,s._)([(0,a.Cb)()],r.prototype,"exportImageParameters",void 0),(0,s._)([(0,a.Cb)({readOnly:!0})],r.prototype,"exportImageVersion",null),(0,s._)([(0,a.Cb)()],r.prototype,"layer",void 0),(0,s._)([(0,a.Cb)()],r.prototype,"suspended",void 0),(0,s._)([(0,a.Cb)(C.qG)],r.prototype,"timeExtent",void 0),r=(0,s._)([(0,v.j)("esri.views.layers.MapImageLayerView")],r),r};var Ce=t(94672);let K=class extends(Ie(N.Z)){constructor(){super(...arguments),this.type="map-image-3d"}initialize(){this.updatingHandles.add(()=>this.exportImageVersion,()=>this.updatingHandles.addPromise(this.refreshDebounced()))}createFetchPopupFeaturesQueryGeometry(n,r){return(0,Ce.K)(n,r,this.view)}getFetchOptions(){return{timeExtent:this.timeExtent}}};K=(0,s._)([(0,v.j)("esri.views.3d.layers.MapImageLayerView3D")],K);const Oe=K},10023:(se,V,t)=>{t.d(V,{V:()=>X,e:()=>H});var s=t(15861),M=t(62208),D=t(36630);function H(v){return R.apply(this,arguments)}function R(){return(R=(0,s.Z)(function*(v,N=v.popupTemplate){if((0,M.Wi)(N))return[];const j=yield N.getRequiredFields(v.fieldsIndex),{lastEditInfoEnabled:A}=N,{objectIdField:I,typeIdField:J,globalIdField:a,relationships:T}=v;if(j.includes("*"))return["*"];const G=A?yield(0,D.CH)(v):[],C=(0,D.Q0)(v.fieldsIndex,[...j,...G]);return J&&C.push(J),C&&I&&v.fieldsIndex.has(I)&&!C.includes(I)&&C.push(I),C&&a&&v.fieldsIndex.has(a)&&!C.includes(a)&&C.push(a),T&&T.forEach($=>{const{keyField:S}=$;C&&S&&v.fieldsIndex.has(S)&&!C.includes(S)&&C.push(S)}),C})).apply(this,arguments)}function X(v,N){return v.popupTemplate?v.popupTemplate:(0,M.pC)(N)&&N.defaultPopupTemplateEnabled&&(0,M.pC)(v.defaultPopupTemplate)?v.defaultPopupTemplate:null}}}]);